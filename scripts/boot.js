//     Underscore.js 1.3.3
//     (c) 2009-2012 Jeremy Ashkenas, DocumentCloud Inc.
//     Underscore is freely distributable under the MIT license.
//     Portions of Underscore are inspired or borrowed from Prototype,
//     Oliver Steele's Functional, and John Resig's Micro-Templating.
//     For all details and documentation:
//     http://documentcloud.github.com/underscore

/*
 * namespace.coffee v1.0.0
 * Copyright (c) 2011 CodeCatalyst, LLC.
 * Open source under the MIT License.
 */

/* -------------------------------------------------------------------------

	// Film grain & scanlines shader

	//	- ported from HLSL to WebGL / GLSL
	//	  http://www.truevision3d.com/forums/showcase/staticnoise_colorblackwhite_scanline_shaders-t18698.0.html

	// Screen Space Static Postprocessor
	//
	// Produces an analogue noise overlay similar to a film grain / TV static
	//
	// Original implementation and noise algorithm
	// Pat 'Hawthorne' Shearon
	//
	// Optimized scanlines + noise version with intensity scaling
	// Georg 'Leviathan' Steinrohder

	// This version is provided under a Creative Commons Attribution 3.0 License
	// http://creativecommons.org/licenses/by/3.0/
	 ------------------------------------------------------------------------- */

/**
 * @license RequireJS text 2.0.0 Copyright (c) 2010-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/requirejs/text for details
 */

define("cs",{load:function(e){throw new Error("Dynamic load not allowed: "+e)}}),function(){function k(e,t,n){if(e===t)return e!==0||1/e==1/t;if(e==null||t==null)return e===t;e._chain&&(e=e._wrapped),t._chain&&(t=t._wrapped);if(e.isEqual&&x.isFunction(e.isEqual))return e.isEqual(t);if(t.isEqual&&x.isFunction(t.isEqual))return t.isEqual(e);var r=f.call(e);if(r!=f.call(t))return!1;switch(r){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:e==0?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if(typeof e!="object"||typeof t!="object")return!1;var i=n.length;while(i--)if(n[i]==e)return!0;n.push(e);var s=0,o=!0;if(r=="[object Array]"){s=e.length,o=s==t.length;if(o)while(s--)if(!(o=s in e==s in t&&k(e[s],t[s],n)))break}else{if("constructor"in e!="constructor"in t||e.constructor!=t.constructor)return!1;for(var u in e)if(x.has(e,u)){s++;if(!(o=x.has(t,u)&&k(e[u],t[u],n)))break}if(o){for(u in t)if(x.has(t,u)&&!(s--))break;o=!s}}return n.pop(),o}var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=Function.prototype,o=r.push,u=r.slice,a=r.unshift,f=i.toString,l=i.hasOwnProperty,c=r.forEach,h=r.map,p=r.reduce,d=r.reduceRight,v=r.filter,m=r.every,g=r.some,y=r.indexOf,b=r.lastIndexOf,w=Array.isArray,E=Object.keys,S=s.bind,x=function(e){return new H(e)};typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=x),exports._=x):e._=x,x.VERSION="1.3.3";var T=x.each=x.forEach=function(e,t,r){if(e==null)return;if(c&&e.forEach===c)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;i<s;i++)if(i in e&&t.call(r,e[i],i,e)===n)return}else for(var o in e)if(x.has(e,o)&&t.call(r,e[o],o,e)===n)return};x.map=x.collect=function(e,t,n){var r=[];return e==null?r:h&&e.map===h?e.map(t,n):(T(e,function(e,i,s){r[r.length]=t.call(n,e,i,s)}),e.length===+e.length&&(r.length=e.length),r)},x.reduce=x.foldl=x.inject=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(p&&e.reduce===p)return r&&(t=x.bind(t,r)),i?e.reduce(t,n):e.reduce(t);T(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)});if(!i)throw new TypeError("Reduce of empty array with no initial value");return n},x.reduceRight=x.foldr=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(d&&e.reduceRight===d)return r&&(t=x.bind(t,r)),i?e.reduceRight(t,n):e.reduceRight(t);var s=x.toArray(e).reverse();return r&&!i&&(t=x.bind(t,r)),i?x.reduce(s,t,n,r):x.reduce(s,t)},x.find=x.detect=function(e,t,n){var r;return N(e,function(e,i,s){if(t.call(n,e,i,s))return r=e,!0}),r},x.filter=x.select=function(e,t,n){var r=[];return e==null?r:v&&e.filter===v?e.filter(t,n):(T(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},x.reject=function(e,t,n){var r=[];return e==null?r:(T(e,function(e,i,s){t.call(n,e,i,s)||(r[r.length]=e)}),r)},x.every=x.all=function(e,t,r){var i=!0;return e==null?i:m&&e.every===m?e.every(t,r):(T(e,function(e,s,o){if(!(i=i&&t.call(r,e,s,o)))return n}),!!i)};var N=x.some=x.any=function(e,t,r){t||(t=x.identity);var i=!1;return e==null?i:g&&e.some===g?e.some(t,r):(T(e,function(e,s,o){if(i||(i=t.call(r,e,s,o)))return n}),!!i)};x.include=x.contains=function(e,t){var n=!1;return e==null?n:y&&e.indexOf===y?e.indexOf(t)!=-1:(n=N(e,function(e){return e===t}),n)},x.invoke=function(e,t){var n=u.call(arguments,2);return x.map(e,function(e){return(x.isFunction(t)?t||e:e[t]).apply(e,n)})},x.pluck=function(e,t){return x.map(e,function(e){return e[t]})},x.max=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0])return Math.max.apply(Math,e);if(!t&&x.isEmpty(e))return-Infinity;var r={computed:-Infinity};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o>=r.computed&&(r={value:e,computed:o})}),r.value},x.min=function(e,t,n){if(!t&&x.isArray(e)&&e[0]===+e[0])return Math.min.apply(Math,e);if(!t&&x.isEmpty(e))return Infinity;var r={computed:Infinity};return T(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o<r.computed&&(r={value:e,computed:o})}),r.value},x.shuffle=function(e){var t=[],n;return T(e,function(e,r,i){n=Math.floor(Math.random()*(r+1)),t[r]=t[n],t[n]=e}),t},x.sortBy=function(e,t,n){var r=x.isFunction(t)?t:function(e){return e[t]};return x.pluck(x.map(e,function(e,t,i){return{value:e,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;return n===void 0?1:r===void 0?-1:n<r?-1:n>r?1:0}),"value")},x.groupBy=function(e,t){var n={},r=x.isFunction(t)?t:function(e){return e[t]};return T(e,function(e,t){var i=r(e,t);(n[i]||(n[i]=[])).push(e)}),n},x.sortedIndex=function(e,t,n){n||(n=x.identity);var r=n(t),i=0,s=e.length;while(i<s){var o=i+s>>1;n(e[o])<r?i=o+1:s=o}return i},x.toArray=function(e){return e?x.isArray(e)?u.call(e):x.isArguments(e)?u.call(e):e.toArray&&x.isFunction(e.toArray)?e.toArray():x.values(e):[]},x.size=function(e){return x.isArray(e)?e.length:x.keys(e).length},x.first=x.head=x.take=function(e,t,n){return t!=null&&!n?u.call(e,0,t):e[0]},x.initial=function(e,t,n){return u.call(e,0,e.length-(t==null||n?1:t))},x.last=function(e,t,n){return t!=null&&!n?u.call(e,Math.max(e.length-t,0)):e[e.length-1]},x.rest=x.tail=function(e,t,n){return u.call(e,t==null||n?1:t)},x.compact=function(e){return x.filter(e,function(e){return!!e})},x.flatten=function(e,t){return function n(e,r){return T(e,function(e){x.isArray(e)?t?o.apply(r,e):n(e,r):r.push(e)}),r}(e,[])},x.without=function(e){return x.difference(e,u.call(arguments,1))},x.uniq=x.unique=function(e,t,n){var r=n?x.map(e,n):e,i=[];return e.length<3&&(t=!0),x.reduce(r,function(n,r,s){if(t?x.last(n)!==r||!n.length:!x.include(n,r))n.push(r),i.push(e[s]);return n},[]),i},x.union=function(){return x.uniq(x.flatten(arguments,!0))},x.intersection=x.intersect=function(e){var t=u.call(arguments,1);return x.filter(x.uniq(e),function(e){return x.every(t,function(t){return x.indexOf(t,e)>=0})})},x.difference=function(e){var t=x.flatten(u.call(arguments,1),!0);return x.filter(e,function(e){return!x.include(t,e)})},x.zip=function(){var e=u.call(arguments),t=x.max(x.pluck(e,"length")),n=new Array(t);for(var r=0;r<t;r++)n[r]=x.pluck(e,""+r);return n},x.indexOf=function(e,t,n){if(e==null)return-1;var r,i;if(n)return r=x.sortedIndex(e,t),e[r]===t?r:-1;if(y&&e.indexOf===y)return e.indexOf(t);for(r=0,i=e.length;r<i;r++)if(r in e&&e[r]===t)return r;return-1},x.lastIndexOf=function(e,t){if(e==null)return-1;if(b&&e.lastIndexOf===b)return e.lastIndexOf(t);var n=e.length;while(n--)if(n in e&&e[n]===t)return n;return-1},x.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0),n=arguments[2]||1;var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=new Array(r);while(i<r)s[i++]=e,e+=n;return s};var C=function(){};x.bind=function(t,n){var r,i;if(t.bind===S&&S)return S.apply(t,u.call(arguments,1));if(!x.isFunction(t))throw new TypeError;return i=u.call(arguments,2),r=function(){if(this instanceof r){C.prototype=t.prototype;var e=new C,s=t.apply(e,i.concat(u.call(arguments)));return Object(s)===s?s:e}return t.apply(n,i.concat(u.call(arguments)))}},x.bindAll=function(e){var t=u.call(arguments,1);return t.length==0&&(t=x.functions(e)),T(t,function(t){e[t]=x.bind(e[t],e)}),e},x.memoize=function(e,t){var n={};return t||(t=x.identity),function(){var r=t.apply(this,arguments);return x.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},x.delay=function(e,t){var n=u.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},x.defer=function(e){return x.delay.apply(x,[e,1].concat(u.call(arguments,1)))},x.throttle=function(e,t){var n,r,i,s,o,u,a=x.debounce(function(){o=s=!1},t);return function(){n=this,r=arguments;var f=function(){i=null,o&&e.apply(n,r),a()};return i||(i=setTimeout(f,t)),s?o=!0:(s=!0,u=e.apply(n,r)),a(),u}},x.debounce=function(e,t,n){var r;return function(){var i=this,s=arguments,o=function(){r=null,n||e.apply(i,s)},u=n&&!r;clearTimeout(r),r=setTimeout(o,t),u&&e.apply(i,s)}},x.once=function(e){var t=!1,n;return function(){return t?n:(t=!0,n=e.apply(this,arguments))}},x.wrap=function(e,t){return function(){var n=[e].concat(u.call(arguments,0));return t.apply(this,n)}},x.compose=function(){var e=arguments;return function(){var t=arguments;for(var n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},x.after=function(e,t){return e<=0?t():function(){if(--e<1)return t.apply(this,arguments)}},x.keys=E||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)x.has(e,n)&&(t[t.length]=n);return t},x.values=function(e){return x.map(e,x.identity)},x.functions=x.methods=function(e){var t=[];for(var n in e)x.isFunction(e[n])&&t.push(n);return t.sort()},x.extend=function(e){return T(u.call(arguments,1),function(t){for(var n in t)e[n]=t[n]}),e},x.pick=function(e){var t={};return T(x.flatten(u.call(arguments,1)),function(n){n in e&&(t[n]=e[n])}),t},x.defaults=function(e){return T(u.call(arguments,1),function(t){for(var n in t)e[n]==null&&(e[n]=t[n])}),e},x.clone=function(e){return x.isObject(e)?x.isArray(e)?e.slice():x.extend({},e):e},x.tap=function(e,t){return t(e),e},x.isEqual=function(e,t){return k(e,t,[])},x.isEmpty=function(e){if(e==null)return!0;if(x.isArray(e)||x.isString(e))return e.length===0;for(var t in e)if(x.has(e,t))return!1;return!0},x.isElement=function(e){return!!e&&e.nodeType==1},x.isArray=w||function(e){return f.call(e)=="[object Array]"},x.isObject=function(e){return e===Object(e)},x.isArguments=function(e){return f.call(e)=="[object Arguments]"},x.isArguments(arguments)||(x.isArguments=function(e){return!!e&&!!x.has(e,"callee")}),x.isFunction=function(e){return f.call(e)=="[object Function]"},x.isString=function(e){return f.call(e)=="[object String]"},x.isNumber=function(e){return f.call(e)=="[object Number]"},x.isFinite=function(e){return x.isNumber(e)&&isFinite(e)},x.isNaN=function(e){return e!==e},x.isBoolean=function(e){return e===!0||e===!1||f.call(e)=="[object Boolean]"},x.isDate=function(e){return f.call(e)=="[object Date]"},x.isRegExp=function(e){return f.call(e)=="[object RegExp]"},x.isNull=function(e){return e===null},x.isUndefined=function(e){return e===void 0},x.has=function(e,t){return l.call(e,t)},x.noConflict=function(){return e._=t,this},x.identity=function(e){return e},x.times=function(e,t,n){for(var r=0;r<e;r++)t.call(n,r)},x.escape=function(e){return(""+e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},x.result=function(e,t){if(e==null)return null;var n=e[t];return x.isFunction(n)?n.call(e):n},x.mixin=function(e){T(x.functions(e),function(t){j(t,x[t]=e[t])})};var L=0;x.uniqueId=function(e){var t=L++;return e?e+t:t},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var A=/.^/,O={"\\":"\\","'":"'",r:"\r",n:"\n",t:"	",u2028:"\u2028",u2029:"\u2029"};for(var M in O)O[O[M]]=M;var _=/\\|'|\r|\n|\t|\u2028|\u2029/g,D=/\\(\\|'|r|n|t|u2028|u2029)/g,P=function(e){return e.replace(D,function(e,t){return O[t]})};x.template=function(e,t,n){n=x.defaults(n||{},x.templateSettings);var r="__p+='"+e.replace(_,function(e){return"\\"+O[e]}).replace(n.escape||A,function(e,t){return"'+\n((__t=("+P(t)+"))==null?'':_.escape(__t))+\n'"}).replace(n.interpolate||A,function(e,t){return"'+\n((__t=("+P(t)+"))==null?'':__t)+\n'"}).replace(n.evaluate||A,function(e,t){return"';\n"+P(t)+"\n;__p+='"})+"';\n";n.variable||(r="with(obj||{}){\n"+r+"}\n"),r="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'')};\n"+r+"return __p;\n";var i=new Function(n.variable||"obj","_",r);if(t)return i(t,x);var s=function(e){return i.call(this,e,x)};return s.source="function("+(n.variable||"obj")+"){\n"+r+"}",s},x.chain=function(e){return x(e).chain()};var H=function(e){this._wrapped=e};x.prototype=H.prototype;var B=function(e,t){return t?x(e).chain():e},j=function(e,t){H.prototype[e]=function(){var e=u.call(arguments);return a.call(e,this._wrapped),B(t.apply(x,e),this._chain)}};x.mixin(x),T(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];H.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),(e=="shift"||e=="splice")&&n.length===0&&delete n[0],B(n,this._chain)}}),T(["concat","join","slice"],function(e){var t=r[e];H.prototype[e]=function(){return B(t.apply(this._wrapped,arguments),this._chain)}}),H.prototype.chain=function(){return this._chain=!0,this},H.prototype.value=function(){return this._wrapped}}.call(this),define("Underscore",function(e){return function(){return e._}}(this));var THREE=THREE||{REVISION:"50"};self.console===undefined&&(self.console={info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}}),self.Int32Array===undefined&&(self.Int32Array=Array,self.Float32Array=Array),function(){var e=0,t=["ms","moz","webkit","o"];for(var n=0;n<t.length&&!window.requestAnimationFrame;++n)window.requestAnimationFrame=window[t[n]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[n]+"CancelAnimationFrame"]||window[t[n]+"CancelRequestAnimationFrame"];window.requestAnimationFrame===undefined&&(window.requestAnimationFrame=function(t,n){var r=Date.now(),i=Math.max(0,16-(r-e)),s=window.setTimeout(function(){t(r+i)},i);return e=r+i,s}),window.cancelAnimationFrame===undefined&&(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),THREE.FrontSide=0,THREE.BackSide=1,THREE.DoubleSide=2,THREE.NoShading=0,THREE.FlatShading=1,THREE.SmoothShading=2,THREE.NoColors=0,THREE.FaceColors=1,THREE.VertexColors=2,THREE.NoBlending=0,THREE.NormalBlending=1,THREE.AdditiveBlending=2,THREE.SubtractiveBlending=3,THREE.MultiplyBlending=4,THREE.CustomBlending=5,THREE.AddEquation=100,THREE.SubtractEquation=101,THREE.ReverseSubtractEquation=102,THREE.ZeroFactor=200,THREE.OneFactor=201,THREE.SrcColorFactor=202,THREE.OneMinusSrcColorFactor=203,THREE.SrcAlphaFactor=204,THREE.OneMinusSrcAlphaFactor=205,THREE.DstAlphaFactor=206,THREE.OneMinusDstAlphaFactor=207,THREE.DstColorFactor=208,THREE.OneMinusDstColorFactor=209,THREE.SrcAlphaSaturateFactor=210,THREE.MultiplyOperation=0,THREE.MixOperation=1,THREE.UVMapping=function(){},THREE.CubeReflectionMapping=function(){},THREE.CubeRefractionMapping=function(){},THREE.SphericalReflectionMapping=function(){},THREE.SphericalRefractionMapping=function(){},THREE.RepeatWrapping=1e3,THREE.ClampToEdgeWrapping=1001,THREE.MirroredRepeatWrapping=1002,THREE.NearestFilter=1003,THREE.NearestMipMapNearestFilter=1004,THREE.NearestMipMapLinearFilter=1005,THREE.LinearFilter=1006,THREE.LinearMipMapNearestFilter=1007,THREE.LinearMipMapLinearFilter=1008,THREE.UnsignedByteType=1009,THREE.ByteType=1010,THREE.ShortType=1011,THREE.UnsignedShortType=1012,THREE.IntType=1013,THREE.UnsignedIntType=1014,THREE.FloatType=1015,THREE.UnsignedShort4444Type=1016,THREE.UnsignedShort5551Type=1017,THREE.UnsignedShort565Type=1018,THREE.AlphaFormat=1019,THREE.RGBFormat=1020,THREE.RGBAFormat=1021,THREE.LuminanceFormat=1022,THREE.LuminanceAlphaFormat=1023,THREE.Clock=function(e){this.autoStart=e!==undefined?e:!0,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1},THREE.Clock.prototype.start=function(){this.startTime=Date.now(),this.oldTime=this.startTime,this.running=!0},THREE.Clock.prototype.stop=function(){this.getElapsedTime(),this.running=!1},THREE.Clock.prototype.getElapsedTime=function(){return this.elapsedTime+=this.getDelta(),this.elapsedTime},THREE.Clock.prototype.getDelta=function(){var e=0;this.autoStart&&!this.running&&this.start();if(this.running){var t=Date.now();e=.001*(t-this.oldTime),this.oldTime=t,this.elapsedTime+=e}return e},THREE.Color=function(e){return e!==undefined&&this.setHex(e),this},THREE.Color.prototype={constructor:THREE.Color,r:1,g:1,b:1,copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e){return this.r=e.r*e.r,this.g=e.g*e.g,this.b=e.b*e.b,this},copyLinearToGamma:function(e){return this.r=Math.sqrt(e.r),this.g=Math.sqrt(e.g),this.b=Math.sqrt(e.b),this},convertGammaToLinear:function(){var e=this.r,t=this.g,n=this.b;return this.r=e*e,this.g=t*t,this.b=n*n,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},setRGB:function(e,t,n){return this.r=e,this.g=t,this.b=n,this},setHSV:function(e,t,n){var r,i,s,o,u;return n===0?this.r=this.g=this.b=0:(r=Math.floor(e*6),i=e*6-r,s=n*(1-t),o=n*(1-t*i),u=n*(1-t*(1-i)),r===0?(this.r=n,this.g=u,this.b=s):r===1?(this.r=o,this.g=n,this.b=s):r===2?(this.r=s,this.g=n,this.b=u):r===3?(this.r=s,this.g=o,this.b=n):r===4?(this.r=u,this.g=s,this.b=n):r===5&&(this.r=n,this.g=s,this.b=o)),this},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(e&255)/255,this},lerpSelf:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},getHex:function(){return Math.floor(this.r*255)<<16^Math.floor(this.g*255)<<8^Math.floor(this.b*255)},getContextStyle:function(){return"rgb("+Math.floor(this.r*255)+","+Math.floor(this.g*255)+","+Math.floor(this.b*255)+")"},clone:function(){return(new THREE.Color).setRGB(this.r,this.g,this.b)}},THREE.Vector2=function(e,t){this.x=e||0,this.y=t||0},THREE.Vector2.prototype={constructor:THREE.Vector2,set:function(e,t){return this.x=e,this.y=t,this},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addSelf:function(e){return this.x+=e.x,this.y+=e.y,this},sub:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},subSelf:function(e){return this.x-=e.x,this.y-=e.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},divideScalar:function(e){return e?(this.x/=e,this.y/=e):this.set(0,0),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,n=this.y-e.y;return t*t+n*n},setLength:function(e){return this.normalize().multiplyScalar(e)},lerpSelf:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},equals:function(e){return e.x===this.x&&e.y===this.y},isZero:function(){return this.lengthSq()<1e-4},clone:function(){return new THREE.Vector2(this.x,this.y)}},THREE.Vector3=function(e,t,n){this.x=e||0,this.y=t||0,this.z=n||0},THREE.Vector3.prototype={constructor:THREE.Vector3,set:function(e,t,n){return this.x=e,this.y=t,this.z=n,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},addSelf:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},sub:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},subSelf:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},multiply:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},multiplySelf:function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},divideSelf:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return e?(this.x/=e,this.y/=e,this.z/=e):(this.x=0,this.y=0,this.z=0),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.lengthSq())},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){return this.normalize().multiplyScalar(e)},lerpSelf:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},cross:function(e,t){return this.x=e.y*t.z-e.z*t.y,this.y=e.z*t.x-e.x*t.z,this.z=e.x*t.y-e.y*t.x,this},crossSelf:function(e){var t=this.x,n=this.y,r=this.z;return this.x=n*e.z-r*e.y,this.y=r*e.x-t*e.z,this.z=t*e.y-n*e.x,this},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){return(new THREE.Vector3).sub(this,e).lengthSq()},getPositionFromMatrix:function(e){return this.x=e.elements[12],this.y=e.elements[13],this.z=e.elements[14],this},setEulerFromRotationMatrix:function(e,t){function n(e){return Math.min(Math.max(e,-1),1)}var r=e.elements,i=r[0],s=r[4],o=r[8],u=r[1],a=r[5],f=r[9],l=r[2],c=r[6],h=r[10];return t===undefined||t==="XYZ"?(this.y=Math.asin(n(o)),Math.abs(o)<.99999?(this.x=Math.atan2(-f,h),this.z=Math.atan2(-s,i)):(this.x=Math.atan2(u,a),this.z=0)):t==="YXZ"?(this.x=Math.asin(-n(f)),Math.abs(f)<.99999?(this.y=Math.atan2(o,h),this.z=Math.atan2(u,a)):(this.y=Math.atan2(-l,i),this.z=0)):t==="ZXY"?(this.x=Math.asin(n(c)),Math.abs(c)<.99999?(this.y=Math.atan2(-l,h),this.z=Math.atan2(-s,a)):(this.y=0,this.z=Math.atan2(o,i))):t==="ZYX"?(this.y=Math.asin(-n(l)),Math.abs(l)<.99999?(this.x=Math.atan2(c,h),this.z=Math.atan2(u,i)):(this.x=0,this.z=Math.atan2(-s,a))):t==="YZX"?(this.z=Math.asin(n(u)),Math.abs(u)<.99999?(this.x=Math.atan2(-f,a),this.y=Math.atan2(-l,i)):(this.x=0,this.y=Math.atan2(l,h))):t==="XZY"&&(this.z=Math.asin(-n(s)),Math.abs(s)<.99999?(this.x=Math.atan2(c,a),this.y=Math.atan2(o,i)):(this.x=Math.atan2(-o,h),this.y=0)),this},setEulerFromQuaternion:function(e,t){function n(e){return Math.min(Math.max(e,-1),1)}var r=e.x*e.x,i=e.y*e.y,s=e.z*e.z,o=e.w*e.w;return t===undefined||t==="XYZ"?(this.x=Math.atan2(2*(e.x*e.w-e.y*e.z),o-r-i+s),this.y=Math.asin(n(2*(e.x*e.z+e.y*e.w))),this.z=Math.atan2(2*(e.z*e.w-e.x*e.y),o+r-i-s)):t==="YXZ"?(this.x=Math.asin(n(2*(e.x*e.w-e.y*e.z))),this.y=Math.atan2(2*(e.x*e.z+e.y*e.w),o-r-i+s),this.z=Math.atan2(2*(e.x*e.y+e.z*e.w),o-r+i-s)):t==="ZXY"?(this.x=Math.asin(n(2*(e.x*e.w+e.y*e.z))),this.y=Math.atan2(2*(e.y*e.w-e.z*e.x),o-r-i+s),this.z=Math.atan2(2*(e.z*e.w-e.x*e.y),o-r+i-s)):t==="ZYX"?(this.x=Math.atan2(2*(e.x*e.w+e.z*e.y),o-r-i+s),this.y=Math.asin(n(2*(e.y*e.w-e.x*e.z))),this.z=Math.atan2(2*(e.x*e.y+e.z*e.w),o+r-i-s)):t==="YZX"?(this.x=Math.atan2(2*(e.x*e.w-e.z*e.y),o-r+i-s),this.y=Math.atan2(2*(e.y*e.w-e.x*e.z),o+r-i-s),this.z=Math.asin(n(2*(e.x*e.y+e.z*e.w)))):t==="XZY"&&(this.x=Math.atan2(2*(e.x*e.w+e.y*e.z),o-r+i-s),this.y=Math.atan2(2*(e.x*e.z+e.y*e.w),o+r-i-s),this.z=Math.asin(n(2*(e.z*e.w-e.x*e.y)))),this},getScaleFromMatrix:function(e){var t=this.set(e.elements[0],e.elements[1],e.elements[2]).length(),n=this.set(e.elements[4],e.elements[5],e.elements[6]).length(),r=this.set(e.elements[8],e.elements[9],e.elements[10]).length();return this.x=t,this.y=n,this.z=r,this},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},isZero:function(){return this.lengthSq()<1e-4},clone:function(){return new THREE.Vector3(this.x,this.y,this.z)}},THREE.Vector4=function(e,t,n,r){this.x=e||0,this.y=t||0,this.z=n||0,this.w=r!==undefined?r:1},THREE.Vector4.prototype={constructor:THREE.Vector4,set:function(e,t,n,r){return this.x=e,this.y=t,this.z=n,this.w=r,this},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w!==undefined?e.w:1,this},add:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},addSelf:function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},sub:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},subSelf:function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},divideScalar:function(e){return e?(this.x/=e,this.y/=e,this.z/=e,this.w/=e):(this.x=0,this.y=0,this.z=0,this.w=1),this},negate:function(){return this.multiplyScalar(-1)},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.dot(this)},length:function(){return Math.sqrt(this.lengthSq())},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){return this.normalize().multiplyScalar(e)},lerpSelf:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},clone:function(){return new THREE.Vector4(this.x,this.y,this.z,this.w)},setAxisAngleFromQuaternion:function(e){this.w=2*Math.acos(e.w);var t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this},setAxisAngleFromRotationMatrix:function(e){var t,n,r,i,s=.01,o=.1,u=e.elements,a=u[0],f=u[4],l=u[8],c=u[1],h=u[5],p=u[9],d=u[2],v=u[6],m=u[10];if(Math.abs(f-c)<s&&Math.abs(l-d)<s&&Math.abs(p-v)<s){if(Math.abs(f+c)<o&&Math.abs(l+d)<o&&Math.abs(p+v)<o&&Math.abs(a+h+m-3)<o)return this.set(1,0,0,0),this;t=Math.PI;var g=(a+1)/2,y=(h+1)/2,b=(m+1)/2,w=(f+c)/4,E=(l+d)/4,S=(p+v)/4;return g>y&&g>b?g<s?(n=0,r=.707106781,i=.707106781):(n=Math.sqrt(g),r=w/n,i=E/n):y>b?y<s?(n=.707106781,r=0,i=.707106781):(r=Math.sqrt(y),n=w/r,i=S/r):b<s?(n=.707106781,r=.707106781,i=0):(i=Math.sqrt(b),n=E/i,r=S/i),this.set(n,r,i,t),this}var x=Math.sqrt((v-p)*(v-p)+(l-d)*(l-d)+(c-f)*(c-f));return Math.abs(x)<.001&&(x=1),this.x=(v-p)/x,this.y=(l-d)/x,this.z=(c-f)/x,this.w=Math.acos((a+h+m-1)/2),this}},THREE.EventTarget=function(){var e={};this.addEventListener=function(t,n){e[t]===undefined&&(e[t]=[]),e[t].indexOf(n)===-1&&e[t].push(n)},this.dispatchEvent=function(t){for(var n in e[t.type])e[t.type][n](t)},this.removeEventListener=function(t,n){var r=e[t].indexOf(n);r!==-1&&e[t].splice(r,1)}},THREE.Frustum=function(){this.planes=[new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4]},THREE.Frustum.prototype.setFromMatrix=function(e){var t,n=this.planes,r=e.elements,i=r[0],s=r[1],o=r[2],u=r[3],a=r[4],f=r[5],l=r[6],c=r[7],h=r[8],p=r[9],d=r[10],v=r[11],m=r[12],g=r[13],y=r[14],b=r[15];n[0].set(u-i,c-a,v-h,b-m),n[1].set(u+i,c+a,v+h,b+m),n[2].set(u+s,c+f,v+p,b+g),n[3].set(u-s,c-f,v-p,b-g),n[4].set(u-o,c-l,v-d,b-y),n[5].set(u+o,c+l,v+d,b+y);for(var w=0;w<6;w++)t=n[w],t.divideScalar(Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z))},THREE.Frustum.prototype.contains=function(e){var t=0,n=this.planes,r=e.matrixWorld,i=r.elements,s=-e.geometry.boundingSphere.radius*r.getMaxScaleOnAxis();for(var o=0;o<6;o++){t=n[o].x*i[12]+n[o].y*i[13]+n[o].z*i[14]+n[o].w;if(t<=s)return!1}return!0},THREE.Frustum.__v1=new THREE.Vector3,THREE.Ray=function(e,t,n,r){this.origin=e||new THREE.Vector3,this.direction=t||new THREE.Vector3,this.near=n||0,this.far=r||Infinity;var i=new THREE.Vector3,s=new THREE.Vector3,o=new THREE.Vector3,u=new THREE.Vector3,a=new THREE.Vector3,f=new THREE.Vector3,l=new THREE.Vector3,c=new THREE.Vector3,h=new THREE.Vector3,p=function(e,t){return e.distance-t.distance},d=new THREE.Vector3,v=new THREE.Vector3,m=new THREE.Vector3,g,y,b,w=function(e,t,n){return d.sub(n,e),g=d.dot(t),y=v.add(e,m.copy(t).multiplyScalar(g)),b=n.distanceTo(y),b},E,S,x,T,N,C,k,L,A=function(e,t,n,r){return d.sub(r,t),v.sub(n,t),m.sub(e,t),E=d.dot(d),S=d.dot(v),x=d.dot(m),T=v.dot(v),N=v.dot(m),C=1/(E*T-S*S),k=(T*x-S*N)*C,L=(E*N-S*x)*C,k>=0&&L>=0&&k+L<1},O=1e-4;this.setPrecision=function(e){O=e},this.intersectObject=function(e,t){var n,r=[];if(t===!0)for(var d=0,v=e.children.length;d<v;d++)Array.prototype.push.apply(r,this.intersectObject(e.children[d],t));if(e instanceof THREE.Particle){b=w(this.origin,this.direction,e.matrixWorld.getPosition());if(b>e.scale.x)return[];n={distance:b,point:e.position,face:null,object:e},r.push(n)}else if(e instanceof THREE.Mesh){var m=THREE.Frustum.__v1.set(e.matrixWorld.getColumnX().length(),e.matrixWorld.getColumnY().length(),e.matrixWorld.getColumnZ().length()),g=e.geometry.boundingSphere.radius*Math.max(m.x,Math.max(m.y,m.z));b=w(this.origin,this.direction,e.matrixWorld.getPosition());if(b>g)return r;var y,E,S,x,T,N=this.range*this.range,C=e.geometry,k=C.vertices,L,M,_,D,P;M=e.geometry.materials,_=e.material instanceof THREE.MeshFaceMaterial,P=e.material.side,e.matrixRotationWorld.extractRotation(e.matrixWorld);for(y=0,E=C.faces.length;y<E;y++){S=C.faces[y],D=_===!0?M[S.materialIndex]:e.material;if(D===undefined)continue;P=D.side,a.copy(this.origin),f.copy(this.direction),L=e.matrixWorld,l=L.multiplyVector3(l.copy(S.centroid)).subSelf(a),c=e.matrixRotationWorld.multiplyVector3(c.copy(S.normal)),x=f.dot(c);if(Math.abs(x)<O)continue;T=c.dot(l)/x;if(T<0)continue;if(P===THREE.DoubleSide||(P===THREE.FrontSide?x<0:x>0)){h.add(a,f.multiplyScalar(T)),b=a.distanceTo(h);if(b<this.near)continue;if(b>this.far)continue;if(S instanceof THREE.Face3)i=L.multiplyVector3(i.copy(k[S.a])),s=L.multiplyVector3(s.copy(k[S.b])),o=L.multiplyVector3(o.copy(k[S.c])),A(h,i,s,o)&&(n={distance:b,point:h.clone(),face:S,faceIndex:y,object:e},r.push(n));else if(S instanceof THREE.Face4){i=L.multiplyVector3(i.copy(k[S.a])),s=L.multiplyVector3(s.copy(k[S.b])),o=L.multiplyVector3(o.copy(k[S.c])),u=L.multiplyVector3(u.copy(k[S.d]));if(A(h,i,s,u)||A(h,s,o,u))n={distance:b,point:h.clone(),face:S,faceIndex:y,object:e},r.push(n)}}}}return r.sort(p),r},this.intersectObjects=function(e,t){var n=[];for(var r=0,i=e.length;r<i;r++)Array.prototype.push.apply(n,this.intersectObject(e[r],t));return n.sort(p),n}},THREE.Rectangle=function(){function u(){i=n-e,s=r-t}var e=0,t=0,n=0,r=0,i=0,s=0,o=!0;this.getX=function(){return e},this.getY=function(){return t},this.getWidth=function(){return i},this.getHeight=function(){return s},this.getLeft=function(){return e},this.getTop=function(){return t},this.getRight=function(){return n},this.getBottom=function(){return r},this.set=function(i,s,a,f){o=!1,e=i,t=s,n=a,r=f,u()},this.addPoint=function(i,s){o===!0?(o=!1,e=i,t=s,n=i,r=s,u()):(e=e<i?e:i,t=t<s?t:s,n=n>i?n:i,r=r>s?r:s,u())},this.add3Points=function(i,s,a,f,l,c){o===!0?(o=!1,e=i<a?i<l?i:l:a<l?a:l,t=s<f?s<c?s:c:f<c?f:c,n=i>a?i>l?i:l:a>l?a:l,r=s>f?s>c?s:c:f>c?f:c,u()):(e=i<a?i<l?i<e?i:e:l<e?l:e:a<l?a<e?a:e:l<e?l:e,t=s<f?s<c?s<t?s:t:c<t?c:t:f<c?f<t?f:t:c<t?c:t,n=i>a?i>l?i>n?i:n:l>n?l:n:a>l?a>n?a:n:l>n?l:n,r=s>f?s>c?s>r?s:r:c>r?c:r:f>c?f>r?f:r:c>r?c:r,u())},this.addRectangle=function(i){o===!0?(o=!1,e=i.getLeft(),t=i.getTop(),n=i.getRight(),r=i.getBottom(),u()):(e=e<i.getLeft()?e:i.getLeft(),t=t<i.getTop()?t:i.getTop(),n=n>i.getRight()?n:i.getRight(),r=r>i.getBottom()?r:i.getBottom(),u())},this.inflate=function(i){e-=i,t-=i,n+=i,r+=i,u()},this.minSelf=function(i){e=e>i.getLeft()?e:i.getLeft(),t=t>i.getTop()?t:i.getTop(),n=n<i.getRight()?n:i.getRight(),r=r<i.getBottom()?r:i.getBottom(),u()},this.intersects=function(i){return n<i.getLeft()?!1:e>i.getRight()?!1:r<i.getTop()?!1:t>i.getBottom()?!1:!0},this.empty=function(){o=!0,e=0,t=0,n=0,r=0,u()},this.isEmpty=function(){return o}},THREE.Math={clamp:function(e,t,n){return e<t?t:e>n?n:e},clampBottom:function(e,t){return e<t?t:e},mapLinear:function(e,t,n,r,i){return r+(e-t)*(i-r)/(n-t)},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},sign:function(e){return e<0?-1:e>0?1:0}},THREE.Matrix3=function(){this.elements=new Float32Array(9)},THREE.Matrix3.prototype={constructor:THREE.Matrix3,getInverse:function(e){var t=e.elements,n=t[10]*t[5]-t[6]*t[9],r=-t[10]*t[1]+t[2]*t[9],i=t[6]*t[1]-t[2]*t[5],s=-t[10]*t[4]+t[6]*t[8],o=t[10]*t[0]-t[2]*t[8],u=-t[6]*t[0]+t[2]*t[4],a=t[9]*t[4]-t[5]*t[8],f=-t[9]*t[0]+t[1]*t[8],l=t[5]*t[0]-t[1]*t[4],c=t[0]*n+t[1]*s+t[2]*a;c===0&&console.warn("Matrix3.getInverse(): determinant == 0");var h=1/c,p=this.elements;return p[0]=h*n,p[1]=h*r,p[2]=h*i,p[3]=h*s,p[4]=h*o,p[5]=h*u,p[6]=h*a,p[7]=h*f,p[8]=h*l,this},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},transposeIntoArray:function(e){var t=this.m;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}},THREE.Matrix4=function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){this.elements=new Float32Array(16),this.set(e!==undefined?e:1,t||0,n||0,r||0,i||0,s!==undefined?s:1,o||0,u||0,a||0,f||0,l!==undefined?l:1,c||0,h||0,p||0,d||0,v!==undefined?v:1)},THREE.Matrix4.prototype={constructor:THREE.Matrix4,set:function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v){var m=this.elements;return m[0]=e,m[4]=t,m[8]=n,m[12]=r,m[1]=i,m[5]=s,m[9]=o,m[13]=u,m[2]=a,m[6]=f,m[10]=l,m[14]=c,m[3]=h,m[7]=p,m[11]=d,m[15]=v,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},copy:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[12],t[1],t[5],t[9],t[13],t[2],t[6],t[10],t[14],t[3],t[7],t[11],t[15]),this},lookAt:function(e,t,n){var r=this.elements,i=THREE.Matrix4.__v1,s=THREE.Matrix4.__v2,o=THREE.Matrix4.__v3;return o.sub(e,t).normalize(),o.length()===0&&(o.z=1),i.cross(n,o).normalize(),i.length()===0&&(o.x+=1e-4,i.cross(n,o).normalize()),s.cross(o,i),r[0]=i.x,r[4]=s.x,r[8]=o.x,r[1]=i.y,r[5]=s.y,r[9]=o.y,r[2]=i.z,r[6]=s.z,r[10]=o.z,this},multiply:function(e,t){var n=e.elements,r=t.elements,i=this.elements,s=n[0],o=n[4],u=n[8],a=n[12],f=n[1],l=n[5],c=n[9],h=n[13],p=n[2],d=n[6],v=n[10],m=n[14],g=n[3],y=n[7],b=n[11],w=n[15],E=r[0],S=r[4],x=r[8],T=r[12],N=r[1],C=r[5],k=r[9],L=r[13],A=r[2],O=r[6],M=r[10],_=r[14],D=r[3],P=r[7],H=r[11],B=r[15];return i[0]=s*E+o*N+u*A+a*D,i[4]=s*S+o*C+u*O+a*P,i[8]=s*x+o*k+u*M+a*H,i[12]=s*T+o*L+u*_+a*B,i[1]=f*E+l*N+c*A+h*D,i[5]=f*S+l*C+c*O+h*P,i[9]=f*x+l*k+c*M+h*H,i[13]=f*T+l*L+c*_+h*B,i[2]=p*E+d*N+v*A+m*D,i[6]=p*S+d*C+v*O+m*P,i[10]=p*x+d*k+v*M+m*H,i[14]=p*T+d*L+v*_+m*B,i[3]=g*E+y*N+b*A+w*D,i[7]=g*S+y*C+b*O+w*P,i[11]=g*x+y*k+b*M+w*H,i[15]=g*T+y*L+b*_+w*B,this},multiplySelf:function(e){return this.multiply(this,e)},multiplyToArray:function(e,t,n){var r=this.elements;return this.multiply(e,t),n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=r[3],n[4]=r[4],n[5]=r[5],n[6]=r[6],n[7]=r[7],n[8]=r[8],n[9]=r[9],n[10]=r[10],n[11]=r[11],n[12]=r[12],n[13]=r[13],n[14]=r[14],n[15]=r[15],this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},multiplyVector3:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z,s=1/(t[3]*n+t[7]*r+t[11]*i+t[15]);return e.x=(t[0]*n+t[4]*r+t[8]*i+t[12])*s,e.y=(t[1]*n+t[5]*r+t[9]*i+t[13])*s,e.z=(t[2]*n+t[6]*r+t[10]*i+t[14])*s,e},multiplyVector4:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z,s=e.w;return e.x=t[0]*n+t[4]*r+t[8]*i+t[12]*s,e.y=t[1]*n+t[5]*r+t[9]*i+t[13]*s,e.z=t[2]*n+t[6]*r+t[10]*i+t[14]*s,e.w=t[3]*n+t[7]*r+t[11]*i+t[15]*s,e},multiplyVector3Array:function(e){var t=THREE.Matrix4.__v1;for(var n=0,r=e.length;n<r;n+=3)t.x=e[n],t.y=e[n+1],t.z=e[n+2],this.multiplyVector3(t),e[n]=t.x,e[n+1]=t.y,e[n+2]=t.z;return e},rotateAxis:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z;return e.x=n*t[0]+r*t[4]+i*t[8],e.y=n*t[1]+r*t[5]+i*t[9],e.z=n*t[2]+r*t[6]+i*t[10],e.normalize(),e},crossVector:function(e){var t=this.elements,n=new THREE.Vector4;return n.x=t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12]*e.w,n.y=t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13]*e.w,n.z=t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14]*e.w,n.w=e.w?t[3]*e.x+t[7]*e.y+t[11]*e.z+t[15]*e.w:1,n},determinant:function(){var e=this.elements,t=e[0],n=e[4],r=e[8],i=e[12],s=e[1],o=e[5],u=e[9],a=e[13],f=e[2],l=e[6],c=e[10],h=e[14],p=e[3],d=e[7],v=e[11],m=e[15];return i*u*l*p-r*a*l*p-i*o*c*p+n*a*c*p+r*o*h*p-n*u*h*p-i*u*f*d+r*a*f*d+i*s*c*d-t*a*c*d-r*s*h*d+t*u*h*d+i*o*f*v-n*a*f*v-i*s*l*v+t*a*l*v+n*s*h*v-t*o*h*v-r*o*f*m+n*u*f*m+r*s*l*m-t*u*l*m-n*s*c*m+t*o*c*m},transpose:function(){var e=this.elements,t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},flattenToArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},flattenToArrayOffset:function(e,t){var n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],e},getPosition:function(){var e=this.elements;return THREE.Matrix4.__v1.set(e[12],e[13],e[14])},setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getColumnX:function(){var e=this.elements;return THREE.Matrix4.__v1.set(e[0],e[1],e[2])},getColumnY:function(){var e=this.elements;return THREE.Matrix4.__v1.set(e[4],e[5],e[6])},getColumnZ:function(){var e=this.elements;return THREE.Matrix4.__v1.set(e[8],e[9],e[10])},getInverse:function(e){var t=this.elements,n=e.elements,r=n[0],i=n[4],s=n[8],o=n[12],u=n[1],a=n[5],f=n[9],l=n[13],c=n[2],h=n[6],p=n[10],d=n[14],v=n[3],m=n[7],g=n[11],y=n[15];return t[0]=f*d*m-l*p*m+l*h*g-a*d*g-f*h*y+a*p*y,t[4]=o*p*m-s*d*m-o*h*g+i*d*g+s*h*y-i*p*y,t[8]=s*l*m-o*f*m+o*a*g-i*l*g-s*a*y+i*f*y,t[12]=o*f*h-s*l*h-o*a*p+i*l*p+s*a*d-i*f*d,t[1]=l*p*v-f*d*v-l*c*g+u*d*g+f*c*y-u*p*y,t[5]=s*d*v-o*p*v+o*c*g-r*d*g-s*c*y+r*p*y,t[9]=o*f*v-s*l*v-o*u*g+r*l*g+s*u*y-r*f*y,t[13]=s*l*c-o*f*c+o*u*p-r*l*p-s*u*d+r*f*d,t[2]=a*d*v-l*h*v+l*c*m-u*d*m-a*c*y+u*h*y,t[6]=o*h*v-i*d*v-o*c*m+r*d*m+i*c*y-r*h*y,t[10]=i*l*v-o*a*v+o*u*m-r*l*m-i*u*y+r*a*y,t[14]=o*a*c-i*l*c-o*u*h+r*l*h+i*u*d-r*a*d,t[3]=f*h*v-a*p*v-f*c*m+u*p*m+a*c*g-u*h*g,t[7]=i*p*v-s*h*v+s*c*m-r*p*m-i*c*g+r*h*g,t[11]=s*a*v-i*f*v-s*u*m+r*f*m+i*u*g-r*a*g,t[15]=i*f*c-s*a*c+s*u*h-r*f*h-i*u*p+r*a*p,this.multiplyScalar(1/e.determinant()),this},setRotationFromEuler:function(e,t){var n=this.elements,r=e.x,i=e.y,s=e.z,o=Math.cos(r),u=Math.sin(r),a=Math.cos(i),f=Math.sin(i),l=Math.cos(s),c=Math.sin(s);if(t===undefined||t==="XYZ"){var h=o*l,p=o*c,d=u*l,v=u*c;n[0]=a*l,n[4]=-a*c,n[8]=f,n[1]=p+d*f,n[5]=h-v*f,n[9]=-u*a,n[2]=v-h*f,n[6]=d+p*f,n[10]=o*a}else if(t==="YXZ"){var m=a*l,g=a*c,y=f*l,b=f*c;n[0]=m+b*u,n[4]=y*u-g,n[8]=o*f,n[1]=o*c,n[5]=o*l,n[9]=-u,n[2]=g*u-y,n[6]=b+m*u,n[10]=o*a}else if(t==="ZXY"){var m=a*l,g=a*c,y=f*l,b=f*c;n[0]=m-b*u,n[4]=-o*c,n[8]=y+g*u,n[1]=g+y*u,n[5]=o*l,n[9]=b-m*u,n[2]=-o*f,n[6]=u,n[10]=o*a}else if(t==="ZYX"){var h=o*l,p=o*c,d=u*l,v=u*c;n[0]=a*l,n[4]=d*f-p,n[8]=h*f+v,n[1]=a*c,n[5]=v*f+h,n[9]=p*f-d,n[2]=-f,n[6]=u*a,n[10]=o*a}else if(t==="YZX"){var w=o*a,E=o*f,S=u*a,x=u*f;n[0]=a*l,n[4]=x-w*c,n[8]=S*c+E,n[1]=c,n[5]=o*l,n[9]=-u*l,n[2]=-f*l,n[6]=E*c+S,n[10]=w-x*c}else if(t==="XZY"){var w=o*a,E=o*f,S=u*a,x=u*f;n[0]=a*l,n[4]=-c,n[8]=f*l,n[1]=w*c+x,n[5]=o*l,n[9]=E*c-S,n[2]=S*c-E,n[6]=u*l,n[10]=x*c+w}return this},setRotationFromQuaternion:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z,s=e.w,o=n+n,u=r+r,a=i+i,f=n*o,l=n*u,c=n*a,h=r*u,p=r*a,d=i*a,v=s*o,m=s*u,g=s*a;return t[0]=1-(h+d),t[4]=l-g,t[8]=c+m,t[1]=l+g,t[5]=1-(f+d),t[9]=p-v,t[2]=c-m,t[6]=p+v,t[10]=1-(f+h),this},compose:function(e,t,n){var r=this.elements,i=THREE.Matrix4.__m1,s=THREE.Matrix4.__m2;return i.identity(),i.setRotationFromQuaternion(t),s.makeScale(n.x,n.y,n.z),this.multiply(i,s),r[12]=e.x,r[13]=e.y,r[14]=e.z,this},decompose:function(e,t,n){var r=this.elements,i=THREE.Matrix4.__v1,s=THREE.Matrix4.__v2,o=THREE.Matrix4.__v3;i.set(r[0],r[1],r[2]),s.set(r[4],r[5],r[6]),o.set(r[8],r[9],r[10]),e=e instanceof THREE.Vector3?e:new THREE.Vector3,t=t instanceof THREE.Quaternion?t:new THREE.Quaternion,n=n instanceof THREE.Vector3?n:new THREE.Vector3,n.x=i.length(),n.y=s.length(),n.z=o.length(),e.x=r[12],e.y=r[13],e.z=r[14];var u=THREE.Matrix4.__m1;return u.copy(this),u.elements[0]/=n.x,u.elements[1]/=n.x,u.elements[2]/=n.x,u.elements[4]/=n.y,u.elements[5]/=n.y,u.elements[6]/=n.y,u.elements[8]/=n.z,u.elements[9]/=n.z,u.elements[10]/=n.z,t.setFromRotationMatrix(u),[e,t,n]},extractPosition:function(e){var t=this.elements,n=e.elements;return t[12]=n[12],t[13]=n[13],t[14]=n[14],this},extractRotation:function(e){var t=this.elements,n=e.elements,r=THREE.Matrix4.__v1,i=1/r.set(n[0],n[1],n[2]).length(),s=1/r.set(n[4],n[5],n[6]).length(),o=1/r.set(n[8],n[9],n[10]).length();return t[0]=n[0]*i,t[1]=n[1]*i,t[2]=n[2]*i,t[4]=n[4]*s,t[5]=n[5]*s,t[6]=n[6]*s,t[8]=n[8]*o,t[9]=n[9]*o,t[10]=n[10]*o,this},translate:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z;return t[12]=t[0]*n+t[4]*r+t[8]*i+t[12],t[13]=t[1]*n+t[5]*r+t[9]*i+t[13],t[14]=t[2]*n+t[6]*r+t[10]*i+t[14],t[15]=t[3]*n+t[7]*r+t[11]*i+t[15],this},rotateX:function(e){var t=this.elements,n=t[4],r=t[5],i=t[6],s=t[7],o=t[8],u=t[9],a=t[10],f=t[11],l=Math.cos(e),c=Math.sin(e);return t[4]=l*n+c*o,t[5]=l*r+c*u,t[6]=l*i+c*a,t[7]=l*s+c*f,t[8]=l*o-c*n,t[9]=l*u-c*r,t[10]=l*a-c*i,t[11]=l*f-c*s,this},rotateY:function(e){var t=this.elements,n=t[0],r=t[1],i=t[2],s=t[3],o=t[8],u=t[9],a=t[10],f=t[11],l=Math.cos(e),c=Math.sin(e);return t[0]=l*n-c*o,t[1]=l*r-c*u,t[2]=l*i-c*a,t[3]=l*s-c*f,t[8]=l*o+c*n,t[9]=l*u+c*r,t[10]=l*a+c*i,t[11]=l*f+c*s,this},rotateZ:function(e){var t=this.elements,n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],u=t[5],a=t[6],f=t[7],l=Math.cos(e),c=Math.sin(e);return t[0]=l*n+c*o,t[1]=l*r+c*u,t[2]=l*i+c*a,t[3]=l*s+c*f,t[4]=l*o-c*n,t[5]=l*u-c*r,t[6]=l*a-c*i,t[7]=l*f-c*s,this},rotateByAxis:function(e,t){var n=this.elements;if(e.x===1&&e.y===0&&e.z===0)return this.rotateX(t);if(e.x===0&&e.y===1&&e.z===0)return this.rotateY(t);if(e.x===0&&e.y===0&&e.z===1)return this.rotateZ(t);var r=e.x,i=e.y,s=e.z,o=Math.sqrt(r*r+i*i+s*s);r/=o,i/=o,s/=o;var u=r*r,a=i*i,f=s*s,l=Math.cos(t),c=Math.sin(t),h=1-l,p=r*i*h,d=r*s*h,v=i*s*h,m=r*c,g=i*c,y=s*c,b=u+(1-u)*l,w=p+y,E=d-g,S=p-y,x=a+(1-a)*l,T=v+m,N=d+g,C=v-m,k=f+(1-f)*l,L=n[0],A=n[1],O=n[2],M=n[3],_=n[4],D=n[5],P=n[6],H=n[7],B=n[8],j=n[9],F=n[10],I=n[11],q=n[12],R=n[13],U=n[14],z=n[15];return n[0]=b*L+w*_+E*B,n[1]=b*A+w*D+E*j,n[2]=b*O+w*P+E*F,n[3]=b*M+w*H+E*I,n[4]=S*L+x*_+T*B,n[5]=S*A+x*D+T*j,n[6]=S*O+x*P+T*F,n[7]=S*M+x*H+T*I,n[8]=N*L+C*_+k*B,n[9]=N*A+C*D+k*j,n[10]=N*O+C*P+k*F,n[11]=N*M+C*H+k*I,this},scale:function(e){var t=this.elements,n=e.x,r=e.y,i=e.z;return t[0]*=n,t[4]*=r,t[8]*=i,t[1]*=n,t[5]*=r,t[9]*=i,t[2]*=n,t[6]*=r,t[10]*=i,t[3]*=n,t[7]*=r,t[11]*=i,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],r=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,Math.max(n,r)))},makeTranslation:function(e,t,n){return this.set(1,0,0,e,0,1,0,t,0,0,1,n,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,t,-n,0,0,n,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(t,0,n,0,0,1,0,0,-n,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,0,n,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var n=Math.cos(t),r=Math.sin(t),i=1-n,s=e.x,o=e.y,u=e.z,a=i*s,f=i*o;return this.set(a*s+n,a*o-r*u,a*u+r*o,0,a*o+r*u,f*o+n,f*u-r*s,0,a*u-r*o,f*u+r*s,i*u*u+n,0,0,0,0,1),this},makeScale:function(e,t,n){return this.set(e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1),this},makeFrustum:function(e,t,n,r,i,s){var o=this.elements,u=2*i/(t-e),a=2*i/(r-n),f=(t+e)/(t-e),l=(r+n)/(r-n),c=-(s+i)/(s-i),h=-2*s*i/(s-i);return o[0]=u,o[4]=0,o[8]=f,o[12]=0,o[1]=0,o[5]=a,o[9]=l,o[13]=0,o[2]=0,o[6]=0,o[10]=c,o[14]=h,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this},makePerspective:function(e,t,n,r){var i=n*Math.tan(e*Math.PI/360),s=-i,o=s*t,u=i*t;return this.makeFrustum(o,u,s,i,n,r)},makeOrthographic:function(e,t,n,r,i,s){var o=this.elements,u=t-e,a=n-r,f=s-i,l=(t+e)/u,c=(n+r)/a,h=(s+i)/f;return o[0]=2/u,o[4]=0,o[8]=0,o[12]=-l,o[1]=0,o[5]=2/a,o[9]=0,o[13]=-c,o[2]=0,o[6]=0,o[10]=-2/f,o[14]=-h,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this},clone:function(){var e=this.elements;return new THREE.Matrix4(e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15])}},THREE.Matrix4.__v1=new THREE.Vector3,THREE.Matrix4.__v2=new THREE.Vector3,THREE.Matrix4.__v3=new THREE.Vector3,THREE.Matrix4.__m1=new THREE.Matrix4,THREE.Matrix4.__m2=new THREE.Matrix4,THREE.Object3D=function(){this.id=THREE.Object3DCount++,this.name="",this.properties={},this.parent=undefined,this.children=[],this.up=new THREE.Vector3(0,1,0),this.position=new THREE.Vector3,this.rotation=new THREE.Vector3,this.eulerOrder="XYZ",this.scale=new THREE.Vector3(1,1,1),this.renderDepth=null,this.rotationAutoUpdate=!0,this.matrix=new THREE.Matrix4,this.matrixWorld=new THREE.Matrix4,this.matrixRotationWorld=new THREE.Matrix4,this.matrixAutoUpdate=!0,this.matrixWorldNeedsUpdate=!0,this.quaternion=new THREE.Quaternion,this.useQuaternion=!1,this.boundRadius=0,this.boundRadiusScale=1,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this._vector=new THREE.Vector3},THREE.Object3D.prototype={constructor:THREE.Object3D,applyMatrix:function(e){this.matrix.multiply(e,this.matrix),this.scale.getScaleFromMatrix(this.matrix);var t=(new THREE.Matrix4).extractRotation(this.matrix);this.rotation.setEulerFromRotationMatrix(t,this.eulerOrder),this.position.getPositionFromMatrix(this.matrix)},translate:function(e,t){this.matrix.rotateAxis(t),this.position.addSelf(t.multiplyScalar(e))},translateX:function(e){this.translate(e,this._vector.set(1,0,0))},translateY:function(e){this.translate(e,this._vector.set(0,1,0))},translateZ:function(e){this.translate(e,this._vector.set(0,0,1))},lookAt:function(e){this.matrix.lookAt(e,this.position,this.up),this.rotationAutoUpdate&&this.rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder)},add:function(e){if(e===this){console.warn("THREE.Object3D.add: An object can't be added as a child of itself.");return}if(e instanceof THREE.Object3D){e.parent!==undefined&&e.parent.remove(e),e.parent=this,this.children.push(e);var t=this;while(t.parent!==undefined)t=t.parent;t!==undefined&&t instanceof THREE.Scene&&t.__addObject(e)}},remove:function(e){var t=this.children.indexOf(e);if(t!==-1){e.parent=undefined,this.children.splice(t,1);var n=this;while(n.parent!==undefined)n=n.parent;n!==undefined&&n instanceof THREE.Scene&&n.__removeObject(e)}},getChildByName:function(e,t){var n,r,i;for(n=0,r=this.children.length;n<r;n++){i=this.children[n];if(i.name===e)return i;if(t){i=i.getChildByName(e,t);if(i!==undefined)return i}}return undefined},updateMatrix:function(){this.matrix.setPosition(this.position),this.useQuaternion===!0?this.matrix.setRotationFromQuaternion(this.quaternion):this.matrix.setRotationFromEuler(this.rotation,this.eulerOrder);if(this.scale.x!==1||this.scale.y!==1||this.scale.z!==1)this.matrix.scale(this.scale),this.boundRadiusScale=Math.max(this.scale.x,Math.max(this.scale.y,this.scale.z));this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate===!0&&this.updateMatrix();if(this.matrixWorldNeedsUpdate===!0||e===!0)this.parent!==undefined?this.matrixWorld.multiply(this.parent.matrixWorld,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0;for(var t=0,n=this.children.length;t<n;t++)this.children[t].updateMatrixWorld(e)},worldToLocal:function(e){return THREE.Object3D.__m1.getInverse(this.matrixWorld).multiplyVector3(e)},localToWorld:function(e){return this.matrixWorld.multiplyVector3(e)},clone:function(){}},THREE.Object3D.__m1=new THREE.Matrix4,THREE.Object3DCount=0,THREE.Projector=function(){function C(n,r){t=0,g.objects.length=0,g.sprites.length=0,g.lights.length=0;var i=function(t){if(t.visible===!1)return;!(t instanceof THREE.Mesh||t instanceof THREE.Line)||t.frustumCulled!==!1&&S.contains(t)!==!0?t instanceof THREE.Sprite||t instanceof THREE.Particle?(y.copy(t.matrixWorld.getPosition()),w.multiplyVector3(y),e=k(),e.object=t,e.z=y.z,g.sprites.push(e)):t instanceof THREE.Light&&g.lights.push(t):(y.copy(t.matrixWorld.getPosition()),w.multiplyVector3(y),e=k(),e.object=t,e.z=y.z,g.objects.push(e));for(var n=0,r=t.children.length;n<r;n++)i(t.children[n])};return i(n),r===!0&&g.objects.sort(D),g}function k(){var e;return t===n.length?(e=new THREE.RenderableObject,n.push(e)):e=n[t],t++,e}function L(){var e;return i===s.length?(e=new THREE.RenderableVertex,s.push(e)):e=s[i],i++,e}function A(){var e;return u===a.length?(e=new THREE.RenderableFace3,a.push(e)):e=a[u],u++,e}function O(){var e;return f===l.length?(e=new THREE.RenderableFace4,l.push(e)):e=l[f],f++,e}function M(){var e;return h===p.length?(e=new THREE.RenderableLine,p.push(e)):e=p[h],h++,e}function _(){var e;return v===m.length?(e=new THREE.RenderableParticle,m.push(e)):e=m[v],v++,e}function D(e,t){return t.z-e.z}function P(e,t){var n=0,r=1,i=e.z+e.w,s=t.z+t.w,o=-e.z+e.w,u=-t.z+t.w;return i>=0&&s>=0&&o>=0&&u>=0?!0:i<0&&s<0||o<0&&u<0?!1:(i<0?n=Math.max(n,i/(i-s)):s<0&&(r=Math.min(r,i/(i-s))),o<0?n=Math.max(n,o/(o-u)):u<0&&(r=Math.min(r,o/(o-u))),r<n?!1:(e.lerpSelf(t,n),t.lerpSelf(e,1-r),!0))}var e,t,n=[],r,i,s=[],o,u,a=[],f,l=[],c,h,p=[],d,v,m=[],g={objects:[],sprites:[],lights:[],elements:[]},y=new THREE.Vector3,b=new THREE.Vector4,w=new THREE.Matrix4,E=new THREE.Matrix4,S=new THREE.Frustum,x=new THREE.Vector4,T=new THREE.Vector4,N;this.projectVector=function(e,t){return t.matrixWorldInverse.getInverse(t.matrixWorld),w.multiply(t.projectionMatrix,t.matrixWorldInverse),w.multiplyVector3(e),e},this.unprojectVector=function(e,t){return t.projectionMatrixInverse.getInverse(t.projectionMatrix),w.multiply(t.matrixWorld,t.projectionMatrixInverse),w.multiplyVector3(e),e},this.pickingRay=function(e,t){var n,r,i;return e.z=-1,n=new THREE.Vector3(e.x,e.y,1),this.unprojectVector(e,t),this.unprojectVector(n,t),n.subSelf(e).normalize(),new THREE.Ray(e,n)},this.projectScene=function(e,t,n){var a=t.near,l=t.far,p=!1,m,y,N,k,H,B,j,F,I,q,R,U,z,W,X,V,$,J,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot,ut,at,ft;u=0,f=0,h=0,v=0,g.elements.length=0,e.updateMatrixWorld(),t.parent===undefined&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),w.multiply(t.projectionMatrix,t.matrixWorldInverse),S.setFromMatrix(w),g=C(e,!1);for(m=0,y=g.objects.length;m<y;m++){z=g.objects[m].object,W=z.matrixWorld,i=0;if(z instanceof THREE.Mesh){V=z.geometry,$=z.geometry.materials,J=V.vertices,G=V.faces,tt=V.faceVertexUvs,X=z.matrixRotationWorld.extractRotation(W),ut=z.material instanceof THREE.MeshFaceMaterial,ft=z.material.side;for(N=0,k=J.length;N<k;N++)r=L(),r.positionWorld.copy(J[N]),W.multiplyVector3(r.positionWorld),r.positionScreen.copy(r.positionWorld),w.multiplyVector4(r.positionScreen),r.positionScreen.x/=r.positionScreen.w,r.positionScreen.y/=r.positionScreen.w,r.visible=r.positionScreen.z>a&&r.positionScreen.z<l;for(H=0,B=G.length;H<B;H++){Y=G[H],at=ut===!0?$[Y.materialIndex]:z.material;if(at===undefined)continue;ft=at.side;if(Y instanceof THREE.Face3){rt=s[Y.a],it=s[Y.b],st=s[Y.c];if(rt.visible!==!0||it.visible!==!0||st.visible!==!0)continue;p=(st.positionScreen.x-rt.positionScreen.x)*(it.positionScreen.y-rt.positionScreen.y)-(st.positionScreen.y-rt.positionScreen.y)*(it.positionScreen.x-rt.positionScreen.x)<0;if(ft!==THREE.DoubleSide&&p!==(ft===THREE.FrontSide))continue;o=A(),o.v1.copy(rt),o.v2.copy(it),o.v3.copy(st)}else if(Y instanceof THREE.Face4){rt=s[Y.a],it=s[Y.b],st=s[Y.c],ot=s[Y.d];if(rt.visible!==!0||it.visible!==!0||st.visible!==!0||ot.visible!==!0)continue;p=(ot.positionScreen.x-rt.positionScreen.x)*(it.positionScreen.y-rt.positionScreen.y)-(ot.positionScreen.y-rt.positionScreen.y)*(it.positionScreen.x-rt.positionScreen.x)<0||(it.positionScreen.x-st.positionScreen.x)*(ot.positionScreen.y-st.positionScreen.y)-(it.positionScreen.y-st.positionScreen.y)*(ot.positionScreen.x-st.positionScreen.x)<0;if(ft!==THREE.DoubleSide&&p!==(ft===THREE.FrontSide))continue;o=O(),o.v1.copy(rt),o.v2.copy(it),o.v3.copy(st),o.v4.copy(ot)}o.normalWorld.copy(Y.normal),p===!1&&(ft===THREE.BackSide||ft===THREE.DoubleSide)&&o.normalWorld.negate(),X.multiplyVector3(o.normalWorld),o.centroidWorld.copy(Y.centroid),W.multiplyVector3(o.centroidWorld),o.centroidScreen.copy(o.centroidWorld),w.multiplyVector3(o.centroidScreen),Z=Y.vertexNormals;for(j=0,F=Z.length;j<F;j++)et=o.vertexNormalsWorld[j],et.copy(Z[j]),p===!1&&(ft===THREE.BackSide||ft===THREE.DoubleSide)&&et.negate(),X.multiplyVector3(et);for(I=0,q=tt.length;I<q;I++){nt=tt[I][H];if(nt===undefined)continue;for(R=0,U=nt.length;R<U;R++)o.uvs[I][R]=nt[R]}o.material=at,o.z=o.centroidScreen.z,g.elements.push(o)}}else if(z instanceof THREE.Line){E.multiply(w,W),J=z.geometry.vertices,rt=L(),rt.positionScreen.copy(J[0]),E.multiplyVector4(rt.positionScreen);var lt=z.type===THREE.LinePieces?2:1;for(N=1,k=J.length;N<k;N++){rt=L(),rt.positionScreen.copy(J[N]),E.multiplyVector4(rt.positionScreen);if((N+1)%lt>0)continue;it=s[i-2],x.copy(rt.positionScreen),T.copy(it.positionScreen),P(x,T)===!0&&(x.multiplyScalar(1/x.w),T.multiplyScalar(1/T.w),c=M(),c.v1.positionScreen.copy(x),c.v2.positionScreen.copy(T),c.z=Math.max(x.z,T.z),c.material=z.material,g.elements.push(c))}}}for(m=0,y=g.sprites.length;m<y;m++)z=g.sprites[m].object,W=z.matrixWorld,z instanceof THREE.Particle&&(b.set(W.elements[12],W.elements[13],W.elements[14],1),w.multiplyVector4(b),b.z/=b.w,b.z>0&&b.z<1&&(d=_(),d.object=z,d.x=b.x/b.w,d.y=b.y/b.w,d.z=b.z,d.rotation=z.rotation.z,d.scale.x=z.scale.x*Math.abs(d.x-(b.x+t.projectionMatrix.elements[0])/(b.w+t.projectionMatrix.elements[12])),d.scale.y=z.scale.y*Math.abs(d.y-(b.y+t.projectionMatrix.elements[5])/(b.w+t.projectionMatrix.elements[13])),d.material=z.material,g.elements.push(d)));return n&&g.elements.sort(D),g}},THREE.Quaternion=function(e,t,n,r){this.x=e||0,this.y=t||0,this.z=n||0,this.w=r!==undefined?r:1},THREE.Quaternion.prototype={constructor:THREE.Quaternion,set:function(e,t,n,r){return this.x=e,this.y=t,this.z=n,this.w=r,this},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},setFromEuler:function(e,t){var n=Math.cos(e.x/2),r=Math.cos(e.y/2),i=Math.cos(e.z/2),s=Math.sin(e.x/2),o=Math.sin(e.y/2),u=Math.sin(e.z/2);return t===undefined||t==="XYZ"?(this.x=s*r*i+n*o*u,this.y=n*o*i-s*r*u,this.z=n*r*u+s*o*i,this.w=n*r*i-s*o*u):t==="YXZ"?(this.x=s*r*i+n*o*u,this.y=n*o*i-s*r*u,this.z=n*r*u-s*o*i,this.w=n*r*i+s*o*u):t==="ZXY"?(this.x=s*r*i-n*o*u,this.y=n*o*i+s*r*u,this.z=n*r*u+s*o*i,this.w=n*r*i-s*o*u):t==="ZYX"?(this.x=s*r*i-n*o*u,this.y=n*o*i+s*r*u,this.z=n*r*u-s*o*i,this.w=n*r*i+s*o*u):t==="YZX"?(this.x=s*r*i+n*o*u,this.y=n*o*i+s*r*u,this.z=n*r*u-s*o*i,this.w=n*r*i-s*o*u):t==="XZY"&&(this.x=s*r*i-n*o*u,this.y=n*o*i-s*r*u,this.z=n*r*u+s*o*i,this.w=n*r*i+s*o*u),this},setFromAxisAngle:function(e,t){var n=t/2,r=Math.sin(n);return this.x=e.x*r,this.y=e.y*r,this.z=e.z*r,this.w=Math.cos(n),this},setFromRotationMatrix:function(e){var t=e.elements,n=t[0],r=t[4],i=t[8],s=t[1],o=t[5],u=t[9],a=t[2],f=t[6],l=t[10],c=n+o+l,h;return c>0?(h=.5/Math.sqrt(c+1),this.w=.25/h,this.x=(f-u)*h,this.y=(i-a)*h,this.z=(s-r)*h):n>o&&n>l?(h=2*Math.sqrt(1+n-o-l),this.w=(f-u)/h,this.x=.25*h,this.y=(r+s)/h,this.z=(i+a)/h):o>l?(h=2*Math.sqrt(1+o-n-l),this.w=(i-a)/h,this.x=(r+s)/h,this.y=.25*h,this.z=(u+f)/h):(h=2*Math.sqrt(1+l-n-o),this.w=(s-r)/h,this.x=(i+a)/h,this.y=(u+f)/h,this.z=.25*h),this},calculateW:function(){return this.w=-Math.sqrt(Math.abs(1-this.x*this.x-this.y*this.y-this.z*this.z)),this},inverse:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},normalize:function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return e===0?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x=this.x*e,this.y=this.y*e,this.z=this.z*e,this.w=this.w*e),this},multiply:function(e,t){var n=e.x,r=e.y,i=e.z,s=e.w,o=t.x,u=t.y,a=t.z,f=t.w;return this.x=n*f+r*a-i*u+s*o,this.y=-n*a+r*f+i*o+s*u,this.z=n*u-r*o+i*f+s*a,this.w=-n*o-r*u-i*a+s*f,this},multiplySelf:function(e){var t=this.x,n=this.y,r=this.z,i=this.w,s=e.x,o=e.y,u=e.z,a=e.w;return this.x=t*a+i*s+n*u-r*o,this.y=n*a+i*o+r*s-t*u,this.z=r*a+i*u+t*o-n*s,this.w=i*a-t*s-n*o-r*u,this},multiplyVector3:function(e,t){t||(t=e);var n=e.x,r=e.y,i=e.z,s=this.x,o=this.y,u=this.z,a=this.w,f=a*n+o*i-u*r,l=a*r+u*n-s*i,c=a*i+s*r-o*n,h=-s*n-o*r-u*i;return t.x=f*a+h*-s+l*-u-c*-o,t.y=l*a+h*-o+c*-s-f*-u,t.z=c*a+h*-u+f*-o-l*-s,t},slerpSelf:function(e,t){var n=this.x,r=this.y,i=this.z,s=this.w,o=s*e.w+n*e.x+r*e.y+i*e.z;o<0?(this.w=-e.w,this.x=-e.x,this.y=-e.y,this.z=-e.z,o=-o):this.copy(e);if(o>=1)return this.w=s,this.x=n,this.y=r,this.z=i,this;var u=Math.acos(o),a=Math.sqrt(1-o*o);if(Math.abs(a)<.001)return this.w=.5*(s+this.w),this.x=.5*(n+this.x),this.y=.5*(r+this.y),this.z=.5*(i+this.z),this;var f=Math.sin((1-t)*u)/a,l=Math.sin(t*u)/a;return this.w=s*f+this.w*l,this.x=n*f+this.x*l,this.y=r*f+this.y*l,this.z=i*f+this.z*l,this},clone:function(){return new THREE.Quaternion(this.x,this.y,this.z,this.w)}},THREE.Quaternion.slerp=function(e,t,n,r){var i=e.w*t.w+e.x*t.x+e.y*t.y+e.z*t.z;i<0?(n.w=-t.w,n.x=-t.x,n.y=-t.y,n.z=-t.z,i=-i):n.copy(t);if(Math.abs(i)>=1)return n.w=e.w,n.x=e.x,n.y=e.y,n.z=e.z,n;var s=Math.acos(i),o=Math.sqrt(1-i*i);if(Math.abs(o)<.001)return n.w=.5*(e.w+n.w),n.x=.5*(e.x+n.x),n.y=.5*(e.y+n.y),n.z=.5*(e.z+n.z),n;var u=Math.sin((1-r)*s)/o,a=Math.sin(r*s)/o;return n.w=e.w*u+n.w*a,n.x=e.x*u+n.x*a,n.y=e.y*u+n.y*a,n.z=e.z*u+n.z*a,n},THREE.Vertex=function(e){return console.warn("THREE.Vertex has been DEPRECATED. Use THREE.Vector3 instead."),e},THREE.Face3=function(e,t,n,r,i,s){this.a=e,this.b=t,this.c=n,this.normal=r instanceof THREE.Vector3?r:new THREE.Vector3,this.vertexNormals=r instanceof Array?r:[],this.color=i instanceof THREE.Color?i:new THREE.Color,this.vertexColors=i instanceof Array?i:[],this.vertexTangents=[],this.materialIndex=s,this.centroid=new THREE.Vector3},THREE.Face3.prototype={constructor:THREE.Face3,clone:function(){var e=new THREE.Face3(this.a,this.b,this.c);e.normal.copy(this.normal),e.color.copy(this.color),e.centroid.copy(this.centroid),e.materialIndex=this.materialIndex;var t,n;for(t=0,n=this.vertexNormals.length;t<n;t++)e.vertexNormals[t]=this.vertexNormals[t].clone();for(t=0,n=this.vertexColors.length;t<n;t++)e.vertexColors[t]=this.vertexColors[t].clone();for(t=0,n=this.vertexTangents.length;t<n;t++)e.vertexTangents[t]=this.vertexTangents[t].clone();return e}},THREE.Face4=function(e,t,n,r,i,s,o){this.a=e,this.b=t,this.c=n,this.d=r,this.normal=i instanceof THREE.Vector3?i:new THREE.Vector3,this.vertexNormals=i instanceof Array?i:[],this.color=s instanceof THREE.Color?s:new THREE.Color,this.vertexColors=s instanceof Array?s:[],this.vertexTangents=[],this.materialIndex=o,this.centroid=new THREE.Vector3},THREE.Face4.prototype={constructor:THREE.Face4,clone:function(){var e=new THREE.Face4(this.a,this.b,this.c,this.d);e.normal.copy(this.normal),e.color.copy(this.color),e.centroid.copy(this.centroid),e.materialIndex=this.materialIndex;var t,n;for(t=0,n=this.vertexNormals.length;t<n;t++)e.vertexNormals[t]=this.vertexNormals[t].clone();for(t=0,n=this.vertexColors.length;t<n;t++)e.vertexColors[t]=this.vertexColors[t].clone();for(t=0,n=this.vertexTangents.length;t<n;t++)e.vertexTangents[t]=this.vertexTangents[t].clone();return e}},THREE.UV=function(e,t){this.u=e||0,this.v=t||0},THREE.UV.prototype={constructor:THREE.UV,set:function(e,t){return this.u=e,this.v=t,this},copy:function(e){return this.u=e.u,this.v=e.v,this},lerpSelf:function(e,t){return this.u+=(e.u-this.u)*t,this.v+=(e.v-this.v)*t,this},clone:function(){return new THREE.UV(this.u,this.v)}},THREE.Geometry=function(){this.id=THREE.GeometryCount++,this.name="",this.vertices=[],this.colors=[],this.materials=[],this.faces=[],this.faceUvs=[[]],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphColors=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.hasTangents=!1,this.dynamic=!0},THREE.Geometry.prototype={constructor:THREE.Geometry,applyMatrix:function(e){var t=new THREE.Matrix4;t.extractRotation(e);for(var n=0,r=this.vertices.length;n<r;n++){var i=this.vertices[n];e.multiplyVector3(i)}for(var n=0,r=this.faces.length;n<r;n++){var s=this.faces[n];t.multiplyVector3(s.normal);for(var o=0,u=s.vertexNormals.length;o<u;o++)t.multiplyVector3(s.vertexNormals[o]);e.multiplyVector3(s.centroid)}},computeCentroids:function(){var e,t,n;for(e=0,t=this.faces.length;e<t;e++)n=this.faces[e],n.centroid.set(0,0,0),n instanceof THREE.Face3?(n.centroid.addSelf(this.vertices[n.a]),n.centroid.addSelf(this.vertices[n.b]),n.centroid.addSelf(this.vertices[n.c]),n.centroid.divideScalar(3)):n instanceof THREE.Face4&&(n.centroid.addSelf(this.vertices[n.a]),n.centroid.addSelf(this.vertices[n.b]),n.centroid.addSelf(this.vertices[n.c]),n.centroid.addSelf(this.vertices[n.d]),n.centroid.divideScalar(4))},computeFaceNormals:function(){var e,t,n,r,i,s,o,u,a,f,l,c=new THREE.Vector3,h=new THREE.Vector3;for(s=0,o=this.faces.length;s<o;s++)u=this.faces[s],a=this.vertices[u.a],f=this.vertices[u.b],l=this.vertices[u.c],c.sub(l,f),h.sub(a,f),c.crossSelf(h),c.isZero()||c.normalize(),u.normal.copy(c)},computeVertexNormals:function(){var e,t,n,r,i,s;if(this.__tmpVertices===undefined){this.__tmpVertices=new Array(this.vertices.length),s=this.__tmpVertices;for(e=0,t=this.vertices.length;e<t;e++)s[e]=new THREE.Vector3;for(n=0,r=this.faces.length;n<r;n++)i=this.faces[n],i instanceof THREE.Face3?i.vertexNormals=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3]:i instanceof THREE.Face4&&(i.vertexNormals=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3])}else{s=this.__tmpVertices;for(e=0,t=this.vertices.length;e<t;e++)s[e].set(0,0,0)}for(n=0,r=this.faces.length;n<r;n++)i=this.faces[n],i instanceof THREE.Face3?(s[i.a].addSelf(i.normal),s[i.b].addSelf(i.normal),s[i.c].addSelf(i.normal)):i instanceof THREE.Face4&&(s[i.a].addSelf(i.normal),s[i.b].addSelf(i.normal),s[i.c].addSelf(i.normal),s[i.d].addSelf(i.normal));for(e=0,t=this.vertices.length;e<t;e++)s[e].normalize();for(n=0,r=this.faces.length;n<r;n++)i=this.faces[n],i instanceof THREE.Face3?(i.vertexNormals[0].copy(s[i.a]),i.vertexNormals[1].copy(s[i.b]),i.vertexNormals[2].copy(s[i.c])):i instanceof THREE.Face4&&(i.vertexNormals[0].copy(s[i.a]),i.vertexNormals[1].copy(s[i.b]),i.vertexNormals[2].copy(s[i.c]),i.vertexNormals[3].copy(s[i.d]))},computeMorphNormals:function(){var e,t,n,r,i;for(n=0,r=this.faces.length;n<r;n++){i=this.faces[n],i.__originalFaceNormal?i.__originalFaceNormal.copy(i.normal):i.__originalFaceNormal=i.normal.clone(),i.__originalVertexNormals||(i.__originalVertexNormals=[]);for(e=0,t=i.vertexNormals.length;e<t;e++)i.__originalVertexNormals[e]?i.__originalVertexNormals[e].copy(i.vertexNormals[e]):i.__originalVertexNormals[e]=i.vertexNormals[e].clone()}var s=new THREE.Geometry;s.faces=this.faces;for(e=0,t=this.morphTargets.length;e<t;e++){if(!this.morphNormals[e]){this.morphNormals[e]={},this.morphNormals[e].faceNormals=[],this.morphNormals[e].vertexNormals=[];var o=this.morphNormals[e].faceNormals,u=this.morphNormals[e].vertexNormals,a,f;for(n=0,r=this.faces.length;n<r;n++)i=this.faces[n],a=new THREE.Vector3,i instanceof THREE.Face3?f={a:new THREE.Vector3,b:new THREE.Vector3,c:new THREE.Vector3}:f={a:new THREE.Vector3,b:new THREE.Vector3,c:new THREE.Vector3,d:new THREE.Vector3},o.push(a),u.push(f)}var l=this.morphNormals[e];s.vertices=this.morphTargets[e].vertices,s.computeFaceNormals(),s.computeVertexNormals();var a,f;for(n=0,r=this.faces.length;n<r;n++)i=this.faces[n],a=l.faceNormals[n],f=l.vertexNormals[n],a.copy(i.normal),i instanceof THREE.Face3?(f.a.copy(i.vertexNormals[0]),f.b.copy(i.vertexNormals[1]),f.c.copy(i.vertexNormals[2])):(f.a.copy(i.vertexNormals[0]),f.b.copy(i.vertexNormals[1]),f.c.copy(i.vertexNormals[2]),f.d.copy(i.vertexNormals[3]))}for(n=0,r=this.faces.length;n<r;n++)i=this.faces[n],i.normal=i.__originalFaceNormal,i.vertexNormals=i.__originalVertexNormals},computeTangents:function(){function B(e,t,n,r,i,s,o){f=e.vertices[t],l=e.vertices[n],c=e.vertices[r],h=a[i],p=a[s],d=a[o],v=l.x-f.x,m=c.x-f.x,g=l.y-f.y,y=c.y-f.y,b=l.z-f.z,w=c.z-f.z,E=p.u-h.u,S=d.u-h.u,x=p.v-h.v,T=d.v-h.v,N=1/(E*T-S*x),O.set((T*v-x*m)*N,(T*g-x*y)*N,(T*b-x*w)*N),M.set((E*m-S*v)*N,(E*y-S*g)*N,(E*w-S*b)*N),L[t].addSelf(O),L[n].addSelf(O),L[r].addSelf(O),A[t].addSelf(M),A[n].addSelf(M),A[r].addSelf(M)}var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L=[],A=[],O=new THREE.Vector3,M=new THREE.Vector3,_=new THREE.Vector3,D=new THREE.Vector3,P=new THREE.Vector3,H;for(n=0,r=this.vertices.length;n<r;n++)L[n]=new THREE.Vector3,A[n]=new THREE.Vector3;for(e=0,t=this.faces.length;e<t;e++)u=this.faces[e],a=this.faceVertexUvs[0][e],u instanceof THREE.Face3?B(this,u.a,u.b,u.c,0,1,2):u instanceof THREE.Face4&&(B(this,u.a,u.b,u.d,0,1,3),B(this,u.b,u.c,u.d,1,2,3));var j=["a","b","c","d"];for(e=0,t=this.faces.length;e<t;e++){u=this.faces[e];for(i=0;i<u.vertexNormals.length;i++)P.copy(u.vertexNormals[i]),o=u[j[i]],C=L[o],_.copy(C),_.subSelf(P.multiplyScalar(P.dot(C))).normalize(),D.cross(u.vertexNormals[i],C),k=D.dot(A[o]),H=k<0?-1:1,u.vertexTangents[i]=new THREE.Vector4(_.x,_.y,_.z,H)}this.hasTangents=!0},computeBoundingBox:function(){this.boundingBox||(this.boundingBox={min:new THREE.Vector3,max:new THREE.Vector3});if(this.vertices.length>0){var e,t=this.vertices[0];this.boundingBox.min.copy(t),this.boundingBox.max.copy(t);var n=this.boundingBox.min,r=this.boundingBox.max;for(var i=1,s=this.vertices.length;i<s;i++)e=this.vertices[i],e.x<n.x?n.x=e.x:e.x>r.x&&(r.x=e.x),e.y<n.y?n.y=e.y:e.y>r.y&&(r.y=e.y),e.z<n.z?n.z=e.z:e.z>r.z&&(r.z=e.z)}else this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0)},computeBoundingSphere:function(){var e=0;this.boundingSphere===null&&(this.boundingSphere={radius:0});for(var t=0,n=this.vertices.length;t<n;t++){var r=this.vertices[t].lengthSq();r>e&&(e=r)}this.boundingSphere.radius=Math.sqrt(e)},mergeVertices:function(){var e={},t=[],n=[],r,i,s=4,o=Math.pow(10,s),u,a,f,l="abcd",c,h,p,d,v;for(u=0,a=this.vertices.length;u<a;u++)r=this.vertices[u],i=[Math.round(r.x*o),Math.round(r.y*o),Math.round(r.z*o)].join("_"),e[i]===undefined?(e[i]=u,t.push(this.vertices[u]),n[u]=t.length-1):n[u]=n[e[i]];for(u=0,a=this.faces.length;u<a;u++){f=this.faces[u];if(f instanceof THREE.Face3)f.a=n[f.a],f.b=n[f.b],f.c=n[f.c];else if(f instanceof THREE.Face4){f.a=n[f.a],f.b=n[f.b],f.c=n[f.c],f.d=n[f.d],c=[f.a,f.b,f.c,f.d];for(h=3;h>0;h--)if(c.indexOf(f[l[h]])!==h){c.splice(h,1),this.faces[u]=new THREE.Face3(c[0],c[1],c[2],f.normal,f.color,f.materialIndex);for(p=0,d=this.faceVertexUvs.length;p<d;p++)v=this.faceVertexUvs[p][u],v&&v.splice(h,1);this.faces[u].vertexColors=f.vertexColors;break}}}var m=this.vertices.length-t.length;return this.vertices=t,m},clone:function(){}},THREE.GeometryCount=0,THREE.BufferGeometry=function(){this.id=THREE.GeometryCount++,this.attributes={},this.dynamic=!1,this.boundingBox=null,this.boundingSphere=null,this.hasTangents=!1,this.morphTargets=[]},THREE.BufferGeometry.prototype={constructor:THREE.BufferGeometry,applyMatrix:function(e){var t,n;this.attributes.position&&(t=this.attributes.position.array),this.attributes.normal&&(n=this.attributes.normal.array),t!==undefined&&(e.multiplyVector3Array(t),this.verticesNeedUpdate=!0);if(n!==undefined){var r=new THREE.Matrix4;r.extractRotation(e),r.multiplyVector3Array(n),this.normalsNeedUpdate=!0}},computeBoundingBox:function(){this.boundingBox||(this.boundingBox={min:new THREE.Vector3(Infinity,Infinity,Infinity),max:new THREE.Vector3(-Infinity,-Infinity,-Infinity)});var e=this.attributes.position.array;if(e){var t=this.boundingBox,n,r,i;for(var s=0,o=e.length;s<o;s+=3)n=e[s],r=e[s+1],i=e[s+2],n<t.min.x?t.min.x=n:n>t.max.x&&(t.max.x=n),r<t.min.y?t.min.y=r:r>t.max.y&&(t.max.y=r),i<t.min.z?t.min.z=i:i>t.max.z&&(t.max.z=i)}if(e===undefined||e.length===0)this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0)},computeBoundingSphere:function(){this.boundingSphere||(this.boundingSphere={radius:0});var e=this.attributes.position.array;if(e){var t,n=0,r,i,s;for(var o=0,u=e.length;o<u;o+=3)r=e[o],i=e[o+1],s=e[o+2],t=r*r+i*i+s*s,t>n&&(n=t);this.boundingSphere.radius=Math.sqrt(n)}},computeVertexNormals:function(){if(this.attributes.position&&this.attributes.index){var e,t,n,r,i=this.attributes.position.array.length;if(this.attributes.normal===undefined)this.attributes.normal={itemSize:3,array:new Float32Array(i),numItems:i};else for(e=0,t=this.attributes.normal.array.length;e<t;e++)this.attributes.normal.array[e]=0;var s=this.offsets,o=this.attributes.index.array,u=this.attributes.position.array,a=this.attributes.normal.array,f,l,c,h,p,d,v=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Vector3,y=new THREE.Vector3,b=new THREE.Vector3;for(n=0,r=s.length;n<r;++n){var w=s[n].start,E=s[n].count,S=s[n].index;for(e=w,t=w+E;e<t;e+=3)f=S+o[e],l=S+o[e+1],c=S+o[e+2],h=u[f*3],p=u[f*3+1],d=u[f*3+2],v.set(h,p,d),h=u[l*3],p=u[l*3+1],d=u[l*3+2],m.set(h,p,d),h=u[c*3],p=u[c*3+1],d=u[c*3+2],g.set(h,p,d),y.sub(g,m),b.sub(v,m),y.crossSelf(b),a[f*3]+=y.x,a[f*3+1]+=y.y,a[f*3+2]+=y.z,a[l*3]+=y.x,a[l*3+1]+=y.y,a[l*3+2]+=y.z,a[c*3]+=y.x,a[c*3+1]+=y.y,a[c*3+2]+=y.z}for(e=0,t=a.length;e<t;e+=3){h=a[e],p=a[e+1],d=a[e+2];var x=1/Math.sqrt(h*h+p*p+d*d);a[e]*=x,a[e+1]*=x,a[e+2]*=x}this.normalsNeedUpdate=!0}},computeTangents:function(){function F(e,n,i){l=t[e*3],c=t[e*3+1],h=t[e*3+2],p=t[n*3],d=t[n*3+1],v=t[n*3+2],m=t[i*3],g=t[i*3+1],y=t[i*3+2],b=r[e*2],w=r[e*2+1],E=r[n*2],S=r[n*2+1],x=r[i*2],T=r[i*2+1],N=p-l,C=m-l,k=d-c,L=g-c,A=v-h,O=y-h,M=E-b,_=x-b,D=S-w,P=T-w,H=1/(M*P-_*D),B.set((P*N-D*C)*H,(P*k-D*L)*H,(P*A-D*O)*H),j.set((M*C-_*N)*H,(M*L-_*k)*H,(M*O-_*A)*H),u[e].addSelf(B),u[n].addSelf(B),u[i].addSelf(B),a[e].addSelf(j),a[n].addSelf(j),a[i].addSelf(j)}function ot(e){Y.x=n[e*3],Y.y=n[e*3+1],Y.z=n[e*3+2],Z.copy(Y),tt=u[e],Q.copy(tt),Q.subSelf(Y.multiplyScalar(Y.dot(tt))).normalize(),G.cross(Z,tt),nt=G.dot(a[e]),et=nt<0?-1:1,o[e*4]=Q.x,o[e*4+1]=Q.y,o[e*4+2]=Q.z,o[e*4+3]=et}if(this.attributes.index===undefined||this.attributes.position===undefined||this.attributes.normal===undefined||this.attributes.uv===undefined){console.warn("Missing required attributes (index, position, normal or uv) in BufferGeometry.computeTangents()");return}var e=this.attributes.index.array,t=this.attributes.position.array,n=this.attributes.normal.array,r=this.attributes.uv.array,i=t.length/3;if(this.attributes.tangent===undefined){var s=4*i;this.attributes.tangent={itemSize:4,array:new Float32Array(s),numItems:s}}var o=this.attributes.tangent.array,u=[],a=[];for(var f=0;f<i;f++)u[f]=new THREE.Vector3,a[f]=new THREE.Vector3;var l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B=new THREE.Vector3,j=new THREE.Vector3,I,q,R,U,z,W,X,V=this.offsets;for(R=0,U=V.length;R<U;++R){var $=V[R].start,J=V[R].count,K=V[R].index;for(I=$,q=$+J;I<q;I+=3)z=K+e[I],W=K+e[I+1],X=K+e[I+2],F(z,W,X)}var Q=new THREE.Vector3,G=new THREE.Vector3,Y=new THREE.Vector3,Z=new THREE.Vector3,et,tt,nt,rt,it,st;for(R=0,U=V.length;R<U;++R){var $=V[R].start,J=V[R].count,K=V[R].index;for(I=$,q=$+J;I<q;I+=3)z=K+e[I],W=K+e[I+1],X=K+e[I+2],ot(z),ot(W),ot(X)}this.hasTangents=!0,this.tangentsNeedUpdate=!0}},THREE.Spline=function(e){function h(e,t,n,r,i,s,o){var u=(n-e)*.5,a=(r-t)*.5;return(2*(t-n)+u+a)*o+(-3*(t-n)-2*u-a)*s+u*i+t}this.points=e;var t=[],n={x:0,y:0,z:0},r,i,s,o,u,a,f,l,c;this.initFromArray=function(e){this.points=[];for(var t=0;t<e.length;t++)this.points[t]={x:e[t][0],y:e[t][1],z:e[t][2]}},this.getPoint=function(e){return r=(this.points.length-1)*e,i=Math.floor(r),s=r-i,t[0]=i===0?i:i-1,t[1]=i,t[2]=i>this.points.length-2?this.points.length-1:i+1,t[3]=i>this.points.length-3?this.points.length-1:i+2,a=this.points[t[0]],f=this.points[t[1]],l=this.points[t[2]],c=this.points[t[3]],o=s*s,u=s*o,n.x=h(a.x,f.x,l.x,c.x,s,o,u),n.y=h(a.y,f.y,l.y,c.y,s,o,u),n.z=h(a.z,f.z,l.z,c.z,s,o,u),n},this.getControlPointsArray=function(){var e,t,n=this.points.length,r=[];for(e=0;e<n;e++)t=this.points[e],r[e]=[t.x,t.y,t.z];return r},this.getLength=function(e){var t,n,r,i,s=0,o=0,u=0,a=new THREE.Vector3,f=new THREE.Vector3,l=[],c=0;l[0]=0,e||(e=100),r=this.points.length*e,a.copy(this.points[0]);for(t=1;t<r;t++)n=t/r,i=this.getPoint(n),f.copy(i),c+=f.distanceTo(a),a.copy(i),s=(this.points.length-1)*n,o=Math.floor(s),o!=u&&(l[o]=c,u=o);return l[l.length]=c,{chunks:l,total:c}},this.reparametrizeByArcLength=function(e){var t,n,r,i,s,o,u,a,f,l=[],c=new THREE.Vector3,h=this.getLength();l.push(c.copy(this.points[0]).clone());for(t=1;t<this.points.length;t++){u=h.chunks[t]-h.chunks[t-1],a=Math.ceil(e*u/h.total),i=(t-1)/(this.points.length-1),s=t/(this.points.length-1);for(n=1;n<a-1;n++)r=i+n*(1/a)*(s-i),f=this.getPoint(r),l.push(c.copy(f).clone());l.push(c.copy(this.points[t]).clone())}this.points=l}},THREE.Camera=function(){THREE.Object3D.call(this),this.matrixWorldInverse=new THREE.Matrix4,this.projectionMatrix=new THREE.Matrix4,this.projectionMatrixInverse=new THREE.Matrix4},THREE.Camera.prototype=Object.create(THREE.Object3D.prototype),THREE.Camera.prototype.lookAt=function(e){this.matrix.lookAt(this.position,e,this.up),this.rotationAutoUpdate===!0&&this.rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder)},THREE.OrthographicCamera=function(e,t,n,r,i,s){THREE.Camera.call(this),this.left=e,this.right=t,this.top=n,this.bottom=r,this.near=i!==undefined?i:.1,this.far=s!==undefined?s:2e3,this.updateProjectionMatrix()},THREE.OrthographicCamera.prototype=Object.create(THREE.Camera.prototype),THREE.OrthographicCamera.prototype.updateProjectionMatrix=function(){this.projectionMatrix.makeOrthographic(this.left,this.right,this.top,this.bottom,this.near,this.far)},THREE.PerspectiveCamera=function(e,t,n,r){THREE.Camera.call(this),this.fov=e!==undefined?e:50,this.aspect=t!==undefined?t:1,this.near=n!==undefined?n:.1,this.far=r!==undefined?r:2e3,this.updateProjectionMatrix()},THREE.PerspectiveCamera.prototype=Object.create(THREE.Camera.prototype),THREE.PerspectiveCamera.prototype.setLens=function(e,t){t=t!==undefined?t:24,this.fov=2*Math.atan(t/(e*2))*(180/Math.PI),this.updateProjectionMatrix()},THREE.PerspectiveCamera.prototype.setViewOffset=function(e,t,n,r,i,s){this.fullWidth=e,this.fullHeight=t,this.x=n,this.y=r,this.width=i,this.height=s,this.updateProjectionMatrix()},THREE.PerspectiveCamera.prototype.updateProjectionMatrix=function(){if(this.fullWidth){var e=this.fullWidth/this.fullHeight,t=Math.tan(this.fov*Math.PI/360)*this.near,n=-t,r=e*n,i=e*t,s=Math.abs(i-r),o=Math.abs(t-n);this.projectionMatrix.makeFrustum(r+this.x*s/this.fullWidth,r+(this.x+this.width)*s/this.fullWidth,t-(this.y+this.height)*o/this.fullHeight,t-this.y*o/this.fullHeight,this.near,this.far)}else this.projectionMatrix.makePerspective(this.fov,this.aspect,this.near,this.far)},THREE.Light=function(e){THREE.Object3D.call(this),this.color=new THREE.Color(e)},THREE.Light.prototype=Object.create(THREE.Object3D.prototype),THREE.AmbientLight=function(e){THREE.Light.call(this,e)},THREE.AmbientLight.prototype=Object.create(THREE.Light.prototype),THREE.DirectionalLight=function(e,t,n){THREE.Light.call(this,e),this.position=new THREE.Vector3(0,1,0),this.target=new THREE.Object3D,this.intensity=t!==undefined?t:1,this.distance=n!==undefined?n:0,this.castShadow=!1,this.onlyShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraLeft=-500,this.shadowCameraRight=500,this.shadowCameraTop=500,this.shadowCameraBottom=-500,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512,this.shadowCascade=!1,this.shadowCascadeOffset=new THREE.Vector3(0,0,-1e3),this.shadowCascadeCount=2,this.shadowCascadeBias=[0,0,0],this.shadowCascadeWidth=[512,512,512],this.shadowCascadeHeight=[512,512,512],this.shadowCascadeNearZ=[-1,.99,.998],this.shadowCascadeFarZ=[.99,.998,1],this.shadowCascadeArray=[],this.shadowMap=null,this.shadowMapSize=null,this.shadowCamera=null,this.shadowMatrix=null},THREE.DirectionalLight.prototype=Object.create(THREE.Light.prototype),THREE.PointLight=function(e,t,n){THREE.Light.call(this,e),this.position=new THREE.Vector3(0,0,0),this.intensity=t!==undefined?t:1,this.distance=n!==undefined?n:0},THREE.PointLight.prototype=Object.create(THREE.Light.prototype),THREE.SpotLight=function(e,t,n,r,i){THREE.Light.call(this,e),this.position=new THREE.Vector3(0,1,0),this.target=new THREE.Object3D,this.intensity=t!==undefined?t:1,this.distance=n!==undefined?n:0,this.angle=r!==undefined?r:Math.PI/2,this.exponent=i!==undefined?i:10,this.castShadow=!1,this.onlyShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraFov=50,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapWidth=512,this.shadowMapHeight=512,this.shadowMap=null,this.shadowMapSize=null,this.shadowCamera=null,this.shadowMatrix=null},THREE.SpotLight.prototype=Object.create(THREE.Light.prototype),THREE.Loader=function(e){this.showStatus=e,this.statusDomElement=e?THREE.Loader.prototype.addStatusElement():null,this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}},THREE.Loader.prototype={constructor:THREE.Loader,crossOrigin:"anonymous",addStatusElement:function(){var e=document.createElement("div");return e.style.position="absolute",e.style.right="0px",e.style.top="0px",e.style.fontSize="0.8em",e.style.textAlign="left",e.style.background="rgba(0,0,0,0.25)",e.style.color="#fff",e.style.width="120px",e.style.padding="0.5em 0.5em 0.5em 0.5em",e.style.zIndex=1e3,e.innerHTML="Loading ...",e},updateProgress:function(e){var t="Loaded ";e.total?t+=(100*e.loaded/e.total).toFixed(0)+"%":t+=(e.loaded/1e3).toFixed(2)+" KB",this.statusDomElement.innerHTML=t},extractUrlBase:function(e){var t=e.split("/");return t.pop(),(t.length<1?".":t.join("/"))+"/"},initMaterials:function(e,t,n){e.materials=[];for(var r=0;r<t.length;++r)e.materials[r]=THREE.Loader.prototype.createMaterial(t[r],n)},hasNormals:function(e){var t,n,r=e.materials.length;for(n=0;n<r;n++){t=e.materials[n];if(t instanceof THREE.ShaderMaterial)return!0}return!1},createMaterial:function(e,t){function r(e){var t=Math.log(e)/Math.LN2;return Math.floor(t)==t}function i(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(t))}function s(e,t){var s=new Image;s.onload=function(){if(!r(this.width)||!r(this.height)){var t=i(this.width),n=i(this.height);e.image.width=t,e.image.height=n,e.image.getContext("2d").drawImage(this,0,0,t,n)}else e.image=this;e.needsUpdate=!0},s.crossOrigin=n.crossOrigin,s.src=t}function o(e,n,r,i,o,u){var a=document.createElement("canvas");e[n]=new THREE.Texture(a),e[n].sourceFile=r,i&&(e[n].repeat.set(i[0],i[1]),i[0]!==1&&(e[n].wrapS=THREE.RepeatWrapping),i[1]!==1&&(e[n].wrapT=THREE.RepeatWrapping)),o&&e[n].offset.set(o[0],o[1]);if(u){var f={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};f[u[0]]!==undefined&&(e[n].wrapS=f[u[0]]),f[u[1]]!==undefined&&(e[n].wrapT=f[u[1]])}s(e[n],t+"/"+r)}function u(e){return(e[0]*255<<16)+(e[1]*255<<8)+e[2]*255}var n=this,a="MeshLambertMaterial",f={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,bumpMap:null,wireframe:!1};if(e.shading){var l=e.shading.toLowerCase();l==="phong"?a="MeshPhongMaterial":l==="basic"&&(a="MeshBasicMaterial")}e.blending!==undefined&&THREE[e.blending]!==undefined&&(f.blending=THREE[e.blending]);if(e.transparent!==undefined||e.opacity<1)f.transparent=e.transparent;e.depthTest!==undefined&&(f.depthTest=e.depthTest),e.depthWrite!==undefined&&(f.depthWrite=e.depthWrite),e.visible!==undefined&&(f.visible=e.visible),e.flipSided!==undefined&&(f.side=THREE.BackSide),e.doubleSided!==undefined&&(f.side=THREE.DoubleSide),e.wireframe!==undefined&&(f.wireframe=e.wireframe),e.vertexColors!==undefined&&(e.vertexColors=="face"?f.vertexColors=THREE.FaceColors:e.vertexColors&&(f.vertexColors=THREE.VertexColors)),e.colorDiffuse?f.color=u(e.colorDiffuse):e.DbgColor&&(f.color=e.DbgColor),e.colorSpecular&&(f.specular=u(e.colorSpecular)),e.colorAmbient&&(f.ambient=u(e.colorAmbient)),e.transparency&&(f.opacity=e.transparency),e.specularCoef&&(f.shininess=e.specularCoef),e.mapDiffuse&&t&&o(f,"map",e.mapDiffuse,e.mapDiffuseRepeat,e.mapDiffuseOffset,e.mapDiffuseWrap),e.mapLight&&t&&o(f,"lightMap",e.mapLight,e.mapLightRepeat,e.mapLightOffset,e.mapLightWrap),e.mapBump&&t&&o(f,"bumpMap",e.mapBump,e.mapBumpRepeat,e.mapBumpOffset,e.mapBumpWrap),e.mapNormal&&t&&o(f,"normalMap",e.mapNormal,e.mapNormalRepeat,e.mapNormalOffset,e.mapNormalWrap),e.mapSpecular&&t&&o(f,"specularMap",e.mapSpecular,e.mapSpecularRepeat,e.mapSpecularOffset,e.mapSpecularWrap);if(e.mapNormal){var c=THREE.ShaderUtils.lib.normal,h=THREE.UniformsUtils.clone(c.uniforms);h.tNormal.texture=f.normalMap,e.mapNormalFactor&&(h.uNormalScale.value=e.mapNormalFactor),f.map&&(h.tDiffuse.texture=f.map,h.enableDiffuse.value=!0),f.specularMap&&(h.tSpecular.texture=f.specularMap,h.enableSpecular.value=!0),f.lightMap&&(h.tAO.texture=f.lightMap,h.enableAO.value=!0),h.uDiffuseColor.value.setHex(f.color),h.uSpecularColor.value.setHex(f.specular),h.uAmbientColor.value.setHex(f.ambient),h.uShininess.value=f.shininess,f.opacity!==undefined&&(h.uOpacity.value=f.opacity);var p={fragmentShader:c.fragmentShader,vertexShader:c.vertexShader,uniforms:h,lights:!0,fog:!0},d=new THREE.ShaderMaterial(p)}else var d=new THREE[a](f);return e.DbgName!==undefined&&(d.name=e.DbgName),d}},THREE.BinaryLoader=function(e){THREE.Loader.call(this,e)},THREE.BinaryLoader.prototype=Object.create(THREE.Loader.prototype),THREE.BinaryLoader.prototype.load=function(e,t,n,r){n=n?n:this.extractUrlBase(e),r=r?r:this.extractUrlBase(e);var i=this.showProgress?THREE.Loader.prototype.updateProgress:null;this.onLoadStart(),this.loadAjaxJSON(this,e,t,n,r,i)},THREE.BinaryLoader.prototype.loadAjaxJSON=function(e,t,n,r,i,s){var o=new XMLHttpRequest;o.onreadystatechange=function(){if(o.readyState==4)if(o.status==200||o.status==0){var u=JSON.parse(o.responseText);e.loadAjaxBuffers(u,n,i,r,s)}else console.error("THREE.BinaryLoader: Couldn't load ["+t+"] ["+o.status+"]")},o.open("GET",t,!0),o.overrideMimeType&&o.overrideMimeType("text/plain; charset=x-user-defined"),o.setRequestHeader("Content-Type","text/plain"),o.send(null)},THREE.BinaryLoader.prototype.loadAjaxBuffers=function(e,t,n,r,i){var s=new XMLHttpRequest,o=n+"/"+e.buffers,u=0;s.onreadystatechange=function(){if(s.readyState==4)if(s.status==200||s.status==0){var n=s.response;n===undefined&&(n=(new Uint8Array(s.responseBody)).buffer),THREE.BinaryLoader.prototype.createBinModel(n,t,r,e.materials)}else console.error("THREE.BinaryLoader: Couldn't load ["+o+"] ["+s.status+"]");else s.readyState==3?i&&(u==0&&(u=s.getResponseHeader("Content-Length")),i({total:u,loaded:s.responseText.length})):s.readyState==2&&(u=s.getResponseHeader("Content-Length"))},s.open("GET",o,!0),s.responseType="arraybuffer",s.send(null)},THREE.BinaryLoader.prototype.createBinModel=function(e,t,n,r){function s(e,t,n,r){e.vertices.push(new THREE.Vector3(t,n,r))}function o(e,t,n,r,i){e.faces.push(new THREE.Face3(t,n,r,null,null,i))}function u(e,t,n,r,i,s){e.faces.push(new THREE.Face4(t,n,r,i,null,null,s))}function a(e,t,n,r,i,s,o,u,a){var f=t[o*3],l=t[o*3+1],c=t[o*3+2],h=t[u*3],p=t[u*3+1],d=t[u*3+2],v=t[a*3],m=t[a*3+1],g=t[a*3+2];e.faces.push(new THREE.Face3(n,r,i,[new THREE.Vector3(f,l,c),new THREE.Vector3(h,p,d),new THREE.Vector3(v,m,g)],null,s))}function f(e,t,n,r,i,s,o,u,a,f,l){var c=t[u*3],h=t[u*3+1],p=t[u*3+2],d=t[a*3],v=t[a*3+1],m=t[a*3+2],g=t[f*3],y=t[f*3+1],b=t[f*3+2],w=t[l*3],E=t[l*3+1],S=t[l*3+2];e.faces.push(new THREE.Face4(n,r,i,s,[new THREE.Vector3(c,h,p),new THREE.Vector3(d,v,m),new THREE.Vector3(g,y,b),new THREE.Vector3(w,E,S)],null,o))}function l(e,t,n,r,i,s,o){var u=[];u.push(new THREE.UV(t,n)),u.push(new THREE.UV(r,i)),u.push(new THREE.UV(s,o)),e.push(u)}function c(e,t,n,r,i,s,o,u,a){var f=[];f.push(new THREE.UV(t,n)),f.push(new THREE.UV(r,i)),f.push(new THREE.UV(s,o)),f.push(new THREE.UV(u,a)),e.push(f)}var i=function(t){function D(e){return e%4?4-e%4:0}function P(e,t){var n={signature:H(e,t,12),header_bytes:B(e,t+12),vertex_coordinate_bytes:B(e,t+13),normal_coordinate_bytes:B(e,t+14),uv_coordinate_bytes:B(e,t+15),vertex_index_bytes:B(e,t+16),normal_index_bytes:B(e,t+17),uv_index_bytes:B(e,t+18),material_index_bytes:B(e,t+19),nvertices:j(e,t+20),nnormals:j(e,t+20+4),nuvs:j(e,t+20+8),ntri_flat:j(e,t+20+12),ntri_smooth:j(e,t+20+16),ntri_flat_uv:j(e,t+20+20),ntri_smooth_uv:j(e,t+20+24),nquad_flat:j(e,t+20+28),nquad_smooth:j(e,t+20+32),nquad_flat_uv:j(e,t+20+36),nquad_smooth_uv:j(e,t+20+40)};return n}function H(e,t,n){var r=new Uint8Array(e,t,n),i="";for(var s=0;s<n;s++)i+=String.fromCharCode(r[t+s]);return i}function B(e,t){var n=new Uint8Array(e,t,1);return n[0]}function j(e,t){var n=new Uint32Array(e,t,1);return n[0]}function F(t){var r=h.nvertices,i=new Float32Array(e,t,r*3),o,u,a,f;for(o=0;o<r;o++)u=i[o*3],a=i[o*3+1],f=i[o*3+2],s(n,u,a,f);return r*3*Float32Array.BYTES_PER_ELEMENT}function I(t){var n=h.nnormals;if(n){var r=new Int8Array(e,t,n*3),i,s,o,u;for(i=0;i<n;i++)s=r[i*3],o=r[i*3+1],u=r[i*3+2],p.push(s/127,o/127,u/127)}return n*3*Int8Array.BYTES_PER_ELEMENT}function q(t){var n=h.nuvs;if(n){var r=new Float32Array(e,t,n*2),i,s,o;for(i=0;i<n;i++)s=r[i*2],o=r[i*2+1],d.push(s,o)}return n*2*Float32Array.BYTES_PER_ELEMENT}function R(t,r){var i,s,o,u,a,f,c,h,p,v,m=new Uint32Array(e,r,3*t);for(i=0;i<t;i++)s=m[i*3],o=m[i*3+1],u=m[i*3+2],a=d[s*2],h=d[s*2+1],f=d[o*2],p=d[o*2+1],c=d[u*2],v=d[u*2+1],l(n.faceVertexUvs[0],a,h,f,p,c,v)}function U(t,r){var i,s,o,u,a,f,l,h,p,v,m,g,y,b=new Uint32Array(e,r,4*t);for(i=0;i<t;i++)s=b[i*4],o=b[i*4+1],u=b[i*4+2],a=b[i*4+3],f=d[s*2],v=d[s*2+1],l=d[o*2],m=d[o*2+1],h=d[u*2],g=d[u*2+1],p=d[a*2],y=d[a*2+1],c(n.faceVertexUvs[0],f,v,l,m,h,g,p,y)}function z(t,r,i){var s,u,a,f,l,c=new Uint32Array(e,r,3*t),h=new Uint16Array(e,i,t);for(s=0;s<t;s++)u=c[s*3],a=c[s*3+1],f=c[s*3+2],l=h[s],o(n,u,a,f,l)}function W(t,r,i){var s,o,a,f,l,c,h=new Uint32Array(e,r,4*t),p=new Uint16Array(e,i,t);for(s=0;s<t;s++)o=h[s*4],a=h[s*4+1],f=h[s*4+2],l=h[s*4+3],c=p[s],u(n,o,a,f,l,c)}function X(t,r,i,s){var o,u,f,l,c,h,d,v,m=new Uint32Array(e,r,3*t),g=new Uint32Array(e,i,3*t),y=new Uint16Array(e,s,t);for(o=0;o<t;o++)u=m[o*3],f=m[o*3+1],l=m[o*3+2],h=g[o*3],d=g[o*3+1],v=g[o*3+2],c=y[o],a(n,p,u,f,l,c,h,d,v)}function V(t,r,i,s){var o,u,a,l,c,h,d,v,m,g,y=new Uint32Array(e,r,4*t),b=new Uint32Array(e,i,4*t),w=new Uint16Array(e,s,t);for(o=0;o<t;o++)u=y[o*4],a=y[o*4+1],l=y[o*4+2],c=y[o*4+3],d=b[o*4],v=b[o*4+1],m=b[o*4+2],g=b[o*4+3],h=w[o],f(n,p,u,a,l,c,h,d,v,m,g)}function $(e){var t=h.ntri_flat;if(t){var n=e+t*Uint32Array.BYTES_PER_ELEMENT*3;z(t,e,n)}}function J(e){var t=h.ntri_flat_uv;if(t){var n=e+t*Uint32Array.BYTES_PER_ELEMENT*3,r=n+t*Uint32Array.BYTES_PER_ELEMENT*3;z(t,e,r),R(t,n)}}function K(e){var t=h.ntri_smooth;if(t){var n=e+t*Uint32Array.BYTES_PER_ELEMENT*3,r=n+t*Uint32Array.BYTES_PER_ELEMENT*3;X(t,e,n,r)}}function Q(e){var t=h.ntri_smooth_uv;if(t){var n=e+t*Uint32Array.BYTES_PER_ELEMENT*3,r=n+t*Uint32Array.BYTES_PER_ELEMENT*3,i=r+t*Uint32Array.BYTES_PER_ELEMENT*3;X(t,e,n,i),R(t,r)}}function G(e){var t=h.nquad_flat;if(t){var n=e+t*Uint32Array.BYTES_PER_ELEMENT*4;W(t,e,n)}}function Y(e){var t=h.nquad_flat_uv;if(t){var n=e+t*Uint32Array.BYTES_PER_ELEMENT*4,r=n+t*Uint32Array.BYTES_PER_ELEMENT*4;W(t,e,r),U(t,n)}}function Z(e){var t=h.nquad_smooth;if(t){var n=e+t*Uint32Array.BYTES_PER_ELEMENT*4,r=n+t*Uint32Array.BYTES_PER_ELEMENT*4;V(t,e,n,r)}}function et(e){var t=h.nquad_smooth_uv;if(t){var n=e+t*Uint32Array.BYTES_PER_ELEMENT*4,r=n+t*Uint32Array.BYTES_PER_ELEMENT*4,i=r+t*Uint32Array.BYTES_PER_ELEMENT*4;V(t,e,n,i),U(t,r)}}var n=this,i=0,h,p=[],d=[],v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_;THREE.Geometry.call(this),THREE.Loader.prototype.initMaterials(n,r,t),h=P(e,i),i+=h.header_bytes,x=h.vertex_index_bytes*3+h.material_index_bytes,T=h.vertex_index_bytes*4+h.material_index_bytes,N=h.ntri_flat*x,C=h.ntri_smooth*(x+h.normal_index_bytes*3),k=h.ntri_flat_uv*(x+h.uv_index_bytes*3),L=h.ntri_smooth_uv*(x+h.normal_index_bytes*3+h.uv_index_bytes*3),A=h.nquad_flat*T,O=h.nquad_smooth*(T+h.normal_index_bytes*4),M=h.nquad_flat_uv*(T+h.uv_index_bytes*4),_=h.nquad_smooth_uv*(T+h.normal_index_bytes*4+h.uv_index_bytes*4),i+=F(i),i+=I(i),i+=D(h.nnormals*3),i+=q(i),v=i,m=v+N+D(h.ntri_flat*2),g=m+C+D(h.ntri_smooth*2),y=g+k+D(h.ntri_flat_uv*2),b=y+L+D(h.ntri_smooth_uv*2),w=b+A+D(h.nquad_flat*2),E=w+O+D(h.nquad_smooth*2),S=E+M+D(h.nquad_flat_uv*2),J(g),Q(y),Y(E),et(S),$(v),K(m),G(b),Z(w),this.computeCentroids(),this.computeFaceNormals(),THREE.Loader.prototype.hasNormals(this)&&this.computeTangents()};i.prototype=Object.create(THREE.Geometry.prototype),t(new i(n))},THREE.ImageLoader=function(){THREE.EventTarget.call(this),this.crossOrigin=null},THREE.ImageLoader.prototype={constructor:THREE.ImageLoader,load:function(e,t){var n=this;t===undefined&&(t=new Image),t.addEventListener("load",function(){n.dispatchEvent({type:"load",content:t})},!1),t.addEventListener("error",function(){n.dispatchEvent({type:"error",message:"Couldn't load URL ["+e+"]"})},!1),n.crossOrigin&&(t.crossOrigin=n.crossOrigin),t.src=e}},THREE.JSONLoader=function(e){THREE.Loader.call(this,e)},THREE.JSONLoader.prototype=Object.create(THREE.Loader.prototype),THREE.JSONLoader.prototype.load=function(e,t,n){var r=this;n=n?n:this.extractUrlBase(e),this.onLoadStart(),this.loadAjaxJSON(this,e,t,n)},THREE.JSONLoader.prototype.loadAjaxJSON=function(e,t,n,r,i){var s=new XMLHttpRequest,o=0;s.onreadystatechange=function(){if(s.readyState===s.DONE)if(s.status===200||s.status===0){if(s.responseText){var u=JSON.parse(s.responseText);e.createModel(u,n,r)}else console.warn("THREE.JSONLoader: ["+t+"] seems to be unreachable or file there is empty");e.onLoadComplete()}else console.error("THREE.JSONLoader: Couldn't load ["+t+"] ["+s.status+"]");else s.readyState===s.LOADING?i&&(o===0&&(o=s.getResponseHeader("Content-Length")),i({total:o,loaded:s.responseText.length})):s.readyState===s.HEADERS_RECEIVED&&(o=s.getResponseHeader("Content-Length"))},s.open("GET",t,!0),s.overrideMimeType&&s.overrideMimeType("text/plain; charset=x-user-defined"),s.setRequestHeader("Content-Type","text/plain"),s.send(null)},THREE.JSONLoader.prototype.createModel=function(e,t,n){function o(t){function n(e,t){return e&1<<t}var r,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M=e.faces,_=e.vertices,D=e.normals,P=e.colors,H=0;for(r=0;r<e.uvs.length;r++)e.uvs[r].length&&H++;for(r=0;r<H;r++)i.faceUvs[r]=[],i.faceVertexUvs[r]=[];u=0,a=_.length;while(u<a)x=new THREE.Vector3,x.x=_[u++]*t,x.y=_[u++]*t,x.z=_[u++]*t,i.vertices.push(x);u=0,a=M.length;while(u<a){d=M[u++],v=n(d,0),m=n(d,1),g=n(d,2),y=n(d,3),b=n(d,4),w=n(d,5),E=n(d,6),S=n(d,7),v?(T=new THREE.Face4,T.a=M[u++],T.b=M[u++],T.c=M[u++],T.d=M[u++],f=4):(T=new THREE.Face3,T.a=M[u++],T.b=M[u++],T.c=M[u++],f=3),m&&(p=M[u++],T.materialIndex=p),o=i.faces.length;if(g)for(r=0;r<H;r++)k=e.uvs[r],h=M[u++],A=k[h*2],O=k[h*2+1],i.faceUvs[r][o]=new THREE.UV(A,O);if(y)for(r=0;r<H;r++){k=e.uvs[r],L=[];for(s=0;s<f;s++)h=M[u++],A=k[h*2],O=k[h*2+1],L[s]=new THREE.UV(A,O);i.faceVertexUvs[r][o]=L}b&&(c=M[u++]*3,C=new THREE.Vector3,C.x=D[c++],C.y=D[c++],C.z=D[c],T.normal=C);if(w)for(r=0;r<f;r++)c=M[u++]*3,C=new THREE.Vector3,C.x=D[c++],C.y=D[c++],C.z=D[c],T.vertexNormals.push(C);E&&(l=M[u++],N=new THREE.Color(P[l]),T.color=N);if(S)for(r=0;r<f;r++)l=M[u++],N=new THREE.Color(P[l]),T.vertexColors.push(N);i.faces.push(T)}}function u(){var t,n,r,s,o,u,a,f,l,c;if(e.skinWeights)for(t=0,n=e.skinWeights.length;t<n;t+=2)r=e.skinWeights[t],s=e.skinWeights[t+1],o=0,u=0,i.skinWeights.push(new THREE.Vector4(r,s,o,u));if(e.skinIndices)for(t=0,n=e.skinIndices.length;t<n;t+=2)a=e.skinIndices[t],f=e.skinIndices[t+1],l=0,c=0,i.skinIndices.push(new THREE.Vector4(a,f,l,c));i.bones=e.bones,i.animation=e.animation}function a(t){if(e.morphTargets!==undefined){var n,r,s,o,u,a;for(n=0,r=e.morphTargets.length;n<r;n++){i.morphTargets[n]={},i.morphTargets[n].name=e.morphTargets[n].name,i.morphTargets[n].vertices=[],u=i.morphTargets[n].vertices,a=e.morphTargets[n].vertices;for(s=0,o=a.length;s<o;s+=3){var f=new THREE.Vector3;f.x=a[s]*t,f.y=a[s+1]*t,f.z=a[s+2]*t,u.push(f)}}}if(e.morphColors!==undefined){var n,r,l,c,h,p,d;for(n=0,r=e.morphColors.length;n<r;n++){i.morphColors[n]={},i.morphColors[n].name=e.morphColors[n].name,i.morphColors[n].colors=[],h=i.morphColors[n].colors,p=e.morphColors[n].colors;for(l=0,c=p.length;l<c;l+=3)d=new THREE.Color(16755200),d.setRGB(p[l],p[l+1],p[l+2]),h.push(d)}}}var r=this,i=new THREE.Geometry,s=e.scale!==undefined?1/e.scale:1;this.initMaterials(i,e.materials,n),o(s),u(),a(s),i.computeCentroids(),i.computeFaceNormals(),this.hasNormals(i)&&i.computeTangents(),t(i)},THREE.GeometryLoader=function(){THREE.EventTarget.call(this),this.crossOrigin=null,this.path=null},THREE.GeometryLoader.prototype={constructor:THREE.GeometryLoader,load:function(e){var t=this,n=null;if(t.path===null){var r=e.split("/");r.pop(),t.path=r.length<1?".":r.join("/")}var i=new XMLHttpRequest;i.addEventListener("load",function(r){r.target.responseText?n=t.parse(JSON.parse(r.target.responseText),s):t.dispatchEvent({type:"error",message:"Invalid file ["+e+"]"})},!1),i.addEventListener("error",function(){t.dispatchEvent({type:"error",message:"Couldn't load URL ["+e+"]"})},!1),i.open("GET",e,!0),i.send(null);var s=new THREE.LoadingMonitor;s.addEventListener("load",function(e){t.dispatchEvent({type:"load",content:n})}),s.add(i)},parse:function(e,t){function y(e,t){return e&1<<t}var n=this,r=new THREE.Geometry,i=e.scale!==undefined?1/e.scale:1;if(e.materials){r.materials=[];for(var s=0;s<e.materials.length;++s){var o=e.materials[s];function u(e){var t=Math.log(e)/Math.LN2;return Math.floor(t)==t}function a(e){var t=Math.log(e)/Math.LN2;return Math.pow(2,Math.round(t))}function f(e,r,i,s,o,f){e[r]=new THREE.Texture,e[r].sourceFile=i,s&&(e[r].repeat.set(s[0],s[1]),s[0]!==1&&(e[r].wrapS=THREE.RepeatWrapping),s[1]!==1&&(e[r].wrapT=THREE.RepeatWrapping)),o&&e[r].offset.set(o[0],o[1]);if(f){var l={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};l[f[0]]!==undefined&&(e[r].wrapS=l[f[0]]),l[f[1]]!==undefined&&(e[r].wrapT=l[f[1]])}var c=e[r],h=new THREE.ImageLoader;h.addEventListener("load",function(e){var t=e.content;if(!u(t.width)||!u(t.height)){var n=a(t.width),r=a(t.height);c.image=document.createElement("canvas"),c.image.width=n,c.image.height=r,c.image.getContext("2d").drawImage(t,0,0,n,r)}else c.image=t;c.needsUpdate=!0}),h.crossOrigin=n.crossOrigin,h.load(n.path+"/"+i),t&&t.add(h)}function l(e){return(e[0]*255<<16)+(e[1]*255<<8)+e[2]*255}var c="MeshLambertMaterial",h={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,bumpMap:null,wireframe:!1};if(o.shading){var p=o.shading.toLowerCase();p==="phong"?c="MeshPhongMaterial":p==="basic"&&(c="MeshBasicMaterial")}o.blending!==undefined&&THREE[o.blending]!==undefined&&(h.blending=THREE[o.blending]);if(o.transparent!==undefined||o.opacity<1)h.transparent=o.transparent;o.depthTest!==undefined&&(h.depthTest=o.depthTest),o.depthWrite!==undefined&&(h.depthWrite=o.depthWrite),o.vertexColors!==undefined&&(o.vertexColors=="face"?h.vertexColors=THREE.FaceColors:o.vertexColors&&(h.vertexColors=THREE.VertexColors)),o.colorDiffuse?h.color=l(o.colorDiffuse):o.DbgColor&&(h.color=o.DbgColor),o.colorSpecular&&(h.specular=l(o.colorSpecular)),o.colorAmbient&&(h.ambient=l(o.colorAmbient)),o.transparency&&(h.opacity=o.transparency),o.specularCoef&&(h.shininess=o.specularCoef),o.visible!==undefined&&(h.visible=o.visible),o.flipSided!==undefined&&(h.side=THREE.BackSide),o.doubleSided!==undefined&&(h.side=THREE.DoubleSide),o.wireframe!==undefined&&(h.wireframe=o.wireframe),o.mapDiffuse&&f(h,"map",o.mapDiffuse,o.mapDiffuseRepeat,o.mapDiffuseOffset,o.mapDiffuseWrap),o.mapLight&&f(h,"lightMap",o.mapLight,o.mapLightRepeat,o.mapLightOffset,o.mapLightWrap),o.mapBump&&f(h,"bumpMap",o.mapBump,o.mapBumpRepeat,o.mapBumpOffset,o.mapBumpWrap),o.mapNormal&&f(h,"normalMap",o.mapNormal,o.mapNormalRepeat,o.mapNormalOffset,o.mapNormalWrap),o.mapSpecular&&f(h,"specularMap",o.mapSpecular,o.mapSpecularRepeat,o.mapSpecularOffset,o.mapSpecularWrap);if(o.mapNormal){var d=THREE.ShaderUtils.lib.normal,v=THREE.UniformsUtils.clone(d.uniforms);v.tNormal.texture=h.normalMap,o.mapNormalFactor&&(v.uNormalScale.value=o.mapNormalFactor),h.map&&(v.tDiffuse.texture=h.map,v.enableDiffuse.value=!0),h.specularMap&&(v.tSpecular.texture=h.specularMap,v.enableSpecular.value=!0),h.lightMap&&(v.tAO.texture=h.lightMap,v.enableAO.value=!0),v.uDiffuseColor.value.setHex(h.color),v.uSpecularColor.value.setHex(h.specular),v.uAmbientColor.value.setHex(h.ambient),v.uShininess.value=h.shininess,h.opacity!==undefined&&(v.uOpacity.value=h.opacity);var m={fragmentShader:d.fragmentShader,vertexShader:d.vertexShader,uniforms:v,lights:!0,fog:!0},g=new THREE.ShaderMaterial(m)}else var g=new THREE[c](h);o.DbgName!==undefined&&(g.name=o.DbgName),r.materials[s]=g}}var b=e.faces,w=e.vertices,E=e.normals,S=e.colors,x=0;if(e.uvs)for(var s=0;s<e.uvs.length;s++)e.uvs[s].length&&x++;for(var s=0;s<x;s++)r.faceUvs[s]=[],r.faceVertexUvs[s]=[];var T=0,N=w.length;while(T<N){var C=new THREE.Vector3;C.x=w[T++]*i,C.y=w[T++]*i,C.z=w[T++]*i,r.vertices.push(C)}T=0,N=b.length;while(T<N){var k=b[T++],L=y(k,0),A=y(k,1),O=y(k,2),M=y(k,3),_=y(k,4),D=y(k,5),P=y(k,6),H=y(k,7);if(L){var B=new THREE.Face4;B.a=b[T++],B.b=b[T++],B.c=b[T++],B.d=b[T++];var j=4}else{var B=new THREE.Face3;B.a=b[T++],B.b=b[T++],B.c=b[T++];var j=3}if(A){var F=b[T++];B.materialIndex=F}var I=r.faces.length;if(O)for(var s=0;s<x;s++){var q=e.uvs[s],R=b[T++],U=q[R*2],z=q[R*2+1];r.faceUvs[s][I]=new THREE.UV(U,z)}if(M)for(var s=0;s<x;s++){var q=e.uvs[s],W=[];for(var X=0;X<j;X++){var R=b[T++],U=q[R*2],z=q[R*2+1];W[X]=new THREE.UV(U,z)}r.faceVertexUvs[s][I]=W}if(_){var V=b[T++]*3,$=new THREE.Vector3;$.x=E[V++],$.y=E[V++],$.z=E[V],B.normal=$}if(D)for(s=0;s<j;s++){var V=b[T++]*3,$=new THREE.Vector3;$.x=E[V++],$.y=E[V++],$.z=E[V],B.vertexNormals.push($)}if(P){var J=b[T++];B.color=new THREE.Color(S[J])}if(H)for(var s=0;s<j;s++){var J=b[T++];B.vertexColors.push(new THREE.Color(S[J]))}r.faces.push(B)}if(e.skinWeights)for(var s=0,K=e.skinWeights.length;s<K;s+=2){var Q=e.skinWeights[s],G=e.skinWeights[s+1],Y=0,Z=0;r.skinWeights.push(new THREE.Vector4(Q,G,Y,Z))}if(e.skinIndices)for(var s=0,K=e.skinIndices.length;s<K;s+=2){var et=e.skinIndices[s],tt=e.skinIndices[s+1],nt=0,rt=0;r.skinIndices.push(new THREE.Vector4(et,tt,nt,rt))}r.bones=e.bones,r.animation=e.animation;if(e.morphTargets)for(var s=0,K=e.morphTargets.length;s<K;s++){r.morphTargets[s]={},r.morphTargets[s].name=e.morphTargets[s].name,r.morphTargets[s].vertices=[];var it=r.morphTargets[s].vertices,st=e.morphTargets[s].vertices;for(var z=0,ot=st.length;z<ot;z+=3){var C=new THREE.Vector3;C.x=st[z]*i,C.y=st[z+1]*i,C.z=st[z+2]*i,it.push(C)}}if(e.morphColors)for(var s=0,K=e.morphColors.length;s<K;s++){r.morphColors[s]={},r.morphColors[s].name=e.morphColors[s].name,r.morphColors[s].colors=[];var ut=r.morphColors[s].colors,at=e.morphColors[s].colors;for(var nt=0,ft=at.length;nt<ft;nt+=3){var lt=new THREE.Color(16755200);lt.setRGB(at[nt],at[nt+1],at[nt+2]),ut.push(lt)}}return r.computeCentroids(),r.computeFaceNormals(),r}},THREE.SceneLoader=function(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){},this.callbackSync=function(){},this.callbackProgress=function(){}},THREE.SceneLoader.prototype.constructor=THREE.SceneLoader,THREE.SceneLoader.prototype.load=function(e,t){var n=this,r=new XMLHttpRequest;r.onreadystatechange=function(){if(r.readyState===4)if(r.status===200||r.status===0){var i=JSON.parse(r.responseText);n.createScene(i,t,e)}else console.error("THREE.SceneLoader: Couldn't load ["+e+"] ["+r.status+"]")},r.open("GET",e,!0),r.overrideMimeType&&r.overrideMimeType("text/plain; charset=x-user-defined"),r.setRequestHeader("Content-Type","text/plain"),r.send(null)},THREE.SceneLoader.prototype.createScene=function(e,t,n){function X(e,t){return t=="relativeToHTML"?e:i+"/"+e}function V(){$(R.scene,P.objects)}function $(e,t){var n;for(u in t)if(R.objects[u]===undefined){p=t[u];if(p.geometry!==undefined){k=R.geometries[p.geometry];if(k){var r=!1;L=R.materials[p.materials[0]],r=L instanceof THREE.ShaderMaterial,r&&k.computeTangents(),g=p.position,y=p.rotation,b=p.quaternion,w=p.scale,d=p.matrix,b=0,p.materials.length==0&&(L=new THREE.MeshFaceMaterial),p.materials.length>1&&(L=new THREE.MeshFaceMaterial),n=new THREE.Mesh(k,L),n.name=u,d?(n.matrixAutoUpdate=!1,n.matrix.set(d[0],d[1],d[2],d[3],d[4],d[5],d[6],d[7],d[8],d[9],d[10],d[11],d[12],d[13],d[14],d[15])):(n.position.set(g[0],g[1],g[2]),b?(n.quaternion.set(b[0],b[1],b[2],b[3]),n.useQuaternion=!0):n.rotation.set(y[0],y[1],y[2]),n.scale.set(w[0],w[1],w[2])),n.visible=p.visible,n.castShadow=p.castShadow,n.receiveShadow=p.receiveShadow,e.add(n),R.objects[u]=n}}else g=p.position,y=p.rotation,b=p.quaternion,w=p.scale,b=0,n=new THREE.Object3D,n.name=u,n.position.set(g[0],g[1],g[2]),b?(n.quaternion.set(b[0],b[1],b[2],b[3]),n.useQuaternion=!0):n.rotation.set(y[0],y[1],y[2]),n.scale.set(w[0],w[1],w[2]),n.visible=p.visible!==undefined?p.visible:!1,e.add(n),R.objects[u]=n,R.empties[u]=n;if(p.properties!==undefined)for(var i in p.properties){var s=p.properties[i];n.properties[i]=s}p.children!==undefined&&$(n,p.children)}}function J(e,t){R.geometries[t]=e,V()}function K(e){return function(t){J(t,e),j-=1,r.onLoadComplete(),G()}}function Q(e){return function(t){R.geometries[e]=t}}function G(){var e={totalModels:I,totalTextures:q,loadedModels:I-j,loadedTextures:q-F};r.callbackProgress(e,R),r.onLoadProgress(),j===0&&F===0&&t(R)}var r=this,i=THREE.Loader.prototype.extractUrlBase(n),s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R;P=e,H=new THREE.BinaryLoader,B=new THREE.JSONLoader,j=0,F=0,R={scene:new THREE.Scene,geometries:{},materials:{},textures:{},objects:{},cameras:{},lights:{},fogs:{},empties:{}};if(P.transform){var U=P.transform.position,z=P.transform.rotation,W=P.transform.scale;U&&R.scene.position.set(U[0],U[1],U[2]),z&&R.scene.rotation.set(z[0],z[1],z[2]),W&&R.scene.scale.set(W[0],W[1],W[2]);if(U||z||W)R.scene.updateMatrix(),R.scene.updateMatrixWorld()}var Y=function(e){F-=e,G(),r.onLoadComplete()},Z=function(e){return function(){Y(e)}};for(f in P.cameras)E=P.cameras[f],E.type==="perspective"?A=new THREE.PerspectiveCamera(E.fov,E.aspect,E.near,E.far):E.type==="ortho"&&(A=new THREE.OrthographicCamera(E.left,E.right,E.top,E.bottom,E.near,E.far)),g=E.position,S=E.target,C=E.up,A.position.set(g[0],g[1],g[2]),A.target=new THREE.Vector3(S[0],S[1],S[2]),C&&A.up.set(C[0],C[1],C[2]),R.cameras[f]=A;var et,tt;for(a in P.lights)v=P.lights[a],et=v.color!==undefined?v.color:16777215,tt=v.intensity!==undefined?v.intensity:1,v.type==="directional"?(g=v.direction,D=new THREE.DirectionalLight(et,tt),D.position.set(g[0],g[1],g[2]),D.position.normalize()):v.type==="point"?(g=v.position,m=v.distance,D=new THREE.PointLight(et,tt,m),D.position.set(g[0],g[1],g[2])):v.type==="ambient"&&(D=new THREE.AmbientLight(et)),R.scene.add(D),R.lights[a]=D;for(l in P.fogs)x=P.fogs[l],x.type==="linear"?O=new THREE.Fog(0,x.near,x.far):x.type==="exp2"&&(O=new THREE.FogExp2(0,x.density)),E=x.color,O.color.setRGB(E[0],E[1],E[2]),R.fogs[l]=O;R.cameras&&P.defaults.camera&&(R.currentCamera=R.cameras[P.defaults.camera]),R.fogs&&P.defaults.fog&&(R.scene.fog=R.fogs[P.defaults.fog]),E=P.defaults.bgcolor,R.bgColor=new THREE.Color,R.bgColor.setRGB(E[0],E[1],E[2]),R.bgColorAlpha=P.defaults.bgalpha;for(s in P.geometries){h=P.geometries[s];if(h.type=="bin_mesh"||h.type=="ascii_mesh")j+=1,r.onLoadStart()}I=j;for(s in P.geometries){h=P.geometries[s];if(h.type==="cube")k=new THREE.CubeGeometry(h.width,h.height,h.depth,h.segmentsWidth,h.segmentsHeight,h.segmentsDepth,null,h.flipped,h.sides),R.geometries[s]=k;else if(h.type==="plane")k=new THREE.PlaneGeometry(h.width,h.height,h.segmentsWidth,h.segmentsHeight),R.geometries[s]=k;else if(h.type==="sphere")k=new THREE.SphereGeometry(h.radius,h.segmentsWidth,h.segmentsHeight),R.geometries[s]=k;else if(h.type==="cylinder")k=new THREE.CylinderGeometry(h.topRad,h.botRad,h.height,h.radSegs,h.heightSegs),R.geometries[s]=k;else if(h.type==="torus")k=new THREE.TorusGeometry(h.radius,h.tube,h.segmentsR,h.segmentsT),R.geometries[s]=k;else if(h.type==="icosahedron")k=new THREE.IcosahedronGeometry(h.radius,h.subdivisions),R.geometries[s]=k;else if(h.type==="bin_mesh")H.load(X(h.url,P.urlBaseType),K(s));else if(h.type==="ascii_mesh")B.load(X(h.url,P.urlBaseType),K(s));else if(h.type==="embedded_mesh"){var nt=P.embeds[h.id],rt="";nt.metadata=P.metadata,nt&&B.createModel(nt,Q(s),rt)}}for(c in P.textures){T=P.textures[c];if(T.url instanceof Array){F+=T.url.length;for(var it=0;it<T.url.length;it++)r.onLoadStart()}else F+=1,r.onLoadStart()}q=F;for(c in P.textures){T=P.textures[c],T.mapping!==undefined&&THREE[T.mapping]!==undefined&&(T.mapping=new THREE[T.mapping]);if(T.url instanceof Array){var st=T.url.length,ot=[];for(var ut=0;ut<st;ut++)ot[ut]=X(T.url[ut],P.urlBaseType);M=THREE.ImageUtils.loadTextureCube(ot,T.mapping,Z(st))}else{M=THREE.ImageUtils.loadTexture(X(T.url,P.urlBaseType),T.mapping,Z(1)),THREE[T.minFilter]!==undefined&&(M.minFilter=THREE[T.minFilter]),THREE[T.magFilter]!==undefined&&(M.magFilter=THREE[T.magFilter]),T.repeat&&(M.repeat.set(T.repeat[0],T.repeat[1]),T.repeat[0]!==1&&(M.wrapS=THREE.RepeatWrapping),T.repeat[1]!==1&&(M.wrapT=THREE.RepeatWrapping)),T.offset&&M.offset.set(T.offset[0],T.offset[1]);if(T.wrap){var at={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping};at[T.wrap[0]]!==undefined&&(M.wrapS=at[T.wrap[0]]),at[T.wrap[1]]!==undefined&&(M.wrapT=at[T.wrap[1]])}}R.textures[c]=M}for(o in P.materials){d=P.materials[o];for(N in d.parameters)N==="envMap"||N==="map"||N==="lightMap"?d.parameters[N]=R.textures[d.parameters[N]]:N==="shading"?d.parameters[N]=d.parameters[N]=="flat"?THREE.FlatShading:THREE.SmoothShading:N==="blending"?d.parameters[N]=d.parameters[N]in THREE?THREE[d.parameters[N]]:THREE.NormalBlending:N==="combine"?d.parameters[N]=d.parameters[N]=="MixOperation"?THREE.MixOperation:THREE.MultiplyOperation:N==="vertexColors"&&(d.parameters[N]=="face"?d.parameters[N]=THREE.FaceColors:d.parameters[N]&&(d.parameters[N]=THREE.VertexColors));d.parameters.opacity!==undefined&&d.parameters.opacity<1&&(d.parameters.transparent=!0);if(d.parameters.normalMap){var ft=THREE.ShaderUtils.lib.normal,lt=THREE.UniformsUtils.clone(ft.uniforms),ct=d.parameters.color,ht=d.parameters.specular,pt=d.parameters.ambient,dt=d.parameters.shininess;lt.tNormal.texture=R.textures[d.parameters.normalMap],d.parameters.normalMapFactor&&(lt.uNormalScale.value=d.parameters.normalMapFactor),d.parameters.map&&(lt.tDiffuse.texture=d.parameters.map,lt.enableDiffuse.value=!0),d.parameters.lightMap&&(lt.tAO.texture=d.parameters.lightMap,lt.enableAO.value=!0),d.parameters.specularMap&&(lt.tSpecular.texture=R.textures[d.parameters.specularMap],lt.enableSpecular.value=!0),lt.uDiffuseColor.value.setHex(ct),lt.uSpecularColor.value.setHex(ht),lt.uAmbientColor.value.setHex(pt),lt.uShininess.value=dt,d.parameters.opacity&&(lt.uOpacity.value=d.parameters.opacity);var vt={fragmentShader:ft.fragmentShader,vertexShader:ft.vertexShader,uniforms:lt,lights:!0,fog:!0};L=new THREE.ShaderMaterial(vt)}else L=new THREE[d.type](d.parameters);R.materials[o]=L}V(),r.callbackSync(R),G()},THREE.TextureLoader=function(){THREE.EventTarget.call(this),this.crossOrigin=null},THREE.TextureLoader.prototype={constructor:THREE.TextureLoader,load:function(e){var t=this,n=new Image;n.addEventListener("load",function(){var e=new THREE.Texture(n);e.needsUpdate=!0,t.dispatchEvent({type:"load",content:e})},!1),n.addEventListener("error",function(){t.dispatchEvent({type:"error",message:"Couldn't load URL ["+e+"]"})},!1),t.crossOrigin&&(n.crossOrigin=t.crossOrigin),n.src=e}},THREE.Material=function(){this.id=THREE.MaterialCount++,this.name="",this.side=THREE.FrontSide,this.opacity=1,this.transparent=!1,this.blending=THREE.NormalBlending,this.blendSrc=THREE.SrcAlphaFactor,this.blendDst=THREE.OneMinusSrcAlphaFactor,this.blendEquation=THREE.AddEquation,this.depthTest=!0,this.depthWrite=!0,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.alphaTest=0,this.overdraw=!1,this.visible=!0,this.needsUpdate=!0},THREE.Material.prototype.setValues=function(e){if(e===undefined)return;for(var t in e){var n=e[t];if(n===undefined){console.warn("THREE.Material: '"+t+"' parameter is undefined.");continue}if(t in this){var r=this[t];r instanceof THREE.Color&&n instanceof THREE.Color?r.copy(n):r instanceof THREE.Color&&typeof n=="number"?r.setHex(n):r instanceof THREE.Vector3&&n instanceof THREE.Vector3?r.copy(n):this[t]=n}}},THREE.Material.prototype.clone=function(e){return e===undefined&&(e=new THREE.Material),e.name=this.name,e.side=this.side,e.opacity=this.opacity,e.transparent=this.transparent,e.blending=this.blending,e.blendSrc=this.blendSrc,e.blendDst=this.blendDst,e.blendEquation=this.blendEquation,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.polygonOffset=this.polygonOffset,e.polygonOffsetFactor=this.polygonOffsetFactor,e.polygonOffsetUnits=this.polygonOffsetUnits,e.alphaTest=this.alphaTest,e.overdraw=this.overdraw,e.visible=this.visible,e},THREE.MaterialCount=0,THREE.LineBasicMaterial=function(e){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.vertexColors=!1,this.fog=!0,this.setValues(e)},THREE.LineBasicMaterial.prototype=Object.create(THREE.Material.prototype),THREE.LineBasicMaterial.prototype.clone=function(){var e=new THREE.LineBasicMaterial;return THREE.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.linewidth=this.linewidth,e.linecap=this.linecap,e.linejoin=this.linejoin,e.vertexColors=this.vertexColors,e.fog=this.fog,e},THREE.MeshBasicMaterial=function(e){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.map=null,this.lightMap=null,this.specularMap=null,this.envMap=null,this.combine=THREE.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=THREE.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=THREE.NoColors,this.skinning=!1,this.morphTargets=!1,this.setValues(e)},THREE.MeshBasicMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshBasicMaterial.prototype.clone=function(){var e=new THREE.MeshBasicMaterial;return THREE.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.map=this.map,e.lightMap=this.lightMap,e.specularMap=this.specularMap,e.envMap=this.envMap,e.combine=this.combine,e.reflectivity=this.reflectivity,e.refractionRatio=this.refractionRatio,e.fog=this.fog,e.shading=this.shading,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.vertexColors=this.vertexColors,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e},THREE.MeshLambertMaterial=function(e){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.ambient=new THREE.Color(16777215),this.emissive=new THREE.Color(0),this.wrapAround=!1,this.wrapRGB=new THREE.Vector3(1,1,1),this.map=null,this.lightMap=null,this.specularMap=null,this.envMap=null,this.combine=THREE.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=THREE.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=THREE.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)},THREE.MeshLambertMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshLambertMaterial.prototype.clone=function(){var e=new THREE.MeshLambertMaterial;return THREE.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.ambient.copy(this.ambient),e.emissive.copy(this.emissive),e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.map=this.map,e.lightMap=this.lightMap,e.specularMap=this.specularMap,e.envMap=this.envMap,e.combine=this.combine,e.reflectivity=this.reflectivity,e.refractionRatio=this.refractionRatio,e.fog=this.fog,e.shading=this.shading,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.vertexColors=this.vertexColors,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e},THREE.MeshPhongMaterial=function(e){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.ambient=new THREE.Color(16777215),this.emissive=new THREE.Color(0),this.specular=new THREE.Color(1118481),this.shininess=30,this.metal=!1,this.perPixel=!1,this.wrapAround=!1,this.wrapRGB=new THREE.Vector3(1,1,1),this.map=null,this.lightMap=null,this.bumpMap=null,this.bumpScale=1,this.specularMap=null,this.envMap=null,this.combine=THREE.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=THREE.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.vertexColors=THREE.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)},THREE.MeshPhongMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshPhongMaterial.prototype.clone=function(){var e=new THREE.MeshPhongMaterial;return THREE.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.ambient.copy(this.ambient),e.emissive.copy(this.emissive),e.specular.copy(this.specular),e.shininess=this.shininess,e.metal=this.metal,e.perPixel=this.perPixel,e.wrapAround=this.wrapAround,e.wrapRGB.copy(this.wrapRGB),e.map=this.map,e.lightMap=this.lightMap,e.bumpMap=this.bumpMap,e.bumpScale=this.bumpScale,e.specularMap=this.specularMap,e.envMap=this.envMap,e.combine=this.combine,e.reflectivity=this.reflectivity,e.refractionRatio=this.refractionRatio,e.fog=this.fog,e.shading=this.shading,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.wireframeLinecap=this.wireframeLinecap,e.wireframeLinejoin=this.wireframeLinejoin,e.vertexColors=this.vertexColors,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e},THREE.MeshDepthMaterial=function(e){THREE.Material.call(this),this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)},THREE.MeshDepthMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshDepthMaterial.prototype.clone=function(){var e=new THREE.LineBasicMaterial;return THREE.Material.prototype.clone.call(this,e),e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e},THREE.MeshNormalMaterial=function(e){THREE.Material.call(this,e),this.shading=THREE.FlatShading,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)},THREE.MeshNormalMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshNormalMaterial.prototype.clone=function(){var e=new THREE.MeshNormalMaterial;return THREE.Material.prototype.clone.call(this,e),e.shading=this.shading,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e},THREE.MeshFaceMaterial=function(){},THREE.MeshFaceMaterial.prototype.clone=function(){return new THREE.MeshFaceMaterial},THREE.ParticleBasicMaterial=function(e){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.vertexColors=!1,this.fog=!0,this.setValues(e)},THREE.ParticleBasicMaterial.prototype=Object.create(THREE.Material.prototype),THREE.ParticleBasicMaterial.prototype.clone=function(){var e=new THREE.ParticleBasicMaterial;return THREE.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.map=this.map,e.size=this.size,e.sizeAttenuation=this.sizeAttenuation,e.vertexColors=this.vertexColors,e.fog=this.fog,e},THREE.ParticleCanvasMaterial=function(e){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.program=function(e,t){},this.setValues(e)},THREE.ParticleCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.ParticleCanvasMaterial.prototype.clone=function(){var e=new THREE.ParticleCanvasMaterial;return THREE.Material.prototype.clone.call(this,e),e.color.copy(this.color),e.program=this.program,e},THREE.ParticleDOMMaterial=function(e){this.domElement=e},THREE.ParticleDOMMaterial.prototype.clone=function(){return new THREE.ParticleDOMMaterial(this.domElement)},THREE.ShaderMaterial=function(e){THREE.Material.call(this),this.fragmentShader="void main() {}",this.vertexShader="void main() {}",this.uniforms={},this.attributes=null,this.shading=THREE.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.vertexColors=THREE.NoColors,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)},THREE.ShaderMaterial.prototype=Object.create(THREE.Material.prototype),THREE.ShaderMaterial.prototype.clone=function(){var e=new THREE.ShaderMaterial;return THREE.Material.prototype.clone.call(this,e),e.fragmentShader=this.fragmentShader,e.vertexShader=this.vertexShader,e.uniforms=this.uniforms,e.attributes=this.attributes,e.shading=this.shading,e.wireframe=this.wireframe,e.wireframeLinewidth=this.wireframeLinewidth,e.fog=this.fog,e.lights=this.lights,e.vertexColors=this.vertexColors,e.skinning=this.skinning,e.morphTargets=this.morphTargets,e.morphNormals=this.morphNormals,e},THREE.Texture=function(e,t,n,r,i,s,o,u,a){this.id=THREE.TextureCount++,this.image=e,this.mapping=t!==undefined?t:new THREE.UVMapping,this.wrapS=n!==undefined?n:THREE.ClampToEdgeWrapping,this.wrapT=r!==undefined?r:THREE.ClampToEdgeWrapping,this.magFilter=i!==undefined?i:THREE.LinearFilter,this.minFilter=s!==undefined?s:THREE.LinearMipMapLinearFilter,this.anisotropy=a!==undefined?a:1,this.format=o!==undefined?o:THREE.RGBAFormat,this.type=u!==undefined?u:THREE.UnsignedByteType,this.offset=new THREE.Vector2(0,0),this.repeat=new THREE.Vector2(1,1),this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.needsUpdate=!1,this.onUpdate=null},THREE.Texture.prototype={constructor:THREE.Texture,clone:function(){var e=new THREE.Texture(this.image,this.mapping,this.wrapS,this.wrapT,this.magFilter,this.minFilter,this.format,this.type,this.anisotropy);return e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.generateMipmaps=this.generateMipmaps,e.premultiplyAlpha=this.premultiplyAlpha,e.flipY=this.flipY,e}},THREE.TextureCount=0,THREE.DataTexture=function(e,t,n,r,i,s,o,u,a,f){THREE.Texture.call(this,null,s,o,u,a,f,r,i),this.image={data:e,width:t,height:n}},THREE.DataTexture.prototype=Object.create(THREE.Texture.prototype),THREE.DataTexture.prototype.clone=function(){var e=new THREE.DataTexture(this.image.data,this.image.width,this.image.height,this.format,this.type,this.mapping,this.wrapS,this.wrapT,this.magFilter,this.minFilter);return e.offset.copy(this.offset),e.repeat.copy(this.repeat),e},THREE.Particle=function(e){THREE.Object3D.call(this),this.material=e},THREE.Particle.prototype=Object.create(THREE.Object3D.prototype),THREE.ParticleSystem=function(e,t){THREE.Object3D.call(this),this.geometry=e,this.material=t!==undefined?t:new THREE.ParticleBasicMaterial({color:Math.random()*16777215}),this.sortParticles=!1,this.geometry&&(this.geometry.boundingSphere||this.geometry.computeBoundingSphere(),this.boundRadius=e.boundingSphere.radius),this.frustumCulled=!1},THREE.ParticleSystem.prototype=Object.create(THREE.Object3D.prototype),THREE.Line=function(e,t,n){THREE.Object3D.call(this),this.geometry=e,this.material=t!==undefined?t:new THREE.LineBasicMaterial({color:Math.random()*16777215}),this.type=n!==undefined?n:THREE.LineStrip,this.geometry&&(this.geometry.boundingSphere||this.geometry.computeBoundingSphere())},THREE.LineStrip=0,THREE.LinePieces=1,THREE.Line.prototype=Object.create(THREE.Object3D.prototype),THREE.Mesh=function(e,t){THREE.Object3D.call(this),this.geometry=e,this.material=t!==undefined?t:new THREE.MeshBasicMaterial({color:Math.random()*16777215,wireframe:!0});if(this.geometry){this.geometry.boundingSphere||this.geometry.computeBoundingSphere(),this.boundRadius=e.boundingSphere.radius;if(this.geometry.morphTargets.length){this.morphTargetBase=-1,this.morphTargetForcedOrder=[],this.morphTargetInfluences=[],this.morphTargetDictionary={};for(var n=0;n<this.geometry.morphTargets.length;n++)this.morphTargetInfluences.push(0),this.morphTargetDictionary[this.geometry.morphTargets[n].name]=n}}},THREE.Mesh.prototype=Object.create(THREE.Object3D.prototype),THREE.Mesh.prototype.getMorphTargetIndexByName=function(e){return this.morphTargetDictionary[e]!==undefined?this.morphTargetDictionary[e]:(console.log("THREE.Mesh.getMorphTargetIndexByName: morph target "+e+" does not exist. Returning 0."),0)},THREE.Bone=function(e){THREE.Object3D.call(this),this.skin=e,this.skinMatrix=new THREE.Matrix4},THREE.Bone.prototype=Object.create(THREE.Object3D.prototype),THREE.Bone.prototype.update=function(e,t){this.matrixAutoUpdate&&(t|=this.updateMatrix());if(t||this.matrixWorldNeedsUpdate)e?this.skinMatrix.multiply(e,this.matrix):this.skinMatrix.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0;var n,r,i=this.children.length;for(r=0;r<i;r++)this.children[r].update(this.skinMatrix,t)},THREE.SkinnedMesh=function(e,t,n){THREE.Mesh.call(this,e,t),this.useVertexTexture=n!==undefined?n:!0,this.identityMatrix=new THREE.Matrix4,this.bones=[],this.boneMatrices=[];var r,i,s,o,u,a;if(this.geometry.bones!==undefined){for(r=0;r<this.geometry.bones.length;r++)s=this.geometry.bones[r],o=s.pos,u=s.rotq,a=s.scl,i=this.addBone(),i.name=s.name,i.position.set(o[0],o[1],o[2]),i.quaternion.set(u[0],u[1],u[2],u[3]),i.useQuaternion=!0,a!==undefined?i.scale.set(a[0],a[1],a[2]):i.scale.set(1,1,1);for(r=0;r<this.bones.length;r++)s=this.geometry.bones[r],i=this.bones[r],s.parent===-1?this.add(i):this.bones[s.parent].add(i);var f=this.bones.length;if(this.useVertexTexture){var l;f>256?l=64:f>64?l=32:f>16?l=16:l=8,this.boneTextureWidth=l,this.boneTextureHeight=l,this.boneMatrices=new Float32Array(this.boneTextureWidth*this.boneTextureHeight*4),this.boneTexture=new THREE.DataTexture(this.boneMatrices,this.boneTextureWidth,this.boneTextureHeight,THREE.RGBAFormat,THREE.FloatType),this.boneTexture.minFilter=THREE.NearestFilter,this.boneTexture.magFilter=THREE.NearestFilter,this.boneTexture.generateMipmaps=!1,this.boneTexture.flipY=!1}else this.boneMatrices=new Float32Array(16*f);this.pose()}},THREE.SkinnedMesh.prototype=Object.create(THREE.Mesh.prototype),THREE.SkinnedMesh.prototype.addBone=function(e){return e===undefined&&(e=new THREE.Bone(this)),this.bones.push(e),e},THREE.SkinnedMesh.prototype.updateMatrixWorld=function(e){this.matrixAutoUpdate&&this.updateMatrix();if(this.matrixWorldNeedsUpdate||e)this.parent?this.matrixWorld.multiply(this.parent.matrixWorld,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0;for(var t=0,n=this.children.length;t<n;t++){var r=this.children[t];r instanceof THREE.Bone?r.update(this.identityMatrix,!1):r.updateMatrixWorld(!0)}var i,s=this.bones.length,o=this.bones,u=this.boneMatrices;for(i=0;i<s;i++)o[i].skinMatrix.flattenToArrayOffset(u,i*16);this.useVertexTexture&&(this.boneTexture.needsUpdate=!0)},THREE.SkinnedMesh.prototype.pose=function(){this.updateMatrixWorld(!0);var e,t,n=[];for(var r=0;r<this.bones.length;r++){t=this.bones[r];var i=new THREE.Matrix4;i.getInverse(t.skinMatrix),n.push(i),t.skinMatrix.flattenToArrayOffset(this.boneMatrices,r*16)}if(this.geometry.skinVerticesA===undefined){this.geometry.skinVerticesA=[],this.geometry.skinVerticesB=[];var s,o;for(var u=0;u<this.geometry.skinIndices.length;u++){s=this.geometry.vertices[u];var a=this.geometry.skinIndices[u].x,f=this.geometry.skinIndices[u].y;o=new THREE.Vector3(s.x,s.y,s.z),this.geometry.skinVerticesA.push(n[a].multiplyVector3(o)),o=new THREE.Vector3(s.x,s.y,s.z),this.geometry.skinVerticesB.push(n[f].multiplyVector3(o));if(this.geometry.skinWeights[u].x+this.geometry.skinWeights[u].y!==1){var l=(1-(this.geometry.skinWeights[u].x+this.geometry.skinWeights[u].y))*.5;this.geometry.skinWeights[u].x+=l,this.geometry.skinWeights[u].y+=l}}}},THREE.MorphAnimMesh=function(e,t){THREE.Mesh.call(this,e,t),this.duration=1e3,this.mirroredLoop=!1,this.time=0,this.lastKeyframe=0,this.currentKeyframe=0,this.direction=1,this.directionBackwards=!1,this.setFrameRange(0,this.geometry.morphTargets.length-1)},THREE.MorphAnimMesh.prototype=Object.create(THREE.Mesh.prototype),THREE.MorphAnimMesh.prototype.setFrameRange=function(e,t){this.startKeyframe=e,this.endKeyframe=t,this.length=this.endKeyframe-this.startKeyframe+1},THREE.MorphAnimMesh.prototype.setDirectionForward=function(){this.direction=1,this.directionBackwards=!1},THREE.MorphAnimMesh.prototype.setDirectionBackward=function(){this.direction=-1,this.directionBackwards=!0},THREE.MorphAnimMesh.prototype.parseAnimations=function(){var e=this.geometry;e.animations||(e.animations={});var t,n=e.animations,r=/([a-z]+)(\d+)/;for(var i=0,s=e.morphTargets.length;i<s;i++){var o=e.morphTargets[i],u=o.name.match(r);if(u&&u.length>1){var a=u[1],f=u[2];n[a]||(n[a]={start:Infinity,end:-Infinity});var l=n[a];i<l.start&&(l.start=i),i>l.end&&(l.end=i),t||(t=a)}}e.firstAnimation=t},THREE.MorphAnimMesh.prototype.setAnimationLabel=function(e,t,n){this.geometry.animations||(this.geometry.animations={}),this.geometry.animations[e]={start:t,end:n}},THREE.MorphAnimMesh.prototype.playAnimation=function(e,t){var n=this.geometry.animations[e];n?(this.setFrameRange(n.start,n.end),this.duration=1e3*((n.end-n.start)/t),this.time=0):console.warn("animation["+e+"] undefined")},THREE.MorphAnimMesh.prototype.updateAnimation=function(e){var t=this.duration/this.length;this.time+=this.direction*e;if(this.mirroredLoop){if(this.time>this.duration||this.time<0)this.direction*=-1,this.time>this.duration&&(this.time=this.duration,this.directionBackwards=!0),this.time<0&&(this.time=0,this.directionBackwards=!1)}else this.time=this.time%this.duration,this.time<0&&(this.time+=this.duration);var n=this.startKeyframe+THREE.Math.clamp(Math.floor(this.time/t),0,this.length-1);n!==this.currentKeyframe&&(this.morphTargetInfluences[this.lastKeyframe]=0,this.morphTargetInfluences[this.currentKeyframe]=1,this.morphTargetInfluences[n]=0,this.lastKeyframe=this.currentKeyframe,this.currentKeyframe=n);var r=this.time%t/t;this.directionBackwards&&(r=1-r),this.morphTargetInfluences[this.currentKeyframe]=r,this.morphTargetInfluences[this.lastKeyframe]=1-r},THREE.Ribbon=function(e,t){THREE.Object3D.call(this),this.geometry=e,this.material=t},THREE.Ribbon.prototype=Object.create(THREE.Object3D.prototype),THREE.LOD=function(){THREE.Object3D.call(this),this.LODs=[]},THREE.LOD.prototype=Object.create(THREE.Object3D.prototype),THREE.LOD.prototype.addLevel=function(e,t){t===undefined&&(t=0),t=Math.abs(t);for(var n=0;n<this.LODs.length;n++)if(t<this.LODs[n].visibleAtDistance)break;this.LODs.splice(n,0,{visibleAtDistance:t,object3D:e}),this.add(e)},THREE.LOD.prototype.update=function(e){if(this.LODs.length>1){e.matrixWorldInverse.getInverse(e.matrixWorld);var t=e.matrixWorldInverse,n=-(t.elements[2]*this.matrixWorld.elements[12]+t.elements[6]*this.matrixWorld.elements[13]+t.elements[10]*this.matrixWorld.elements[14]+t.elements[14]);this.LODs[0].object3D.visible=!0;for(var r=1;r<this.LODs.length;r++){if(!(n>=this.LODs[r].visibleAtDistance))break;this.LODs[r-1].object3D.visible=!1,this.LODs[r].object3D.visible=!0}for(;r<this.LODs.length;r++)this.LODs[r].object3D.visible=!1}},THREE.Sprite=function(e){THREE.Object3D.call(this),this.color=e.color!==undefined?new THREE.Color(e.color):new THREE.Color(16777215),this.map=e.map!==undefined?e.map:new THREE.Texture,this.blending=e.blending!==undefined?e.blending:THREE.NormalBlending,this.blendSrc=e.blendSrc!==undefined?e.blendSrc:THREE.SrcAlphaFactor,this.blendDst=e.blendDst!==undefined?e.blendDst:THREE.OneMinusSrcAlphaFactor,this.blendEquation=e.blendEquation!==undefined?e.blendEquation:THREE.AddEquation,this.useScreenCoordinates=e.useScreenCoordinates!==undefined?e.useScreenCoordinates:!0,this.mergeWith3D=e.mergeWith3D!==undefined?e.mergeWith3D:!this.useScreenCoordinates,this.affectedByDistance=e.affectedByDistance!==undefined?e.affectedByDistance:!this.useScreenCoordinates,this.scaleByViewport=e.scaleByViewport!==undefined?e.scaleByViewport:!this.affectedByDistance,this.alignment=e.alignment instanceof THREE.Vector2?e.alignment:THREE.SpriteAlignment.center,this.rotation3d=this.rotation,this.rotation=0,this.opacity=1,this.uvOffset=new THREE.Vector2(0,0),this.uvScale=new THREE.Vector2(1,1)},THREE.Sprite.prototype=Object.create(THREE.Object3D.prototype),THREE.Sprite.prototype.updateMatrix=function(){this.matrix.setPosition(this.position),this.rotation3d.set(0,0,this.rotation),this.matrix.setRotationFromEuler(this.rotation3d);if(this.scale.x!==1||this.scale.y!==1)this.matrix.scale(this.scale),this.boundRadiusScale=Math.max(this.scale.x,this.scale.y);this.matrixWorldNeedsUpdate=!0},THREE.SpriteAlignment={},THREE.SpriteAlignment.topLeft=new THREE.Vector2(1,-1),THREE.SpriteAlignment.topCenter=new THREE.Vector2(0,-1),THREE.SpriteAlignment.topRight=new THREE.Vector2(-1,-1),THREE.SpriteAlignment.centerLeft=new THREE.Vector2(1,0),THREE.SpriteAlignment.center=new THREE.Vector2(0,0),THREE.SpriteAlignment.centerRight=new THREE.Vector2(-1,0),THREE.SpriteAlignment.bottomLeft=new THREE.Vector2(1,1),THREE.SpriteAlignment.bottomCenter=new THREE.Vector2(0,1),THREE.SpriteAlignment.bottomRight=new THREE.Vector2(-1,1),THREE.Scene=function(){THREE.Object3D.call(this),this.fog=null,this.overrideMaterial=null,this.matrixAutoUpdate=!1,this.__objects=[],this.__lights=[],this.__objectsAdded=[],this.__objectsRemoved=[]},THREE.Scene.prototype=Object.create(THREE.Object3D.prototype),THREE.Scene.prototype.__addObject=function(e){if(e instanceof THREE.Light)this.__lights.indexOf(e)===-1&&this.__lights.push(e),e.target&&e.target.parent===undefined&&this.add(e.target);else if(!(e instanceof THREE.Camera||e instanceof THREE.Bone)&&this.__objects.indexOf(e)===-1){this.__objects.push(e),this.__objectsAdded.push(e);var t=this.__objectsRemoved.indexOf(e);t!==-1&&this.__objectsRemoved.splice(t,1)}for(var n=0;n<e.children.length;n++)this.__addObject(e.children[n])},THREE.Scene.prototype.__removeObject=function(e){if(e instanceof THREE.Light){var t=this.__lights.indexOf(e);t!==-1&&this.__lights.splice(t,1)}else if(!(e instanceof THREE.Camera)){var t=this.__objects.indexOf(e);if(t!==-1){this.__objects.splice(t,1),this.__objectsRemoved.push(e);var n=this.__objectsAdded.indexOf(e);n!==-1&&this.__objectsAdded.splice(n,1)}}for(var r=0;r<e.children.length;r++)this.__removeObject(e.children[r])},THREE.Fog=function(e,t,n){this.color=new THREE.Color(e),this.near=t!==undefined?t:1,this.far=n!==undefined?n:1e3},THREE.FogExp2=function(e,t){this.color=new THREE.Color(e),this.density=t!==undefined?t:25e-5},THREE.CanvasRenderer=function(e){function yt(e){d!==e&&(c.globalAlpha=e,d=e)}function bt(e){v!==e&&(e===THREE.NormalBlending?c.globalCompositeOperation="source-over":e===THREE.AdditiveBlending?c.globalCompositeOperation="lighter":e===THREE.SubtractiveBlending&&(c.globalCompositeOperation="darker"),v=e)}function wt(e){y!==e&&(c.lineWidth=e,y=e)}function Et(e){b!==e&&(c.lineCap=e,b=e)}function St(e){w!==e&&(c.lineJoin=e,w=e)}function xt(e){m!==e&&(c.strokeStyle=e,m=e)}function Tt(e){g!==e&&(c.fillStyle=e,g=e)}console.log("THREE.CanvasRenderer",THREE.REVISION),e=e||{};var t=this,n,r,i,s=new THREE.Projector,o=e.canvas!==undefined?e.canvas:document.createElement("canvas"),u,a,f,l,c=o.getContext("2d"),h=new THREE.Color(0),p=0,d=1,v=0,m=null,g=null,y=null,b=null,w=null,E,S,x,T,N=new THREE.RenderableVertex,C=new THREE.RenderableVertex,k,L,A,O,M,_,D,P,H,B,j,F,I=new THREE.Color,q=new THREE.Color,R=new THREE.Color,U=new THREE.Color,z=new THREE.Color,W=[],X=[],V,$,J,K,Q,G,Y,Z,et,tt,nt=new THREE.Rectangle,rt=new THREE.Rectangle,it=new THREE.Rectangle,st=!1,ot=new THREE.Color,ut=new THREE.Color,at=new THREE.Color,ft=Math.PI*2,lt=new THREE.Vector3,ct,ht,pt,dt,vt,mt,gt=16;ct=document.createElement("canvas"),ct.width=ct.height=2,ht=ct.getContext("2d"),ht.fillStyle="rgba(0,0,0,1)",ht.fillRect(0,0,2,2),pt=ht.getImageData(0,0,2,2),dt=pt.data,vt=document.createElement("canvas"),vt.width=vt.height=gt,mt=vt.getContext("2d"),mt.translate(-gt/2,-gt/2),mt.scale(gt,gt),gt--,this.domElement=o,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.setSize=function(e,t){u=e,a=t,f=Math.floor(u/2),l=Math.floor(a/2),o.width=u,o.height=a,nt.set(-f,-l,f,l),rt.set(-f,-l,f,l),d=1,v=0,m=null,g=null,y=null,b=null,w=null},this.setClearColor=function(e,t){h.copy(e),p=t!==undefined?t:1,rt.set(-f,-l,f,l)},this.setClearColorHex=function(e,t){h.setHex(e),p=t!==undefined?t:1,rt.set(-f,-l,f,l)},this.clear=function(){c.setTransform(1,0,0,-1,f,l),rt.isEmpty()===!1&&(rt.minSelf(nt),rt.inflate(2),p<1&&c.clearRect(Math.floor(rt.getX()),Math.floor(rt.getY()),Math.floor(rt.getWidth()),Math.floor(rt.getHeight())),p>0&&(bt(THREE.NormalBlending),yt(1),Tt("rgba("+Math.floor(h.r*255)+","+Math.floor(h.g*255)+","+Math.floor(h.b*255)+","+p+")"),c.fillRect(Math.floor(rt.getX()),Math.floor(rt.getY()),Math.floor(rt.getWidth()),Math.floor(rt.getHeight()))),rt.empty())},this.render=function(e,o){function d(e){var t,n,r,i;ot.setRGB(0,0,0),ut.setRGB(0,0,0),at.setRGB(0,0,0);for(t=0,n=e.length;t<n;t++)r=e[t],i=r.color,r instanceof THREE.AmbientLight?(ot.r+=i.r,ot.g+=i.g,ot.b+=i.b):r instanceof THREE.DirectionalLight?(ut.r+=i.r,ut.g+=i.g,ut.b+=i.b):r instanceof THREE.PointLight&&(at.r+=i.r,at.g+=i.g,at.b+=i.b)}function v(e,t,n,r){var i,s,o,u,a,f;for(i=0,s=e.length;i<s;i++){o=e[i],u=o.color;if(o instanceof THREE.DirectionalLight){a=o.matrixWorld.getPosition().normalize(),f=n.dot(a);if(f<=0)continue;f*=o.intensity,r.r+=u.r*f,r.g+=u.g*f,r.b+=u.b*f}else if(o instanceof THREE.PointLight){a=o.matrixWorld.getPosition(),f=n.dot(lt.sub(a,t).normalize());if(f<=0)continue;f*=o.distance==0?1:1-Math.min(t.distanceTo(a)/o.distance,1);if(f==0)continue;f*=o.intensity,r.r+=u.r*f,r.g+=u.g*f,r.b+=u.b*f}}}function m(e,t,n,r){yt(n.opacity),bt(n.blending);var i,s,o,u,a,h,p;if(n instanceof THREE.ParticleBasicMaterial)if(n.map===null){o=t.object.scale.x,u=t.object.scale.y,o*=t.scale.x*f,u*=t.scale.y*l,it.set(e.x-o,e.y-u,e.x+o,e.y+u);if(nt.intersects(it)===!1)return;Tt(n.color.getContextStyle()),c.save(),c.translate(e.x,e.y),c.rotate(-t.rotation),c.scale(o,u),c.fillRect(-1,-1,2,2),c.restore()}else{a=n.map.image,h=a.width>>1,p=a.height>>1,o=t.scale.x*f,u=t.scale.y*l,i=o*h,s=u*p,it.set(e.x-i,e.y-s,e.x+i,e.y+s);if(nt.intersects(it)===!1)return;c.save(),c.translate(e.x,e.y),c.rotate(-t.rotation),c.scale(o,-u),c.translate(-h,-p),c.drawImage(a,0,0),c.restore()}else if(n instanceof THREE.ParticleCanvasMaterial){i=t.scale.x*f,s=t.scale.y*l,it.set(e.x-i,e.y-s,e.x+i,e.y+s);if(nt.intersects(it)===!1)return;xt(n.color.getContextStyle()),Tt(n.color.getContextStyle()),c.save(),c.translate(e.x,e.y),c.rotate(-t.rotation),c.scale(i,s),n.program(c),c.restore()}}function g(e,t,n,r,i){yt(r.opacity),bt(r.blending),c.beginPath(),c.moveTo(e.positionScreen.x,e.positionScreen.y),c.lineTo(t.positionScreen.x,t.positionScreen.y),c.closePath(),r instanceof THREE.LineBasicMaterial&&(wt(r.linewidth),Et(r.linecap),St(r.linejoin),xt(r.color.getContextStyle()),c.stroke(),it.inflate(r.linewidth*2))}function y(e,n,r,s,u,a,f,l,c){t.info.render.vertices+=3,t.info.render.faces++,yt(l.opacity),bt(l.blending),k=e.positionScreen.x,L=e.positionScreen.y,A=n.positionScreen.x,O=n.positionScreen.y,M=r.positionScreen.x,_=r.positionScreen.y,w(k,L,A,O,M,_);if(l instanceof THREE.MeshBasicMaterial)if(l.map!==null)l.map.mapping instanceof THREE.UVMapping&&(K=f.uvs[0],Ct(k,L,A,O,M,_,K[s].u,K[s].v,K[u].u,K[u].v,K[a].u,K[a].v,l.map));else if(l.envMap!==null){if(l.envMap.mapping instanceof THREE.SphericalReflectionMapping){var h=o.matrixWorldInverse;lt.copy(f.vertexNormalsWorld[s]),Q=(lt.x*h.elements[0]+lt.y*h.elements[4]+lt.z*h.elements[8])*.5+.5,G=(lt.x*h.elements[1]+lt.y*h.elements[5]+lt.z*h.elements[9])*.5+.5,lt.copy(f.vertexNormalsWorld[u]),Y=(lt.x*h.elements[0]+lt.y*h.elements[4]+lt.z*h.elements[8])*.5+.5,Z=(lt.x*h.elements[1]+lt.y*h.elements[5]+lt.z*h.elements[9])*.5+.5,lt.copy(f.vertexNormalsWorld[a]),et=(lt.x*h.elements[0]+lt.y*h.elements[4]+lt.z*h.elements[8])*.5+.5,tt=(lt.x*h.elements[1]+lt.y*h.elements[5]+lt.z*h.elements[9])*.5+.5,Ct(k,L,A,O,M,_,Q,G,Y,Z,et,tt,l.envMap)}}else l.wireframe===!0?gt(l.color,l.wireframeLinewidth,l.wireframeLinecap,l.wireframeLinejoin):Nt(l.color);else l instanceof THREE.MeshLambertMaterial?st===!0?l.wireframe===!1&&l.shading==THREE.SmoothShading&&f.vertexNormalsWorld.length==3?(q.r=R.r=U.r=ot.r,q.g=R.g=U.g=ot.g,q.b=R.b=U.b=ot.b,v(i,f.v1.positionWorld,f.vertexNormalsWorld[0],q),v(i,f.v2.positionWorld,f.vertexNormalsWorld[1],R),v(i,f.v3.positionWorld,f.vertexNormalsWorld[2],U),q.r=Math.max(0,Math.min(l.color.r*q.r,1)),q.g=Math.max(0,Math.min(l.color.g*q.g,1)),q.b=Math.max(0,Math.min(l.color.b*q.b,1)),R.r=Math.max(0,Math.min(l.color.r*R.r,1)),R.g=Math.max(0,Math.min(l.color.g*R.g,1)),R.b=Math.max(0,Math.min(l.color.b*R.b,1)),U.r=Math.max(0,Math.min(l.color.r*U.r,1)),U.g=Math.max(0,Math.min(l.color.g*U.g,1)),U.b=Math.max(0,Math.min(l.color.b*U.b,1)),z.r=(R.r+U.r)*.5,z.g=(R.g+U.g)*.5,z.b=(R.b+U.b)*.5,J=Lt(q,R,U,z),kt(k,L,A,O,M,_,0,0,1,0,0,1,J)):(I.r=ot.r,I.g=ot.g,I.b=ot.b,v(i,f.centroidWorld,f.normalWorld,I),I.r=Math.max(0,Math.min(l.color.r*I.r,1)),I.g=Math.max(0,Math.min(l.color.g*I.g,1)),I.b=Math.max(0,Math.min(l.color.b*I.b,1)),l.wireframe===!0?gt(I,l.wireframeLinewidth,l.wireframeLinecap,l.wireframeLinejoin):Nt(I)):l.wireframe===!0?gt(l.color,l.wireframeLinewidth,l.wireframeLinecap,l.wireframeLinejoin):Nt(l.color):l instanceof THREE.MeshDepthMaterial?(V=o.near,$=o.far,q.r=q.g=q.b=1-At(e.positionScreen.z,V,$),R.r=R.g=R.b=1-At(n.positionScreen.z,V,$),U.r=U.g=U.b=1-At(r.positionScreen.z,V,$),z.r=(R.r+U.r)*.5,z.g=(R.g+U.g)*.5,z.b=(R.b+U.b)*.5,J=Lt(q,R,U,z),kt(k,L,A,O,M,_,0,0,1,0,0,1,J)):l instanceof THREE.MeshNormalMaterial&&(I.r=Ot(f.normalWorld.x),I.g=Ot(f.normalWorld.y),I.b=Ot(f.normalWorld.z),l.wireframe===!0?gt(I,l.wireframeLinewidth,l.wireframeLinecap,l.wireframeLinejoin):Nt(I))}function b(e,n,r,s,u,a,f,l,c){t.info.render.vertices+=4,t.info.render.faces++,yt(l.opacity),bt(l.blending);if(l.map!==undefined&&l.map!==null||l.envMap!==undefined&&l.envMap!==null){y(e,n,s,0,1,3,f,l,c),y(u,r,a,1,2,3,f,l,c);return}k=e.positionScreen.x,L=e.positionScreen.y,A=n.positionScreen.x,O=n.positionScreen.y,M=r.positionScreen.x,_=r.positionScreen.y,D=s.positionScreen.x,P=s.positionScreen.y,H=u.positionScreen.x,B=u.positionScreen.y,j=a.positionScreen.x,F=a.positionScreen.y,l instanceof THREE.MeshBasicMaterial?(ft(k,L,A,O,M,_,D,P),l.wireframe===!0?gt(l.color,l.wireframeLinewidth,l.wireframeLinecap,l.wireframeLinejoin):Nt(l.color)):l instanceof THREE.MeshLambertMaterial?st===!0?!l.wireframe&&l.shading==THREE.SmoothShading&&f.vertexNormalsWorld.length==4?(q.r=R.r=U.r=z.r=ot.r,q.g=R.g=U.g=z.g=ot.g,q.b=R.b=U.b=z.b=ot.b,v(i,f.v1.positionWorld,f.vertexNormalsWorld[0],q),v(i,f.v2.positionWorld,f.vertexNormalsWorld[1],R),v(i,f.v4.positionWorld,f.vertexNormalsWorld[3],U),v(i,f.v3.positionWorld,f.vertexNormalsWorld[2],z),q.r=Math.max(0,Math.min(l.color.r*q.r,1)),q.g=Math.max(0,Math.min(l.color.g*q.g,1)),q.b=Math.max(0,Math.min(l.color.b*q.b,1)),R.r=Math.max(0,Math.min(l.color.r*R.r,1)),R.g=Math.max(0,Math.min(l.color.g*R.g,1)),R.b=Math.max(0,Math.min(l.color.b*R.b,1)),U.r=Math.max(0,Math.min(l.color.r*U.r,1)),U.g=Math.max(0,Math.min(l.color.g*U.g,1)),U.b=Math.max(0,Math.min(l.color.b*U.b,1)),z.r=Math.max(0,Math.min(l.color.r*z.r,1)),z.g=Math.max(0,Math.min(l.color.g*z.g,1)),z.b=Math.max(0,Math.min(l.color.b*z.b,1)),J=Lt(q,R,U,z),w(k,L,A,O,D,P),kt(k,L,A,O,D,P,0,0,1,0,0,1,J),w(H,B,M,_,j,F),kt(H,B,M,_,j,F,1,0,1,1,0,1,J)):(I.r=ot.r,I.g=ot.g,I.b=ot.b,v(i,f.centroidWorld,f.normalWorld,I),I.r=Math.max(0,Math.min(l.color.r*I.r,1)),I.g=Math.max(0,Math.min(l.color.g*I.g,1)),I.b=Math.max(0,Math.min(l.color.b*I.b,1)),ft(k,L,A,O,M,_,D,P),l.wireframe===!0?gt(I,l.wireframeLinewidth,l.wireframeLinecap,l.wireframeLinejoin):Nt(I)):(ft(k,L,A,O,M,_,D,P),l.wireframe===!0?gt(l.color,l.wireframeLinewidth,l.wireframeLinecap,l.wireframeLinejoin):Nt(l.color)):l instanceof THREE.MeshNormalMaterial?(I.r=Ot(f.normalWorld.x),I.g=Ot(f.normalWorld.y),I.b=Ot(f.normalWorld.z),ft(k,L,A,O,M,_,D,P),l.wireframe===!0?gt(I,l.wireframeLinewidth,l.wireframeLinecap,l.wireframeLinejoin):Nt(I)):l instanceof THREE.MeshDepthMaterial&&(V=o.near,$=o.far,q.r=q.g=q.b=1-At(e.positionScreen.z,V,$),R.r=R.g=R.b=1-At(n.positionScreen.z,V,$),U.r=U.g=U.b=1-At(s.positionScreen.z,V,$),z.r=z.g=z.b=1-At(r.positionScreen.z,V,$),J=Lt(q,R,U,z),w(k,L,A,O,D,P),kt(k,L,A,O,D,P,0,0,1,0,0,1,J),w(H,B,M,_,j,F),kt(H,B,M,_,j,F,1,0,1,1,0,1,J))}function w(e,t,n,r,i,s){c.beginPath(),c.moveTo(e,t),c.lineTo(n,r),c.lineTo(i,s),c.lineTo(e,t)}function ft(e,t,n,r,i,s,o,u){c.beginPath(),c.moveTo(e,t),c.lineTo(n,r),c.lineTo(i,s),c.lineTo(o,u),c.lineTo(e,t)}function gt(e,t,n,r){wt(t),Et(n),St(r),xt(e.getContextStyle()),c.stroke(),it.inflate(t*2)}function Nt(e){Tt(e.getContextStyle()),c.fill()}function Ct(e,t,n,r,i,s,o,u,a,f,l,h,p){if(p.image===undefined||p.image.width===0)return;if(p.needsUpdate===!0||W[p.id]===undefined){var d=p.wrapS==THREE.RepeatWrapping,v=p.wrapT==THREE.RepeatWrapping;W[p.id]=c.createPattern(p.image,d===!0&&v===!0?"repeat":d===!0&&v===!1?"repeat-x":d===!1&&v===!0?"repeat-y":"no-repeat"),p.needsUpdate=!1}Tt(W[p.id]);var m,g,y,b,w,E,S,x,T=p.offset.x/p.repeat.x,N=p.offset.y/p.repeat.y,C=p.image.width*p.repeat.x,k=p.image.height*p.repeat.y;o=(o+T)*C,u=(1-u+N)*k,a=(a+T)*C,f=(1-f+N)*k,l=(l+T)*C,h=(1-h+N)*k,n-=e,r-=t,i-=e,s-=t,a-=o,f-=u,l-=o,h-=u,S=a*h-l*f;if(S===0){if(X[p.id]===undefined){var L=document.createElement("canvas");L.width=p.image.width,L.height=p.image.height;var A=L.getContext("2d");A.drawImage(p.image,0,0),X[p.id]=A.getImageData(0,0,p.image.width,p.image.height).data}var O=X[p.id],M=(Math.floor(o)+Math.floor(u)*p.image.width)*4;I.setRGB(O[M]/255,O[M+1]/255,O[M+2]/255),Nt(I);return}x=1/S,m=(h*n-f*i)*x,g=(h*r-f*s)*x,y=(a*i-l*n)*x,b=(a*s-l*r)*x,w=e-m*o-y*u,E=t-g*o-b*u,c.save(),c.transform(m,g,y,b,w,E),c.fill(),c.restore()}function kt(e,t,n,r,i,s,o,u,a,f,l,h,p){var d,v,m,g,y,b,w,E,S=p.width-1,x=p.height-1;o*=S,u*=x,a*=S,f*=x,l*=S,h*=x,n-=e,r-=t,i-=e,s-=t,a-=o,f-=u,l-=o,h-=u,w=a*h-l*f,E=1/w,d=(h*n-f*i)*E,v=(h*r-f*s)*E,m=(a*i-l*n)*E,g=(a*s-l*r)*E,y=e-d*o-m*u,b=t-v*o-g*u,c.save(),c.transform(d,v,m,g,y,b),c.clip(),c.drawImage(p,0,0),c.restore()}function Lt(e,t,n,r){var i=~~(e.r*255),s=~~(e.g*255),o=~~(e.b*255),u=~~(t.r*255),a=~~(t.g*255),f=~~(t.b*255),l=~~(n.r*255),c=~~(n.g*255),h=~~(n.b*255),p=~~(r.r*255),d=~~(r.g*255),v=~~(r.b*255);return dt[0]=i<0?0:i>255?255:i,dt[1]=s<0?0:s>255?255:s,dt[2]=o<0?0:o>255?255:o,dt[4]=u<0?0:u>255?255:u,dt[5]=a<0?0:a>255?255:a,dt[6]=f<0?0:f>255?255:f,dt[8]=l<0?0:l>255?255:l,dt[9]=c<0?0:c>255?255:c,dt[10]=h<0?0:h>255?255:h,dt[12]=p<0?0:p>255?255:p,dt[13]=d<0?0:d>255?255:d,dt[14]=v<0?0:v>255?255:v,ht.putImageData(pt,0,0),mt.drawImage(ct,0,0),vt}function At(e,t,n){var r=(e-t)/(n-t);return r*r*(3-2*r)}function Ot(e){var t=(e+1)*.5;return t<0?0:t>1?1:t}function Mt(e,t){var n=t.x-e.x,r=t.y-e.y,i=n*n+r*r,s;if(i===0)return;s=1/Math.sqrt(i),n*=s,r*=s,t.x+=n,t.y+=r,e.x-=n,e.y-=r}if(o instanceof THREE.Camera==0){console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");return}var u,a,h,p;this.autoClear===!0?this.clear():c.setTransform(1,0,0,-1,f,l),t.info.render.vertices=0,t.info.render.faces=0,n=s.projectScene(e,o,this.sortElements),r=n.elements,i=n.lights,st=i.length>0,st===!0&&d(i);for(u=0,a=r.length;u<a;u++){h=r[u],p=h.material;if(p===undefined||p.visible===!1)continue;it.empty(),h instanceof THREE.RenderableParticle?(E=h,E.x*=f,E.y*=l,m(E,h,p,e)):h instanceof THREE.RenderableLine?(E=h.v1,S=h.v2,E.positionScreen.x*=f,E.positionScreen.y*=l,S.positionScreen.x*=f,S.positionScreen.y*=l,it.addPoint(E.positionScreen.x,E.positionScreen.y),it.addPoint(S.positionScreen.x,S.positionScreen.y),nt.intersects(it)===!0&&g(E,S,h,p,e)):h instanceof THREE.RenderableFace3?(E=h.v1,S=h.v2,x=h.v3,E.positionScreen.x*=f,E.positionScreen.y*=l,S.positionScreen.x*=f,S.positionScreen.y*=l,x.positionScreen.x*=f,x.positionScreen.y*=l,p.overdraw===!0&&(Mt(E.positionScreen,S.positionScreen),Mt(S.positionScreen,x.positionScreen),Mt(x.positionScreen,E.positionScreen)),it.add3Points(E.positionScreen.x,E.positionScreen.y,S.positionScreen.x,S.positionScreen.y,x.positionScreen.x,x.positionScreen.y),nt.intersects(it)===!0&&y(E,S,x,0,1,2,h,p,e)):h instanceof THREE.RenderableFace4&&(E=h.v1,S=h.v2,x=h.v3,T=h.v4,E.positionScreen.x*=f,E.positionScreen.y*=l,S.positionScreen.x*=f,S.positionScreen.y*=l,x.positionScreen.x*=f,x.positionScreen.y*=l,T.positionScreen.x*=f,T.positionScreen.y*=l,N.positionScreen.copy(S.positionScreen),C.positionScreen.copy(T.positionScreen),p.overdraw===!0&&(Mt(E.positionScreen,S.positionScreen),Mt(S.positionScreen,T.positionScreen),Mt(T.positionScreen,E.positionScreen),Mt(x.positionScreen,N.positionScreen),Mt(x.positionScreen,C.positionScreen)),it.addPoint(E.positionScreen.x,E.positionScreen.y),it.addPoint(S.positionScreen.x,S.positionScreen.y),it.addPoint(x.positionScreen.x,x.positionScreen.y),it.addPoint(T.positionScreen.x,T.positionScreen.y),nt.intersects(it)===!0&&b(E,S,x,T,N,C,h,p,e)),rt.addRectangle(it)}c.setTransform(1,0,0,1,0,0)}},THREE.ShaderChunk={fog_pars_fragment:["#ifdef USE_FOG","uniform vec3 fogColor;","#ifdef FOG_EXP2","uniform float fogDensity;","#else","uniform float fogNear;","uniform float fogFar;","#endif","#endif"].join("\n"),fog_fragment:["#ifdef USE_FOG","float depth = gl_FragCoord.z / gl_FragCoord.w;","#ifdef FOG_EXP2","const float LOG2 = 1.442695;","float fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","#else","float fogFactor = smoothstep( fogNear, fogFar, depth );","#endif","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","#endif"].join("\n"),envmap_pars_fragment:["#ifdef USE_ENVMAP","uniform float reflectivity;","uniform samplerCube envMap;","uniform float flipEnvMap;","uniform int combine;","#ifdef USE_BUMPMAP","uniform bool useRefract;","uniform float refractionRatio;","#else","varying vec3 vReflect;","#endif","#endif"].join("\n"),envmap_fragment:["#ifdef USE_ENVMAP","vec3 reflectVec;","#ifdef USE_BUMPMAP","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","if ( useRefract ) {","reflectVec = refract( cameraToVertex, normal, refractionRatio );","} else { ","reflectVec = reflect( cameraToVertex, normal );","}","#else","reflectVec = vReflect;","#endif","#ifdef DOUBLE_SIDED","float flipNormal = ( -1.0 + 2.0 * float( gl_FrontFacing ) );","vec4 cubeColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );","#else","vec4 cubeColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );","#endif","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","if ( combine == 1 ) {","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );","} else {","gl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );","}","#endif"].join("\n"),envmap_pars_vertex:["#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP )","varying vec3 vReflect;","uniform float refractionRatio;","uniform bool useRefract;","#endif"].join("\n"),envmap_vertex:["#ifdef USE_ENVMAP","vec4 mPosition = modelMatrix * vec4( position, 1.0 );","#endif","#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP )","vec3 nWorld = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * normal;","if ( useRefract ) {","vReflect = refract( normalize( mPosition.xyz - cameraPosition ), normalize( nWorld.xyz ), refractionRatio );","} else {","vReflect = reflect( normalize( mPosition.xyz - cameraPosition ), normalize( nWorld.xyz ) );","}","#endif"].join("\n"),map_particle_pars_fragment:["#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_particle_fragment:["#ifdef USE_MAP","gl_FragColor = gl_FragColor * texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );","#endif"].join("\n"),map_pars_vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_SPECULARMAP )","varying vec2 vUv;","uniform vec4 offsetRepeat;","#endif"].join("\n"),map_pars_fragment:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_SPECULARMAP )","varying vec2 vUv;","#endif","#ifdef USE_MAP","uniform sampler2D map;","#endif"].join("\n"),map_vertex:["#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_SPECULARMAP )","vUv = uv * offsetRepeat.zw + offsetRepeat.xy;","#endif"].join("\n"),map_fragment:["#ifdef USE_MAP","#ifdef GAMMA_INPUT","vec4 texelColor = texture2D( map, vUv );","texelColor.xyz *= texelColor.xyz;","gl_FragColor = gl_FragColor * texelColor;","#else","gl_FragColor = gl_FragColor * texture2D( map, vUv );","#endif","#endif"].join("\n"),lightmap_pars_fragment:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","uniform sampler2D lightMap;","#endif"].join("\n"),lightmap_pars_vertex:["#ifdef USE_LIGHTMAP","varying vec2 vUv2;","#endif"].join("\n"),lightmap_fragment:["#ifdef USE_LIGHTMAP","gl_FragColor = gl_FragColor * texture2D( lightMap, vUv2 );","#endif"].join("\n"),lightmap_vertex:["#ifdef USE_LIGHTMAP","vUv2 = uv2;","#endif"].join("\n"),bumpmap_pars_fragment:["#ifdef USE_BUMPMAP","uniform sampler2D bumpMap;","uniform float bumpScale;","vec2 dHdxy_fwd() {","vec2 dSTdx = dFdx( vUv );","vec2 dSTdy = dFdy( vUv );","float Hll = bumpScale * texture2D( bumpMap, vUv ).x;","float dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;","float dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;","return vec2( dBx, dBy );","}","vec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {","vec3 vSigmaX = dFdx( surf_pos );","vec3 vSigmaY = dFdy( surf_pos );","vec3 vN = surf_norm;","vec3 R1 = cross( vSigmaY, vN );","vec3 R2 = cross( vN, vSigmaX );","float fDet = dot( vSigmaX, R1 );","vec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );","return normalize( abs( fDet ) * surf_norm - vGrad );","}","#endif"].join("\n"),specularmap_pars_fragment:["#ifdef USE_SPECULARMAP","uniform sampler2D specularMap;","#endif"].join("\n"),specularmap_fragment:["float specularStrength;","#ifdef USE_SPECULARMAP","vec4 texelSpecular = texture2D( specularMap, vUv );","specularStrength = texelSpecular.r;","#else","specularStrength = 1.0;","#endif"].join("\n"),lights_lambert_pars_vertex:["uniform vec3 ambient;","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngle[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif"].join("\n"),lights_lambert_vertex:["vLightFront = vec3( 0.0 );","#ifdef DOUBLE_SIDED","vLightBack = vec3( 0.0 );","#endif","transformedNormal = normalize( transformedNormal );","#if MAX_DIR_LIGHTS > 0","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( transformedNormal, dirVector );","vec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","directionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","directionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += directionalLightColor[ i ] * directionalLightWeighting;","#ifdef DOUBLE_SIDED","vLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;","#endif","}","#endif","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","float dotProduct = dot( transformedNormal, lVector );","vec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","pointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","pointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;","#ifdef DOUBLE_SIDED","vLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","lVector = normalize( lVector );","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - mPosition.xyz ) );","if ( spotEffect > spotLightAngle[ i ] ) {","spotEffect = pow( spotEffect, spotLightExponent[ i ] );","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","float dotProduct = dot( transformedNormal, lVector );","vec3 spotLightWeighting = vec3( max( dotProduct, 0.0 ) );","#ifdef DOUBLE_SIDED","vec3 spotLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );","#endif","#endif","#ifdef WRAP_AROUND","vec3 spotLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );","spotLightWeighting = mix( spotLightWeighting, spotLightWeightingHalf, wrapRGB );","#ifdef DOUBLE_SIDED","spotLightWeightingBack = mix( spotLightWeightingBack, spotLightWeightingHalfBack, wrapRGB );","#endif","#endif","vLightFront += spotLightColor[ i ] * spotLightWeighting * lDistance * spotEffect;","#ifdef DOUBLE_SIDED","vLightBack += spotLightColor[ i ] * spotLightWeightingBack * lDistance * spotEffect;","#endif","}","}","#endif","vLightFront = vLightFront * diffuse + ambient * ambientLightColor + emissive;","#ifdef DOUBLE_SIDED","vLightBack = vLightBack * diffuse + ambient * ambientLightColor + emissive;","#endif"].join("\n"),lights_phong_pars_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )","varying vec3 vWorldPosition;","#endif"].join("\n"),lights_phong_vertex:["#ifndef PHONG_PER_PIXEL","#if MAX_POINT_LIGHTS > 0","for( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","vPointLight[ i ] = vec4( lVector, lDistance );","}","#endif","#if MAX_SPOT_LIGHTS > 0","for( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz - mvPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","vSpotLight[ i ] = vec4( lVector, lDistance );","}","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )","vWorldPosition = mPosition.xyz;","#endif"].join("\n"),lights_phong_pars_fragment:["uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#else","varying vec4 vPointLight[ MAX_POINT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngle[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","#ifdef PHONG_PER_PIXEL","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#else","varying vec4 vSpotLight[ MAX_SPOT_LIGHTS ];","#endif","#endif","#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )","varying vec3 vWorldPosition;","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","varying vec3 vViewPosition;","varying vec3 vNormal;"].join("\n"),lights_phong_fragment:["vec3 normal = normalize( vNormal );","vec3 viewPosition = normalize( vViewPosition );","#ifdef DOUBLE_SIDED","normal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );","#endif","#ifdef USE_BUMPMAP","normal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );","#endif","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse  = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vPointLight[ i ].xyz );","float lDistance = vPointLight[ i ].w;","#endif","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dotProduct, 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dotProduct, 0.0 );","#endif","pointDiffuse  += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;","vec3 pointHalfVector = normalize( lVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, pointHalfVector ), 5.0 );","pointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization;","#else","pointSpecular += specular * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse  = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","#ifdef PHONG_PER_PIXEL","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 lVector = lPosition.xyz + vViewPosition.xyz;","float lDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","lDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );","lVector = normalize( lVector );","#else","vec3 lVector = normalize( vSpotLight[ i ].xyz );","float lDistance = vSpotLight[ i ].w;","#endif","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngle[ i ] ) {","spotEffect = pow( spotEffect, spotLightExponent[ i ] );","float dotProduct = dot( normal, lVector );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dotProduct, 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dotProduct, 0.0 );","#endif","spotDiffuse += diffuse * spotLightColor[ i ] * spotDiffuseWeight * lDistance * spotEffect;","vec3 spotHalfVector = normalize( lVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularStrength * max( pow( spotDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, spotHalfVector ), 5.0 );","spotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * specularNormalization * spotEffect;","#else","spotSpecular += specular * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * spotEffect;","#endif","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse  = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","float dotProduct = dot( normal, dirVector );","#ifdef WRAP_AROUND","float dirDiffuseWeightFull = max( dotProduct, 0.0 );","float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dotProduct, 0.0 );","#endif","dirDiffuse  += diffuse * directionalLightColor[ i ] * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( shininess + 2.0001 ) / 8.0;","vec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );","dirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;","#else","dirSpecular += specular * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight;","#endif","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","#endif"].join("\n"),color_pars_fragment:["#ifdef USE_COLOR","varying vec3 vColor;","#endif"].join("\n"),color_fragment:["#ifdef USE_COLOR","gl_FragColor = gl_FragColor * vec4( vColor, opacity );","#endif"].join("\n"),color_pars_vertex:["#ifdef USE_COLOR","varying vec3 vColor;","#endif"].join("\n"),color_vertex:["#ifdef USE_COLOR","#ifdef GAMMA_INPUT","vColor = color * color;","#else","vColor = color;","#endif","#endif"].join("\n"),skinning_pars_vertex:["#ifdef USE_SKINNING","#ifdef BONE_TEXTURE","uniform sampler2D boneTexture;","mat4 getBoneMatrix( const in float i ) {","float j = i * 4.0;","float x = mod( j, N_BONE_PIXEL_X );","float y = floor( j / N_BONE_PIXEL_X );","const float dx = 1.0 / N_BONE_PIXEL_X;","const float dy = 1.0 / N_BONE_PIXEL_Y;","y = dy * ( y + 0.5 );","vec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );","vec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );","vec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );","vec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );","mat4 bone = mat4( v1, v2, v3, v4 );","return bone;","}","#else","uniform mat4 boneGlobalMatrices[ MAX_BONES ];","mat4 getBoneMatrix( const in float i ) {","mat4 bone = boneGlobalMatrices[ int(i) ];","return bone;","}","#endif","#endif"].join("\n"),skinbase_vertex:["#ifdef USE_SKINNING","mat4 boneMatX = getBoneMatrix( skinIndex.x );","mat4 boneMatY = getBoneMatrix( skinIndex.y );","#endif"].join("\n"),skinning_vertex:["#ifdef USE_SKINNING","vec4 skinned  = boneMatX * skinVertexA * skinWeight.x;","skinned 	  += boneMatY * skinVertexB * skinWeight.y;","gl_Position  = projectionMatrix * modelViewMatrix * skinned;","#endif"].join("\n"),morphtarget_pars_vertex:["#ifdef USE_MORPHTARGETS","#ifndef USE_MORPHNORMALS","uniform float morphTargetInfluences[ 8 ];","#else","uniform float morphTargetInfluences[ 4 ];","#endif","#endif"].join("\n"),morphtarget_vertex:["#ifdef USE_MORPHTARGETS","vec3 morphed = vec3( 0.0 );","morphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];","morphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];","morphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];","morphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];","#ifndef USE_MORPHNORMALS","morphed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];","morphed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];","morphed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];","morphed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];","#endif","morphed += position;","gl_Position = projectionMatrix * modelViewMatrix * vec4( morphed, 1.0 );","#endif"].join("\n"),default_vertex:["#ifndef USE_MORPHTARGETS","#ifndef USE_SKINNING","gl_Position = projectionMatrix * mvPosition;","#endif","#endif"].join("\n"),morphnormal_vertex:["#ifdef USE_MORPHNORMALS","vec3 morphedNormal = vec3( 0.0 );","morphedNormal +=  ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];","morphedNormal +=  ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];","morphedNormal +=  ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];","morphedNormal +=  ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];","morphedNormal += normal;","#endif"].join("\n"),skinnormal_vertex:["#ifdef USE_SKINNING","mat4 skinMatrix = skinWeight.x * boneMatX;","skinMatrix 	+= skinWeight.y * boneMatY;","vec4 skinnedNormal = skinMatrix * vec4( normal, 0.0 );","#endif"].join("\n"),defaultnormal_vertex:["vec3 transformedNormal;","#ifdef USE_SKINNING","transformedNormal = skinnedNormal.xyz;","#endif","#ifdef USE_MORPHNORMALS","transformedNormal = morphedNormal;","#endif","#ifndef USE_MORPHNORMALS","#ifndef USE_SKINNING","transformedNormal = normal;","#endif","#endif","transformedNormal = normalMatrix * transformedNormal;"].join("\n"),shadowmap_pars_fragment:["#ifdef USE_SHADOWMAP","uniform sampler2D shadowMap[ MAX_SHADOWS ];","uniform vec2 shadowMapSize[ MAX_SHADOWS ];","uniform float shadowDarkness[ MAX_SHADOWS ];","uniform float shadowBias[ MAX_SHADOWS ];","varying vec4 vShadowCoord[ MAX_SHADOWS ];","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","#endif"].join("\n"),shadowmap_fragment:["#ifdef USE_SHADOWMAP","#ifdef SHADOWMAP_DEBUG","vec3 frustumColors[3];","frustumColors[0] = vec3( 1.0, 0.5, 0.0 );","frustumColors[1] = vec3( 0.0, 1.0, 0.8 );","frustumColors[2] = vec3( 0.0, 0.5, 1.0 );","#endif","#ifdef SHADOWMAP_CASCADE","int inFrustumCount = 0;","#endif","float fDepth;","vec3 shadowColor = vec3( 1.0 );","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;","bvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );","bool inFrustum = all( inFrustumVec );","#ifdef SHADOWMAP_CASCADE","inFrustumCount += int( inFrustum );","bvec3 frustumTestVec = bvec3( inFrustum, inFrustumCount == 1, shadowCoord.z <= 1.0 );","#else","bvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );","#endif","bool frustumTest = all( frustumTestVec );","if ( frustumTest ) {","shadowCoord.z += shadowBias[ i ];","#ifdef SHADOWMAP_SOFT","float shadow = 0.0;","const float shadowDelta = 1.0 / 9.0;","float xPixelOffset = 1.0 / shadowMapSize[ i ].x;","float yPixelOffset = 1.0 / shadowMapSize[ i ].y;","float dx0 = -1.25 * xPixelOffset;","float dy0 = -1.25 * yPixelOffset;","float dx1 = 1.25 * xPixelOffset;","float dy1 = 1.25 * yPixelOffset;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","fDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );","if ( fDepth < shadowCoord.z ) shadow += shadowDelta;","shadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );","#else","vec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );","float fDepth = unpackDepth( rgbaDepth );","if ( fDepth < shadowCoord.z )","shadowColor = shadowColor * vec3( 1.0 - shadowDarkness[ i ] );","#endif","}","#ifdef SHADOWMAP_DEBUG","#ifdef SHADOWMAP_CASCADE","if ( inFrustum && inFrustumCount == 1 ) gl_FragColor.xyz *= frustumColors[ i ];","#else","if ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];","#endif","#endif","}","#ifdef GAMMA_OUTPUT","shadowColor *= shadowColor;","#endif","gl_FragColor.xyz = gl_FragColor.xyz * shadowColor;","#endif"].join("\n"),shadowmap_pars_vertex:["#ifdef USE_SHADOWMAP","varying vec4 vShadowCoord[ MAX_SHADOWS ];","uniform mat4 shadowMatrix[ MAX_SHADOWS ];","#endif"].join("\n"),shadowmap_vertex:["#ifdef USE_SHADOWMAP","vec4 transformedPosition;","#ifdef USE_MORPHTARGETS","transformedPosition = modelMatrix * vec4( morphed, 1.0 );","#else","#ifdef USE_SKINNING","transformedPosition = modelMatrix * skinned;","#else","transformedPosition = modelMatrix * vec4( position, 1.0 );","#endif","#endif","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * transformedPosition;","}","#endif"].join("\n"),alphatest_fragment:["#ifdef ALPHATEST","if ( gl_FragColor.a < ALPHATEST ) discard;","#endif"].join("\n"),linear_to_gamma_fragment:["#ifdef GAMMA_OUTPUT","gl_FragColor.xyz = sqrt( gl_FragColor.xyz );","#endif"].join("\n")},THREE.UniformsUtils={merge:function(e){var t,n,r,i={};for(t=0;t<e.length;t++){r=this.clone(e[t]);for(n in r)i[n]=r[n]}return i},clone:function(e){var t,n,r,i,s={};for(t in e){s[t]={};for(n in e[t])i=e[t][n],i instanceof THREE.Color||i instanceof THREE.Vector2||i instanceof THREE.Vector3||i instanceof THREE.Vector4||i instanceof THREE.Matrix4||i instanceof THREE.Texture?s[t][n]=i.clone():i instanceof Array?s[t][n]=i.slice():s[t][n]=i}return s}},THREE.UniformsLib={common:{diffuse:{type:"c",value:new THREE.Color(15658734)},opacity:{type:"f",value:1},map:{type:"t",value:0,texture:null},offsetRepeat:{type:"v4",value:new THREE.Vector4(0,0,1,1)},lightMap:{type:"t",value:2,texture:null},specularMap:{type:"t",value:3,texture:null},envMap:{type:"t",value:1,texture:null},flipEnvMap:{type:"f",value:-1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98},combine:{type:"i",value:0},morphTargetInfluences:{type:"f",value:0}},bump:{bumpMap:{type:"t",value:4,texture:null},bumpScale:{type:"f",value:1}},fog:{fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new THREE.Color(16777215)}},lights:{ambientLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightDistance:{type:"fv1",value:[]},spotLightColor:{type:"fv",value:[]},spotLightPosition:{type:"fv",value:[]},spotLightDirection:{type:"fv",value:[]},spotLightDistance:{type:"fv1",value:[]},spotLightAngle:{type:"fv1",value:[]},spotLightExponent:{type:"fv1",value:[]}},particle:{psColor:{type:"c",value:new THREE.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:0,texture:null},fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new THREE.Color(16777215)}},shadowmap:{shadowMap:{type:"tv",value:6,texture:[]},shadowMapSize:{type:"v2v",value:[]},shadowBias:{type:"fv1",value:[]},shadowDarkness:{type:"fv1",value:[]},shadowMatrix:{type:"m4v",value:[]}}},THREE.ShaderLib={depth:{uniforms:{mNear:{type:"f",value:1},mFar:{type:"f",value:2e3},opacity:{type:"f",value:1}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float mNear;","uniform float mFar;","uniform float opacity;","void main() {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float color = 1.0 - smoothstep( mNear, mFar, depth );","gl_FragColor = vec4( vec3( color ), opacity );","}"].join("\n")},normal:{uniforms:{opacity:{type:"f",value:1}},vertexShader:["varying vec3 vNormal;","void main() {","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","vNormal = normalMatrix * normal;","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vNormal;","void main() {","gl_FragColor = vec4( 0.5 * normalize( vNormal ) + 0.5, opacity );","}"].join("\n")},basic:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.shadowmap]),vertexShader:[THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( diffuse, opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},lambert:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),vertexShader:["varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_lambert_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,"#ifndef USE_ENVMAP","vec4 mPosition = modelMatrix * vec4( position, 1.0 );","#endif",THREE.ShaderChunk.lights_lambert_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;","varying vec3 vLightFront;","#ifdef DOUBLE_SIDED","varying vec3 vLightBack;","#endif",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,"#ifdef DOUBLE_SIDED","if ( gl_FrontFacing )","gl_FragColor.xyz *= vLightFront;","else","gl_FragColor.xyz *= vLightBack;","#else","gl_FragColor.xyz *= vLightFront;","#endif",THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},phong:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.bump,THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},specular:{type:"c",value:new THREE.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),vertexShader:["varying vec3 vViewPosition;","varying vec3 vNormal;",THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_phong_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.color_vertex,"#ifndef USE_ENVMAP","vec4 mPosition = modelMatrix * vec4( position, 1.0 );","#endif","vViewPosition = -mvPosition.xyz;",THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,"vNormal = transformedNormal;",THREE.ShaderChunk.lights_phong_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 ambient;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.lights_phong_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.bumpmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {","gl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.lights_phong_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},particle_basic:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.particle,THREE.UniformsLib.shadowmap]),vertexShader:["uniform float size;","uniform float scale;",THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.color_vertex,"vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","#ifdef USE_SIZEATTENUATION","gl_PointSize = size * ( scale / length( mvPosition.xyz ) );","#else","gl_PointSize = size;","#endif","gl_Position = projectionMatrix * mvPosition;",THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 psColor;","uniform float opacity;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_particle_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,"void main() {","gl_FragColor = vec4( psColor, opacity );",THREE.ShaderChunk.map_particle_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},depthRGBA:{uniforms:{},vertexShader:[THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,"void main() {","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );",THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.default_vertex,"}"].join("\n"),fragmentShader:["vec4 pack_depth( const in float depth ) {","const vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );","const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );","vec4 res = fract( depth * bit_shift );","res -= res.xxyz * bit_mask;","return res;","}","void main() {","gl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );","}"].join("\n")}},THREE.WebGLRenderer=function(e){function tt(e){e.__webglVertexBuffer=X.createBuffer(),e.__webglColorBuffer=X.createBuffer(),c.info.geometries++}function nt(e){e.__webglVertexBuffer=X.createBuffer(),e.__webglColorBuffer=X.createBuffer(),c.info.memory.geometries++}function rt(e){e.__webglVertexBuffer=X.createBuffer(),e.__webglColorBuffer=X.createBuffer(),c.info.memory.geometries++}function it(e){e.__webglVertexBuffer=X.createBuffer(),e.__webglNormalBuffer=X.createBuffer(),e.__webglTangentBuffer=X.createBuffer(),e.__webglColorBuffer=X.createBuffer(),e.__webglUVBuffer=X.createBuffer(),e.__webglUV2Buffer=X.createBuffer(),e.__webglSkinVertexABuffer=X.createBuffer(),e.__webglSkinVertexBBuffer=X.createBuffer(),e.__webglSkinIndicesBuffer=X.createBuffer(),e.__webglSkinWeightsBuffer=X.createBuffer(),e.__webglFaceBuffer=X.createBuffer(),e.__webglLineBuffer=X.createBuffer();var t,n;if(e.numMorphTargets){e.__webglMorphTargetsBuffers=[];for(t=0,n=e.numMorphTargets;t<n;t++)e.__webglMorphTargetsBuffers.push(X.createBuffer())}if(e.numMorphNormals){e.__webglMorphNormalsBuffers=[];for(t=0,n=e.numMorphNormals;t<n;t++)e.__webglMorphNormalsBuffers.push(X.createBuffer())}c.info.memory.geometries++}function st(e){X.deleteBuffer(e.__webglVertexBuffer),X.deleteBuffer(e.__webglColorBuffer),c.info.memory.geometries--}function ot(e){X.deleteBuffer(e.__webglVertexBuffer),X.deleteBuffer(e.__webglColorBuffer),c.info.memory.geometries--}function ut(e){X.deleteBuffer(e.__webglVertexBuffer),X.deleteBuffer(e.__webglColorBuffer),c.info.memory.geometries--}function at(e){X.deleteBuffer(e.__webglVertexBuffer),X.deleteBuffer(e.__webglNormalBuffer),X.deleteBuffer(e.__webglTangentBuffer),X.deleteBuffer(e.__webglColorBuffer),X.deleteBuffer(e.__webglUVBuffer),X.deleteBuffer(e.__webglUV2Buffer),X.deleteBuffer(e.__webglSkinVertexABuffer),X.deleteBuffer(e.__webglSkinVertexBBuffer),X.deleteBuffer(e.__webglSkinIndicesBuffer),X.deleteBuffer(e.__webglSkinWeightsBuffer),X.deleteBuffer(e.__webglFaceBuffer),X.deleteBuffer(e.__webglLineBuffer);var t,n;if(e.numMorphTargets)for(t=0,n=e.numMorphTargets;t<n;t++)X.deleteBuffer(e.__webglMorphTargetsBuffers[t]);if(e.numMorphNormals)for(t=0,n=e.numMorphNormals;t<n;t++)X.deleteBuffer(e.__webglMorphNormalsBuffers[t]);if(e.__webglCustomAttributesList)for(var r in e.__webglCustomAttributesList)X.deleteBuffer(e.__webglCustomAttributesList[r].buffer);c.info.memory.geometries--}function ft(e,t){var n=e.vertices.length,r=t.material;if(r.attributes){e.__webglCustomAttributesList===undefined&&(e.__webglCustomAttributesList=[]);for(var i in r.attributes){var s=r.attributes[i];if(!s.__webglInitialized||s.createUniqueBuffers){s.__webglInitialized=!0;var o=1;s.type==="v2"?o=2:s.type==="v3"?o=3:s.type==="v4"?o=4:s.type==="c"&&(o=3),s.size=o,s.array=new Float32Array(n*o),s.buffer=X.createBuffer(),s.buffer.belongsToAttribute=i,s.needsUpdate=!0}e.__webglCustomAttributesList.push(s)}}}function lt(e,t){var n=e.vertices.length;e.__vertexArray=new Float32Array(n*3),e.__colorArray=new Float32Array(n*3),e.__sortArray=[],e.__webglParticleCount=n,ft(e,t)}function ct(e,t){var n=e.vertices.length;e.__vertexArray=new Float32Array(n*3),e.__colorArray=new Float32Array(n*3),e.__webglLineCount=n,ft(e,t)}function ht(e){var t=e.vertices.length;e.__vertexArray=new Float32Array(t*3),e.__colorArray=new Float32Array(t*3),e.__webglVertexCount=t}function pt(e,t){var n=t.geometry,r=e.faces3,i=e.faces4,s=r.length*3+i.length*4,o=r.length*1+i.length*2,u=r.length*3+i.length*4,a=dt(t,e),f=yt(a),l=mt(a),c=gt(a);e.__vertexArray=new Float32Array(s*3),l&&(e.__normalArray=new Float32Array(s*3)),n.hasTangents&&(e.__tangentArray=new Float32Array(s*4)),c&&(e.__colorArray=new Float32Array(s*3));if(f){if(n.faceUvs.length>0||n.faceVertexUvs.length>0)e.__uvArray=new Float32Array(s*2);if(n.faceUvs.length>1||n.faceVertexUvs.length>1)e.__uv2Array=new Float32Array(s*2)}t.geometry.skinWeights.length&&t.geometry.skinIndices.length&&(e.__skinVertexAArray=new Float32Array(s*4),e.__skinVertexBArray=new Float32Array(s*4),e.__skinIndexArray=new Float32Array(s*4),e.__skinWeightArray=new Float32Array(s*4)),e.__faceArray=new Uint16Array(o*3),e.__lineArray=new Uint16Array(u*2);var h,p;if(e.numMorphTargets){e.__morphTargetsArrays=[];for(h=0,p=e.numMorphTargets;h<p;h++)e.__morphTargetsArrays.push(new Float32Array(s*3))}if(e.numMorphNormals){e.__morphNormalsArrays=[];for(h=0,p=e.numMorphNormals;h<p;h++)e.__morphNormalsArrays.push(new Float32Array(s*3))}e.__webglFaceCount=o*3,e.__webglLineCount=u*2;if(a.attributes){e.__webglCustomAttributesList===undefined&&(e.__webglCustomAttributesList=[]);for(var d in a.attributes){var v=a.attributes[d],m={};for(var g in v)m[g]=v[g];if(!m.__webglInitialized||m.createUniqueBuffers){m.__webglInitialized=!0;var y=1;m.type==="v2"?y=2:m.type==="v3"?y=3:m.type==="v4"?y=4:m.type==="c"&&(y=3),m.size=y,m.array=new Float32Array(s*y),m.buffer=X.createBuffer(),m.buffer.belongsToAttribute=d,v.needsUpdate=!0,m.__original=v}e.__webglCustomAttributesList.push(m)}}e.__inittedArrays=!0}function dt(e,t){if(!(!e.material||e.material instanceof THREE.MeshFaceMaterial))return e.material;if(t.materialIndex>=0)return e.geometry.materials[t.materialIndex]}function vt(e){return e&&e.shading!==undefined&&e.shading===THREE.SmoothShading}function mt(e){return e instanceof THREE.MeshBasicMaterial&&!e.envMap||e instanceof THREE.MeshDepthMaterial?!1:vt(e)?THREE.SmoothShading:THREE.FlatShading}function gt(e){return e.vertexColors?e.vertexColors:!1}function yt(e){return e.map||e.lightMap||e.bumpMap||e.specularMap||e instanceof THREE.ShaderMaterial?!0:!1}function bt(e){var t,n,r;for(t in e.attributes)t==="index"?r=X.ELEMENT_ARRAY_BUFFER:r=X.ARRAY_BUFFER,n=e.attributes[t],n.buffer=X.createBuffer(),X.bindBuffer(r,n.buffer),X.bufferData(r,n.array,X.STATIC_DRAW)}function wt(e,t,n){var r,i,s,o,u,a,f=e.vertices,l=f.length,c=e.colors,h=c.length,p=e.__vertexArray,d=e.__colorArray,v=e.__sortArray,m=e.verticesNeedUpdate,g=e.elementsNeedUpdate,y=e.colorsNeedUpdate,b=e.__webglCustomAttributesList,w,E,S,x,T,N,C;if(n.sortParticles){q.copy(I),q.multiplySelf(n.matrixWorld);for(r=0;r<l;r++)s=f[r],R.copy(s),q.multiplyVector3(R),v[r]=[R.z,r];v.sort(function(e,t){return t[0]-e[0]});for(r=0;r<l;r++)s=f[v[r][1]],o=r*3,p[o]=s.x,p[o+1]=s.y,p[o+2]=s.z;for(i=0;i<h;i++)o=i*3,a=c[v[i][1]],d[o]=a.r,d[o+1]=a.g,d[o+2]=a.b;if(b)for(w=0,E=b.length;w<E;w++){C=b[w];if(C.boundTo!==undefined&&C.boundTo!=="vertices")continue;o=0,T=C.value.length;if(C.size===1)for(x=0;x<T;x++)u=v[x][1],C.array[x]=C.value[u];else if(C.size===2)for(x=0;x<T;x++)u=v[x][1],N=C.value[u],C.array[o]=N.x,C.array[o+1]=N.y,o+=2;else if(C.size===3)if(C.type==="c")for(x=0;x<T;x++)u=v[x][1],N=C.value[u],C.array[o]=N.r,C.array[o+1]=N.g,C.array[o+2]=N.b,o+=3;else for(x=0;x<T;x++)u=v[x][1],N=C.value[u],C.array[o]=N.x,C.array[o+1]=N.y,C.array[o+2]=N.z,o+=3;else if(C.size===4)for(x=0;x<T;x++)u=v[x][1],N=C.value[u],C.array[o]=N.x,C.array[o+1]=N.y,C.array[o+2]=N.z,C.array[o+3]=N.w,o+=4}}else{if(m)for(r=0;r<l;r++)s=f[r],o=r*3,p[o]=s.x,p[o+1]=s.y,p[o+2]=s.z;if(y)for(i=0;i<h;i++)a=c[i],o=i*3,d[o]=a.r,d[o+1]=a.g,d[o+2]=a.b;if(b)for(w=0,E=b.length;w<E;w++){C=b[w];if(C.needsUpdate&&(C.boundTo===undefined||C.boundTo==="vertices")){T=C.value.length,o=0;if(C.size===1)for(x=0;x<T;x++)C.array[x]=C.value[x];else if(C.size===2)for(x=0;x<T;x++)N=C.value[x],C.array[o]=N.x,C.array[o+1]=N.y,o+=2;else if(C.size===3)if(C.type==="c")for(x=0;x<T;x++)N=C.value[x],C.array[o]=N.r,C.array[o+1]=N.g,C.array[o+2]=N.b,o+=3;else for(x=0;x<T;x++)N=C.value[x],C.array[o]=N.x,C.array[o+1]=N.y,C.array[o+2]=N.z,o+=3;else if(C.size===4)for(x=0;x<T;x++)N=C.value[x],C.array[o]=N.x,C.array[o+1]=N.y,C.array[o+2]=N.z,C.array[o+3]=N.w,o+=4}}}if(m||n.sortParticles)X.bindBuffer(X.ARRAY_BUFFER,e.__webglVertexBuffer),X.bufferData(X.ARRAY_BUFFER,p,t);if(y||n.sortParticles)X.bindBuffer(X.ARRAY_BUFFER,e.__webglColorBuffer),X.bufferData(X.ARRAY_BUFFER,d,t);if(b)for(w=0,E=b.length;w<E;w++){C=b[w];if(C.needsUpdate||n.sortParticles)X.bindBuffer(X.ARRAY_BUFFER,C.buffer),X.bufferData(X.ARRAY_BUFFER,C.array,t)}}function Et(e,t){var n,r,i,s,o,u=e.vertices,a=e.colors,f=u.length,l=a.length,c=e.__vertexArray,h=e.__colorArray,p=e.verticesNeedUpdate,d=e.colorsNeedUpdate,v=e.__webglCustomAttributesList,m,g,y,b,w,E,S;if(p){for(n=0;n<f;n++)i=u[n],s=n*3,c[s]=i.x,c[s+1]=i.y,c[s+2]=i.z;X.bindBuffer(X.ARRAY_BUFFER,e.__webglVertexBuffer),X.bufferData(X.ARRAY_BUFFER,c,t)}if(d){for(r=0;r<l;r++)o=a[r],s=r*3,h[s]=o.r,h[s+1]=o.g,h[s+2]=o.b;X.bindBuffer(X.ARRAY_BUFFER,e.__webglColorBuffer),X.bufferData(X.ARRAY_BUFFER,h,t)}if(v)for(m=0,g=v.length;m<g;m++){S=v[m];if(S.needsUpdate&&(S.boundTo===undefined||S.boundTo==="vertices")){s=0,w=S.value.length;if(S.size===1)for(b=0;b<w;b++)S.array[b]=S.value[b];else if(S.size===2)for(b=0;b<w;b++)E=S.value[b],S.array[s]=E.x,S.array[s+1]=E.y,s+=2;else if(S.size===3)if(S.type==="c")for(b=0;b<w;b++)E=S.value[b],S.array[s]=E.r,S.array[s+1]=E.g,S.array[s+2]=E.b,s+=3;else for(b=0;b<w;b++)E=S.value[b],S.array[s]=E.x,S.array[s+1]=E.y,S.array[s+2]=E.z,s+=3;else if(S.size===4)for(b=0;b<w;b++)E=S.value[b],S.array[s]=E.x,S.array[s+1]=E.y,S.array[s+2]=E.z,S.array[s+3]=E.w,s+=4;X.bindBuffer(X.ARRAY_BUFFER,S.buffer),X.bufferData(X.ARRAY_BUFFER,S.array,t)}}}function St(e,t){var n,r,i,s,o,u=e.vertices,a=e.colors,f=u.length,l=a.length,c=e.__vertexArray,h=e.__colorArray,p=e.verticesNeedUpdate,d=e.colorsNeedUpdate;if(p){for(n=0;n<f;n++)i=u[n],s=n*3,c[s]=i.x,c[s+1]=i.y,c[s+2]=i.z;X.bindBuffer(X.ARRAY_BUFFER,e.__webglVertexBuffer),X.bufferData(X.ARRAY_BUFFER,c,t)}if(d){for(r=0;r<l;r++)o=a[r],s=r*3,h[s]=o.r,h[s+1]=o.g,h[s+2]=o.b;X.bindBuffer(X.ARRAY_BUFFER,e.__webglColorBuffer),X.bufferData(X.ARRAY_BUFFER,h,t)}}function xt(e,t,n,r,i){if(!e.__inittedArrays)return;var s=mt(i),o=gt(i),u=yt(i),a=s===THREE.SmoothShading,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H,B,j,F,I,q,R,U,z,W,V,$,J,K,Q,G,Y,Z,et,tt,nt,rt,it,st,ot,ut,at,ft,lt,ct,ht,pt,dt=0,vt=0,bt=0,wt=0,Et=0,St=0,xt=0,Tt=0,Nt=0,Ct=0,kt=0,Lt=0,At=0,Ot,Mt=e.__vertexArray,_t=e.__uvArray,Dt=e.__uv2Array,Pt=e.__normalArray,Ht=e.__tangentArray,Bt=e.__colorArray,jt=e.__skinVertexAArray,Ft=e.__skinVertexBArray,It=e.__skinIndexArray,qt=e.__skinWeightArray,Rt=e.__morphTargetsArrays,Ut=e.__morphNormalsArrays,zt=e.__webglCustomAttributesList,Wt,Xt=e.__faceArray,Vt=e.__lineArray,$t=t.geometry,Jt=$t.verticesNeedUpdate,Kt=$t.elementsNeedUpdate,Qt=$t.uvsNeedUpdate,Gt=$t.normalsNeedUpdate,Yt=$t.tangentsNeedUpdate,Zt=$t.colorsNeedUpdate,en=$t.morphTargetsNeedUpdate,tn=$t.vertices,nn=e.faces3,rn=e.faces4,sn=$t.faces,on=$t.faceVertexUvs[0],un=$t.faceVertexUvs[1],an=$t.colors,fn=$t.skinVerticesA,ln=$t.skinVerticesB,cn=$t.skinIndices,hn=$t.skinWeights,pn=$t.morphTargets,dn=$t.morphNormals;if(Jt){for(f=0,l=nn.length;f<l;f++)h=sn[nn[f]],E=tn[h.a],S=tn[h.b],x=tn[h.c],Mt[vt]=E.x,Mt[vt+1]=E.y,Mt[vt+2]=E.z,Mt[vt+3]=S.x,Mt[vt+4]=S.y,Mt[vt+5]=S.z,Mt[vt+6]=x.x,Mt[vt+7]=x.y,Mt[vt+8]=x.z,vt+=9;for(f=0,l=rn.length;f<l;f++)h=sn[rn[f]],E=tn[h.a],S=tn[h.b],x=tn[h.c],T=tn[h.d],Mt[vt]=E.x,Mt[vt+1]=E.y,Mt[vt+2]=E.z,Mt[vt+3]=S.x,Mt[vt+4]=S.y,Mt[vt+5]=S.z,Mt[vt+6]=x.x,Mt[vt+7]=x.y,Mt[vt+8]=x.z,Mt[vt+9]=T.x,Mt[vt+10]=T.y,Mt[vt+11]=T.z,vt+=12;X.bindBuffer(X.ARRAY_BUFFER,e.__webglVertexBuffer),X.bufferData(X.ARRAY_BUFFER,Mt,n)}if(en)for(ut=0,at=pn.length;ut<at;ut++){kt=0;for(f=0,l=nn.length;f<l;f++)ct=nn[f],h=sn[ct],E=pn[ut].vertices[h.a],S=pn[ut].vertices[h.b],x=pn[ut].vertices[h.c],ft=Rt[ut],ft[kt]=E.x,ft[kt+1]=E.y,ft[kt+2]=E.z,ft[kt+3]=S.x,ft[kt+4]=S.y,ft[kt+5]=S.z,ft[kt+6]=x.x,ft[kt+7]=x.y,ft[kt+8]=x.z,i.morphNormals&&(a?(ht=dn[ut].vertexNormals[ct],A=ht.a,O=ht.b,M=ht.c):(A=dn[ut].faceNormals[ct],O=A,M=A),lt=Ut[ut],lt[kt]=A.x,lt[kt+1]=A.y,lt[kt+2]=A.z,lt[kt+3]=O.x,lt[kt+4]=O.y,lt[kt+5]=O.z,lt[kt+6]=M.x,lt[kt+7]=M.y,lt[kt+8]=M.z),kt+=9;for(f=0,l=rn.length;f<l;f++)ct=rn[f],h=sn[ct],E=pn[ut].vertices[h.a],S=pn[ut].vertices[h.b],x=pn[ut].vertices[h.c],T=pn[ut].vertices[h.d],ft=Rt[ut],ft[kt]=E.x,ft[kt+1]=E.y,ft[kt+2]=E.z,ft[kt+3]=S.x,ft[kt+4]=S.y,ft[kt+5]=S.z,ft[kt+6]=x.x,ft[kt+7]=x.y,ft[kt+8]=x.z,ft[kt+9]=T.x,ft[kt+10]=T.y,ft[kt+11]=T.z,i.morphNormals&&(a?(ht=dn[ut].vertexNormals[ct],A=ht.a,O=ht.b,M=ht.c,_=ht.d):(A=dn[ut].faceNormals[ct],O=A,M=A,_=A),lt=Ut[ut],lt[kt]=A.x,lt[kt+1]=A.y,lt[kt+2]=A.z,lt[kt+3]=O.x,lt[kt+4]=O.y,lt[kt+5]=O.z,lt[kt+6]=M.x,lt[kt+7]=M.y,lt[kt+8]=M.z,lt[kt+9]=_.x,lt[kt+10]=_.y,lt[kt+11]=_.z),kt+=12;X.bindBuffer(X.ARRAY_BUFFER,e.__webglMorphTargetsBuffers[ut]),X.bufferData(X.ARRAY_BUFFER,Rt[ut],n),i.morphNormals&&(X.bindBuffer(X.ARRAY_BUFFER,e.__webglMorphNormalsBuffers[ut]),X.bufferData(X.ARRAY_BUFFER,Ut[ut],n))}if(hn.length){for(f=0,l=nn.length;f<l;f++)h=sn[nn[f]],j=hn[h.a],F=hn[h.b],I=hn[h.c],qt[Ct]=j.x,qt[Ct+1]=j.y,qt[Ct+2]=j.z,qt[Ct+3]=j.w,qt[Ct+4]=F.x,qt[Ct+5]=F.y,qt[Ct+6]=F.z,qt[Ct+7]=F.w,qt[Ct+8]=I.x,qt[Ct+9]=I.y,qt[Ct+10]=I.z,qt[Ct+11]=I.w,R=cn[h.a],U=cn[h.b],z=cn[h.c],It[Ct]=R.x,It[Ct+1]=R.y,It[Ct+2]=R.z,It[Ct+3]=R.w,It[Ct+4]=U.x,It[Ct+5]=U.y,It[Ct+6]=U.z,It[Ct+7]=U.w,It[Ct+8]=z.x,It[Ct+9]=z.y,It[Ct+10]=z.z,It[Ct+11]=z.w,V=fn[h.a],$=fn[h.b],J=fn[h.c],jt[Ct]=V.x,jt[Ct+1]=V.y,jt[Ct+2]=V.z,jt[Ct+3]=1,jt[Ct+4]=$.x,jt[Ct+5]=$.y,jt[Ct+6]=$.z,jt[Ct+7]=1,jt[Ct+8]=J.x,jt[Ct+9]=J.y,jt[Ct+10]=J.z,jt[Ct+11]=1,Q=ln[h.a],G=ln[h.b],Y=ln[h.c],Ft[Ct]=Q.x,Ft[Ct+1]=Q.y,Ft[Ct+2]=Q.z,Ft[Ct+3]=1,Ft[Ct+4]=G.x,Ft[Ct+5]=G.y,Ft[Ct+6]=G.z,Ft[Ct+7]=1,Ft[Ct+8]=Y.x,Ft[Ct+9]=Y.y,Ft[Ct+10]=Y.z,Ft[Ct+11]=1,Ct+=12;for(f=0,l=rn.length;f<l;f++)h=sn[rn[f]],j=hn[h.a],F=hn[h.b],I=hn[h.c],q=hn[h.d],qt[Ct]=j.x,qt[Ct+1]=j.y,qt[Ct+2]=j.z,qt[Ct+3]=j.w,qt[Ct+4]=F.x,qt[Ct+5]=F.y,qt[Ct+6]=F.z,qt[Ct+7]=F.w,qt[Ct+8]=I.x,qt[Ct+9]=I.y,qt[Ct+10]=I.z,qt[Ct+11]=I.w,qt[Ct+12]=q.x,qt[Ct+13]=q.y,qt[Ct+14]=q.z,qt[Ct+15]=q.w,R=cn[h.a],U=cn[h.b],z=cn[h.c],W=cn[h.d],It[Ct]=R.x,It[Ct+1]=R.y,It[Ct+2]=R.z,It[Ct+3]=R.w,It[Ct+4]=U.x,It[Ct+5]=U.y,It[Ct+6]=U.z,It[Ct+7]=U.w,It[Ct+8]=z.x,It[Ct+9]=z.y,It[Ct+10]=z.z,It[Ct+11]=z.w,It[Ct+12]=W.x,It[Ct+13]=W.y,It[Ct+14]=W.z,It[Ct+15]=W.w,V=fn[h.a],$=fn[h.b],J=fn[h.c],K=fn[h.d],jt[Ct]=V.x,jt[Ct+1]=V.y,jt[Ct+2]=V.z,jt[Ct+3]=1,jt[Ct+4]=$.x,jt[Ct+5]=$.y,jt[Ct+6]=$.z,jt[Ct+7]=1,jt[Ct+8]=J.x,jt[Ct+9]=J.y,jt[Ct+10]=J.z,jt[Ct+11]=1,jt[Ct+12]=K.x,jt[Ct+13]=K.y,jt[Ct+14]=K.z,jt[Ct+15]=1,Q=ln[h.a],G=ln[h.b],Y=ln[h.c],Z=ln[h.d],Ft[Ct]=Q.x,Ft[Ct+1]=Q.y,Ft[Ct+2]=Q.z,Ft[Ct+3]=1,Ft[Ct+4]=G.x,Ft[Ct+5]=G.y,Ft[Ct+6]=G.z,Ft[Ct+7]=1,Ft[Ct+8]=Y.x,Ft[Ct+9]=Y.y,Ft[Ct+10]=Y.z,Ft[Ct+11]=1,Ft[Ct+12]=Z.x,Ft[Ct+13]=Z.y,Ft[Ct+14]=Z.z,Ft[Ct+15]=1,Ct+=16;Ct>0&&(X.bindBuffer(X.ARRAY_BUFFER,e.__webglSkinVertexABuffer),X.bufferData(X.ARRAY_BUFFER,jt,n),X.bindBuffer(X.ARRAY_BUFFER,e.__webglSkinVertexBBuffer),X.bufferData(X.ARRAY_BUFFER,Ft,n),X.bindBuffer(X.ARRAY_BUFFER,e.__webglSkinIndicesBuffer),X.bufferData(X.ARRAY_BUFFER,It,n),X.bindBuffer(X.ARRAY_BUFFER,e.__webglSkinWeightsBuffer),X.bufferData(X.ARRAY_BUFFER,qt,n))}if(Zt&&o){for(f=0,l=nn.length;f<l;f++)h=sn[nn[f]],m=h.vertexColors,g=h.color,m.length===3&&o===THREE.VertexColors?(D=m[0],P=m[1],H=m[2]):(D=g,P=g,H=g),Bt[Nt]=D.r,Bt[Nt+1]=D.g,Bt[Nt+2]=D.b,Bt[Nt+3]=P.r,Bt[Nt+4]=P.g,Bt[Nt+5]=P.b,Bt[Nt+6]=H.r,Bt[Nt+7]=H.g,Bt[Nt+8]=H.b,Nt+=9;for(f=0,l=rn.length;f<l;f++)h=sn[rn[f]],m=h.vertexColors,g=h.color,m.length===4&&o===THREE.VertexColors?(D=m[0],P=m[1],H=m[2],B=m[3]):(D=g,P=g,H=g,B=g),Bt[Nt]=D.r,Bt[Nt+1]=D.g,Bt[Nt+2]=D.b,Bt[Nt+3]=P.r,Bt[Nt+4]=P.g,Bt[Nt+5]=P.b,Bt[Nt+6]=H.r,Bt[Nt+7]=H.g,Bt[Nt+8]=H.b,Bt[Nt+9]=B.r,Bt[Nt+10]=B.g,Bt[Nt+11]=B.b,Nt+=12;Nt>0&&(X.bindBuffer(X.ARRAY_BUFFER,e.__webglColorBuffer),X.bufferData(X.ARRAY_BUFFER,Bt,n))}if(Yt&&$t.hasTangents){for(f=0,l=nn.length;f<l;f++)h=sn[nn[f]],y=h.vertexTangents,N=y[0],C=y[1],k=y[2],Ht[xt]=N.x,Ht[xt+1]=N.y,Ht[xt+2]=N.z,Ht[xt+3]=N.w,Ht[xt+4]=C.x,Ht[xt+5]=C.y,Ht[xt+6]=C.z,Ht[xt+7]=C.w,Ht[xt+8]=k.x,Ht[xt+9]=k.y,Ht[xt+10]=k.z,Ht[xt+11]=k.w,xt+=12;for(f=0,l=rn.length;f<l;f++)h=sn[rn[f]],y=h.vertexTangents,N=y[0],C=y[1],k=y[2],L=y[3],Ht[xt]=N.x,Ht[xt+1]=N.y,Ht[xt+2]=N.z,Ht[xt+3]=N.w,Ht[xt+4]=C.x,Ht[xt+5]=C.y,Ht[xt+6]=C.z,Ht[xt+7]=C.w,Ht[xt+8]=k.x,Ht[xt+9]=k.y,Ht[xt+10]=k.z,Ht[xt+11]=k.w,Ht[xt+12]=L.x,Ht[xt+13]=L.y,Ht[xt+14]=L.z,Ht[xt+15]=L.w,xt+=16;X.bindBuffer(X.ARRAY_BUFFER,e.__webglTangentBuffer),X.bufferData(X.ARRAY_BUFFER,Ht,n)}if(Gt&&s){for(f=0,l=nn.length;f<l;f++){h=sn[nn[f]],p=h.vertexNormals,d=h.normal;if(p.length===3&&a)for(nt=0;nt<3;nt++)it=p[nt],Pt[St]=it.x,Pt[St+1]=it.y,Pt[St+2]=it.z,St+=3;else for(nt=0;nt<3;nt++)Pt[St]=d.x,Pt[St+1]=d.y,Pt[St+2]=d.z,St+=3}for(f=0,l=rn.length;f<l;f++){h=sn[rn[f]],p=h.vertexNormals,d=h.normal;if(p.length===4&&a)for(nt=0;nt<4;nt++)it=p[nt],Pt[St]=it.x,Pt[St+1]=it.y,Pt[St+2]=it.z,St+=3;else for(nt=0;nt<4;nt++)Pt[St]=d.x,Pt[St+1]=d.y,Pt[St+2]=d.z,St+=3}X.bindBuffer(X.ARRAY_BUFFER,e.__webglNormalBuffer),X.bufferData(X.ARRAY_BUFFER,Pt,n)}if(Qt&&on&&u){for(f=0,l=nn.length;f<l;f++){c=nn[f],h=sn[c],b=on[c];if(b===undefined)continue;for(nt=0;nt<3;nt++)st=b[nt],_t[bt]=st.u,_t[bt+1]=st.v,bt+=2}for(f=0,l=rn.length;f<l;f++){c=rn[f],h=sn[c],b=on[c];if(b===undefined)continue;for(nt=0;nt<4;nt++)st=b[nt],_t[bt]=st.u,_t[bt+1]=st.v,bt+=2}bt>0&&(X.bindBuffer(X.ARRAY_BUFFER,e.__webglUVBuffer),X.bufferData(X.ARRAY_BUFFER,_t,n))}if(Qt&&un&&u){for(f=0,l=nn.length;f<l;f++){c=nn[f],h=sn[c],w=un[c];if(w===undefined)continue;for(nt=0;nt<3;nt++)ot=w[nt],Dt[wt]=ot.u,Dt[wt+1]=ot.v,wt+=2}for(f=0,l=rn.length;f<l;f++){c=rn[f],h=sn[c],w=un[c];if(w===undefined)continue;for(nt=0;nt<4;nt++)ot=w[nt],Dt[wt]=ot.u,Dt[wt+1]=ot.v,wt+=2}wt>0&&(X.bindBuffer(X.ARRAY_BUFFER,e.__webglUV2Buffer),X.bufferData(X.ARRAY_BUFFER,Dt,n))}if(Kt){for(f=0,l=nn.length;f<l;f++)h=sn[nn[f]],Xt[Et]=dt,Xt[Et+1]=dt+1,Xt[Et+2]=dt+2,Et+=3,Vt[Tt]=dt,Vt[Tt+1]=dt+1,Vt[Tt+2]=dt,Vt[Tt+3]=dt+2,Vt[Tt+4]=dt+1,Vt[Tt+5]=dt+2,Tt+=6,dt+=3;for(f=0,l=rn.length;f<l;f++)h=sn[rn[f]],Xt[Et]=dt,Xt[Et+1]=dt+1,Xt[Et+2]=dt+3,Xt[Et+3]=dt+1,Xt[Et+4]=dt+2,Xt[Et+5]=dt+3,Et+=6,Vt[Tt]=dt,Vt[Tt+1]=dt+1,Vt[Tt+2]=dt,Vt[Tt+3]=dt+3,Vt[Tt+4]=dt+1,Vt[Tt+5]=dt+2,Vt[Tt+6]=dt+2,Vt[Tt+7]=dt+3,Tt+=8,dt+=4;X.bindBuffer(X.ELEMENT_ARRAY_BUFFER,e.__webglFaceBuffer),X.bufferData(X.ELEMENT_ARRAY_BUFFER,Xt,n),X.bindBuffer(X.ELEMENT_ARRAY_BUFFER,e.__webglLineBuffer),X.bufferData(X.ELEMENT_ARRAY_BUFFER,Vt,n)}if(zt)for(nt=0,rt=zt.length;nt<rt;nt++){Wt=zt[nt];if(!Wt.__original.needsUpdate)continue;Lt=0,At=0;if(Wt.size===1){if(Wt.boundTo===undefined||Wt.boundTo==="vertices"){for(f=0,l=nn.length;f<l;f++)h=sn[nn[f]],Wt.array[Lt]=Wt.value[h.a],Wt.array[Lt+1]=Wt.value[h.b],Wt.array[Lt+2]=Wt.value[h.c],Lt+=3;for(f=0,l=rn.length;f<l;f++)h=sn[rn[f]],Wt.array[Lt]=Wt.value[h.a],Wt.array[Lt+1]=Wt.value[h.b],Wt.array[Lt+2]=Wt.value[h.c],Wt.array[Lt+3]=Wt.value[h.d],Lt+=4}else if(Wt.boundTo==="faces"){for(f=0,l=nn.length;f<l;f++)Ot=Wt.value[nn[f]],Wt.array[Lt]=Ot,Wt.array[Lt+1]=Ot,Wt.array[Lt+2]=Ot,Lt+=3;for(f=0,l=rn.length;f<l;f++)Ot=Wt.value[rn[f]],Wt.array[Lt]=Ot,Wt.array[Lt+1]=Ot,Wt.array[Lt+2]=Ot,Wt.array[Lt+3]=Ot,Lt+=4}}else if(Wt.size===2){if(Wt.boundTo===undefined||Wt.boundTo==="vertices"){for(f=0,l=nn.length;f<l;f++)h=sn[nn[f]],E=Wt.value[h.a],S=Wt.value[h.b],x=Wt.value[h.c],Wt.array[Lt]=E.x,Wt.array[Lt+1]=E.y,Wt.array[Lt+2]=S.x,Wt.array[Lt+3]=S.y,Wt.array[Lt+4]=x.x,Wt.array[Lt+5]=x.y,Lt+=6;for(f=0,l=rn.length;f<l;f++)h=sn[rn[f]],E=Wt.value[h.a],S=Wt.value[h.b],x=Wt.value[h.c],T=Wt.value[h.d],Wt.array[Lt]=E.x,Wt.array[Lt+1]=E.y,Wt.array[Lt+2]=S.x,Wt.array[Lt+3]=S.y,Wt.array[Lt+4]=x.x,Wt.array[Lt+5]=x.y,Wt.array[Lt+6]=T.x,Wt.array[Lt+7]=T.y,Lt+=8}else if(Wt.boundTo==="faces"){for(f=0,l=nn.length;f<l;f++)Ot=Wt.value[nn[f]],E=Ot,S=Ot,x=Ot,Wt.array[Lt]=E.x,Wt.array[Lt+1]=E.y,Wt.array[Lt+2]=S.x,Wt.array[Lt+3]=S.y,Wt.array[Lt+4]=x.x,Wt.array[Lt+5]=x.y,Lt+=6;for(f=0,l=rn.length;f<l;f++)Ot=Wt.value[rn[f]],E=Ot,S=Ot,x=Ot,T=Ot,Wt.array[Lt]=E.x,Wt.array[Lt+1]=E.y,Wt.array[Lt+2]=S.x,Wt.array[Lt+3]=S.y,Wt.array[Lt+4]=x.x,Wt.array[Lt+5]=x.y,Wt.array[Lt+6]=T.x,Wt.array[Lt+7]=T.y,Lt+=8}}else if(Wt.size===3){var vn;Wt.type==="c"?vn=["r","g","b"]:vn=["x","y","z"];if(Wt.boundTo===undefined||Wt.boundTo==="vertices"){for(f=0,l=nn.length;f<l;f++)h=sn[nn[f]],E=Wt.value[h.a],S=Wt.value[h.b],x=Wt.value[h.c],Wt.array[Lt]=E[vn[0]],Wt.array[Lt+1]=E[vn[1]],Wt.array[Lt+2]=E[vn[2]],Wt.array[Lt+3]=S[vn[0]],Wt.array[Lt+4]=S[vn[1]],Wt.array[Lt+5]=S[vn[2]],Wt.array[Lt+6]=x[vn[0]],Wt.array[Lt+7]=x[vn[1]],Wt.array[Lt+8]=x[vn[2]],Lt+=9;for(f=0,l=rn.length;f<l;f++)h=sn[rn[f]],E=Wt.value[h.a],S=Wt.value[h.b],x=Wt.value[h.c],T=Wt.value[h.d],Wt.array[Lt]=E[vn[0]],Wt.array[Lt+1]=E[vn[1]],Wt.array[Lt+2]=E[vn[2]],Wt.array[Lt+3]=S[vn[0]],Wt.array[Lt+4]=S[vn[1]],Wt.array[Lt+5]=S[vn[2]],Wt.array[Lt+6]=x[vn[0]],Wt.array[Lt+7]=x[vn[1]],Wt.array[Lt+8]=x[vn[2]],Wt.array[Lt+9]=T[vn[0]],Wt.array[Lt+10]=T[vn[1]],Wt.array[Lt+11]=T[vn[2]],Lt+=12}else if(Wt.boundTo==="faces"){for(f=0,l=nn.length;f<l;f++)Ot=Wt.value[nn[f]],E=Ot,S=Ot,x=Ot,Wt.array[Lt]=E[vn[0]],Wt.array[Lt+1]=E[vn[1]],Wt.array[Lt+2]=E[vn[2]],Wt.array[Lt+3]=S[vn[0]],Wt.array[Lt+4]=S[vn[1]],Wt.array[Lt+5]=S[vn[2]],Wt.array[Lt+6]=x[vn[0]],Wt.array[Lt+7]=x[vn[1]],Wt.array[Lt+8]=x[vn[2]],Lt+=9;for(f=0,l=rn.length;f<l;f++)Ot=Wt.value[rn[f]],E=Ot,S=Ot,x=Ot,T=Ot,Wt.array[Lt]=E[vn[0]],Wt.array[Lt+1]=E[vn[1]],Wt.array[Lt+2]=E[vn[2]],Wt.array[Lt+3]=S[vn[0]],Wt.array[Lt+4]=S[vn[1]],Wt.array[Lt+5]=S[vn[2]],Wt.array[Lt+6]=x[vn[0]],Wt.array[Lt+7]=x[vn[1]],Wt.array[Lt+8]=x[vn[2]],Wt.array[Lt+9]=T[vn[0]],Wt.array[Lt+10]=T[vn[1]],Wt.array[Lt+11]=T[vn[2]],Lt+=12}else if(Wt.boundTo==="faceVertices"){for(f=0,l=nn.length;f<l;f++)Ot=Wt.value[nn[f]],E=Ot[0],S=Ot[1],x=Ot[2],Wt.array[Lt]=E[vn[0]],Wt.array[Lt+1]=E[vn[1]],Wt.array[Lt+2]=E[vn[2]],Wt.array[Lt+3]=S[vn[0]],Wt.array[Lt+4]=S[vn[1]],Wt.array[Lt+5]=S[vn[2]],Wt.array[Lt+6]=x[vn[0]],Wt.array[Lt+7]=x[vn[1]],Wt.array[Lt+8]=x[vn[2]],Lt+=9;for(f=0,l=rn.length;f<l;f++)Ot=Wt.value[rn[f]],E=Ot[0],S=Ot[1],x=Ot[2],T=Ot[3],Wt.array[Lt]=E[vn[0]],Wt.array[Lt+1]=E[vn[1]],Wt.array[Lt+2]=E[vn[2]],Wt.array[Lt+3]=S[vn[0]],Wt.array[Lt+4]=S[vn[1]],Wt.array[Lt+5]=S[vn[2]],Wt.array[Lt+6]=x[vn[0]],Wt.array[Lt+7]=x[vn[1]],Wt.array[Lt+8]=x[vn[2]],Wt.array[Lt+9]=T[vn[0]],Wt.array[Lt+10]=T[vn[1]],Wt.array[Lt+11]=T[vn[2]],Lt+=12}}else if(Wt.size===4)if(Wt.boundTo===undefined||Wt.boundTo==="vertices"){for(f=0,l=nn.length;f<l;f++)h=sn[nn[f]],E=Wt.value[h.a],S=Wt.value[h.b],x=Wt.value[h.c],Wt.array[Lt]=E.x,Wt.array[Lt+1]=E.y,Wt.array[Lt+2]=E.z,Wt.array[Lt+3]=E.w,Wt.array[Lt+4]=S.x,Wt.array[Lt+5]=S.y,Wt.array[Lt+6]=S.z,Wt.array[Lt+7]=S.w,Wt.array[Lt+8]=x.x,Wt.array[Lt+9]=x.y,Wt.array[Lt+10]=x.z,Wt.array[Lt+11]=x.w,Lt+=12;for(f=0,l=rn.length;f<l;f++)h=sn[rn[f]],E=Wt.value[h.a],S=Wt.value[h.b],x=Wt.value[h.c],T=Wt.value[h.d],Wt.array[Lt]=E.x,Wt.array[Lt+1]=E.y,Wt.array[Lt+2]=E.z,Wt.array[Lt+3]=E.w,Wt.array[Lt+4]=S.x,Wt.array[Lt+5]=S.y,Wt.array[Lt+6]=S.z,Wt.array[Lt+7]=S.w,Wt.array[Lt+8]=x.x,Wt.array[Lt+9]=x.y,Wt.array[Lt+10]=x.z,Wt.array[Lt+11]=x.w,Wt.array[Lt+12]=T.x,Wt.array[Lt+13]=T.y,Wt.array[Lt+14]=T.z,Wt.array[Lt+15]=T.w,Lt+=16}else if(Wt.boundTo==="faces"){for(f=0,l=nn.length;f<l;f++)Ot=Wt.value[nn[f]],E=Ot,S=Ot,x=Ot,Wt.array[Lt]=E.x,Wt.array[Lt+1]=E.y,Wt.array[Lt+2]=E.z,Wt.array[Lt+3]=E.w,Wt.array[Lt+4]=S.x,Wt.array[Lt+5]=S.y,Wt.array[Lt+6]=S.z,Wt.array[Lt+7]=S.w,Wt.array[Lt+8]=x.x,Wt.array[Lt+9]=x.y,Wt.array[Lt+10]=x.z,Wt.array[Lt+11]=x.w,Lt+=12;for(f=0,l=rn.length;f<l;f++)Ot=Wt.value[rn[f]],E=Ot,S=Ot,x=Ot,T=Ot,Wt.array[Lt]=E.x,Wt.array[Lt+1]=E.y,Wt.array[Lt+2]=E.z,Wt.array[Lt+3]=E.w,Wt.array[Lt+4]=S.x,Wt.array[Lt+5]=S.y,Wt.array[Lt+6]=S.z,Wt.array[Lt+7]=S.w,Wt.array[Lt+8]=x.x,Wt.array[Lt+9]=x.y,Wt.array[Lt+10]=x.z,Wt.array[Lt+11]=x.w,Wt.array[Lt+12]=T.x,Wt.array[Lt+13]=T.y,Wt.array[Lt+14]=T.z,Wt.array[Lt+15]=T.w,Lt+=16}else if(Wt.boundTo==="faceVertices"){for(f=0,l=nn.length;f<l;f++)Ot=Wt.value[nn[f]],E=Ot[0],S=Ot[1],x=Ot[2],Wt.array[Lt]=E.x,Wt.array[Lt+1]=E.y,Wt.array[Lt+2]=E.z,Wt.array[Lt+3]=E.w,Wt.array[Lt+4]=S.x,Wt.array[Lt+5]=S.y,Wt.array[Lt+6]=S.z,Wt.array[Lt+7]=S.w,Wt.array[Lt+8]=x.x,Wt.array[Lt+9]=x.y,Wt.array[Lt+10]=x.z,Wt.array[Lt+11]=x.w,Lt+=12;for(f=0,l=rn.length;f<l;f++)Ot=Wt.value[rn[f]],E=Ot[0],S=Ot[1],x=Ot[2],T=Ot[3],Wt.array[Lt]=E.x,Wt.array[Lt+1]=E.y,Wt.array[Lt+2]=E.z,Wt.array[Lt+3]=E.w,Wt.array[Lt+4]=S.x,Wt.array[Lt+5]=S.y,Wt.array[Lt+6]=S.z,Wt.array[Lt+7]=S.w,Wt.array[Lt+8]=x.x,Wt.array[Lt+9]=x.y,Wt.array[Lt+10]=x.z,Wt.array[Lt+11]=x.w,Wt.array[Lt+12]=T.x,Wt.array[Lt+13]=T.y,Wt.array[Lt+14]=T.z,Wt.array[Lt+15]=T.w,Lt+=16}X.bindBuffer(X.ARRAY_BUFFER,Wt.buffer),X.bufferData(X.ARRAY_BUFFER,Wt.array,n)}r&&(delete e.__inittedArrays,delete e.__colorArray,delete e.__normalArray,delete e.__tangentArray,delete e.__uvArray,delete e.__uv2Array,delete e.__faceArray,delete e.__vertexArray,delete e.__lineArray,delete e.__skinVertexAArray,delete e.__skinVertexBArray,delete e.__skinIndexArray,delete e.__skinWeightArray)}function Tt(e,t,n){var r=e.attributes,i=r.index,s=r.position,o=r.normal,u=r.uv,a=r.color,f=r.tangent;e.elementsNeedUpdate&&i!==undefined&&(X.bindBuffer(X.ELEMENT_ARRAY_BUFFER,i.buffer),X.bufferData(X.ELEMENT_ARRAY_BUFFER,i.array,t)),e.verticesNeedUpdate&&s!==undefined&&(X.bindBuffer(X.ARRAY_BUFFER,s.buffer),X.bufferData(X.ARRAY_BUFFER,s.array,t)),e.normalsNeedUpdate&&o!==undefined&&(X.bindBuffer(X.ARRAY_BUFFER,o.buffer),X.bufferData(X.ARRAY_BUFFER,o.array,t)),e.uvsNeedUpdate&&u!==undefined&&(X.bindBuffer(X.ARRAY_BUFFER,u.buffer),X.bufferData(X.ARRAY_BUFFER,u.array,t)),e.colorsNeedUpdate&&a!==undefined&&(X.bindBuffer(X.ARRAY_BUFFER,a.buffer),X.bufferData(X.ARRAY_BUFFER,a.array,t)),e.tangentsNeedUpdate&&f!==undefined&&(X.bindBuffer(X.ARRAY_BUFFER,f.buffer),X.bufferData(X.ARRAY_BUFFER,f.array,t));if(n)for(var l in e.attributes)delete e.attributes[l].array}function Nt(e,t,n){var r=e.program.attributes;n.morphTargetBase!==-1?(X.bindBuffer(X.ARRAY_BUFFER,t.__webglMorphTargetsBuffers[n.morphTargetBase]),X.vertexAttribPointer(r.position,3,X.FLOAT,!1,0,0)):r.position>=0&&(X.bindBuffer(X.ARRAY_BUFFER,t.__webglVertexBuffer),X.vertexAttribPointer(r.position,3,X.FLOAT,!1,0,0));if(n.morphTargetForcedOrder.length){var i=0,s=n.morphTargetForcedOrder,o=n.morphTargetInfluences;while(i<e.numSupportedMorphTargets&&i<s.length)X.bindBuffer(X.ARRAY_BUFFER,t.__webglMorphTargetsBuffers[s[i]]),X.vertexAttribPointer(r["morphTarget"+i],3,X.FLOAT,!1,0,0),e.morphNormals&&(X.bindBuffer(X.ARRAY_BUFFER,t.__webglMorphNormalsBuffers[s[i]]),X.vertexAttribPointer(r["morphNormal"+i],3,X.FLOAT,!1,0,0)),n.__webglMorphTargetInfluences[i]=o[s[i]],i++}else{var u,a=[],o=n.morphTargetInfluences,f,l=o.length;for(f=0;f<l;f++)u=o[f],u>0&&a.push([f,u]);a.length>e.numSupportedMorphTargets?(a.sort(kt),a.length=e.numSupportedMorphTargets):a.length>e.numSupportedMorphNormals?a.sort(kt):a.length===0&&a.push([0,0]);var c,i=0;while(i<e.numSupportedMorphTargets)a[i]?(c=a[i][0],X.bindBuffer(X.ARRAY_BUFFER,t.__webglMorphTargetsBuffers[c]),X.vertexAttribPointer(r["morphTarget"+i],3,X.FLOAT,!1,0,0),e.morphNormals&&(X.bindBuffer(X.ARRAY_BUFFER,t.__webglMorphNormalsBuffers[c]),X.vertexAttribPointer(r["morphNormal"+i],3,X.FLOAT,!1,0,0)),n.__webglMorphTargetInfluences[i]=o[c]):(X.vertexAttribPointer(r["morphTarget"+i],3,X.FLOAT,!1,0,0),e.morphNormals&&X.vertexAttribPointer(r["morphNormal"+i],3,X.FLOAT,!1,0,0),n.__webglMorphTargetInfluences[i]=0),i++}e.program.uniforms.morphTargetInfluences!==null&&X.uniform1fv(e.program.uniforms.morphTargetInfluences,n.__webglMorphTargetInfluences)}function Ct(e,t){return t.z-e.z}function kt(e,t){return t[1]-e[1]}function Lt(e,t,n){if(!e.length)return;for(var r=0,i=e.length;r<i;r++)d=null,y=null,S=-1,C=-1,k=-1,w=-1,E=-1,g=-1,m=-1,z=!0,e[r].render(t,n,B,j),d=null,y=null,S=-1,C=-1,k=-1,w=-1,E=-1,g=-1,m=-1,z=!0}function At(e,t,n,r,i,s,o,u){var a,f,l,h,p,d,v;t?(p=e.length-1,d=-1,v=-1):(p=0,d=e.length,v=1);for(var m=p;m!==d;m+=v){a=e[m];if(a.render){f=a.object,l=a.buffer;if(u)h=u;else{h=a[n];if(!h)continue;o&&c.setBlending(h.blending,h.blendEquation,h.blendSrc,h.blendDst),c.setDepthTest(h.depthTest),c.setDepthWrite(h.depthWrite),sn(h.polygonOffset,h.polygonOffsetFactor,h.polygonOffsetUnits)}c.setMaterialFaces(h),l instanceof THREE.BufferGeometry?c.renderBufferDirect(r,i,s,h,l,f):c.renderBuffer(r,i,s,h,l,f)}}}function Ot(e,t,n,r,i,s,o){var u,a,f,l;for(var h=0,p=e.length;h<p;h++){u=e[h],a=u.object;if(a.visible){if(o)f=o;else{f=u[t];if(!f)continue;s&&c.setBlending(f.blending,f.blendEquation,f.blendSrc,f.blendDst),c.setDepthTest(f.depthTest),c.setDepthWrite(f.depthWrite),sn(f.polygonOffset,f.polygonOffsetFactor,f.polygonOffsetUnits)}c.renderImmediateObject(n,r,i,f,a)}}}function Mt(e){var t=e.object,n=t.material;n.transparent?(e.transparent=n,e.opaque=null):(e.opaque=n,e.transparent=null)}function _t(e){var t=e.object,n=e.buffer,r,i,s;s=t.material,s instanceof THREE.MeshFaceMaterial?(i=n.materialIndex,i>=0&&(r=t.geometry.materials[i],r.transparent?(e.transparent=r,e.opaque=null):(e.opaque=r,e.transparent=null))):(r=s,r&&(r.transparent?(e.transparent=r,e.opaque=null):(e.opaque=r,e.transparent=null)))}function Dt(e){var t,n,r,i,s,o,u,a={},f=e.morphTargets.length,l=e.morphNormals.length;e.geometryGroups={};for(t=0,n=e.faces.length;t<n;t++)r=e.faces[t],i=r.materialIndex,o=i!==undefined?i:-1,a[o]===undefined&&(a[o]={hash:o,counter:0}),u=a[o].hash+"_"+a[o].counter,e.geometryGroups[u]===undefined&&(e.geometryGroups[u]={faces3:[],faces4:[],materialIndex:i,vertices:0,numMorphTargets:f,numMorphNormals:l}),s=r instanceof THREE.Face3?3:4,e.geometryGroups[u].vertices+s>65535&&(a[o].counter+=1,u=a[o].hash+"_"+a[o].counter,e.geometryGroups[u]===undefined&&(e.geometryGroups[u]={faces3:[],faces4:[],materialIndex:i,vertices:0,numMorphTargets:f,numMorphNormals:l})),r instanceof THREE.Face3?e.geometryGroups[u].faces3.push(t):e.geometryGroups[u].faces4.push(t),e.geometryGroups[u].vertices+=s;e.geometryGroupsList=[];for(var c in e.geometryGroups)e.geometryGroups[c].id=b++,e.geometryGroupsList.push(e.geometryGroups[c])}function Pt(e,t){var n,r,i;if(!e.__webglInit){e.__webglInit=!0,e._modelViewMatrix=new THREE.Matrix4,e._normalMatrix=new THREE.Matrix3;if(e instanceof THREE.Mesh){r=e.geometry;if(r instanceof THREE.Geometry){r.geometryGroups===undefined&&Dt(r);for(n in r.geometryGroups)i=r.geometryGroups[n],i.__webglVertexBuffer||(it(i),pt(i,e),r.verticesNeedUpdate=!0,r.morphTargetsNeedUpdate=!0,r.elementsNeedUpdate=!0,r.uvsNeedUpdate=!0,r.normalsNeedUpdate=!0,r.tangentsNeedUpdate=!0,r.colorsNeedUpdate=!0)}else r instanceof THREE.BufferGeometry&&bt(r)}else e instanceof THREE.Ribbon?(r=e.geometry,r.__webglVertexBuffer||(rt(r),ht(r),r.verticesNeedUpdate=!0,r.colorsNeedUpdate=!0)):e instanceof THREE.Line?(r=e.geometry,r.__webglVertexBuffer||(nt(r),ct(r,e),r.verticesNeedUpdate=!0,r.colorsNeedUpdate=!0)):e instanceof THREE.ParticleSystem&&(r=e.geometry,r.__webglVertexBuffer||(tt(r),lt(r,e),r.verticesNeedUpdate=!0,r.colorsNeedUpdate=!0))}if(!e.__webglActive){if(e instanceof THREE.Mesh){r=e.geometry;if(r instanceof THREE.BufferGeometry)Ht(t.__webglObjects,r,e);else for(n in r.geometryGroups)i=r.geometryGroups[n],Ht(t.__webglObjects,i,e)}else e instanceof THREE.Ribbon||e instanceof THREE.Line||e instanceof THREE.ParticleSystem?(r=e.geometry,Ht(t.__webglObjects,r,e)):e instanceof THREE.ImmediateRenderObject||e.immediateRenderCallback?Bt(t.__webglObjectsImmediate,e):e instanceof THREE.Sprite?t.__webglSprites.push(e):e instanceof THREE.LensFlare&&t.__webglFlares.push(e);e.__webglActive=!0}}function Ht(e,t,n){e.push({buffer:t,object:n,opaque:null,transparent:null})}function Bt(e,t){e.push({object:t,opaque:null,transparent:null})}function jt(e){var t=e.geometry,n,r,i;if(e instanceof THREE.Mesh)if(t instanceof THREE.BufferGeometry)(t.verticesNeedUpdate||t.elementsNeedUpdate||t.uvsNeedUpdate||t.normalsNeedUpdate||t.colorsNeedUpdate||t.tangentsNeedUpdate)&&Tt(t,X.DYNAMIC_DRAW,!t.dynamic),t.verticesNeedUpdate=!1,t.elementsNeedUpdate=!1,t.uvsNeedUpdate=!1,t.normalsNeedUpdate=!1,t.colorsNeedUpdate=!1,t.tangentsNeedUpdate=!1;else{for(var s=0,o=t.geometryGroupsList.length;s<o;s++)n=t.geometryGroupsList[s],i=dt(e,n),r=i.attributes&&Ft(i),(t.verticesNeedUpdate||t.morphTargetsNeedUpdate||t.elementsNeedUpdate||t.uvsNeedUpdate||t.normalsNeedUpdate||t.colorsNeedUpdate||t.tangentsNeedUpdate||r)&&xt(n,e,X.DYNAMIC_DRAW,!t.dynamic,i);t.verticesNeedUpdate=!1,t.morphTargetsNeedUpdate=!1,t.elementsNeedUpdate=!1,t.uvsNeedUpdate=!1,t.normalsNeedUpdate=!1,t.colorsNeedUpdate=!1,t.tangentsNeedUpdate=!1,i.attributes&&It(i)}else e instanceof THREE.Ribbon?((t.verticesNeedUpdate||t.colorsNeedUpdate)&&St(t,X.DYNAMIC_DRAW),t.verticesNeedUpdate=!1,t.colorsNeedUpdate=!1):e instanceof THREE.Line?(i=dt(e,n),r=i.attributes&&Ft(i),(t.verticesNeedUpdate||t.colorsNeedUpdate||r)&&Et(t,X.DYNAMIC_DRAW),t.verticesNeedUpdate=!1,t.colorsNeedUpdate=!1,i.attributes&&It(i)):e instanceof THREE.ParticleSystem&&(i=dt(e,n),r=i.attributes&&Ft(i),(t.verticesNeedUpdate||t.colorsNeedUpdate||e.sortParticles||r)&&wt(t,X.DYNAMIC_DRAW,e),t.verticesNeedUpdate=!1,t.colorsNeedUpdate=!1,i.attributes&&It(i))}function Ft(e){for(var t in e.attributes)if(e.attributes[t].needsUpdate)return!0;return!1}function It(e){for(var t in e.attributes)e.attributes[t].needsUpdate=!1}function qt(e,t){e instanceof THREE.Mesh||e instanceof THREE.ParticleSystem||e instanceof THREE.Ribbon||e instanceof THREE.Line?Rt(t.__webglObjects,e):e instanceof THREE.Sprite?Ut(t.__webglSprites,e):e instanceof THREE.LensFlare?Ut(t.__webglFlares,e):(e instanceof THREE.ImmediateRenderObject||e.immediateRenderCallback)&&Rt(t.__webglObjectsImmediate,e),e.__webglActive=!1}function Rt(e,t){for(var n=e.length-1;n>=0;n--)e[n].object===t&&e.splice(n,1)}function Ut(e,t){for(var n=e.length-1;n>=0;n--)e[n]===t&&e.splice(n,1)}function zt(e,t){e.uniforms=THREE.UniformsUtils.clone(t.uniforms),e.vertexShader=t.vertexShader,e.fragmentShader=t.fragmentShader}function Wt(e,t,n,r,i){r.needsUpdate&&(r.program&&c.deallocateMaterial(r),c.initMaterial(r,t,n,i),r.needsUpdate=!1),r.morphTargets&&(i.__webglMorphTargetInfluences||(i.__webglMorphTargetInfluences=new Float32Array(c.maxMorphTargets)));var s=!1,o=r.program,u=o.uniforms,a=r.uniforms;o!==d&&(X.useProgram(o),d=o,s=!0),r.id!==m&&(m=r.id,s=!0);if(s||e!==y)X.uniformMatrix4fv(u.projectionMatrix,!1,e._projectionMatrixArray),e!==y&&(y=e);if(s){n&&r.fog&&Jt(a,n);if(r instanceof THREE.MeshPhongMaterial||r instanceof THREE.MeshLambertMaterial||r.lights)z&&(nn(o,t),z=!1),Gt(a,W);(r instanceof THREE.MeshBasicMaterial||r instanceof THREE.MeshLambertMaterial||r instanceof THREE.MeshPhongMaterial)&&Xt(a,r),r instanceof THREE.LineBasicMaterial?Vt(a,r):r instanceof THREE.ParticleBasicMaterial?$t(a,r):r instanceof THREE.MeshPhongMaterial?Kt(a,r):r instanceof THREE.MeshLambertMaterial?Qt(a,r):r instanceof THREE.MeshDepthMaterial?(a.mNear.value=e.near,a.mFar.value=e.far,a.opacity.value=r.opacity):r instanceof THREE.MeshNormalMaterial&&(a.opacity.value=r.opacity),i.receiveShadow&&!r._shadowPass&&Yt(a,t),en(o,r.uniformsList);if(r instanceof THREE.ShaderMaterial||r instanceof THREE.MeshPhongMaterial||r.envMap)if(u.cameraPosition!==null){var f=e.matrixWorld.getPosition();X.uniform3f(u.cameraPosition,f.x,f.y,f.z)}(r instanceof THREE.MeshPhongMaterial||r instanceof THREE.MeshLambertMaterial||r instanceof THREE.ShaderMaterial||r.skinning)&&u.viewMatrix!==null&&X.uniformMatrix4fv(u.viewMatrix,!1,e._viewMatrixArray)}if(r.skinning)if(et&&i.useVertexTexture){if(u.boneTexture!==null){var l=12;X.uniform1i(u.boneTexture,l),c.setTexture(i.boneTexture,l)}}else u.boneGlobalMatrices!==null&&X.uniformMatrix4fv(u.boneGlobalMatrices,!1,i.boneMatrices);return Zt(u,i),u.modelMatrix!==null&&X.uniformMatrix4fv(u.modelMatrix,!1,i.matrixWorld.elements),o}function Xt(e,t){e.opacity.value=t.opacity,c.gammaInput?e.diffuse.value.copyGammaToLinear(t.color):e.diffuse.value=t.color,e.map.texture=t.map,e.lightMap.texture=t.lightMap,e.specularMap.texture=t.specularMap,t.bumpMap&&(e.bumpMap.texture=t.bumpMap,e.bumpScale.value=t.bumpScale);var n;t.map?n=t.map:t.specularMap?n=t.specularMap:t.bumpMap&&(n=t.bumpMap);if(n!==undefined){var r=n.offset,i=n.repeat;e.offsetRepeat.value.set(r.x,r.y,i.x,i.y)}e.envMap.texture=t.envMap,e.flipEnvMap.value=t.envMap instanceof THREE.WebGLRenderTargetCube?1:-1,c.gammaInput?e.reflectivity.value=t.reflectivity:e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio,e.combine.value=t.combine,e.useRefract.value=t.envMap&&t.envMap.mapping instanceof THREE.CubeRefractionMapping}function Vt(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}function $t(e,n){e.psColor.value=n.color,e.opacity.value=n.opacity,e.size.value=n.size,e.scale.value=t.height/2,e.map.texture=n.map}function Jt(e,t){e.fogColor.value=t.color,t instanceof THREE.Fog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t instanceof THREE.FogExp2&&(e.fogDensity.value=t.density)}function Kt(e,t){e.shininess.value=t.shininess,c.gammaInput?(e.ambient.value.copyGammaToLinear(t.ambient),e.emissive.value.copyGammaToLinear(t.emissive),e.specular.value.copyGammaToLinear(t.specular)):(e.ambient.value=t.ambient,e.emissive.value=t.emissive,e.specular.value=t.specular),t.wrapAround&&e.wrapRGB.value.copy(t.wrapRGB)}function Qt(e,t){c.gammaInput?(e.ambient.value.copyGammaToLinear(t.ambient),e.emissive.value.copyGammaToLinear(t.emissive)):(e.ambient.value=t.ambient,e.emissive.value=t.emissive),t.wrapAround&&e.wrapRGB.value.copy(t.wrapRGB)}function Gt(e,t){e.ambientLightColor.value=t.ambient,e.directionalLightColor.value=t.directional.colors,e.directionalLightDirection.value=t.directional.positions,e.pointLightColor.value=t.point.colors,e.pointLightPosition.value=t.point.positions,e.pointLightDistance.value=t.point.distances,e.spotLightColor.value=t.spot.colors,e.spotLightPosition.value=t.spot.positions,e.spotLightDistance.value=t.spot.distances,e.spotLightDirection.value=t.spot.directions,e.spotLightAngle.value=t.spot.angles,e.spotLightExponent.value=t.spot.exponents}function Yt(e,t){if(e.shadowMatrix){var n=0;for(var r=0,i=t.length;r<i;r++){var s=t[r];if(!s.castShadow)continue;if(s instanceof THREE.SpotLight||s instanceof THREE.DirectionalLight&&!s.shadowCascade)e.shadowMap.texture[n]=s.shadowMap,e.shadowMapSize.value[n]=s.shadowMapSize,e.shadowMatrix.value[n]=s.shadowMatrix,e.shadowDarkness.value[n]=s.shadowDarkness,e.shadowBias.value[n]=s.shadowBias,n++}}}function Zt(e,t){X.uniformMatrix4fv(e.modelViewMatrix,!1,t._modelViewMatrix.elements),e.normalMatrix&&X.uniformMatrix3fv(e.normalMatrix,!1,t._normalMatrix.elements)}function en(e,t){var n,r,i,s,o,u,a,f,l,h;for(f=0,l=t.length;f<l;f++){s=e.uniforms[t[f][1]];if(!s)continue;n=t[f][0],i=n.type,r=n.value;if(i==="i")X.uniform1i(s,r);else if(i==="f")X.uniform1f(s,r);else if(i==="v2")X.uniform2f(s,r.x,r.y);else if(i==="v3")X.uniform3f(s,r.x,r.y,r.z);else if(i==="v4")X.uniform4f(s,r.x,r.y,r.z,r.w);else if(i==="c")X.uniform3f(s,r.r,r.g,r.b);else if(i==="iv1")X.uniform1iv(s,r);else if(i==="iv")X.uniform3iv(s,r);else if(i==="fv1")X.uniform1fv(s,r);else if(i==="fv")X.uniform3fv(s,r);else if(i==="v2v"){n._array===undefined&&(n._array=new Float32Array(2*r.length));for(u=0,a=r.length;u<a;u++)h=u*2,n._array[h]=r[u].x,n._array[h+1]=r[u].y;X.uniform2fv(s,n._array)}else if(i==="v3v"){n._array===undefined&&(n._array=new Float32Array(3*r.length));for(u=0,a=r.length;u<a;u++)h=u*3,n._array[h]=r[u].x,n._array[h+1]=r[u].y,n._array[h+2]=r[u].z;X.uniform3fv(s,n._array)}else if(i==="v4v"){n._array===undefined&&(n._array=new Float32Array(4*r.length));for(u=0,a=r.length;u<a;u++)h=u*4,n._array[h]=r[u].x,n._array[h+1]=r[u].y,n._array[h+2]=r[u].z,n._array[h+3]=r[u].w;X.uniform4fv(s,n._array)}else if(i==="m4")n._array===undefined&&(n._array=new Float32Array(16)),r.flattenToArray(n._array),X.uniformMatrix4fv(s,!1,n._array);else if(i==="m4v"){n._array===undefined&&(n._array=new Float32Array(16*r.length));for(u=0,a=r.length;u<a;u++)r[u].flattenToArrayOffset(n._array,u*16);X.uniformMatrix4fv(s,!1,n._array)}else if(i==="t"){X.uniform1i(s,r),o=n.texture;if(!o)continue;o.image instanceof Array&&o.image.length===6?dn(o,r):o instanceof THREE.WebGLRenderTargetCube?vn(o,r):c.setTexture(o,r)}else if(i==="tv"){if(n._array===undefined){n._array=[];for(u=0,a=n.texture.length;u<a;u++)n._array[u]=r+u}X.uniform1iv(s,n._array);for(u=0,a=n.texture.length;u<a;u++){o=n.texture[u];if(!o)continue;c.setTexture(o,n._array[u])}}}}function tn(e,t){e._modelViewMatrix.multiply(t.matrixWorldInverse,e.matrixWorld),e._normalMatrix.getInverse(e._modelViewMatrix),e._normalMatrix.transpose()}function nn(e,t){var n,r,i,s,o=0,u=0,a=0,f,l,h,p,d=W,v=d.directional.colors,m=d.directional.positions,g=d.point.colors,y=d.point.positions,b=d.point.distances,w=d.spot.colors,E=d.spot.positions,S=d.spot.distances,x=d.spot.directions,T=d.spot.angles,N=d.spot.exponents,C=0,k=0,L=0,A=0,O=0,M=0;for(n=0,r=t.length;n<r;n++){i=t[n];if(i.onlyShadow||!i.visible)continue;f=i.color,h=i.intensity,p=i.distance,i instanceof THREE.AmbientLight?c.gammaInput?(o+=f.r*f.r,u+=f.g*f.g,a+=f.b*f.b):(o+=f.r,u+=f.g,a+=f.b):i instanceof THREE.DirectionalLight?(A=C*3,c.gammaInput?(v[A]=f.r*f.r*h*h,v[A+1]=f.g*f.g*h*h,v[A+2]=f.b*f.b*h*h):(v[A]=f.r*h,v[A+1]=f.g*h,v[A+2]=f.b*h),U.copy(i.matrixWorld.getPosition()),U.subSelf(i.target.matrixWorld.getPosition()),U.normalize(),m[A]=U.x,m[A+1]=U.y,m[A+2]=U.z,C+=1):i instanceof THREE.PointLight?(O=k*3,c.gammaInput?(g[O]=f.r*f.r*h*h,g[O+1]=f.g*f.g*h*h,g[O+2]=f.b*f.b*h*h):(g[O]=f.r*h,g[O+1]=f.g*h,g[O+2]=f.b*h),l=i.matrixWorld.getPosition(),y[O]=l.x,y[O+1]=l.y,y[O+2]=l.z,b[k]=p,k+=1):i instanceof THREE.SpotLight&&(M=L*3,c.gammaInput?(w[M]=f.r*f.r*h*h,w[M+1]=f.g*f.g*h*h,w[M+2]=f.b*f.b*h*h):(w[M]=f.r*h,w[M+1]=f.g*h,w[M+2]=f.b*h),l=i.matrixWorld.getPosition(),E[M]=l.x,E[M+1]=l.y,E[M+2]=l.z,S[L]=p,U.copy(l),U.subSelf(i.target.matrixWorld.getPosition()),U.normalize(),x[M]=U.x,x[M+1]=U.y,x[M+2]=U.z,T[L]=Math.cos(i.angle),N[L]=i.exponent,L+=1)}for(n=C*3,r=v.length;n<r;n++)v[n]=0;for(n=k*3,r=g.length;n<r;n++)g[n]=0;for(n=L*3,r=w.length;n<r;n++)w[n]=0;d.directional.length=C,d.point.length=k,d.spot.length=L,d.ambient[0]=o,d.ambient[1]=u,d.ambient[2]=a}function rn(e){e!==M&&(X.lineWidth(e),M=e)}function sn(e,t,n){L!==e&&(e?X.enable(X.POLYGON_OFFSET_FILL):X.disable(X.POLYGON_OFFSET_FILL),L=e),e&&(A!==t||O!==n)&&(X.polygonOffset(t,n),A=t,O=n)}function on(e,t,r,i,s,o){var u,a,f,l,d=[];e?d.push(e):(d.push(t),d.push(r));for(u in o)d.push(u),d.push(o[u]);l=d.join();for(u=0,a=h.length;u<a;u++){var v=h[u];if(v.code===l)return v.usedTimes++,v.program}f=X.createProgram();var m=["precision "+n+" float;",Z?"#define VERTEX_TEXTURES":"",c.gammaInput?"#define GAMMA_INPUT":"",c.gammaOutput?"#define GAMMA_OUTPUT":"",c.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"","#define MAX_DIR_LIGHTS "+o.maxDirLights,"#define MAX_POINT_LIGHTS "+o.maxPointLights,"#define MAX_SPOT_LIGHTS "+o.maxSpotLights,"#define MAX_SHADOWS "+o.maxShadows,"#define MAX_BONES "+o.maxBones,o.map?"#define USE_MAP":"",o.envMap?"#define USE_ENVMAP":"",o.lightMap?"#define USE_LIGHTMAP":"",o.bumpMap?"#define USE_BUMPMAP":"",o.specularMap?"#define USE_SPECULARMAP":"",o.vertexColors?"#define USE_COLOR":"",o.skinning?"#define USE_SKINNING":"",o.useVertexTexture?"#define BONE_TEXTURE":"",o.boneTextureWidth?"#define N_BONE_PIXEL_X "+o.boneTextureWidth.toFixed(1):"",o.boneTextureHeight?"#define N_BONE_PIXEL_Y "+o.boneTextureHeight.toFixed(1):"",o.morphTargets?"#define USE_MORPHTARGETS":"",o.morphNormals?"#define USE_MORPHNORMALS":"",o.perPixel?"#define PHONG_PER_PIXEL":"",o.wrapAround?"#define WRAP_AROUND":"",o.doubleSided?"#define DOUBLE_SIDED":"",o.shadowMapEnabled?"#define USE_SHADOWMAP":"",o.shadowMapSoft?"#define SHADOWMAP_SOFT":"",o.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",o.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",o.sizeAttenuation?"#define USE_SIZEATTENUATION":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","attribute vec2 uv2;","#ifdef USE_COLOR","attribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","attribute vec3 morphTarget0;","attribute vec3 morphTarget1;","attribute vec3 morphTarget2;","attribute vec3 morphTarget3;","#ifdef USE_MORPHNORMALS","attribute vec3 morphNormal0;","attribute vec3 morphNormal1;","attribute vec3 morphNormal2;","attribute vec3 morphNormal3;","#else","attribute vec3 morphTarget4;","attribute vec3 morphTarget5;","attribute vec3 morphTarget6;","attribute vec3 morphTarget7;","#endif","#endif","#ifdef USE_SKINNING","attribute vec4 skinVertexA;","attribute vec4 skinVertexB;","attribute vec4 skinIndex;","attribute vec4 skinWeight;","#endif",""].join("\n"),g=["precision "+n+" float;",o.bumpMap?"#extension GL_OES_standard_derivatives : enable":"","#define MAX_DIR_LIGHTS "+o.maxDirLights,"#define MAX_POINT_LIGHTS "+o.maxPointLights,"#define MAX_SPOT_LIGHTS "+o.maxSpotLights,"#define MAX_SHADOWS "+o.maxShadows,o.alphaTest?"#define ALPHATEST "+o.alphaTest:"",c.gammaInput?"#define GAMMA_INPUT":"",c.gammaOutput?"#define GAMMA_OUTPUT":"",c.physicallyBasedShading?"#define PHYSICALLY_BASED_SHADING":"",o.useFog&&o.fog?"#define USE_FOG":"",o.useFog&&o.fog instanceof THREE.FogExp2?"#define FOG_EXP2":"",o.map?"#define USE_MAP":"",o.envMap?"#define USE_ENVMAP":"",o.lightMap?"#define USE_LIGHTMAP":"",o.bumpMap?"#define USE_BUMPMAP":"",o.specularMap?"#define USE_SPECULARMAP":"",o.vertexColors?"#define USE_COLOR":"",o.metal?"#define METAL":"",o.perPixel?"#define PHONG_PER_PIXEL":"",o.wrapAround?"#define WRAP_AROUND":"",o.doubleSided?"#define DOUBLE_SIDED":"",o.shadowMapEnabled?"#define USE_SHADOWMAP":"",o.shadowMapSoft?"#define SHADOWMAP_SOFT":"",o.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",o.shadowMapCascade?"#define SHADOWMAP_CASCADE":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",""].join("\n"),y=ln("fragment",g+t),b=ln("vertex",m+r);X.attachShader(f,b),X.attachShader(f,y),X.linkProgram(f),X.getProgramParameter(f,X.LINK_STATUS)||console.error("Could not initialise shader\nVALIDATE_STATUS: "+X.getProgramParameter(f,X.VALIDATE_STATUS)+", gl error ["+X.getError()+"]"),X.deleteShader(y),X.deleteShader(b),f.uniforms={},f.attributes={};var w,E,S,x;w=["viewMatrix","modelViewMatrix","projectionMatrix","normalMatrix","modelMatrix","cameraPosition","morphTargetInfluences"],o.useVertexTexture?w.push("boneTexture"):w.push("boneGlobalMatrices");for(E in i)w.push(E);un(f,w),w=["position","normal","uv","uv2","tangent","color","skinVertexA","skinVertexB","skinIndex","skinWeight"];for(x=0;x<o.maxMorphTargets;x++)w.push("morphTarget"+x);for(x=0;x<o.maxMorphNormals;x++)w.push("morphNormal"+x);for(S in s)w.push(S);return an(f,w),f.id=p++,h.push({program:f,code:l,usedTimes:1}),c.info.memory.programs=h.length,f}function un(e,t){var n,r,i;for(n=0,r=t.length;n<r;n++)i=t[n],e.uniforms[i]=X.getUniformLocation(e,i)}function an(e,t){var n,r,i;for(n=0,r=t.length;n<r;n++)i=t[n],e.attributes[i]=X.getAttribLocation(e,i)}function fn(e){var t=e.split("\n");for(var n=0,r=t.length;n<r;n++)t[n]=n+1+": "+t[n];return t.join("\n")}function ln(e,t){var n;return e==="fragment"?n=X.createShader(X.FRAGMENT_SHADER):e==="vertex"&&(n=X.createShader(X.VERTEX_SHADER)),X.shaderSource(n,t),X.compileShader(n),X.getShaderParameter(n,X.COMPILE_STATUS)?n:(console.error(X.getShaderInfoLog(n)),console.error(fn(t)),null)}function cn(e){return(e&e-1)===0}function hn(e,t,n){n?(X.texParameteri(e,X.TEXTURE_WRAP_S,wn(t.wrapS)),X.texParameteri(e,X.TEXTURE_WRAP_T,wn(t.wrapT)),X.texParameteri(e,X.TEXTURE_MAG_FILTER,wn(t.magFilter)),X.texParameteri(e,X.TEXTURE_MIN_FILTER,wn(t.minFilter))):(X.texParameteri(e,X.TEXTURE_WRAP_S,X.CLAMP_TO_EDGE),X.texParameteri(e,X.TEXTURE_WRAP_T,X.CLAMP_TO_EDGE),X.texParameteri(e,X.TEXTURE_MAG_FILTER,bn(t.magFilter)),X.texParameteri(e,X.TEXTURE_MIN_FILTER,bn(t.minFilter))),J&&t.type!==THREE.FloatType&&(t.anisotropy>1||t.__oldAnisotropy)&&(X.texParameterf(e,J.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(t.anisotropy,Y)),t.__oldAnisotropy=t.anisotropy)}function pn(e,t){if(e.width<=t&&e.height<=t)return e;var n=Math.max(e.width,e.height),r=Math.floor(e.width*t/n),i=Math.floor(e.height*t/n),s=document.createElement("canvas");s.width=r,s.height=i;var o=s.getContext("2d");return o.drawImage(e,0,0,e.width,e.height,0,0,r,i),s}function dn(e,t){if(e.image.length===6)if(e.needsUpdate){e.image.__webglTextureCube||(e.image.__webglTextureCube=X.createTexture()),X.activeTexture(X.TEXTURE0+t),X.bindTexture(X.TEXTURE_CUBE_MAP,e.image.__webglTextureCube),X.pixelStorei(X.UNPACK_FLIP_Y_WEBGL,e.flipY);var n=[];for(var r=0;r<6;r++)c.autoScaleCubemaps?n[r]=pn(e.image[r],G):n[r]=e.image[r];var i=n[0],s=cn(i.width)&&cn(i.height),o=wn(e.format),u=wn(e.type);hn(X.TEXTURE_CUBE_MAP,e,s);for(var r=0;r<6;r++)X.texImage2D(X.TEXTURE_CUBE_MAP_POSITIVE_X+r,0,o,o,u,n[r]);e.generateMipmaps&&s&&X.generateMipmap(X.TEXTURE_CUBE_MAP),e.needsUpdate=!1,e.onUpdate&&e.onUpdate()}else X.activeTexture(X.TEXTURE0+t),X.bindTexture(X.TEXTURE_CUBE_MAP,e.image.__webglTextureCube)}function vn(e,t){X.activeTexture(X.TEXTURE0+t),X.bindTexture(X.TEXTURE_CUBE_MAP,e.__webglTexture)}function mn(e,t,n){X.bindFramebuffer(X.FRAMEBUFFER,e),X.framebufferTexture2D(X.FRAMEBUFFER,X.COLOR_ATTACHMENT0,n,t.__webglTexture,0)}function gn(e,t){X.bindRenderbuffer(X.RENDERBUFFER,e),t.depthBuffer&&!t.stencilBuffer?(X.renderbufferStorage(X.RENDERBUFFER,X.DEPTH_COMPONENT16,t.width,t.height),X.framebufferRenderbuffer(X.FRAMEBUFFER,X.DEPTH_ATTACHMENT,X.RENDERBUFFER,e)):t.depthBuffer&&t.stencilBuffer?(X.renderbufferStorage(X.RENDERBUFFER,X.DEPTH_STENCIL,t.width,t.height),X.framebufferRenderbuffer(X.FRAMEBUFFER,X.DEPTH_STENCIL_ATTACHMENT,X.RENDERBUFFER,e)):X.renderbufferStorage(X.RENDERBUFFER,X.RGBA4,t.width,t.height)}function yn(e){e instanceof THREE.WebGLRenderTargetCube?(X.bindTexture(X.TEXTURE_CUBE_MAP,e.__webglTexture),X.generateMipmap(X.TEXTURE_CUBE_MAP),X.bindTexture(X.TEXTURE_CUBE_MAP,null)):(X.bindTexture(X.TEXTURE_2D,e.__webglTexture),X.generateMipmap(X.TEXTURE_2D),X.bindTexture(X.TEXTURE_2D,null))}function bn(e){return e===THREE.NearestFilter||e===THREE.NearestMipMapNearestFilter||e===THREE.NearestMipMapLinearFilter?X.NEAREST:X.LINEAR}function wn(e){return e===THREE.RepeatWrapping?X.REPEAT:e===THREE.ClampToEdgeWrapping?X.CLAMP_TO_EDGE:e===THREE.MirroredRepeatWrapping?X.MIRRORED_REPEAT:e===THREE.NearestFilter?X.NEAREST:e===THREE.NearestMipMapNearestFilter?X.NEAREST_MIPMAP_NEAREST:e===THREE.NearestMipMapLinearFilter?X.NEAREST_MIPMAP_LINEAR:e===THREE.LinearFilter?X.LINEAR:e===THREE.LinearMipMapNearestFilter?X.LINEAR_MIPMAP_NEAREST:e===THREE.LinearMipMapLinearFilter?X.LINEAR_MIPMAP_LINEAR:e===THREE.UnsignedByteType?X.UNSIGNED_BYTE:e===THREE.UnsignedShort4444Type?X.UNSIGNED_SHORT_4_4_4_4:e===THREE.UnsignedShort5551Type?X.UNSIGNED_SHORT_5_5_5_1:e===THREE.UnsignedShort565Type?X.UNSIGNED_SHORT_5_6_5:e===THREE.ByteType?X.BYTE:e===THREE.ShortType?X.SHORT:e===THREE.UnsignedShortType?X.UNSIGNED_SHORT:e===THREE.IntType?X.INT:e===THREE.UnsignedIntType?X.UNSIGNED_INT:e===THREE.FloatType?X.FLOAT:e===THREE.AlphaFormat?X.ALPHA:e===THREE.RGBFormat?X.RGB:e===THREE.RGBAFormat?X.RGBA:e===THREE.LuminanceFormat?X.LUMINANCE:e===THREE.LuminanceAlphaFormat?X.LUMINANCE_ALPHA:e===THREE.AddEquation?X.FUNC_ADD:e===THREE.SubtractEquation?X.FUNC_SUBTRACT:e===THREE.ReverseSubtractEquation?X.FUNC_REVERSE_SUBTRACT:e===THREE.ZeroFactor?X.ZERO:e===THREE.OneFactor?X.ONE:e===THREE.SrcColorFactor?X.SRC_COLOR:e===THREE.OneMinusSrcColorFactor?X.ONE_MINUS_SRC_COLOR:e===THREE.SrcAlphaFactor?X.SRC_ALPHA:e===THREE.OneMinusSrcAlphaFactor?X.ONE_MINUS_SRC_ALPHA:e===THREE.DstAlphaFactor?X.DST_ALPHA:e===THREE.OneMinusDstAlphaFactor?X.ONE_MINUS_DST_ALPHA:e===THREE.DstColorFactor?X.DST_COLOR:e===THREE.OneMinusDstColorFactor?X.ONE_MINUS_DST_COLOR:e===THREE.SrcAlphaSaturateFactor?X.SRC_ALPHA_SATURATE:0}function En(e){if(et&&e&&e.useVertexTexture)return 1024;var t=X.getParameter(X.MAX_VERTEX_UNIFORM_VECTORS),n=Math.floor((t-20)/4),r=n;return e!==undefined&&e instanceof THREE.SkinnedMesh&&(r=Math.min(e.bones.length,r),r<e.bones.length&&console.warn("WebGLRenderer: too many bones - "+e.bones.length+", this GPU supports just "+r+" (try OpenGL instead of ANGLE)")),r}function Sn(e){var t,n,r,i,s,o,u,a,f;i=s=o=u=a=f=0;for(t=0,n=e.length;t<n;t++){r=e[t];if(r.onlyShadow)continue;r instanceof THREE.DirectionalLight&&i++,r instanceof THREE.PointLight&&s++,r instanceof THREE.SpotLight&&o++}return s+o+i<=l?(u=i,a=s,f=o):(u=Math.ceil(l*i/(s+i)),a=l-u,f=a),{directional:u,point:a,spot:f}}function xn(e){var t,n,r,i=0;for(t=0,n=e.length;t<n;t++){r=e[t];if(!r.castShadow)continue;r instanceof THREE.SpotLight&&i++,r instanceof THREE.DirectionalLight&&!r.shadowCascade&&i++}return i}function Tn(){try{if(!(X=t.getContext("experimental-webgl",{alpha:r,premultipliedAlpha:i,antialias:s,stencil:o,preserveDrawingBuffer:u})))throw"Error creating WebGL context."}catch(e){console.error(e)}V=X.getExtension("OES_texture_float"),$=X.getExtension("OES_standard_derivatives"),J=X.getExtension("EXT_texture_filter_anisotropic")||X.getExtension("MOZ_EXT_texture_filter_anisotropic")||X.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),V||console.log("THREE.WebGLRenderer: Float textures not supported."),$||console.log("THREE.WebGLRenderer: Standard derivatives not supported."),J||console.log("THREE.WebGLRenderer: Anisotropic texture filtering not supported.")}function Nn(){X.clearColor(0,0,0,1),X.clearDepth(1),X.clearStencil(0),X.enable(X.DEPTH_TEST),X.depthFunc(X.LEQUAL),X.frontFace(X.CCW),X.cullFace(X.BACK),X.enable(X.CULL_FACE),X.enable(X.BLEND),X.blendEquation(X.FUNC_ADD),X.blendFunc(X.SRC_ALPHA,X.ONE_MINUS_SRC_ALPHA),X.clearColor(a.r,a.g,a.b,f)}console.log("THREE.WebGLRenderer",THREE.REVISION),e=e||{};var t=e.canvas!==undefined?e.canvas:document.createElement("canvas"),n=e.precision!==undefined?e.precision:"highp",r=e.alpha!==undefined?e.alpha:!0,i=e.premultipliedAlpha!==undefined?e.premultipliedAlpha:!0,s=e.antialias!==undefined?e.antialias:!1,o=e.stencil!==undefined?e.stencil:!0,u=e.preserveDrawingBuffer!==undefined?e.preserveDrawingBuffer:!1,a=e.clearColor!==undefined?new THREE.Color(e.clearColor):new THREE.Color(0),f=e.clearAlpha!==undefined?e.clearAlpha:0,l=e.maxLights!==undefined?e.maxLights:4;this.domElement=t,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.autoUpdateObjects=!0,this.autoUpdateScene=!0,this.gammaInput=!1,this.gammaOutput=!1,this.physicallyBasedShading=!1,this.shadowMapEnabled=!1,this.shadowMapAutoUpdate=!0,this.shadowMapSoft=!0,this.shadowMapCullFrontFaces=!0,this.shadowMapDebug=!1,this.shadowMapCascade=!1,this.maxMorphTargets=8,this.maxMorphNormals=4,this.autoScaleCubemaps=!0,this.renderPluginsPre=[],this.renderPluginsPost=[],this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}};var c=this,h=[],p=0,d=null,v=null,m=-1,g=null,y=null,b=0,w=-1,E=-1,S=-1,x=-1,T=-1,N=-1,C=-1,k=-1,L=null,A=null,O=null,M=null,_=0,D=0,P=0,H=0,B=0,j=0,F=new THREE.Frustum,I=new THREE.Matrix4,q=new THREE.Matrix4,R=new THREE.Vector4,U=new THREE.Vector3,z=!0,W={ambient:[0,0,0],directional:{length:0,colors:new Array,positions:new Array},point:{length:0,colors:new Array,positions:new Array,distances:new Array},spot:{length:0,colors:new Array,positions:new Array,distances:new Array,directions:new Array,angles:new Array,exponents:new Array}},X,V,$,J;Tn(),Nn(),this.context=X;var K=X.getParameter(X.MAX_VERTEX_TEXTURE_IMAGE_UNITS),Q=X.getParameter(X.MAX_TEXTURE_SIZE),G=X.getParameter(X.MAX_CUBE_MAP_TEXTURE_SIZE),Y=J?X.getParameter(J.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,Z=K>0,et=Z&&V;this.getContext=function(){return X},this.supportsVertexTextures=function(){return Z},this.getMaxAnisotropy=function(){return Y},this.setSize=function(e,n){t.width=e,t.height=n,this.setViewport(0,0,t.width,t.height)},this.setViewport=function(e,n,r,i){_=e!==undefined?e:0,D=n!==undefined?n:0,P=r!==undefined?r:t.width,H=i!==undefined?i:t.height,X.viewport(_,D,P,H)},this.setScissor=function(e,t,n,r){X.scissor(e,t,n,r)},this.enableScissorTest=function(e){e?X.enable(X.SCISSOR_TEST):X.disable(X.SCISSOR_TEST)},this.setClearColorHex=function(e,t){a.setHex(e),f=t,X.clearColor(a.r,a.g,a.b,f)},this.setClearColor=function(e,t){a.copy(e),f=t,X.clearColor(a.r,a.g,a.b,f)},this.getClearColor=function(){return a},this.getClearAlpha=function(){return f},this.clear=function(e,t,n){var r=0;if(e===undefined||e)r|=X.COLOR_BUFFER_BIT;if(t===undefined||t)r|=X.DEPTH_BUFFER_BIT;if(n===undefined||n)r|=X.STENCIL_BUFFER_BIT;X.clear(r)},this.clearTarget=function(e,t,n,r){this.setRenderTarget(e),this.clear(t,n,r)},this.addPostPlugin=function(e){e.init(this),this.renderPluginsPost.push(e)},this.addPrePlugin=function(e){e.init(this),this.renderPluginsPre.push(e)},this.deallocateObject=function(e){if(!e.__webglInit)return;e.__webglInit=!1,delete e._modelViewMatrix,delete e._normalMatrix,delete e._normalMatrixArray,delete e._modelViewMatrixArray,delete e._modelMatrixArray;if(e instanceof THREE.Mesh)for(var t in e.geometry.geometryGroups)at(e.geometry.geometryGroups[t]);else e instanceof THREE.Ribbon?ut(e.geometry):e instanceof THREE.Line?ot(e.geometry):e instanceof THREE.ParticleSystem&&st(e.geometry)},this.deallocateTexture=function(e){if(!e.__webglInit)return;e.__webglInit=!1,X.deleteTexture(e.__webglTexture),c.info.memory.textures--},this.deallocateRenderTarget=function(e){if(!e||!e.__webglTexture)return;X.deleteTexture(e.__webglTexture);if(e instanceof THREE.WebGLRenderTargetCube)for(var t=0;t<6;t++)X.deleteFramebuffer(e.__webglFramebuffer[t]),X.deleteRenderbuffer(e.__webglRenderbuffer[t]);else X.deleteFramebuffer(e.__webglFramebuffer),X.deleteRenderbuffer(e.__webglRenderbuffer)},this.deallocateMaterial=function(e){var t=e.program;if(!t)return;e.program=undefined;var n,r,i,s=!1;for(n=0,r=h.length;n<r;n++){i=h[n];if(i.program===t){i.usedTimes--,i.usedTimes===0&&(s=!0);break}}if(s){var o=[];for(n=0,r=h.length;n<r;n++)i=h[n],i.program!==t&&o.push(i);h=o,X.deleteProgram(t),c.info.memory.programs--}},this.updateShadowMap=function(e,t){d=null,S=-1,C=-1,k=-1,g=-1,m=-1,z=!0,w=-1,E=-1,this.shadowMapPlugin.update(e,t)},this.renderBufferImmediate=function(e,t,n){e.hasPositions&&!e.__webglVertexBuffer&&(e.__webglVertexBuffer=X.createBuffer()),e.hasNormals&&!e.__webglNormalBuffer&&(e.__webglNormalBuffer=X.createBuffer()),e.hasUvs&&!e.__webglUvBuffer&&(e.__webglUvBuffer=X.createBuffer()),e.hasColors&&!e.__webglColorBuffer&&(e.__webglColorBuffer=X.createBuffer()),e.hasPositions&&(X.bindBuffer(X.ARRAY_BUFFER,e.__webglVertexBuffer),X.bufferData(X.ARRAY_BUFFER,e.positionArray,X.DYNAMIC_DRAW),X.enableVertexAttribArray(t.attributes.position),X.vertexAttribPointer(t.attributes.position,3,X.FLOAT,!1,0,0));if(e.hasNormals){X.bindBuffer(X.ARRAY_BUFFER,e.__webglNormalBuffer);if(n.shading===THREE.FlatShading){var r,i,s,o,u,a,f,l,c,h,p,d,v,m,g=e.count*3;for(m=0;m<g;m+=9)v=e.normalArray,o=v[m],f=v[m+1],h=v[m+2],u=v[m+3],l=v[m+4],p=v[m+5],a=v[m+6],c=v[m+7],d=v[m+8],r=(o+u+a)/3,i=(f+l+c)/3,s=(h+p+d)/3,v[m]=r,v[m+1]=i,v[m+2]=s,v[m+3]=r,v[m+4]=i,v[m+5]=s,v[m+6]=r,v[m+7]=i,v[m+8]=s}X.bufferData(X.ARRAY_BUFFER,e.normalArray,X.DYNAMIC_DRAW),X.enableVertexAttribArray(t.attributes.normal),X.vertexAttribPointer(t.attributes.normal,3,X.FLOAT,!1,0,0)}e.hasUvs&&n.map&&(X.bindBuffer(X.ARRAY_BUFFER,e.__webglUvBuffer),X.bufferData(X.ARRAY_BUFFER,e.uvArray,X.DYNAMIC_DRAW),X.enableVertexAttribArray(t.attributes.uv),X.vertexAttribPointer(t.attributes.uv,2,X.FLOAT,!1,0,0)),e.hasColors&&n.vertexColors!==THREE.NoColors&&(X.bindBuffer(X.ARRAY_BUFFER,e.__webglColorBuffer),X.bufferData(X.ARRAY_BUFFER,e.colorArray,X.DYNAMIC_DRAW),X.enableVertexAttribArray(t.attributes.color),X.vertexAttribPointer(t.attributes.color,3,X.FLOAT,!1,0,0)),X.drawArrays(X.TRIANGLES,0,e.count),e.count=0},this.renderBufferDirect=function(e,t,n,r,i,s){if(r.visible===!1)return;var o,u,a,f,l,h;o=Wt(e,t,n,r,s),u=o.attributes;var p=!1,d=r.wireframe?1:0,v=i.id*16777215+o.id*2+d;v!==g&&(g=v,p=!0);if(s instanceof THREE.Mesh){var m=i.offsets;m.length>1&&(p=!0);for(var y=0,b=m.length;y<b;++y){var w=m[y].index;if(p){var E=i.attributes.position,S=E.itemSize;X.bindBuffer(X.ARRAY_BUFFER,E.buffer),X.vertexAttribPointer(u.position,S,X.FLOAT,!1,0,w*S*4);var x=i.attributes.normal;if(u.normal>=0&&x){var T=x.itemSize;X.bindBuffer(X.ARRAY_BUFFER,x.buffer),X.vertexAttribPointer(u.normal,T,X.FLOAT,!1,0,w*T*4)}var N=i.attributes.uv;if(u.uv>=0&&N)if(N.buffer){var C=N.itemSize;X.bindBuffer(X.ARRAY_BUFFER,N.buffer),X.vertexAttribPointer(u.uv,C,X.FLOAT,!1,0,w*C*4),X.enableVertexAttribArray(u.uv)}else X.disableVertexAttribArray(u.uv);var k=i.attributes.color;if(u.color>=0&&k){var L=k.itemSize;X.bindBuffer(X.ARRAY_BUFFER,k.buffer),X.vertexAttribPointer(u.color,L,X.FLOAT,!1,0,w*L*4)}var A=i.attributes.tangent;if(u.tangent>=0&&A){var O=A.itemSize;X.bindBuffer(X.ARRAY_BUFFER,A.buffer),X.vertexAttribPointer(u.tangent,O,X.FLOAT,!1,0,w*O*4)}var M=i.attributes.index;X.bindBuffer(X.ELEMENT_ARRAY_BUFFER,M.buffer)}X.drawElements(X.TRIANGLES,m[y].count,X.UNSIGNED_SHORT,m[y].start*2),c.info.render.calls++,c.info.render.vertices+=m[y].count,c.info.render.faces+=m[y].count/3}}},this.renderBuffer=function(e,t,n,r,i,s){if(r.visible===!1)return;var o,u,a,f,l,h,p,d;o=Wt(e,t,n,r,s),u=o.attributes;var v=!1,m=r.wireframe?1:0,y=i.id*16777215+o.id*2+m;y!==g&&(g=y,v=!0),!r.morphTargets&&u.position>=0?v&&(X.bindBuffer(X.ARRAY_BUFFER,i.__webglVertexBuffer),X.vertexAttribPointer(u.position,3,X.FLOAT,!1,0,0)):s.morphTargetBase&&Nt(r,i,s);if(v){if(i.__webglCustomAttributesList)for(p=0,d=i.__webglCustomAttributesList.length;p<d;p++)h=i.__webglCustomAttributesList[p],u[h.buffer.belongsToAttribute]>=0&&(X.bindBuffer(X.ARRAY_BUFFER,h.buffer),X.vertexAttribPointer(u[h.buffer.belongsToAttribute],h.size,X.FLOAT,!1,0,0));u.color>=0&&(X.bindBuffer(X.ARRAY_BUFFER,i.__webglColorBuffer),X.vertexAttribPointer(u.color,3,X.FLOAT,!1,0,0)),u.normal>=0&&(X.bindBuffer(X.ARRAY_BUFFER,i.__webglNormalBuffer),X.vertexAttribPointer(u.normal,3,X.FLOAT,!1,0,0)),u.tangent>=0&&(X.bindBuffer(X.ARRAY_BUFFER,i.__webglTangentBuffer),X.vertexAttribPointer(u.tangent,4,X.FLOAT,!1,0,0)),u.uv>=0&&(i.__webglUVBuffer?(X.bindBuffer(X.ARRAY_BUFFER,i.__webglUVBuffer),X.vertexAttribPointer(u.uv,2,X.FLOAT,!1,0,0),X.enableVertexAttribArray(u.uv)):X.disableVertexAttribArray(u.uv)),u.uv2>=0&&(i.__webglUV2Buffer?(X.bindBuffer(X.ARRAY_BUFFER,i.__webglUV2Buffer),X.vertexAttribPointer(u.uv2,2,X.FLOAT,!1,0,0),X.enableVertexAttribArray(u.uv2)):X.disableVertexAttribArray(u.uv2)),r.skinning&&u.skinVertexA>=0&&u.skinVertexB>=0&&u.skinIndex>=0&&u.skinWeight>=0&&(X.bindBuffer(X.ARRAY_BUFFER,i.__webglSkinVertexABuffer),X.vertexAttribPointer(u.skinVertexA,4,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,i.__webglSkinVertexBBuffer),X.vertexAttribPointer(u.skinVertexB,4,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,i.__webglSkinIndicesBuffer),X.vertexAttribPointer(u.skinIndex,4,X.FLOAT,!1,0,0),X.bindBuffer(X.ARRAY_BUFFER,i.__webglSkinWeightsBuffer),X.vertexAttribPointer(u.skinWeight,4,X.FLOAT,!1,0,0))}s instanceof THREE.Mesh?(r.wireframe?(rn(r.wireframeLinewidth),v&&X.bindBuffer(X.ELEMENT_ARRAY_BUFFER,i.__webglLineBuffer),X.drawElements(X.LINES,i.__webglLineCount,X.UNSIGNED_SHORT,0)):(v&&X.bindBuffer(X.ELEMENT_ARRAY_BUFFER,i.__webglFaceBuffer),X.drawElements(X.TRIANGLES,i.__webglFaceCount,X.UNSIGNED_SHORT,0)),c.info.render.calls++,c.info.render.vertices+=i.__webglFaceCount,c.info.render.faces+=i.__webglFaceCount/3):s instanceof THREE.Line?(f=s.type===THREE.LineStrip?X.LINE_STRIP:X.LINES,rn(r.linewidth),X.drawArrays(f,0,i.__webglLineCount),c.info.render.calls++):s instanceof THREE.ParticleSystem?(X.drawArrays(X.POINTS,0,i.__webglParticleCount),c.info.render.calls++,c.info.render.points+=i.__webglParticleCount):s instanceof THREE.Ribbon&&(X.drawArrays(X.TRIANGLE_STRIP,0,i.__webglVertexCount),c.info.render.calls++)},this.render=function(e,t,n,r){if(t instanceof THREE.Camera==0){console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");return}var i,s,o,u,a,f=e.__lights,l=e.fog;m=-1,z=!0,this.autoUpdateScene&&e.updateMatrixWorld(),t.parent===undefined&&t.updateMatrixWorld(),t._viewMatrixArray||(t._viewMatrixArray=new Float32Array(16)),t._projectionMatrixArray||(t._projectionMatrixArray=new Float32Array(16)),t.matrixWorldInverse.getInverse(t.matrixWorld),t.matrixWorldInverse.flattenToArray(t._viewMatrixArray),t.projectionMatrix.flattenToArray(t._projectionMatrixArray),I.multiply(t.projectionMatrix,t.matrixWorldInverse),F.setFromMatrix(I),this.autoUpdateObjects&&this.initWebGLObjects(e),Lt(this.renderPluginsPre,e,t),c.info.render.calls=0,c.info.render.vertices=0,c.info.render.faces=0,c.info.render.points=0,this.setRenderTarget(n),(this.autoClear||r)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),a=e.__webglObjects;for(i=0,s=a.length;i<s;i++)o=a[i],u=o.object,o.render=!1,u.visible&&(!(u instanceof THREE.Mesh||u instanceof THREE.ParticleSystem)||!u.frustumCulled||F.contains(u))&&(tn(u,t),_t(o),o.render=!0,this.sortObjects&&(u.renderDepth?o.z=u.renderDepth:(R.copy(u.matrixWorld.getPosition()),I.multiplyVector3(R),o.z=R.z)));this.sortObjects&&a.sort(Ct),a=e.__webglObjectsImmediate;for(i=0,s=a.length;i<s;i++)o=a[i],u=o.object,u.visible&&(tn(u,t),Mt(o));if(e.overrideMaterial){var h=e.overrideMaterial;this.setBlending(h.blending,h.blendEquation,h.blendSrc,h.blendDst),this.setDepthTest(h.depthTest),this.setDepthWrite(h.depthWrite),sn(h.polygonOffset,h.polygonOffsetFactor,h.polygonOffsetUnits),At(e.__webglObjects,!1,"",t,f,l,!0,h),Ot(e.__webglObjectsImmediate,"",t,f,l,!1,h)}else this.setBlending(THREE.NormalBlending),At(e.__webglObjects,!0,"opaque",t,f,l,!1),Ot(e.__webglObjectsImmediate,"opaque",t,f,l,!1),At(e.__webglObjects,!1,"transparent",t,f,l,!0),Ot(e.__webglObjectsImmediate,"transparent",t,f,l,!0);Lt(this.renderPluginsPost,e,t),n&&n.generateMipmaps&&n.minFilter!==THREE.NearestFilter&&n.minFilter!==THREE.LinearFilter&&yn(n),this.setDepthTest(!0),this.setDepthWrite(!0)},this.renderImmediateObject=function(e,t,n,r,i){var s=Wt(e,t,n,r,i);g=-1,c.setMaterialFaces(r),i.immediateRenderCallback?i.immediateRenderCallback(s,X,F):i.render(function(e){c.renderBufferImmediate(e,s,r)})},this.initWebGLObjects=function(e){e.__webglObjects||(e.__webglObjects=[],e.__webglObjectsImmediate=[],e.__webglSprites=[],e.__webglFlares=[]);while(e.__objectsAdded.length)Pt(e.__objectsAdded[0],e),e.__objectsAdded.splice(0,1);while(e.__objectsRemoved.length)qt(e.__objectsRemoved[0],e),e.__objectsRemoved.splice(0,1);for(var t=0,n=e.__webglObjects.length;t<n;t++)jt(e.__webglObjects[t].object)},this.initMaterial=function(e,t,n,r){var i,s,o,u,a,f,l,c,h;e instanceof THREE.MeshDepthMaterial?h="depth":e instanceof THREE.MeshNormalMaterial?h="normal":e instanceof THREE.MeshBasicMaterial?h="basic":e instanceof THREE.MeshLambertMaterial?h="lambert":e instanceof THREE.MeshPhongMaterial?h="phong":e instanceof THREE.LineBasicMaterial?h="basic":e instanceof THREE.ParticleBasicMaterial&&(h="particle_basic"),h&&zt(e,THREE.ShaderLib[h]),f=Sn(t),c=xn(t),l=En(r),a={map:!!e.map,envMap:!!e.envMap,lightMap:!!e.lightMap,bumpMap:!!e.bumpMap,specularMap:!!e.specularMap,vertexColors:e.vertexColors,fog:n,useFog:e.fog,sizeAttenuation:e.sizeAttenuation,skinning:e.skinning,maxBones:l,useVertexTexture:et&&r&&r.useVertexTexture,boneTextureWidth:r&&r.boneTextureWidth,boneTextureHeight:r&&r.boneTextureHeight,morphTargets:e.morphTargets,morphNormals:e.morphNormals,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,maxDirLights:f.directional,maxPointLights:f.point,maxSpotLights:f.spot,maxShadows:c,shadowMapEnabled:this.shadowMapEnabled&&r.receiveShadow,shadowMapSoft:this.shadowMapSoft,shadowMapDebug:this.shadowMapDebug,shadowMapCascade:this.shadowMapCascade,alphaTest:e.alphaTest,metal:e.metal,perPixel:e.perPixel,wrapAround:e.wrapAround,doubleSided:e.side===THREE.DoubleSide},e.program=on(h,e.fragmentShader,e.vertexShader,e.uniforms,e.attributes,a);var p=e.program.attributes;p.position>=0&&X.enableVertexAttribArray(p.position),p.color>=0&&X.enableVertexAttribArray(p.color),p.normal>=0&&X.enableVertexAttribArray(p.normal),p.tangent>=0&&X.enableVertexAttribArray(p.tangent),e.skinning&&p.skinVertexA>=0&&p.skinVertexB>=0&&p.skinIndex>=0&&p.skinWeight>=0&&(X.enableVertexAttribArray(p.skinVertexA),X.enableVertexAttribArray(p.skinVertexB),X.enableVertexAttribArray(p.skinIndex),X.enableVertexAttribArray(p.skinWeight));if(e.attributes)for(s in e.attributes)p[s]!==undefined&&p[s]>=0&&X.enableVertexAttribArray(p[s]);if(e.morphTargets){e.numSupportedMorphTargets=0;var d,v="morphTarget";for(u=0;u<this.maxMorphTargets;u++)d=v+u,p[d]>=0&&(X.enableVertexAttribArray(p[d]),e.numSupportedMorphTargets++)}if(e.morphNormals){e.numSupportedMorphNormals=0;var d,v="morphNormal";for(u=0;u<this.maxMorphNormals;u++)d=v+u,p[d]>=0&&(X.enableVertexAttribArray(p[d]),e.numSupportedMorphNormals++)}e.uniformsList=[];for(i in e.uniforms)e.uniformsList.push([e.uniforms[i],i])},this.setFaceCulling=function(e,t){e?(!t||t==="ccw"?X.frontFace(X.CCW):X.frontFace(X.CW),e==="back"?X.cullFace(X.BACK):e==="front"?X.cullFace(X.FRONT):X.cullFace(X.FRONT_AND_BACK),X.enable(X.CULL_FACE)):X.disable(X.CULL_FACE)},this.setMaterialFaces=function(e){var t=e.side===THREE.DoubleSide,n=e.side===THREE.BackSide;w!==t&&(t?X.disable(X.CULL_FACE):X.enable(X.CULL_FACE),w=t),E!==n&&(n?X.frontFace(X.CW):X.frontFace(X.CCW),E=n)},this.setDepthTest=function(e){C!==e&&(e?X.enable(X.DEPTH_TEST):X.disable(X.DEPTH_TEST),C=e)},this.setDepthWrite=function(e){k!==e&&(X.depthMask(e),k=e)},this.setBlending=function(e,t,n,r){e!==S&&(e===THREE.NoBlending?X.disable(X.BLEND):e===THREE.AdditiveBlending?(X.enable(X.BLEND),X.blendEquation(X.FUNC_ADD),X.blendFunc(X.SRC_ALPHA,X.ONE)):e===THREE.SubtractiveBlending?(X.enable(X.BLEND),X.blendEquation(X.FUNC_ADD),X.blendFunc(X.ZERO,X.ONE_MINUS_SRC_COLOR)):e===THREE.MultiplyBlending?(X.enable(X.BLEND),X.blendEquation(X.FUNC_ADD),X.blendFunc(X.ZERO,X.SRC_COLOR)):e===THREE.CustomBlending?X.enable(X.BLEND):(X.enable(X.BLEND),X.blendEquationSeparate(X.FUNC_ADD,X.FUNC_ADD),X.blendFuncSeparate(X.SRC_ALPHA,X.ONE_MINUS_SRC_ALPHA,X.ONE,X.ONE_MINUS_SRC_ALPHA)),S=e);if(e===THREE.CustomBlending){t!==x&&(X.blendEquation(wn(t)),x=t);if(n!==T||r!==N)X.blendFunc(wn(n),wn(r)),T=n,N=r}else x=null,T=null,N=null},this.setTexture=function(e,t){if(e.needsUpdate){e.__webglInit||(e.__webglInit=!0,e.__webglTexture=X.createTexture(),c.info.memory.textures++),X.activeTexture(X.TEXTURE0+t),X.bindTexture(X.TEXTURE_2D,e.__webglTexture),X.pixelStorei(X.UNPACK_FLIP_Y_WEBGL,e.flipY),X.pixelStorei(X.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e.premultiplyAlpha);var n=e.image,r=cn(n.width)&&cn(n.height),i=wn(e.format),s=wn(e.type);hn(X.TEXTURE_2D,e,r),e instanceof THREE.DataTexture?X.texImage2D(X.TEXTURE_2D,0,i,n.width,n.height,0,i,s,n.data):X.texImage2D(X.TEXTURE_2D,0,i,i,s,e.image),e.generateMipmaps&&r&&X.generateMipmap(X.TEXTURE_2D),e.needsUpdate=!1,e.onUpdate&&e.onUpdate()}else X.activeTexture(X.TEXTURE0+t),X.bindTexture(X.TEXTURE_2D,e.__webglTexture)},this.setRenderTarget=function(e){var t=e instanceof THREE.WebGLRenderTargetCube;if(e&&!e.__webglFramebuffer){e.depthBuffer===undefined&&(e.depthBuffer=!0),e.stencilBuffer===undefined&&(e.stencilBuffer=!0),e.__webglTexture=X.createTexture();var n=cn(e.width)&&cn(e.height),r=wn(e.format),i=wn(e.type);if(t){e.__webglFramebuffer=[],e.__webglRenderbuffer=[],X.bindTexture(X.TEXTURE_CUBE_MAP,e.__webglTexture),hn(X.TEXTURE_CUBE_MAP,e,n);for(var s=0;s<6;s++)e.__webglFramebuffer[s]=X.createFramebuffer(),e.__webglRenderbuffer[s]=X.createRenderbuffer(),X.texImage2D(X.TEXTURE_CUBE_MAP_POSITIVE_X+s,0,r,e.width,e.height,0,r,i,null),mn(e.__webglFramebuffer[s],e,X.TEXTURE_CUBE_MAP_POSITIVE_X+s),gn(e.__webglRenderbuffer[s],e);n&&X.generateMipmap(X.TEXTURE_CUBE_MAP)}else e.__webglFramebuffer=X.createFramebuffer(),e.__webglRenderbuffer=X.createRenderbuffer(),X.bindTexture(X.TEXTURE_2D,e.__webglTexture),hn(X.TEXTURE_2D,e,n),X.texImage2D(X.TEXTURE_2D,0,r,e.width,e.height,0,r,i,null),mn(e.__webglFramebuffer,e,X.TEXTURE_2D),gn(e.__webglRenderbuffer,e),n&&X.generateMipmap(X.TEXTURE_2D);t?X.bindTexture(X.TEXTURE_CUBE_MAP,null):X.bindTexture(X.TEXTURE_2D,null),X.bindRenderbuffer(X.RENDERBUFFER,null),X.bindFramebuffer(X.FRAMEBUFFER,null)}var o,u,a,f,l;e?(t?o=e.__webglFramebuffer[e.activeCubeFace]:o=e.__webglFramebuffer,u=e.width,a=e.height,f=0,l=0):(o=null,u=P,a=H,f=_,l=D),o!==v&&(X.bindFramebuffer(X.FRAMEBUFFER,o),X.viewport(f,l,u,a),v=o),B=u,j=a},this.shadowMapPlugin=new THREE.ShadowMapPlugin,this.addPrePlugin(this.shadowMapPlugin),this.addPostPlugin(new THREE.SpritePlugin),this.addPostPlugin(new THREE.LensFlarePlugin)},THREE.WebGLRenderTarget=function(e,t,n){this.width=e,this.height=t,n=n||{},this.wrapS=n.wrapS!==undefined?n.wrapS:THREE.ClampToEdgeWrapping,this.wrapT=n.wrapT!==undefined?n.wrapT:THREE.ClampToEdgeWrapping,this.magFilter=n.magFilter!==undefined?n.magFilter:THREE.LinearFilter,this.minFilter=n.minFilter!==undefined?n.minFilter:THREE.LinearMipMapLinearFilter,this.anisotropy=n.anisotropy!==undefined?n.anisotropy:1,this.offset=new THREE.Vector2(0,0),this.repeat=new THREE.Vector2(1,1),this.format=n.format!==undefined?n.format:THREE.RGBAFormat,this.type=n.type!==undefined?n.type:THREE.UnsignedByteType,this.depthBuffer=n.depthBuffer!==undefined?n.depthBuffer:!0,this.stencilBuffer=n.stencilBuffer!==undefined?n.stencilBuffer:!0,this.generateMipmaps=!0},THREE.WebGLRenderTarget.prototype.clone=function(){var e=new THREE.WebGLRenderTarget(this.width,this.height);return e.wrapS=this.wrapS,e.wrapT=this.wrapT,e.magFilter=this.magFilter,e.anisotropy=this.anisotropy,e.minFilter=this.minFilter,e.offset.copy(this.offset),e.repeat.copy(this.repeat),e.format=this.format,e.type=this.type,e.depthBuffer=this.depthBuffer,e.stencilBuffer=this.stencilBuffer,e.generateMipmaps=this.generateMipmaps,e},THREE.WebGLRenderTargetCube=function(e,t,n){THREE.WebGLRenderTarget.call(this,e,t,n),this.activeCubeFace=0},THREE.WebGLRenderTargetCube.prototype=Object.create(THREE.WebGLRenderTarget.prototype),THREE.RenderableVertex=function(){this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld),this.positionScreen.copy(e.positionScreen)},THREE.RenderableFace3=function(){this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.centroidWorld=new THREE.Vector3,this.centroidScreen=new THREE.Vector3,this.normalWorld=new THREE.Vector3,this.vertexNormalsWorld=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.material=null,this.uvs=[[]],this.z=null},THREE.RenderableFace4=function(){this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.v4=new THREE.RenderableVertex,this.centroidWorld=new THREE.Vector3,this.centroidScreen=new THREE.Vector3,this.normalWorld=new THREE.Vector3,this.vertexNormalsWorld=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.material=null,this.uvs=[[]],this.z=null},THREE.RenderableObject=function(){this.object=null,this.z=null},THREE.RenderableParticle=function(){this.object=null,this.x=null,this.y=null,this.z=null,this.rotation=null,this.scale=new THREE.Vector2,this.material=null},THREE.RenderableLine=function(){this.z=null,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.material=null},THREE.ColorUtils={adjustHSV:function(e,t,n,r){var i=THREE.ColorUtils.__hsv;THREE.ColorUtils.rgbToHsv(e,i),i.h=THREE.Math.clamp(i.h+t,0,1),i.s=THREE.Math.clamp(i.s+n,0,1),i.v=THREE.Math.clamp(i.v+r,0,1),e.setHSV(i.h,i.s,i.v)},rgbToHsv:function(e,t){var n=e.r,r=e.g,i=e.b,s=Math.max(Math.max(n,r),i),o=Math.min(Math.min(n,r),i),u,a,f=s;if(o===s)u=0,a=0;else{var l=s-o;a=l/s,n===s?u=(r-i)/l:r===s?u=2+(i-n)/l:u=4+(n-r)/l,u/=6,u<0&&(u+=1),u>1&&(u-=1)}return t===undefined&&(t={h:0,s:0,v:0}),t.h=u,t.s=a,t.v=f,t}},THREE.ColorUtils.__hsv={h:0,s:0,v:0},THREE.GeometryUtils={merge:function(e,t){var n,r,i=e.vertices.length,s=e.faceVertexUvs[0].length,o=t instanceof THREE.Mesh?t.geometry:t,u=e.vertices,a=o.vertices,f=e.faces,l=o.faces,c=e.faceVertexUvs[0],h=o.faceVertexUvs[0],p={};for(var d=0;d<e.materials.length;d++){var v=e.materials[d].id;p[v]=d}t instanceof THREE.Mesh&&(t.matrixAutoUpdate&&t.updateMatrix(),n=t.matrix,r=new THREE.Matrix4,r.extractRotation(n,t.scale));for(var d=0,m=a.length;d<m;d++){var g=a[d],y=g.clone();n&&n.multiplyVector3(y),u.push(y)}for(d=0,m=l.length;d<m;d++){var b=l[d],w,E,S,x=b.vertexNormals,T=b.vertexColors;b instanceof THREE.Face3?w=new THREE.Face3(b.a+i,b.b+i,b.c+i):b instanceof THREE.Face4&&(w=new THREE.Face4(b.a+i,b.b+i,b.c+i,b.d+i)),w.normal.copy(b.normal),r&&r.multiplyVector3(w.normal);for(var N=0,C=x.length;N<C;N++)E=x[N].clone(),r&&r.multiplyVector3(E),w.vertexNormals.push(E);w.color.copy(b.color);for(var N=0,C=T.length;N<C;N++)S=T[N],w.vertexColors.push(S.clone());if(b.materialIndex!==undefined){var k=o.materials[b.materialIndex],L=k.id,A=p[L];A===undefined&&(A=e.materials.length,p[L]=A,e.materials.push(k)),w.materialIndex=A}w.centroid.copy(b.centroid),n&&n.multiplyVector3(w.centroid),f.push(w)}for(d=0,m=h.length;d<m;d++){var O=h[d],M=[];for(var N=0,C=O.length;N<C;N++)M.push(new THREE.UV(O[N].u,O[N].v));c.push(M)}},clone:function(e){var t=new THREE.Geometry,n,r,i=e.vertices,s=e.faces,o=e.faceVertexUvs[0];e.materials&&(t.materials=e.materials.slice());for(n=0,r=i.length;n<r;n++){var u=i[n];t.vertices.push(u.clone())}for(n=0,r=s.length;n<r;n++){var a=s[n];t.faces.push(a.clone())}for(n=0,r=o.length;n<r;n++){var f=o[n],l=[];for(var c=0,h=f.length;c<h;c++)l.push(new THREE.UV(f[c].u,f[c].v));t.faceVertexUvs[0].push(l)}return t},randomPointInTriangle:function(e,t,n){var r,i,s,o=new THREE.Vector3,u=THREE.GeometryUtils.__v1;return r=THREE.GeometryUtils.random(),i=THREE.GeometryUtils.random(),r+i>1&&(r=1-r,i=1-i),s=1-r-i,o.copy(e),o.multiplyScalar(r),u.copy(t),u.multiplyScalar(i),o.addSelf(u),u.copy(n),u.multiplyScalar(s),o.addSelf(u),o},randomPointInFace:function(e,t,n){var r,i,s,o;if(e instanceof THREE.Face3)return r=t.vertices[e.a],i=t.vertices[e.b],s=t.vertices[e.c],THREE.GeometryUtils.randomPointInTriangle(r,i,s);if(e instanceof THREE.Face4){r=t.vertices[e.a],i=t.vertices[e.b],s=t.vertices[e.c],o=t.vertices[e.d];var u,a;n?e._area1&&e._area2?(u=e._area1,a=e._area2):(u=THREE.GeometryUtils.triangleArea(r,i,o),a=THREE.GeometryUtils.triangleArea(i,s,o),e._area1=u,e._area2=a):(u=THREE.GeometryUtils.triangleArea(r,i,o),a=THREE.GeometryUtils.triangleArea(i,s,o));var f=THREE.GeometryUtils.random()*(u+a);return f<u?THREE.GeometryUtils.randomPointInTriangle(r,i,o):THREE.GeometryUtils.randomPointInTriangle(i,s,o)}},randomPointsInGeometry:function(e,t){function p(e){function t(n,r){if(r<n)return n;var i=n+Math.floor((r-n)/2);return a[i]>e?t(n,i-1):a[i]<e?t(i+1,r):i}var n=t(0,a.length-1);return n}var n,r,i=e.faces,s=e.vertices,o=i.length,u=0,a=[],f,l,c,h;for(r=0;r<o;r++)n=i[r],n instanceof THREE.Face3?(f=s[n.a],l=s[n.b],c=s[n.c],n._area=THREE.GeometryUtils.triangleArea(f,l,c)):n instanceof THREE.Face4&&(f=s[n.a],l=s[n.b],c=s[n.c],h=s[n.d],n._area1=THREE.GeometryUtils.triangleArea(f,l,h),n._area2=THREE.GeometryUtils.triangleArea(l,c,h),n._area=n._area1+n._area2),u+=n._area,a[r]=u;var d,v,m=[],g={};for(r=0;r<t;r++)d=THREE.GeometryUtils.random()*u,v=p(d),m[r]=THREE.GeometryUtils.randomPointInFace(i[v],e,!0),g[v]?g[v]+=1:g[v]=1;return m},triangleArea:function(e,t,n){var r,i,s,o,u=THREE.GeometryUtils.__v1;return u.sub(e,t),i=u.length(),u.sub(e,n),s=u.length(),u.sub(t,n),o=u.length(),r=.5*(i+s+o),Math.sqrt(r*(r-i)*(r-s)*(r-o))},center:function(e){e.computeBoundingBox();var t=e.boundingBox,n=new THREE.Vector3;return n.add(t.min,t.max),n.multiplyScalar(-0.5),e.applyMatrix((new THREE.Matrix4).makeTranslation(n.x,n.y,n.z)),e.computeBoundingBox(),n},normalizeUVs:function(e){var t=e.faceVertexUvs[0];for(var n=0,r=t.length;n<r;n++){var i=t[n];for(var s=0,o=i.length;s<o;s++)i[s].u!==1&&(i[s].u=i[s].u-Math.floor(i[s].u)),i[s].v!==1&&(i[s].v=i[s].v-Math.floor(i[s].v))}},triangulateQuads:function(e){var t,n,r,i,s=[],o=[],u=[];for(t=0,n=e.faceUvs.length;t<n;t++)o[t]=[];for(t=0,n=e.faceVertexUvs.length;t<n;t++)u[t]=[];for(t=0,n=e.faces.length;t<n;t++){var a=e.faces[t];if(a instanceof THREE.Face4){var f=a.a,l=a.b,c=a.c,h=a.d,p=new THREE.Face3,d=new THREE.Face3;p.color.copy(a.color),d.color.copy(a.color),p.materialIndex=a.materialIndex,d.materialIndex=a.materialIndex,p.a=f,p.b=l,p.c=h,d.a=l,d.b=c,d.c=h,a.vertexColors.length===4&&(p.vertexColors[0]=a.vertexColors[0].clone(),p.vertexColors[1]=a.vertexColors[1].clone(),p.vertexColors[2]=a.vertexColors[3].clone(),d.vertexColors[0]=a.vertexColors[1].clone(),d.vertexColors[1]=a.vertexColors[2].clone(),d.vertexColors[2]=a.vertexColors[3].clone()),s.push(p,d);for(r=0,i=e.faceVertexUvs.length;r<i;r++)if(e.faceVertexUvs[r].length){var v=e.faceVertexUvs[r][t],m=v[0],g=v[1],y=v[2],b=v[3],w=[m.clone(),g.clone(),b.clone()],E=[g.clone(),y.clone(),b.clone()];u[r].push(w,E)}for(r=0,i=e.faceUvs.length;r<i;r++)if(e.faceUvs[r].length){var S=e.faceUvs[r][t];o[r].push(S,S)}}else{s.push(a);for(r=0,i=e.faceUvs.length;r<i;r++)o[r].push(e.faceUvs[r]);for(r=0,i=e.faceVertexUvs.length;r<i;r++)u[r].push(e.faceVertexUvs[r])}}e.faces=s,e.faceUvs=o,e.faceVertexUvs=u,e.computeCentroids(),e.computeFaceNormals(),e.computeVertexNormals(),e.hasTangents&&e.computeTangents()},explode:function(e){var t=[];for(var n=0,r=e.faces.length;n<r;n++){var i=t.length,s=e.faces[n];if(s instanceof THREE.Face4){var o=s.a,u=s.b,a=s.c,f=s.d,l=e.vertices[o],c=e.vertices[u],h=e.vertices[a],p=e.vertices[f];t.push(l.clone()),t.push(c.clone()),t.push(h.clone()),t.push(p.clone()),s.a=i,s.b=i+1,s.c=i+2,s.d=i+3}else{var o=s.a,u=s.b,a=s.c,l=e.vertices[o],c=e.vertices[u],h=e.vertices[a];t.push(l.clone()),t.push(c.clone()),t.push(h.clone()),s.a=i,s.b=i+1,s.c=i+2}}e.vertices=t,delete e.__tmpVertices},tessellate:function(e,t){var n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O,M,_,D,P,H=[],B=[];for(n=0,r=e.faceVertexUvs.length;n<r;n++)B[n]=[];for(n=0,r=e.faces.length;n<r;n++){i=e.faces[n];if(i instanceof THREE.Face3){s=i.a,o=i.b,u=i.c,f=e.vertices[s],l=e.vertices[o],c=e.vertices[u],p=f.distanceTo(l),d=l.distanceTo(c),v=f.distanceTo(c);if(p>t||d>t||v>t){y=e.vertices.length,O=i.clone(),M=i.clone(),p>=d&&p>=v?(E=f.clone(),E.lerpSelf(l,.5),O.a=s,O.b=y,O.c=u,M.a=y,M.b=o,M.c=u,i.vertexNormals.length===3&&(T=i.vertexNormals[0].clone(),T.lerpSelf(i.vertexNormals[1],.5),O.vertexNormals[1].copy(T),M.vertexNormals[0].copy(T)),i.vertexColors.length===3&&(k=i.vertexColors[0].clone(),k.lerpSelf(i.vertexColors[1],.5),O.vertexColors[1].copy(k),M.vertexColors[0].copy(k)),P=0):d>=p&&d>=v?(E=l.clone(),E.lerpSelf(c,.5),O.a=s,O.b=o,O.c=y,M.a=y,M.b=u,M.c=s,i.vertexNormals.length===3&&(T=i.vertexNormals[1].clone(),T.lerpSelf(i.vertexNormals[2],.5),O.vertexNormals[2].copy(T),M.vertexNormals[0].copy(T),M.vertexNormals[1].copy(i.vertexNormals[2]),M.vertexNormals[2].copy(i.vertexNormals[0])),i.vertexColors.length===3&&(k=i.vertexColors[1].clone(),k.lerpSelf(i.vertexColors[2],.5),O.vertexColors[2].copy(k),M.vertexColors[0].copy(k),M.vertexColors[1].copy(i.vertexColors[2]),M.vertexColors[2].copy(i.vertexColors[0])),P=1):(E=f.clone(),E.lerpSelf(c,.5),O.a=s,O.b=o,O.c=y,M.a=y,M.b=o,M.c=u,i.vertexNormals.length===3&&(T=i.vertexNormals[0].clone(),T.lerpSelf(i.vertexNormals[2],.5),O.vertexNormals[2].copy(T),M.vertexNormals[0].copy(T)),i.vertexColors.length===3&&(k=i.vertexColors[0].clone(),k.lerpSelf(i.vertexColors[2],.5),O.vertexColors[2].copy(k),M.vertexColors[0].copy(k)),P=2),H.push(O,M),e.vertices.push(E);var j,F,I,q,R,U,z,W,X;for(j=0,F=e.faceVertexUvs.length;j<F;j++)e.faceVertexUvs[j].length&&(I=e.faceVertexUvs[j][n],q=I[0],R=I[1],U=I[2],P===0?(z=q.clone(),z.lerpSelf(R,.5),W=[q.clone(),z.clone(),U.clone()],X=[z.clone(),R.clone(),U.clone()]):P===1?(z=R.clone(),z.lerpSelf(U,.5),W=[q.clone(),R.clone(),z.clone()],X=[z.clone(),U.clone(),q.clone()]):(z=q.clone(),z.lerpSelf(U,.5),W=[q.clone(),R.clone(),z.clone()],X=[z.clone(),R.clone(),U.clone()]),B[j].push(W,X))}else{H.push(i);for(j=0,F=e.faceVertexUvs.length;j<F;j++)B[j].push(e.faceVertexUvs[j][n])}}else{s=i.a,o=i.b,u=i.c,a=i.d,f=e.vertices[s],l=e.vertices[o],c=e.vertices[u],h=e.vertices[a],p=f.distanceTo(l),d=l.distanceTo(c),m=c.distanceTo(h),g=f.distanceTo(h);if(p>t||d>t||m>t||g>t){b=e.vertices.length,w=e.vertices.length+1,_=i.clone(),D=i.clone(),p>=d&&p>=m&&p>=g||m>=d&&m>=p&&m>=g?(S=f.clone(),S.lerpSelf(l,.5),x=c.clone(),x.lerpSelf(h,.5),_.a=s,_.b=b,_.c=w,_.d=a,D.a=b,D.b=o,D.c=u,D.d=w,i.vertexNormals.length===4&&(N=i.vertexNormals[0].clone(),N.lerpSelf(i.vertexNormals[1],.5),C=i.vertexNormals[2].clone(),C.lerpSelf(i.vertexNormals[3],.5),_.vertexNormals[1].copy(N),_.vertexNormals[2].copy(C),D.vertexNormals[0].copy(N),D.vertexNormals[3].copy(C)),i.vertexColors.length===4&&(L=i.vertexColors[0].clone(),L.lerpSelf(i.vertexColors[1],.5),A=i.vertexColors[2].clone(),A.lerpSelf(i.vertexColors[3],.5),_.vertexColors[1].copy(L),_.vertexColors[2].copy(A),D.vertexColors[0].copy(L),D.vertexColors[3].copy(A)),P=0):(S=l.clone(),S.lerpSelf(c,.5),x=h.clone(),x.lerpSelf(f,.5),_.a=s,_.b=o,_.c=b,_.d=w,D.a=w,D.b=b,D.c=u,D.d=a,i.vertexNormals.length===4&&(N=i.vertexNormals[1].clone(),N.lerpSelf(i.vertexNormals[2],.5),C=i.vertexNormals[3].clone(),C.lerpSelf(i.vertexNormals[0],.5),_.vertexNormals[2].copy(N),_.vertexNormals[3].copy(C),D.vertexNormals[0].copy(C),D.vertexNormals[1].copy(N)),i.vertexColors.length===4&&(L=i.vertexColors[1].clone(),L.lerpSelf(i.vertexColors[2],.5),A=i.vertexColors[3].clone(),A.lerpSelf(i.vertexColors[0],.5),_.vertexColors[2].copy(L),_.vertexColors[3].copy(A),D.vertexColors[0].copy(A),D.vertexColors[1].copy(L)),P=1),H.push(_,D),e.vertices.push(S,x);var j,F,I,q,R,U,V,$,J,K,Q;for(j=0,F=e.faceVertexUvs.length;j<F;j++)e.faceVertexUvs[j].length&&(I=e.faceVertexUvs[j][n],q=I[0],R=I[1],U=I[2],V=I[3],P===0?($=q.clone(),$.lerpSelf(R,.5),J=U.clone(),J.lerpSelf(V,.5),K=[q.clone(),$.clone(),J.clone(),V.clone()],Q=[$.clone(),R.clone(),U.clone(),J.clone()]):($=R.clone(),$.lerpSelf(U,.5),J=V.clone(),J.lerpSelf(q,.5),K=[q.clone(),R.clone(),$.clone(),J.clone()],Q=[J.clone(),$.clone(),U.clone(),V.clone()]),B[j].push(K,Q))}else{H.push(i);for(j=0,F=e.faceVertexUvs.length;j<F;j++)B[j].push(e.faceVertexUvs[j][n])}}}e.faces=H,e.faceVertexUvs=B}},THREE.GeometryUtils.random=THREE.Math.random16,THREE.GeometryUtils.__v1=new THREE.Vector3,THREE.ImageUtils={crossOrigin:"anonymous",loadTexture:function(e,t,n,r){var i=new Image,s=new THREE.Texture(i,t),o=new THREE.ImageLoader;return o.addEventListener("load",function(e){s.image=e.content,s.needsUpdate=!0,n&&n(s)}),o.addEventListener("error",function(e){r&&r(e.message)}),o.crossOrigin=this.crossOrigin,o.load(e,i),s},loadTextureCube:function(e,t,n){var r,i,s=[],o=new THREE.Texture(s,t);o.flipY=!1,s.loadCount=0;for(r=0,i=e.length;r<i;++r)s[r]=new Image,s[r].onload=function(){s.loadCount+=1,s.loadCount===6&&(o.needsUpdate=!0,n&&n())},s[r].crossOrigin=this.crossOrigin,s[r].src=e[r];return o},getNormalMap:function(e,t){var n=function(e,t){return[e[1]*t[2]-e[2]*t[1],e[2]*t[0]-e[0]*t[2],e[0]*t[1]-e[1]*t[0]]},r=function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},i=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);return[e[0]/t,e[1]/t,e[2]/t]};t|=1;var s=e.width,o=e.height,u=document.createElement("canvas");u.width=s,u.height=o;var a=u.getContext("2d");a.drawImage(e,0,0);var f=a.getImageData(0,0,s,o).data,l=a.createImageData(s,o),c=l.data;for(var h=0;h<s;h++)for(var p=0;p<o;p++){var d=p-1<0?0:p-1,v=p+1>o-1?o-1:p+1,m=h-1<0?0:h-1,g=h+1>s-1?s-1:h+1,y=[],b=[0,0,f[(p*s+h)*4]/255*t];y.push([-1,0,f[(p*s+m)*4]/255*t]),y.push([-1,-1,f[(d*s+m)*4]/255*t]),y.push([0,-1,f[(d*s+h)*4]/255*t]),y.push([1,-1,f[(d*s+g)*4]/255*t]),y.push([1,0,f[(p*s+g)*4]/255*t]),y.push([1,1,f[(v*s+g)*4]/255*t]),y.push([0,1,f[(v*s+h)*4]/255*t]),y.push([-1,1,f[(v*s+m)*4]/255*t]);var w=[],E=y.length;for(var S=0;S<E;S++){var x=y[S],T=y[(S+1)%E];x=r(x,b),T=r(T,b),w.push(i(n(x,T)))}var N=[0,0,0];for(var S=0;S<w.length;S++)N[0]+=w[S][0],N[1]+=w[S][1],N[2]+=w[S][2];N[0]/=w.length,N[1]/=w.length,N[2]/=w.length;var C=(p*s+h)*4;c[C]=(N[0]+1)/2*255|0,c[C+1]=(N[1]+1)/2*255|0,c[C+2]=N[2]*255|0,c[C+3]=255}return a.putImageData(l,0,0),u},generateDataTexture:function(e,t,n){var r=e*t,i=new Uint8Array(3*r),s=Math.floor(n.r*255),o=Math.floor(n.g*255),u=Math.floor(n.b*255);for(var a=0;a<r;a++)i[a*3]=s,i[a*3+1]=o,i[a*3+2]=u;var f=new THREE.DataTexture(i,e,t,THREE.RGBFormat);return f.needsUpdate=!0,f}},THREE.SceneUtils={showHierarchy:function(e,t){THREE.SceneUtils.traverseHierarchy(e,function(e){e.visible=t})},traverseHierarchy:function(e,t){var n,r,i=e.children.length;for(r=0;r<i;r++)n=e.children[r],t(n),THREE.SceneUtils.traverseHierarchy(n,t)},createMultiMaterialObject:function(e,t){var n,r=t.length,i=new THREE.Object3D;for(n=0;n<r;n++){var s=new THREE.Mesh(e,t[n]);i.add(s)}return i},cloneObject:function(e){var t;e instanceof THREE.MorphAnimMesh?(t=new THREE.MorphAnimMesh(e.geometry,e.material),t.duration=e.duration,t.mirroredLoop=e.mirroredLoop,t.time=e.time,t.lastKeyframe=e.lastKeyframe,t.currentKeyframe=e.currentKeyframe,t.direction=e.direction,t.directionBackwards=e.directionBackwards):e instanceof THREE.SkinnedMesh?t=new THREE.SkinnedMesh(e.geometry,e.material):e instanceof THREE.Mesh?t=new THREE.Mesh(e.geometry,e.material):e instanceof THREE.Line?t=new THREE.Line(e.geometry,e.material,e.type):e instanceof THREE.Ribbon?t=new THREE.Ribbon(e.geometry,e.material):e instanceof THREE.ParticleSystem?(t=new THREE.ParticleSystem(e.geometry,e.material),t.sortParticles=e.sortParticles):e instanceof THREE.Particle?t=new THREE.Particle(e.material):e instanceof THREE.Sprite?(t=new THREE.Sprite({}),t.color.copy(e.color),t.map=e.map,t.blending=e.blending,t.useScreenCoordinates=e.useScreenCoordinates,t.mergeWith3D=e.mergeWith3D,t.affectedByDistance=e.affectedByDistance,t.scaleByViewport=e.scaleByViewport,t.alignment=e.alignment,t.rotation3d.copy(e.rotation3d),t.rotation=e.rotation,t.opacity=e.opacity,t.uvOffset.copy(e.uvOffset),t.uvScale.copy(e.uvScale)):e instanceof THREE.LOD?t=new THREE.LOD:e instanceof THREE.Object3D&&(t=new THREE.Object3D),t.name=e.name,t.parent=e.parent,t.up.copy(e.up),t.position.copy(e.position),t.rotation instanceof THREE.Vector3&&t.rotation.copy(e.rotation),t.eulerOrder=e.eulerOrder,t.scale.copy(e.scale),t.dynamic=e.dynamic,t.renderDepth=e.renderDepth,t.rotationAutoUpdate=e.rotationAutoUpdate,t.matrix.copy(e.matrix),t.matrixWorld.copy(e.matrixWorld),t.matrixRotationWorld.copy(e.matrixRotationWorld),t.matrixAutoUpdate=e.matrixAutoUpdate,t.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,t.quaternion.copy(e.quaternion),t.useQuaternion=e.useQuaternion,t.boundRadius=e.boundRadius,t.boundRadiusScale=e.boundRadiusScale,t.visible=e.visible,t.castShadow=e.castShadow,t.receiveShadow=e.receiveShadow,t.frustumCulled=e.frustumCulled;for(var n=0;n<e.children.length;n++){var r=THREE.SceneUtils.cloneObject(e.children[n]);t.children[n]=r,r.parent=t}if(e instanceof THREE.LOD)for(var n=0;n<e.LODs.length;n++){var i=e.LODs[n];t.LODs[n]={visibleAtDistance:i.visibleAtDistance,object3D:t.children[n]}}return t},detach:function(e,t,n){e.applyMatrix(t.matrixWorld),t.remove(e),n.add(e)},attach:function(e,t,n){var r=new THREE.Matrix4;r.getInverse(n.matrixWorld),e.applyMatrix(r),t.remove(e),n.add(e)}},THREE.WebGLRenderer&&(THREE.ShaderUtils={lib:{fresnel:{uniforms:{mRefractionRatio:{type:"f",value:1.02},mFresnelBias:{type:"f",value:.1},mFresnelPower:{type:"f",value:2},mFresnelScale:{type:"f",value:1},tCube:{type:"t",value:1,texture:null}},fragmentShader:["uniform samplerCube tCube;","varying vec3 vReflect;","varying vec3 vRefract[3];","varying float vReflectionFactor;","void main() {","vec4 reflectedColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );","vec4 refractedColor = vec4( 1.0, 1.0, 1.0, 1.0 );","refractedColor.r = textureCube( tCube, vec3( -vRefract[0].x, vRefract[0].yz ) ).r;","refractedColor.g = textureCube( tCube, vec3( -vRefract[1].x, vRefract[1].yz ) ).g;","refractedColor.b = textureCube( tCube, vec3( -vRefract[2].x, vRefract[2].yz ) ).b;","refractedColor.a = 1.0;","gl_FragColor = mix( refractedColor, reflectedColor, clamp( vReflectionFactor, 0.0, 1.0 ) );","}"].join("\n"),vertexShader:["uniform float mRefractionRatio;","uniform float mFresnelBias;","uniform float mFresnelScale;","uniform float mFresnelPower;","varying vec3 vReflect;","varying vec3 vRefract[3];","varying float vReflectionFactor;","void main() {","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","vec4 mPosition = modelMatrix * vec4( position, 1.0 );","vec3 nWorld = normalize( mat3( modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz ) * normal );","vec3 I = mPosition.xyz - cameraPosition;","vReflect = reflect( I, nWorld );","vRefract[0] = refract( normalize( I ), nWorld, mRefractionRatio );","vRefract[1] = refract( normalize( I ), nWorld, mRefractionRatio * 0.99 );","vRefract[2] = refract( normalize( I ), nWorld, mRefractionRatio * 0.98 );","vReflectionFactor = mFresnelBias + mFresnelScale * pow( 1.0 + dot( normalize( I ), nWorld ), mFresnelPower );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n")},normal:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{enableAO:{type:"i",value:0},enableDiffuse:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},enableDisplacement:{type:"i",value:0},tDiffuse:{type:"t",value:0,texture:null},tCube:{type:"t",value:1,texture:null},tNormal:{type:"t",value:2,texture:null},tSpecular:{type:"t",value:3,texture:null},tAO:{type:"t",value:4,texture:null},tDisplacement:{type:"t",value:5,texture:null},uNormalScale:{type:"f",value:1},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},uDiffuseColor:{type:"c",value:new THREE.Color(16777215)},uSpecularColor:{type:"c",value:new THREE.Color(1118481)},uAmbientColor:{type:"c",value:new THREE.Color(16777215)},uShininess:{type:"f",value:30},uOpacity:{type:"f",value:1},useRefract:{type:"i",value:0},uRefractionRatio:{type:"f",value:.98},uReflectivity:{type:"f",value:.5},uOffset:{type:"v2",value:new THREE.Vector2(0,0)},uRepeat:{type:"v2",value:new THREE.Vector2(1,1)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),fragmentShader:["uniform vec3 uAmbientColor;","uniform vec3 uDiffuseColor;","uniform vec3 uSpecularColor;","uniform float uShininess;","uniform float uOpacity;","uniform bool enableDiffuse;","uniform bool enableSpecular;","uniform bool enableAO;","uniform bool enableReflection;","uniform sampler2D tDiffuse;","uniform sampler2D tNormal;","uniform sampler2D tSpecular;","uniform sampler2D tAO;","uniform samplerCube tCube;","uniform float uNormalScale;","uniform bool useRefract;","uniform float uRefractionRatio;","uniform float uReflectivity;","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","uniform vec3 ambientLightColor;","#if MAX_DIR_LIGHTS > 0","uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","#endif","#if MAX_POINT_LIGHTS > 0","uniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];","uniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];","uniform float pointLightDistance[ MAX_POINT_LIGHTS ];","#endif","#if MAX_SPOT_LIGHTS > 0","uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","uniform float spotLightAngle[ MAX_SPOT_LIGHTS ];","uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","#endif","#ifdef WRAP_AROUND","uniform vec3 wrapRGB;","#endif","varying vec3 vWorldPosition;",THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,"void main() {","vec3 vViewPosition = cameraPosition - vWorldPosition;","gl_FragColor = vec4( vec3( 1.0 ), uOpacity );","vec3 specularTex = vec3( 1.0 );","vec3 normalTex = texture2D( tNormal, vUv ).xyz * 2.0 - 1.0;","normalTex.xy *= uNormalScale;","normalTex = normalize( normalTex );","if( enableDiffuse ) {","#ifdef GAMMA_INPUT","vec4 texelColor = texture2D( tDiffuse, vUv );","texelColor.xyz *= texelColor.xyz;","gl_FragColor = gl_FragColor * texelColor;","#else","gl_FragColor = gl_FragColor * texture2D( tDiffuse, vUv );","#endif","}","if( enableAO ) {","#ifdef GAMMA_INPUT","vec4 aoColor = texture2D( tAO, vUv );","aoColor.xyz *= aoColor.xyz;","gl_FragColor.xyz = gl_FragColor.xyz * aoColor.xyz;","#else","gl_FragColor.xyz = gl_FragColor.xyz * texture2D( tAO, vUv ).xyz;","#endif","}","if( enableSpecular )","specularTex = texture2D( tSpecular, vUv ).xyz;","mat3 tsb = mat3( normalize( vTangent ), normalize( vBinormal ), normalize( vNormal ) );","vec3 finalNormal = tsb * normalTex;","vec3 normal = normalize( finalNormal );","vec3 viewPosition = normalize( vViewPosition );","#if MAX_POINT_LIGHTS > 0","vec3 pointDiffuse = vec3( 0.0 );","vec3 pointSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","vec3 pointVector = lPosition.xyz + vViewPosition.xyz;","float pointDistance = 1.0;","if ( pointLightDistance[ i ] > 0.0 )","pointDistance = 1.0 - min( ( length( pointVector ) / pointLightDistance[ i ] ), 1.0 );","pointVector = normalize( pointVector );","#ifdef WRAP_AROUND","float pointDiffuseWeightFull = max( dot( normal, pointVector ), 0.0 );","float pointDiffuseWeightHalf = max( 0.5 * dot( normal, pointVector ) + 0.5, 0.0 );","vec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","#else","float pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );","#endif","pointDiffuse += pointDistance * pointLightColor[ i ] * uDiffuseColor * pointDiffuseWeight;","vec3 pointHalfVector = normalize( pointVector + viewPosition );","float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","float pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( pointVector, pointHalfVector ), 5.0 );","pointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * pointDistance * specularNormalization;","#else","pointSpecular += pointDistance * pointLightColor[ i ] * uSpecularColor * pointSpecularWeight * pointDiffuseWeight;","#endif","}","#endif","#if MAX_SPOT_LIGHTS > 0","vec3 spotDiffuse = vec3( 0.0 );","vec3 spotSpecular = vec3( 0.0 );","for ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {","vec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );","vec3 spotVector = lPosition.xyz + vViewPosition.xyz;","float spotDistance = 1.0;","if ( spotLightDistance[ i ] > 0.0 )","spotDistance = 1.0 - min( ( length( spotVector ) / spotLightDistance[ i ] ), 1.0 );","spotVector = normalize( spotVector );","float spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );","if ( spotEffect > spotLightAngle[ i ] ) {","spotEffect = pow( spotEffect, spotLightExponent[ i ] );","#ifdef WRAP_AROUND","float spotDiffuseWeightFull = max( dot( normal, spotVector ), 0.0 );","float spotDiffuseWeightHalf = max( 0.5 * dot( normal, spotVector ) + 0.5, 0.0 );","vec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );","#else","float spotDiffuseWeight = max( dot( normal, spotVector ), 0.0 );","#endif","spotDiffuse += spotDistance * spotLightColor[ i ] * uDiffuseColor * spotDiffuseWeight * spotEffect;","vec3 spotHalfVector = normalize( spotVector + viewPosition );","float spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );","float spotSpecularWeight = specularTex.r * max( pow( spotDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( spotVector, spotHalfVector ), 5.0 );","spotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * spotDistance * specularNormalization * spotEffect;","#else","spotSpecular += spotDistance * spotLightColor[ i ] * uSpecularColor * spotSpecularWeight * spotDiffuseWeight * spotEffect;","#endif","}","}","#endif","#if MAX_DIR_LIGHTS > 0","vec3 dirDiffuse = vec3( 0.0 );","vec3 dirSpecular = vec3( 0.0 );","for( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {","vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","vec3 dirVector = normalize( lDirection.xyz );","#ifdef WRAP_AROUND","float directionalLightWeightingFull = max( dot( normal, dirVector ), 0.0 );","float directionalLightWeightingHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );","vec3 dirDiffuseWeight = mix( vec3( directionalLightWeightingFull ), vec3( directionalLightWeightingHalf ), wrapRGB );","#else","float dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );","#endif","dirDiffuse += directionalLightColor[ i ] * uDiffuseColor * dirDiffuseWeight;","vec3 dirHalfVector = normalize( dirVector + viewPosition );","float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","float dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, uShininess ), 0.0 );","#ifdef PHYSICALLY_BASED_SHADING","float specularNormalization = ( uShininess + 2.0001 ) / 8.0;","vec3 schlick = uSpecularColor + vec3( 1.0 - uSpecularColor ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );","dirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;","#else","dirSpecular += directionalLightColor[ i ] * uSpecularColor * dirSpecularWeight * dirDiffuseWeight;","#endif","}","#endif","vec3 totalDiffuse = vec3( 0.0 );","vec3 totalSpecular = vec3( 0.0 );","#if MAX_DIR_LIGHTS > 0","totalDiffuse += dirDiffuse;","totalSpecular += dirSpecular;","#endif","#if MAX_POINT_LIGHTS > 0","totalDiffuse += pointDiffuse;","totalSpecular += pointSpecular;","#endif","#if MAX_SPOT_LIGHTS > 0","totalDiffuse += spotDiffuse;","totalSpecular += spotSpecular;","#endif","#ifdef METAL","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor + totalSpecular );","#else","gl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * uAmbientColor ) + totalSpecular;","#endif","if ( enableReflection ) {","vec3 vReflect;","vec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );","if ( useRefract ) {","vReflect = refract( cameraToVertex, normal, uRefractionRatio );","} else {","vReflect = reflect( cameraToVertex, normal );","}","vec4 cubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );","#ifdef GAMMA_INPUT","cubeColor.xyz *= cubeColor.xyz;","#endif","gl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularTex.r * uReflectivity );","}",THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["attribute vec4 tangent;","uniform vec2 uOffset;","uniform vec2 uRepeat;","uniform bool enableDisplacement;","#ifdef VERTEX_TEXTURES","uniform sampler2D tDisplacement;","uniform float uDisplacementScale;","uniform float uDisplacementBias;","#endif","varying vec3 vTangent;","varying vec3 vBinormal;","varying vec3 vNormal;","varying vec2 vUv;","varying vec3 vWorldPosition;",THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,"#ifdef USE_SKINNING","vNormal = normalMatrix * skinnedNormal.xyz;","vec4 skinnedTangent = skinMatrix * vec4( tangent.xyz, 0.0 );","vTangent = normalMatrix * skinnedTangent.xyz;","#else","vNormal = normalMatrix * normal;","vTangent = normalMatrix * tangent.xyz;","#endif","vBinormal = cross( vNormal, vTangent ) * tangent.w;","vUv = uv * uRepeat + uOffset;","vec3 displacedPosition;","#ifdef VERTEX_TEXTURES","if ( enableDisplacement ) {","vec3 dv = texture2D( tDisplacement, uv ).xyz;","float df = uDisplacementScale * dv.x + uDisplacementBias;","displacedPosition = position + normalize( normal ) * df;","} else {","#ifdef USE_SKINNING","vec4 skinned  = boneMatX * skinVertexA * skinWeight.x;","skinned 	  += boneMatY * skinVertexB * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","}","#else","#ifdef USE_SKINNING","vec4 skinned  = boneMatX * skinVertexA * skinWeight.x;","skinned 	  += boneMatY * skinVertexB * skinWeight.y;","displacedPosition  = skinned.xyz;","#else","displacedPosition = position;","#endif","#endif","vec4 mvPosition = modelViewMatrix * vec4( displacedPosition, 1.0 );","vec4 wPosition = modelMatrix * vec4( displacedPosition, 1.0 );","gl_Position = projectionMatrix * mvPosition;","vWorldPosition = wPosition.xyz;","#ifdef USE_SHADOWMAP","for( int i = 0; i < MAX_SHADOWS; i ++ ) {","vShadowCoord[ i ] = shadowMatrix[ i ] * wPosition;","}","#endif","}"].join("\n")},cube:{uniforms:{tCube:{type:"t",value:1,texture:null},tFlip:{type:"f",value:-1}},vertexShader:["varying vec3 vViewPosition;","void main() {","vec4 mPosition = modelMatrix * vec4( position, 1.0 );","vViewPosition = cameraPosition - mPosition.xyz;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform samplerCube tCube;","uniform float tFlip;","varying vec3 vViewPosition;","void main() {","vec3 wPos = cameraPosition - vViewPosition;","gl_FragColor = textureCube( tCube, vec3( tFlip * wPos.x, wPos.yz ) );","}"].join("\n")}}}),THREE.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(e){var t=e.familyName.toLowerCase(),n=this;n.faces[t]=n.faces[t]||{},n.faces[t][e.cssFontWeight]=n.faces[t][e.cssFontWeight]||{},n.faces[t][e.cssFontWeight][e.cssFontStyle]=e;var r=n.faces[t][e.cssFontWeight][e.cssFontStyle]=e;return e},drawText:function(e){var t=[],n=[],r,i,s=this.getFace(),o=this.size/s.resolution,u=0,a=String(e).split(""),f=a.length,l=[];for(r=0;r<f;r++){var c=new THREE.Path,h=this.extractGlyphPoints(a[r],s,o,u,c);u+=h.offset,l.push(h.path)}var p=u/2;return{paths:l,offset:p}},extractGlyphPoints:function(e,t,n,r,i){var s=[],o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N=t.glyphs[e]||t.glyphs["?"];if(!N)return;if(N.o){f=N._cachedOutline||(N._cachedOutline=N.o.split(" ")),c=f.length,h=n,p=n;for(o=0;o<c;){l=f[o++];switch(l){case"m":d=f[o++]*h+r,v=f[o++]*p,i.moveTo(d,v);break;case"l":d=f[o++]*h+r,v=f[o++]*p,i.lineTo(d,v);break;case"q":m=f[o++]*h+r,g=f[o++]*p,w=f[o++]*h+r,E=f[o++]*p,i.quadraticCurveTo(w,E,m,g),T=s[s.length-1];if(T){y=T.x,b=T.y;for(u=1,a=this.divisions;u<=a;u++)var C=u/a,k=THREE.Shape.Utils.b2(C,y,w,m),L=THREE.Shape.Utils.b2(C,b,E,g)}break;case"b":m=f[o++]*h+r,g=f[o++]*p,w=f[o++]*h+r,E=f[o++]*-p,S=f[o++]*h+r,x=f[o++]*-p,i.bezierCurveTo(m,g,w,E,S,x),T=s[s.length-1];if(T){y=T.x,b=T.y;for(u=1,a=this.divisions;u<=a;u++)var C=u/a,k=THREE.Shape.Utils.b3(C,y,w,S,m),L=THREE.Shape.Utils.b3(C,b,E,x,g)}}}}return{offset:N.ha*n,path:i}}},THREE.FontUtils.generateShapes=function(e,t){t=t||{};var n=t.size!==undefined?t.size:100,r=t.curveSegments!==undefined?t.curveSegments:4,i=t.font!==undefined?t.font:"helvetiker",s=t.weight!==undefined?t.weight:"normal",o=t.style!==undefined?t.style:"normal";THREE.FontUtils.size=n,THREE.FontUtils.divisions=r,THREE.FontUtils.face=i,THREE.FontUtils.weight=s,THREE.FontUtils.style=o;var u=THREE.FontUtils.drawText(e),a=u.paths,f=[];for(var l=0,c=a.length;l<c;l++)Array.prototype.push.apply(f,a[l].toShapes());return f},function(e){var t=1e-10,n=function(e,t){var n=e.length;if(n<3)return null;var i=[],o=[],u=[],a,f,l;if(r(e)>0)for(f=0;f<n;f++)o[f]=f;else for(f=0;f<n;f++)o[f]=n-1-f;var c=n,h=2*c;for(f=c-1;c>2;){if(h--<=0)return console.log("Warning, unable to triangulate polygon!"),t?u:i;a=f,c<=a&&(a=0),f=a+1,c<=f&&(f=0),l=f+1,c<=l&&(l=0);if(s(e,a,f,l,c,o)){var p,d,v,m,g;p=o[a],d=o[f],v=o[l],i.push([e[p],e[d],e[v]]),u.push([o[a],o[f],o[l]]);for(m=f,g=f+1;g<c;m++,g++)o[m]=o[g];c--,h=2*c}}return t?u:i},r=function(e){var t=e.length,n=0;for(var r=t-1,i=0;i<t;r=i++)n+=e[r].x*e[i].y-e[i].x*e[r].y;return n*.5},i=function(e,t,n,r,i,s,o,u){var a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;return a=i-n,f=s-r,l=e-i,c=t-s,h=n-e,p=r-t,d=o-e,v=u-t,m=o-n,g=u-r,y=o-i,b=u-s,S=a*g-f*m,w=h*v-p*d,E=l*b-c*y,S>=0&&E>=0&&w>=0},s=function(e,n,r,s,o,u){var a,f,l,c,h,p,d,v,m;f=e[u[n]].x,l=e[u[n]].y,c=e[u[r]].x,h=e[u[r]].y,p=e[u[s]].x,d=e[u[s]].y;if(t>(c-f)*(d-l)-(h-l)*(p-f))return!1;for(a=0;a<o;a++){if(a==n||a==r||a==s)continue;v=e[u[a]].x,m=e[u[a]].y;if(i(f,l,c,h,p,d,v,m))return!1}return!0};return e.Triangulate=n,e.Triangulate.area=r,e}(THREE.FontUtils),self._typeface_js={faces:THREE.FontUtils.faces,loadFace:THREE.FontUtils.loadFace},THREE.Curve=function(){},THREE.Curve.prototype.getPoint=function(e){return console.log("Warning, getPoint() not implemented!"),null},THREE.Curve.prototype.getPointAt=function(e){var t=this.getUtoTmapping(e);return this.getPoint(t)},THREE.Curve.prototype.getPoints=function(e){e||(e=5);var t,n=[];for(t=0;t<=e;t++)n.push(this.getPoint(t/e));return n},THREE.Curve.prototype.getSpacedPoints=function(e){e||(e=5);var t,n=[];for(t=0;t<=e;t++)n.push(this.getPointAt(t/e));return n},THREE.Curve.prototype.getLength=function(){var e=this.getLengths();return e[e.length-1]},THREE.Curve.prototype.getLengths=function(e){e||(e=this.__arcLengthDivisions?this.__arcLengthDivisions:200);if(this.cacheArcLengths&&this.cacheArcLengths.length==e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t=[],n,r=this.getPoint(0),i,s=0;t.push(0);for(i=1;i<=e;i++)n=this.getPoint(i/e),s+=n.distanceTo(r),t.push(s),r=n;return this.cacheArcLengths=t,t},THREE.Curve.prototype.updateArcLengths=function(){this.needsUpdate=!0,this.getLengths()},THREE.Curve.prototype.getUtoTmapping=function(e,t){var n=this.getLengths(),r=0,i=n.length,s;t?s=t:s=e*n[i-1];var o=0,u=i-1,a;while(o<=u){r=Math.floor(o+(u-o)/2),a=n[r]-s;if(a<0){o=r+1;continue}if(a>0){u=r-1;continue}u=r;break}r=u;if(n[r]==s){var f=r/(i-1);return f}var l=n[r],c=n[r+1],h=c-l,p=(s-l)/h,f=(r+p)/(i-1);return f},THREE.Curve.prototype.getNormalVector=function(e){var t=this.getTangent(e);return new THREE.Vector2(-t.y,t.x)},THREE.Curve.prototype.getTangent=function(e){var t=1e-4,n=e-t,r=e+t;n<0&&(n=0),r>1&&(r=1);var i=this.getPoint(n),s=this.getPoint(r),o=s.clone().subSelf(i);return o.normalize()},THREE.Curve.prototype.getTangentAt=function(e){var t=this.getUtoTmapping(e);return this.getTangent(t)},THREE.LineCurve=function(e,t){this.v1=e,this.v2=t},THREE.LineCurve.prototype=Object.create(THREE.Curve.prototype),THREE.LineCurve.prototype.getPoint=function(e){var t=this.v2.clone().subSelf(this.v1);return t.multiplyScalar(e).addSelf(this.v1),t},THREE.LineCurve.prototype.getPointAt=function(e){return this.getPoint(e)},THREE.LineCurve.prototype.getTangent=function(e){var t=this.v2.clone().subSelf(this.v1);return t.normalize()},THREE.QuadraticBezierCurve=function(e,t,n){this.v0=e,this.v1=t,this.v2=n},THREE.QuadraticBezierCurve.prototype=Object.create(THREE.Curve.prototype),THREE.QuadraticBezierCurve.prototype.getPoint=function(e){var t,n;return t=THREE.Shape.Utils.b2(e,this.v0.x,this.v1.x,this.v2.x),n=THREE.Shape.Utils.b2(e,this.v0.y,this.v1.y,this.v2.y),new THREE.Vector2(t,n)},THREE.QuadraticBezierCurve.prototype.getTangent=function(e){var t,n;t=THREE.Curve.Utils.tangentQuadraticBezier(e,this.v0.x,this.v1.x,this.v2.x),n=THREE.Curve.Utils.tangentQuadraticBezier(e,this.v0.y,this.v1.y,this.v2.y);var r=new THREE.Vector2(t,n);return r.normalize(),r},THREE.CubicBezierCurve=function(e,t,n,r){this.v0=e,this.v1=t,this.v2=n,this.v3=r},THREE.CubicBezierCurve.prototype=Object.create(THREE.Curve.prototype),THREE.CubicBezierCurve.prototype.getPoint=function(e){var t,n;return t=THREE.Shape.Utils.b3(e,this.v0.x,this.v1.x,this.v2.x,this.v3.x),n=THREE.Shape.Utils.b3(e,this.v0.y,this.v1.y,this.v2.y,this.v3.y),new THREE.Vector2(t,n)},THREE.CubicBezierCurve.prototype.getTangent=function(e){var t,n;t=THREE.Curve.Utils.tangentCubicBezier(e,this.v0.x,this.v1.x,this.v2.x,this.v3.x),n=THREE.Curve.Utils.tangentCubicBezier(e,this.v0.y,this.v1.y,this.v2.y,this.v3.y);var r=new THREE.Vector2(t,n);return r.normalize(),r},THREE.SplineCurve=function(e){this.points=e==undefined?[]:e},THREE.SplineCurve.prototype=Object.create(THREE.Curve.prototype),THREE.SplineCurve.prototype.getPoint=function(e){var t=new THREE.Vector2,n=[],r=this.points,i,s,o;return i=(r.length-1)*e,s=Math.floor(i),o=i-s,n[0]=s==0?s:s-1,n[1]=s,n[2]=s>r.length-2?r.length-1:s+1,n[3]=s>r.length-3?r.length-1:s+2,t.x=THREE.Curve.Utils.interpolate(r[n[0]].x,r[n[1]].x,r[n[2]].x,r[n[3]].x,o),t.y=THREE.Curve.Utils.interpolate(r[n[0]].y,r[n[1]].y,r[n[2]].y,r[n[3]].y,o),t},THREE.EllipseCurve=function(e,t,n,r,i,s,o){this.aX=e,this.aY=t,this.xRadius=n,this.yRadius=r,this.aStartAngle=i,this.aEndAngle=s,this.aClockwise=o},THREE.EllipseCurve.prototype=Object.create(THREE.Curve.prototype),THREE.EllipseCurve.prototype.getPoint=function(e){var t=this.aEndAngle-this.aStartAngle;this.aClockwise||(e=1-e);var n=this.aStartAngle+e*t,r=this.aX+this.xRadius*Math.cos(n),i=this.aY+this.yRadius*Math.sin(n);return new THREE.Vector2(r,i)},THREE.ArcCurve=function(e,t,n,r,i,s){THREE.EllipseCurve.call(this,e,t,n,n,r,i,s)},THREE.ArcCurve.prototype=Object.create(THREE.EllipseCurve.prototype),THREE.Curve.Utils={tangentQuadraticBezier:function(e,t,n,r){return 2*(1-e)*(n-t)+2*e*(r-n)},tangentCubicBezier:function(e,t,n,r,i){return-3*t*(1-e)*(1-e)+3*n*(1-e)*(1-e)-6*e*n*(1-e)+6*e*r*(1-e)-3*e*e*r+3*e*e*i},tangentSpline:function(e,t,n,r,i){var s=6*e*e-6*e,o=3*e*e-4*e+1,u=-6*e*e+6*e,a=3*e*e-2*e;return s+o+u+a},interpolate:function(e,t,n,r,i){var s=(n-e)*.5,o=(r-t)*.5,u=i*i,a=i*u;return(2*t-2*n+s+o)*a+(-3*t+3*n-2*s-o)*u+s*i+t}},THREE.Curve.create=function(e,t){return e.prototype=Object.create(THREE.Curve.prototype),e.prototype.getPoint=t,e},THREE.LineCurve3=THREE.Curve.create(function(e,t){this.v1=e,this.v2=t},function(e){var t=new THREE.Vector3;return t.sub(this.v2,this.v1),t.multiplyScalar(e),t.addSelf(this.v1),t}),THREE.QuadraticBezierCurve3=THREE.Curve.create(function(e,t,n){this.v0=e,this.v1=t,this.v2=n},function(e){var t,n,r;return t=THREE.Shape.Utils.b2(e,this.v0.x,this.v1.x,this.v2.x),n=THREE.Shape.Utils.b2(e,this.v0.y,this.v1.y,this.v2.y),r=THREE.Shape.Utils.b2(e,this.v0.z,this.v1.z,this.v2.z),new THREE.Vector3(t,n,r)}),THREE.CubicBezierCurve3=THREE.Curve.create(function(e,t,n,r){this.v0=e,this.v1=t,this.v2=n,this.v3=r},function(e){var t,n,r;return t=THREE.Shape.Utils.b3(e,this.v0.x,this.v1.x,this.v2.x,this.v3.x),n=THREE.Shape.Utils.b3(e,this.v0.y,this.v1.y,this.v2.y,this.v3.y),r=THREE.Shape.Utils.b3(e,this.v0.z,this.v1.z,this.v2.z,this.v3.z),new THREE.Vector3(t,n,r)}),THREE.SplineCurve3=THREE.Curve.create(function(e){this.points=e==undefined?[]:e},function(e){var t=new THREE.Vector3,n=[],r=this.points,i,s,o;i=(r.length-1)*e,s=Math.floor(i),o=i-s,n[0]=s==0?s:s-1,n[1]=s,n[2]=s>r.length-2?r.length-1:s+1,n[3]=s>r.length-3?r.length-1:s+2;var u=r[n[0]],a=r[n[1]],f=r[n[2]],l=r[n[3]];return t.x=THREE.Curve.Utils.interpolate(u.x,a.x,f.x,l.x,o),t.y=THREE.Curve.Utils.interpolate(u.y,a.y,f.y,l.y,o),t.z=THREE.Curve.Utils.interpolate(u.z,a.z,f.z,l.z,o),t}),THREE.ClosedSplineCurve3=THREE.Curve.create(function(e){this.points=e==undefined?[]:e},function(e){var t=new THREE.Vector3,n=[],r=this.points,i,s,o;return i=(r.length-0)*e,s=Math.floor(i),o=i-s,s+=s>0?0:(Math.floor(Math.abs(s)/r.length)+1)*r.length,n[0]=(s-1)%r.length,n[1]=s%r.length,n[2]=(s+1)%r.length,n[3]=(s+2)%r.length,t.x=THREE.Curve.Utils.interpolate(r[n[0]].x,r[n[1]].x,r[n[2]].x,r[n[3]].x,o),t.y=THREE.Curve.Utils.interpolate(r[n[0]].y,r[n[1]].y,r[n[2]].y,r[n[3]].y,o),t.z=THREE.Curve.Utils.interpolate(r[n[0]].z,r[n[1]].z,r[n[2]].z,r[n[3]].z,o),t}),THREE.CurvePath=function(){this.curves=[],this.bends=[],this.autoClose=!1},THREE.CurvePath.prototype=Object.create(THREE.Curve.prototype),THREE.CurvePath.prototype.add=function(e){this.curves.push(e)},THREE.CurvePath.prototype.checkConnection=function(){},THREE.CurvePath.prototype.closePath=function(){var e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new THREE.LineCurve(t,e))},THREE.CurvePath.prototype.getPoint=function(e){var t=e*this.getLength(),n=this.getCurveLengths(),r=0,i,s;while(r<n.length){if(n[r]>=t){i=n[r]-t,s=this.curves[r];var o=1-i/s.getLength();return s.getPointAt(o)}r++}return null},THREE.CurvePath.prototype.getLength=function(){var e=this.getCurveLengths();return e[e.length-1]},THREE.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length)return this.cacheLengths;var e=[],t=0,n,r=this.curves.length;for(n=0;n<r;n++)t+=this.curves[n].getLength(),e.push(t);return this.cacheLengths=e,e},THREE.CurvePath.prototype.getBoundingBox=function(){var e=this.getPoints(),t,n,r,i,s,o;t=n=Number.NEGATIVE_INFINITY,i=s=Number.POSITIVE_INFINITY;var u,a,f,l,c=e[0]instanceof THREE.Vector3;l=c?new THREE.Vector3:new THREE.Vector2;for(a=0,f=e.length;a<f;a++)u=e[a],u.x>t?t=u.x:u.x<i&&(i=u.x),u.y>n?n=u.y:u.y<s&&(s=u.y),c&&(u.z>r?r=u.z:u.z<o&&(o=u.z)),l.addSelf(u);var h={minX:i,minY:s,maxX:t,maxY:n,centroid:l.divideScalar(f)};return c&&(h.maxZ=r,h.minZ=o),h},THREE.CurvePath.prototype.createPointsGeometry=function(e){var t=this.getPoints(e,!0);return this.createGeometry(t)},THREE.CurvePath.prototype.createSpacedPointsGeometry=function(e){var t=this.getSpacedPoints(e,!0);return this.createGeometry(t)},THREE.CurvePath.prototype.createGeometry=function(e){var t=new THREE.Geometry;for(var n=0;n<e.length;n++)t.vertices.push(new THREE.Vector3(e[n].x,e[n].y,e[n].z||0));return t},THREE.CurvePath.prototype.addWrapPath=function(e){this.bends.push(e)},THREE.CurvePath.prototype.getTransformedPoints=function(e,t){var n=this.getPoints(e),r,i;t||(t=this.bends);for(r=0,i=t.length;r<i;r++)n=this.getWrapPoints(n,t[r]);return n},THREE.CurvePath.prototype.getTransformedSpacedPoints=function(e,t){var n=this.getSpacedPoints(e),r,i;t||(t=this.bends);for(r=0,i=t.length;r<i;r++)n=this.getWrapPoints(n,t[r]);return n},THREE.CurvePath.prototype.getWrapPoints=function(e,t){var n=this.getBoundingBox(),r,i,s,o,u,a;for(r=0,i=e.length;r<i;r++){s=e[r],o=s.x,u=s.y,a=o/n.maxX,a=t.getUtoTmapping(a,o);var f=t.getPoint(a),l=t.getNormalVector(a).multiplyScalar(u);s.x=f.x+l.x,s.y=f.y+l.y}return e},THREE.Gyroscope=function(){THREE.Object3D.call(this)},THREE.Gyroscope.prototype=Object.create(THREE.Object3D.prototype),THREE.Gyroscope.prototype.updateMatrixWorld=function(e){this.matrixAutoUpdate&&this.updateMatrix();if(this.matrixWorldNeedsUpdate||e)this.parent?(this.matrixWorld.multiply(this.parent.matrixWorld,this.matrix),this.matrixWorld.decompose(this.translationWorld,this.rotationWorld,this.scaleWorld),this.matrix.decompose(this.translationObject,this.rotationObject,this.scaleObject),this.matrixWorld.compose(this.translationWorld,this.rotationObject,this.scaleWorld)):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0;for(var t=0,n=this.children.length;t<n;t++)this.children[t].updateMatrixWorld(e)},THREE.Gyroscope.prototype.translationWorld=new THREE.Vector3,THREE.Gyroscope.prototype.translationObject=new THREE.Vector3,THREE.Gyroscope.prototype.rotationWorld=new THREE.Quaternion,THREE.Gyroscope.prototype.rotationObject=new THREE.Quaternion,THREE.Gyroscope.prototype.scaleWorld=new THREE.Vector3,THREE.Gyroscope.prototype.scaleObject=new THREE.Vector3,THREE.Path=function(e){THREE.CurvePath.call(this),this.actions=[],e&&this.fromPoints(e)},THREE.Path.prototype=Object.create(THREE.CurvePath.prototype),THREE.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"},THREE.Path.prototype.fromPoints=function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,n=e.length;t<n;t++)this.lineTo(e[t].x,e[t].y)},THREE.Path.prototype.moveTo=function(e,t){var n=Array.prototype.slice.call(arguments);this.actions.push({action:THREE.PathActions.MOVE_TO,args:n})},THREE.Path.prototype.lineTo=function(e,t){var n=Array.prototype.slice.call(arguments),r=this.actions[this.actions.length-1].args,i=r[r.length-2],s=r[r.length-1],o=new THREE.LineCurve(new THREE.Vector2(i,s),new THREE.Vector2(e,t));this.curves.push(o),this.actions.push({action:THREE.PathActions.LINE_TO,args:n})},THREE.Path.prototype.quadraticCurveTo=function(e,t,n,r){var i=Array.prototype.slice.call(arguments),s=this.actions[this.actions.length-1].args,o=s[s.length-2],u=s[s.length-1],a=new THREE.QuadraticBezierCurve(new THREE.Vector2(o,u),new THREE.Vector2(e,t),new THREE.Vector2(n,r));this.curves.push(a),this.actions.push({action:THREE.PathActions.QUADRATIC_CURVE_TO,args:i})},THREE.Path.prototype.bezierCurveTo=function(e,t,n,r,i,s){var o=Array.prototype.slice.call(arguments),u=this.actions[this.actions.length-1].args,a=u[u.length-2],f=u[u.length-1],l=new THREE.CubicBezierCurve(new THREE.Vector2(a,f),new THREE.Vector2(e,t),new THREE.Vector2(n,r),new THREE.Vector2(i,s));this.curves.push(l),this.actions.push({action:THREE.PathActions.BEZIER_CURVE_TO,args:o})},THREE.Path.prototype.splineThru=function(e){var t=Array.prototype.slice.call(arguments),n=this.actions[this.actions.length-1].args,r=n[n.length-2],i=n[n.length-1],s=[new THREE.Vector2(r,i)];Array.prototype.push.apply(s,e);var o=new THREE.SplineCurve(s);this.curves.push(o),this.actions.push({action:THREE.PathActions.CSPLINE_THRU,args:t})},THREE.Path.prototype.arc=function(e,t,n,r,i,s){var o=this.actions[this.actions.length-1].args,u=o[o.length-2],a=o[o.length-1];this.absarc(e+u,t+a,n,r,i,s)},THREE.Path.prototype.absarc=function(e,t,n,r,i,s){this.absellipse(e,t,n,n,r,i,s)},THREE.Path.prototype.ellipse=function(e,t,n,r,i,s,o){var u=this.actions[this.actions.length-1].args,a=u[u.length-2],f=u[u.length-1];this.absellipse(e+a,t+f,n,r,i,s,o)},THREE.Path.prototype.absellipse=function(e,t,n,r,i,s,o){var u=Array.prototype.slice.call(arguments),a=new THREE.EllipseCurve(e,t,n,r,i,s,o);this.curves.push(a);var f=a.getPoint(o?1:0);u.push(f.x),u.push(f.y),this.actions.push({action:THREE.PathActions.ELLIPSE,args:u})},THREE.Path.prototype.getSpacedPoints=function(e,t){e||(e=40);var n=[];for(var r=0;r<e;r++)n.push(this.getPoint(r/e));return n},THREE.Path.prototype.getPoints=function(e,t){if(this.useSpacedPoints)return console.log("tata"),this.getSpacedPoints(e,t);e=e||12;var n=[],r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w;for(r=0,i=this.actions.length;r<i;r++){s=this.actions[r],o=s.action,u=s.args;switch(o){case THREE.PathActions.MOVE_TO:n.push(new THREE.Vector2(u[0],u[1]));break;case THREE.PathActions.LINE_TO:n.push(new THREE.Vector2(u[0],u[1]));break;case THREE.PathActions.QUADRATIC_CURVE_TO:a=u[2],f=u[3],h=u[0],p=u[1],n.length>0?(m=n[n.length-1],d=m.x,v=m.y):(m=this.actions[r-1].args,d=m[m.length-2],v=m[m.length-1]);for(g=1;g<=e;g++)y=g/e,b=THREE.Shape.Utils.b2(y,d,h,a),w=THREE.Shape.Utils.b2(y,v,p,f),n.push(new THREE.Vector2(b,w));break;case THREE.PathActions.BEZIER_CURVE_TO:a=u[4],f=u[5],h=u[0],p=u[1],l=u[2],c=u[3],n.length>0?(m=n[n.length-1],d=m.x,v=m.y):(m=this.actions[r-1].args,d=m[m.length-2],v=m[m.length-1]);for(g=1;g<=e;g++)y=g/e,b=THREE.Shape.Utils.b3(y,d,h,l,a),w=THREE.Shape.Utils.b3(y,v,p,c,f),n.push(new THREE.Vector2(b,w));break;case THREE.PathActions.CSPLINE_THRU:m=this.actions[r-1].args;var E=new THREE.Vector2(m[m.length-2],m[m.length-1]),S=[E],x=e*u[0].length;S=S.concat(u[0]);var T=new THREE.SplineCurve(S);for(g=1;g<=x;g++)n.push(T.getPointAt(g/x));break;case THREE.PathActions.ARC:var N=u[0],C=u[1],k=u[2],L=u[3],A=u[4],O=!!u[5],M=A-L,_,D=e*2;for(g=1;g<=D;g++)y=g/D,O||(y=1-y),_=L+y*M,b=N+k*Math.cos(_),w=C+k*Math.sin(_),n.push(new THREE.Vector2(b,w));break;case THREE.PathActions.ELLIPSE:var N=u[0],C=u[1],P=u[2],H=u[3],L=u[4],A=u[5],O=!!u[6],M=A-L,_,D=e*2;for(g=1;g<=D;g++)y=g/D,O||(y=1-y),_=L+y*M,b=N+P*Math.cos(_),w=C+H*Math.sin(_),n.push(new THREE.Vector2(b,w))}}var B=n[n.length-1],j=1e-10;return Math.abs(B.x-n[0].x)<j&&Math.abs(B.y-n[0].y)<j&&n.splice(n.length-1,1),t&&n.push(n[0]),n},THREE.Path.prototype.toShapes=function(){var e,t,n,r,i,s=[],o=new THREE.Path;for(e=0,t=this.actions.length;e<t;e++)n=this.actions[e],i=n.args,r=n.action,r==THREE.PathActions.MOVE_TO&&o.actions.length!=0&&(s.push(o),o=new THREE.Path),o[r].apply(o,i);o.actions.length!=0&&s.push(o);if(s.length==0)return[];var u,a,f=[],l=!THREE.Shape.Utils.isClockWise(s[0].getPoints());if(s.length==1)return u=s[0],a=new THREE.Shape,a.actions=u.actions,a.curves=u.curves,f.push(a),f;if(l){a=new THREE.Shape;for(e=0,t=s.length;e<t;e++)u=s[e],THREE.Shape.Utils.isClockWise(u.getPoints())?(a.actions=u.actions,a.curves=u.curves,f.push(a),a=new THREE.Shape):a.holes.push(u)}else{for(e=0,t=s.length;e<t;e++)u=s[e],THREE.Shape.Utils.isClockWise(u.getPoints())?(a&&f.push(a),a=new THREE.Shape,a.actions=u.actions,a.curves=u.curves):a.holes.push(u);f.push(a)}return f},THREE.Shape=function(){THREE.Path.apply(this,arguments),this.holes=[]},THREE.Shape.prototype=Object.create(THREE.Path.prototype),THREE.Shape.prototype.extrude=function(e){var t=new THREE.ExtrudeGeometry(this,e);return t},THREE.Shape.prototype.getPointsHoles=function(e){var t,n=this.holes.length,r=[];for(t=0;t<n;t++)r[t]=this.holes[t].getTransformedPoints(e,this.bends);return r},THREE.Shape.prototype.getSpacedPointsHoles=function(e){var t,n=this.holes.length,r=[];for(t=0;t<n;t++)r[t]=this.holes[t].getTransformedSpacedPoints(e,this.bends);return r},THREE.Shape.prototype.extractAllPoints=function(e){return{shape:this.getTransformedPoints(e),holes:this.getPointsHoles(e)}},THREE.Shape.prototype.extractPoints=function(e){return this.useSpacedPoints?this.extractAllSpacedPoints(e):this.extractAllPoints(e)},THREE.Shape.prototype.extractAllSpacedPoints=function(e){return{shape:this.getTransformedSpacedPoints(e),holes:this.getSpacedPointsHoles(e)}},THREE.Shape.Utils={removeHoles:function(e,t){var n=e.concat(),r=n.concat(),i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T=[];for(h=0;h<t.length;h++){d=t[h],Array.prototype.push.apply(r,d),v=Number.POSITIVE_INFINITY;for(p=0;p<d.length;p++){y=d[p];var N=[];for(g=0;g<n.length;g++)b=n[g],m=y.distanceToSquared(b),N.push(m),m<v&&(v=m,a=p,f=g)}i=f-1>=0?f-1:n.length-1,o=a-1>=0?a-1:d.length-1;var C=[d[a],n[f],n[i]],k=THREE.FontUtils.Triangulate.area(C),L=[d[a],d[o],n[f]],A=THREE.FontUtils.Triangulate.area(L),O=1,M=-1,_=f,D=a;f+=O,a+=M,f<0&&(f+=n.length),f%=n.length,a<0&&(a+=d.length),a%=d.length,i=f-1>=0?f-1:n.length-1,o=a-1>=0?a-1:d.length-1,C=[d[a],n[f],n[i]];var P=THREE.FontUtils.Triangulate.area(C);L=[d[a],d[o],n[f]];var H=THREE.FontUtils.Triangulate.area(L);k+A>P+H&&(f=_,a=D,f<0&&(f+=n.length),f%=n.length,a<0&&(a+=d.length),a%=d.length,i=f-1>=0?f-1:n.length-1,o=a-1>=0?a-1:d.length-1),w=n.slice(0,f),E=n.slice(f),S=d.slice(a),x=d.slice(0,a);var B=[d[a],n[f],n[i]],j=[d[a],d[o],n[f]];T.push(B),T.push(j),n=w.concat(S).concat(x).concat(E)}return{shape:n,isolatedPts:T,allpoints:r}},triangulateShape:function(e,t){var n=THREE.Shape.Utils.removeHoles(e,t),r=n.shape,i=n.allpoints,s=n.isolatedPts,o=THREE.FontUtils.Triangulate(r,!1),u,a,f,l,c,h,p={},d={};for(u=0,a=i.length;u<a;u++)c=i[u].x+":"+i[u].y,p[c]!==undefined&&console.log("Duplicate point",c),p[c]=u;for(u=0,a=o.length;u<a;u++){l=o[u];for(f=0;f<3;f++)c=l[f].x+":"+l[f].y,h=p[c],h!==undefined&&(l[f]=h)}for(u=0,a=s.length;u<a;u++){l=s[u];for(f=0;f<3;f++)c=l[f].x+":"+l[f].y,h=p[c],h!==undefined&&(l[f]=h)}return o.concat(s)},isClockWise:function(e){return THREE.FontUtils.Triangulate.area(e)<0},b2p0:function(e,t){var n=1-e;return n*n*t},b2p1:function(e,t){return 2*(1-e)*e*t},b2p2:function(e,t){return e*e*t},b2:function(e,t,n,r){return this.b2p0(e,t)+this.b2p1(e,n)+this.b2p2(e,r)},b3p0:function(e,t){var n=1-e;return n*n*n*t},b3p1:function(e,t){var n=1-e;return 3*n*n*e*t},b3p2:function(e,t){var n=1-e;return 3*n*e*e*t},b3p3:function(e,t){return e*e*e*t},b3:function(e,t,n,r,i){return this.b3p0(e,t)+this.b3p1(e,n)+this.b3p2(e,r)+this.b3p3(e,i)}},THREE.AnimationHandler=function(){var e=[],t={},n={};n.update=function(t){for(var n=0;n<e.length;n++)e[n].update(t)},n.addToUpdate=function(t){e.indexOf(t)===-1&&e.push(t)},n.removeFromUpdate=function(t){var n=e.indexOf(t);n!==-1&&e.splice(n,1)},n.add=function(e){t[e.name]!==undefined&&console.log("THREE.AnimationHandler.add: Warning! "+e.name+" already exists in library. Overwriting."),t[e.name]=e,i(e)},n.get=function(e){if(typeof e=="string")return t[e]?t[e]:(console.log("THREE.AnimationHandler.get: Couldn't find animation "+e),null)},n.parse=function(e){var t=[];if(e instanceof THREE.SkinnedMesh)for(var n=0;n<e.bones.length;n++)t.push(e.bones[n]);else r(e,t);return t};var r=function(e,t){t.push(e);for(var n=0;n<e.children.length;n++)r(e.children[n],t)},i=function(e){if(e.initialized===!0)return;for(var t=0;t<e.hierarchy.length;t++){for(var n=0;n<e.hierarchy[t].keys.length;n++){e.hierarchy[t].keys[n].time<0&&(e.hierarchy[t].keys[n].time=0);if(e.hierarchy[t].keys[n].rot!==undefined&&!(e.hierarchy[t].keys[n].rot instanceof THREE.Quaternion)){var r=e.hierarchy[t].keys[n].rot;e.hierarchy[t].keys[n].rot=new THREE.Quaternion(r[0],r[1],r[2],r[3])}}if(e.hierarchy[t].keys.length&&e.hierarchy[t].keys[0].morphTargets!==undefined){var i={};for(var n=0;n<e.hierarchy[t].keys.length;n++)for(var s=0;s<e.hierarchy[t].keys[n].morphTargets.length;s++){var o=e.hierarchy[t].keys[n].morphTargets[s];i[o]=-1}e.hierarchy[t].usedMorphTargets=i;for(var n=0;n<e.hierarchy[t].keys.length;n++){var u={};for(var o in i){for(var s=0;s<e.hierarchy[t].keys[n].morphTargets.length;s++)if(e.hierarchy[t].keys[n].morphTargets[s]===o){u[o]=e.hierarchy[t].keys[n].morphTargetsInfluences[s];break}s===e.hierarchy[t].keys[n].morphTargets.length&&(u[o]=0)}e.hierarchy[t].keys[n].morphTargetsInfluences=u}}for(var n=1;n<e.hierarchy[t].keys.length;n++)e.hierarchy[t].keys[n].time===e.hierarchy[t].keys[n-1].time&&(e.hierarchy[t].keys.splice(n,1),n--);for(var n=0;n<e.hierarchy[t].keys.length;n++)e.hierarchy[t].keys[n].index=n}var a=parseInt(e.length*e.fps,10);e.JIT={},e.JIT.hierarchy=[];for(var t=0;t<e.hierarchy.length;t++)e.JIT.hierarchy.push(new Array(a));e.initialized=!0};return n.LINEAR=0,n.CATMULLROM=1,n.CATMULLROM_FORWARD=2,n}(),THREE.Animation=function(e,t,n){this.root=e,this.data=THREE.AnimationHandler.get(t),this.hierarchy=THREE.AnimationHandler.parse(e),this.currentTime=0,this.timeScale=1,this.isPlaying=!1,this.isPaused=!0,this.loop=!0,this.interpolationType=n!==undefined?n:THREE.AnimationHandler.LINEAR,this.points=[],this.target=new THREE.Vector3},THREE.Animation.prototype.play=function(e,t){if(this.isPlaying===!1){this.isPlaying=!0,this.loop=e!==undefined?e:!0,this.currentTime=t!==undefined?t:0;var n,r=this.hierarchy.length,i;for(n=0;n<r;n++){i=this.hierarchy[n],this.interpolationType!==THREE.AnimationHandler.CATMULLROM_FORWARD&&(i.useQuaternion=!0),i.matrixAutoUpdate=!0,i.animationCache===undefined&&(i.animationCache={},i.animationCache.prevKey={pos:0,rot:0,scl:0},i.animationCache.nextKey={pos:0,rot:0,scl:0},i.animationCache.originalMatrix=i instanceof THREE.Bone?i.skinMatrix:i.matrix);var s=i.animationCache.prevKey,o=i.animationCache.nextKey;s.pos=this.data.hierarchy[n].keys[0],s.rot=this.data.hierarchy[n].keys[0],s.scl=this.data.hierarchy[n].keys[0],o.pos=this.getNextKeyWith("pos",n,1),o.rot=this.getNextKeyWith("rot",n,1),o.scl=this.getNextKeyWith("scl",n,1)}this.update(0)}this.isPaused=!1,THREE.AnimationHandler.addToUpdate(this)},THREE.Animation.prototype.pause=function(){this.isPaused===!0?THREE.AnimationHandler.addToUpdate(this):THREE.AnimationHandler.removeFromUpdate(this),this.isPaused=!this.isPaused},THREE.Animation.prototype.stop=function(){this.isPlaying=!1,this.isPaused=!1,THREE.AnimationHandler.removeFromUpdate(this)},THREE.Animation.prototype.update=function(e){if(this.isPlaying===!1)return;var t=["pos","rot","scl"],n,r,i,s,o,u,a,f,l,c,h=this.data.JIT.hierarchy,p,d,v,m,g;this.currentTime+=e*this.timeScale,d=this.currentTime,p=this.currentTime=this.currentTime%this.data.length,c=parseInt(Math.min(p*this.data.fps,this.data.length*this.data.fps),10);for(var y=0,b=this.hierarchy.length;y<b;y++){f=this.hierarchy[y],l=f.animationCache;for(var w=0;w<3;w++){n=t[w],u=l.prevKey[n],a=l.nextKey[n];if(a.time<=d){if(p<d){if(!this.loop){this.stop();return}u=this.data.hierarchy[y].keys[0],a=this.getNextKeyWith(n,y,1);while(a.time<p)u=a,a=this.getNextKeyWith(n,y,a.index+1)}else do u=a,a=this.getNextKeyWith(n,y,a.index+1);while(a.time<p);l.prevKey[n]=u,l.nextKey[n]=a}f.matrixAutoUpdate=!0,f.matrixWorldNeedsUpdate=!0,r=(p-u.time)/(a.time-u.time),s=u[n],o=a[n];if(r<0||r>1)console.log("THREE.Animation.update: Warning! Scale out of bounds:"+r+" on bone "+y),r=r<0?0:1;if(n==="pos"){i=f.position;if(this.interpolationType===THREE.AnimationHandler.LINEAR)i.x=s[0]+(o[0]-s[0])*r,i.y=s[1]+(o[1]-s[1])*r,i.z=s[2]+(o[2]-s[2])*r;else if(this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD)this.points[0]=this.getPrevKeyWith("pos",y,u.index-1).pos,this.points[1]=s,this.points[2]=o,this.points[3]=this.getNextKeyWith("pos",y,a.index+1).pos,r=r*.33+.33,v=this.interpolateCatmullRom(this.points,r),i.x=v[0],i.y=v[1],i.z=v[2],this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD&&(m=this.interpolateCatmullRom(this.points,r*1.01),this.target.set(m[0],m[1],m[2]),this.target.subSelf(i),this.target.y=0,this.target.normalize(),g=Math.atan2(this.target.x,this.target.z),f.rotation.set(0,g,0))}else n==="rot"?THREE.Quaternion.slerp(s,o,f.quaternion,r):n==="scl"&&(i=f.scale,i.x=s[0]+(o[0]-s[0])*r,i.y=s[1]+(o[1]-s[1])*r,i.z=s[2]+(o[2]-s[2])*r)}}},THREE.Animation.prototype.interpolateCatmullRom=function(e,t){var n=[],r=[],i,s,o,u,a,f,l,c,h;return i=(e.length-1)*t,s=Math.floor(i),o=i-s,n[0]=s===0?s:s-1,n[1]=s,n[2]=s>e.length-2?s:s+1,n[3]=s>e.length-3?s:s+2,f=e[n[0]],l=e[n[1]],c=e[n[2]],h=e[n[3]],u=o*o,a=o*u,r[0]=this.interpolate(f[0],l[0],c[0],h[0],o,u,a),r[1]=this.interpolate(f[1],l[1],c[1],h[1],o,u,a),r[2]=this.interpolate(f[2],l[2],c[2],h[2],o,u,a),r},THREE.Animation.prototype.interpolate=function(e,t,n,r,i,s,o){var u=(n-e)*.5,a=(r-t)*.5;return(2*(t-n)+u+a)*o+(-3*(t-n)-2*u-a)*s+u*i+t},THREE.Animation.prototype.getNextKeyWith=function(e,t,n){var r=this.data.hierarchy[t].keys;this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD?n=n<r.length-1?n:r.length-1:n%=r.length;for(;n<r.length;n++)if(r[n][e]!==undefined)return r[n];return this.data.hierarchy[t].keys[0]},THREE.Animation.prototype.getPrevKeyWith=function(e,t,n){var r=this.data.hierarchy[t].keys;this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD?n=n>0?n:0:n=n>=0?n:n+r.length;for(;n>=0;n--)if(r[n][e]!==undefined)return r[n];return this.data.hierarchy[t].keys[r.length-1]},THREE.KeyFrameAnimation=function(e,t,n){this.root=e,this.data=THREE.AnimationHandler.get(t),this.hierarchy=THREE.AnimationHandler.parse(e),this.currentTime=0,this.timeScale=.001,this.isPlaying=!1,this.isPaused=!0,this.loop=!0,this.JITCompile=n!==undefined?n:!0;for(var r=0,i=this.hierarchy.length;r<i;r++){var s=this.data.hierarchy[r].keys,o=this.data.hierarchy[r].sids,u=this.hierarchy[r];if(s.length&&o){for(var a=0;a<o.length;a++){var f=o[a],l=this.getNextKeyWith(f,r,0);l&&l.apply(f)}u.matrixAutoUpdate=!1,this.data.hierarchy[r].node.updateMatrix(),u.matrixWorldNeedsUpdate=!0}}},THREE.KeyFrameAnimation.prototype.play=function(e,t){if(!this.isPlaying){this.isPlaying=!0,this.loop=e!==undefined?e:!0,this.currentTime=t!==undefined?t:0,this.startTimeMs=t,this.startTime=1e7,this.endTime=-this.startTime;var n,r=this.hierarchy.length,i,s;for(n=0;n<r;n++){i=this.hierarchy[n],s=this.data.hierarchy[n],i.useQuaternion=!0,s.animationCache===undefined&&(s.animationCache={},s.animationCache.prevKey=null,s.animationCache.nextKey=null,s.animationCache.originalMatrix=i instanceof THREE.Bone?i.skinMatrix:i.matrix);var o=this.data.hierarchy[n].keys;o.length&&(s.animationCache.prevKey=o[0],s.animationCache.nextKey=o[1],this.startTime=Math.min(o[0].time,this.startTime),this.endTime=Math.max(o[o.length-1].time,this.endTime))}this.update(0)}this.isPaused=!1,THREE.AnimationHandler.addToUpdate(this)},THREE.KeyFrameAnimation.prototype.pause=function(){this.isPaused?THREE.AnimationHandler.addToUpdate(this):THREE.AnimationHandler.removeFromUpdate(this),this.isPaused=!this.isPaused},THREE.KeyFrameAnimation.prototype.stop=function(){this.isPlaying=!1,this.isPaused=!1,THREE.AnimationHandler.removeFromUpdate(this);for(var e=0;e<this.data.hierarchy.length;e++){var t=this.hierarchy[e],n=this.data.hierarchy[e];if(n.animationCache!==undefined){var r=n.animationCache.originalMatrix;t instanceof THREE.Bone?(r.copy(t.skinMatrix),t.skinMatrix=r):(r.copy(t.matrix),t.matrix=r),delete n.animationCache}}},THREE.KeyFrameAnimation.prototype.update=function(e){if(!this.isPlaying)return;var t,n,r,i,s,o=this.data.JIT.hierarchy,u,a,f;this.currentTime+=e*this.timeScale,a=this.currentTime,u=this.currentTime=this.currentTime%this.data.length,u<this.startTimeMs&&(u=this.currentTime=this.startTimeMs+u),s=parseInt(Math.min(u*this.data.fps,this.data.length*this.data.fps),10),f=u<a;if(f&&!this.loop){for(var l=0,c=this.hierarchy.length;l<c;l++){var h=this.data.hierarchy[l].keys,p=this.data.hierarchy[l].sids,d=h.length-1,v=this.hierarchy[l];if(h.length){for(var m=0;m<p.length;m++){var g=p[m],y=this.getPrevKeyWith(g,l,d);y&&y.apply(g)}this.data.hierarchy[l].node.updateMatrix(),v.matrixWorldNeedsUpdate=!0}}this.stop();return}if(u<this.startTime)return;for(var l=0,c=this.hierarchy.length;l<c;l++){r=this.hierarchy[l],i=this.data.hierarchy[l];var h=i.keys,b=i.animationCache;if(this.JITCompile&&o[l][s]!==undefined)r instanceof THREE.Bone?(r.skinMatrix=o[l][s],r.matrixWorldNeedsUpdate=!1):(r.matrix=o[l][s],r.matrixWorldNeedsUpdate=!0);else if(h.length){this.JITCompile&&b&&(r instanceof THREE.Bone?r.skinMatrix=b.originalMatrix:r.matrix=b.originalMatrix),t=b.prevKey,n=b.nextKey;if(t&&n){if(n.time<=a){if(f&&this.loop){t=h[0],n=h[1];while(n.time<u)t=n,n=h[t.index+1]}else if(!f){var w=h.length-1;while(n.time<u&&n.index!==w)t=n,n=h[t.index+1]}b.prevKey=t,b.nextKey=n}n.time>=u?t.interpolate(n,u):t.interpolate(n,n.time)}this.data.hierarchy[l].node.updateMatrix(),r.matrixWorldNeedsUpdate=!0}}if(this.JITCompile&&o[0][s]===undefined){this.hierarchy[0].updateMatrixWorld(!0);for(var l=0;l<this.hierarchy.length;l++)this.hierarchy[l]instanceof THREE.Bone?o[l][s]=this.hierarchy[l].skinMatrix.clone():o[l][s]=this.hierarchy[l].matrix.clone()}},THREE.KeyFrameAnimation.prototype.getNextKeyWith=function(e,t,n){var r=this.data.hierarchy[t].keys;n%=r.length;for(;n<r.length;n++)if(r[n].hasTarget(e))return r[n];return r[0]},THREE.KeyFrameAnimation.prototype.getPrevKeyWith=function(e,t,n){var r=this.data.hierarchy[t].keys;n=n>=0?n:n+r.length;for(;n>=0;n--)if(r[n].hasTarget(e))return r[n];return r[r.length-1]},THREE.CubeCamera=function(e,t,n){THREE.Object3D.call(this);var r=90,i=1,s=new THREE.PerspectiveCamera(r,i,e,t);s.up.set(0,-1,0),s.lookAt(new THREE.Vector3(1,0,0)),this.add(s);var o=new THREE.PerspectiveCamera(r,i,e,t);o.up.set(0,-1,0),o.lookAt(new THREE.Vector3(-1,0,0)),this.add(o);var u=new THREE.PerspectiveCamera(r,i,e,t);u.up.set(0,0,1),u.lookAt(new THREE.Vector3(0,1,0)),this.add(u);var a=new THREE.PerspectiveCamera(r,i,e,t);a.up.set(0,0,-1),a.lookAt(new THREE.Vector3(0,-1,0)),this.add(a);var f=new THREE.PerspectiveCamera(r,i,e,t);f.up.set(0,-1,0),f.lookAt(new THREE.Vector3(0,0,1)),this.add(f);var l=new THREE.PerspectiveCamera(r,i,e,t);l.up.set(0,-1,0),l.lookAt(new THREE.Vector3(0,0,-1)),this.add(l),this.renderTarget=new THREE.WebGLRenderTargetCube(n,n,{format:THREE.RGBFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter}),this.updateCubeMap=function(e,t){var n=this.renderTarget,r=n.generateMipmaps;n.generateMipmaps=!1,n.activeCubeFace=0,e.render(t,s,n),n.activeCubeFace=1,e.render(t,o,n),n.activeCubeFace=2,e.render(t,u,n),n.activeCubeFace=3,e.render(t,a,n),n.activeCubeFace=4,e.render(t,f,n),n.generateMipmaps=r,n.activeCubeFace=5,e.render(t,l,n)}},THREE.CubeCamera.prototype=Object.create(THREE.Object3D.prototype),THREE.CombinedCamera=function(e,t,n,r,i,s,o){THREE.Camera.call(this),this.fov=n,this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2,this.cameraO=new THREE.OrthographicCamera(e/-2,e/2,t/2,t/-2,s,o),this.cameraP=new THREE.PerspectiveCamera(n,e/t,r,i),this.zoom=1,this.toPerspective();var u=e/t},THREE.CombinedCamera.prototype=Object.create(THREE.Camera.prototype),THREE.CombinedCamera.prototype.toPerspective=function(){this.near=this.cameraP.near,this.far=this.cameraP.far,this.cameraP.fov=this.fov/this.zoom,this.cameraP.updateProjectionMatrix(),this.projectionMatrix=this.cameraP.projectionMatrix,this.inPerspectiveMode=!0,this.inOrthographicMode=!1},THREE.CombinedCamera.prototype.toOrthographic=function(){var e=this.fov,t=this.cameraP.aspect,n=this.cameraP.near,r=this.cameraP.far,i=(n+r)/2,s=Math.tan(e/2)*i,o=2*s,u=o*t,a=u/2;s/=this.zoom,a/=this.zoom,this.cameraO.left=-a,this.cameraO.right=a,this.cameraO.top=s,this.cameraO.bottom=-s,this.cameraO.updateProjectionMatrix(),this.near=this.cameraO.near,this.far=this.cameraO.far,this.projectionMatrix=this.cameraO.projectionMatrix,this.inPerspectiveMode=!1,this.inOrthographicMode=!0},THREE.CombinedCamera.prototype.setSize=function(e,t){this.cameraP.aspect=e/t,this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2},THREE.CombinedCamera.prototype.setFov=function(e){this.fov=e,this.inPerspectiveMode?this.toPerspective():this.toOrthographic()},THREE.CombinedCamera.prototype.updateProjectionMatrix=function(){this.inPerspectiveMode?this.toPerspective():(this.toPerspective(),this.toOrthographic())},THREE.CombinedCamera.prototype.setLens=function(e,t){t=t!==undefined?t:24;var n=2*Math.atan(t/(e*2))*(180/Math.PI);return this.setFov(n),n},THREE.CombinedCamera.prototype.setZoom=function(e){this.zoom=e,this.inPerspectiveMode?this.toPerspective():this.toOrthographic()},THREE.CombinedCamera.prototype.toFrontView=function(){this.rotation.x=0,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toBackView=function(){this.rotation.x=0,this.rotation.y=Math.PI,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toLeftView=function(){this.rotation.x=0,this.rotation.y=-Math.PI/2,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toRightView=function(){this.rotation.x=0,this.rotation.y=Math.PI/2,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toTopView=function(){this.rotation.x=-Math.PI/2,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toBottomView=function(){this.rotation.x=Math.PI/2,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.FirstPersonControls=function(e,t){function n(e,t){return function(){t.apply(e,arguments)}}this.object=e,this.target=new THREE.Vector3(0,0,0),this.domElement=t!==undefined?t:document,this.movementSpeed=1,this.lookSpeed=.005,this.lookVertical=!0,this.autoForward=!1,this.activeLook=!0,this.heightSpeed=!1,this.heightCoef=1,this.heightMin=0,this.heightMax=1,this.constrainVertical=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.autoSpeedFactor=0,this.mouseX=0,this.mouseY=0,this.lat=0,this.lon=0,this.phi=0,this.theta=0,this.moveForward=!1,this.moveBackward=!1,this.moveLeft=!1,this.moveRight=!1,this.freeze=!1,this.mouseDragOn=!1,this.viewHalfX=0,this.viewHalfY=0,this.domElement!==document&&this.domElement.setAttribute("tabindex",-1),this.handleResize=function(){this.domElement===document?(this.viewHalfX=window.innerWidth/2,this.viewHalfY=window.innerHeight/2):(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2)},this.onMouseDown=function(e){this.domElement!==document&&this.domElement.focus(),e.preventDefault(),e.stopPropagation();if(this.activeLook)switch(e.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0}this.mouseDragOn=!0},this.onMouseUp=function(e){e.preventDefault(),e.stopPropagation();if(this.activeLook)switch(e.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1}this.mouseDragOn=!1},this.onMouseMove=function(e){this.domElement===document?(this.mouseX=e.pageX-this.viewHalfX,this.mouseY=e.pageY-this.viewHalfY):(this.mouseX=e.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=e.pageY-this.domElement.offsetTop-this.viewHalfY)},this.onKeyDown=function(e){switch(e.keyCode){case 38:case 87:this.moveForward=!0;break;case 37:case 65:this.moveLeft=!0;break;case 40:case 83:this.moveBackward=!0;break;case 39:case 68:this.moveRight=!0;break;case 82:this.moveUp=!0;break;case 70:this.moveDown=!0;break;case 81:this.freeze=!this.freeze}},this.onKeyUp=function(e){switch(e.keyCode){case 38:case 87:this.moveForward=!1;break;case 37:case 65:this.moveLeft=!1;break;case 40:case 83:this.moveBackward=!1;break;case 39:case 68:this.moveRight=!1;break;case 82:this.moveUp=!1;break;case 70:this.moveDown=!1}},this.update=function(e){var t=0;if(this.freeze)return;if(this.heightSpeed){var n=THREE.Math.clamp(this.object.position.y,this.heightMin,this.heightMax),r=n-this.heightMin;this.autoSpeedFactor=e*r*this.heightCoef}else this.autoSpeedFactor=0;t=e*this.movementSpeed,(this.moveForward||this.autoForward&&!this.moveBackward)&&this.object.translateZ(-(t+this.autoSpeedFactor)),this.moveBackward&&this.object.translateZ(t),this.moveLeft&&this.object.translateX(-t),this.moveRight&&this.object.translateX(t),this.moveUp&&this.object.translateY(t),this.moveDown&&this.object.translateY(-t);var i=e*this.lookSpeed;this.activeLook||(i=0),this.lon+=this.mouseX*i,this.lookVertical&&(this.lat-=this.mouseY*i),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=(90-this.lat)*Math.PI/180,this.theta=this.lon*Math.PI/180;var s=this.target,o=this.object.position;s.x=o.x+100*Math.sin(this.phi)*Math.cos(this.theta),s.y=o.y+100*Math.cos(this.phi),s.z=o.z+100*Math.sin(this.phi)*Math.sin(this.theta);var u=1;this.constrainVertical&&(u=Math.PI/(this.verticalMax-this.verticalMin)),this.lon+=this.mouseX*i,this.lookVertical&&(this.lat-=this.mouseY*i*u),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=(90-this.lat)*Math.PI/180,this.theta=this.lon*Math.PI/180,this.constrainVertical&&(this.phi=THREE.Math.mapLinear(this.phi,0,Math.PI,this.verticalMin,this.verticalMax));var s=this.target,o=this.object.position;s.x=o.x+100*Math.sin(this.phi)*Math.cos(this.theta),s.y=o.y+100*Math.cos(this.phi),s.z=o.z+100*Math.sin(this.phi)*Math.sin(this.theta),this.object.lookAt(s)},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousemove",n(this,this.onMouseMove),!1),this.domElement.addEventListener("mousedown",n(this,this.onMouseDown),!1),this.domElement.addEventListener("mouseup",n(this,this.onMouseUp),!1),this.domElement.addEventListener("keydown",n(this,this.onKeyDown),!1),this.domElement.addEventListener("keyup",n(this,this.onKeyUp),!1),this.handleResize()},THREE.PathControls=function(e,t){function i(e){var t=e%n;return t>=0?t:t+n}function s(e,t){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+r*r+i*i)}function o(e){return(e*=2)<1?.5*e*e:-0.5*(--e*(e-2)-1)}function u(e,t){return function(){t.apply(e,arguments)}}function a(e,t,n,r){var i={name:n,fps:.6,length:r,hierarchy:[]},s,o,u,a=t.getControlPointsArray(),f=t.getLength(),l=a.length,c=0,h=0,p=l-1;o={parent:-1,keys:[]},o.keys[h]={time:0,pos:a[h],rot:[0,0,0,1],scl:[1,1,1]},o.keys[p]={time:r,pos:a[p],rot:[0,0,0,1],scl:[1,1,1]};for(s=1;s<l-1;s++)c=r*f.chunks[s]/f.total,o.keys[s]={time:c,pos:a[s]};return i.hierarchy[0]=o,THREE.AnimationHandler.add(i),new THREE.Animation(e,n,THREE.AnimationHandler.CATMULLROM_FORWARD,!1)}function f(e,t){var n,r,i,s=new THREE.Geometry;for(n=0;n<e.points.length*t;n++)r=n/(e.points.length*t),i=e.getPoint(r),s.vertices[n]=new THREE.Vector3(i.x,i.y,i.z);return s}function l(e,t){var n=f(t,10),r=f(t,10),i=new THREE.LineBasicMaterial({color:16711680,linewidth:3}),s=new THREE.Line(n,i),o=new THREE.ParticleSystem(r,new THREE.ParticleBasicMaterial({color:16755200,size:3}));s.scale.set(1,1,1),e.add(s),o.scale.set(1,1,1),e.add(o);var u,a=new THREE.SphereGeometry(1,16,8),l=new THREE.MeshBasicMaterial({color:65280});for(var c=0;c<t.points.length;c++)u=new THREE.Mesh(a,l),u.position.copy(t.points[c]),e.add(u)}this.object=e,this.domElement=t!==undefined?t:document,this.id="PathControls"+THREE.PathControlsIdCounter++,this.duration=1e4,this.waypoints=[],this.useConstantSpeed=!0,this.resamplingCoef=50,this.debugPath=new THREE.Object3D,this.debugDummy=new THREE.Object3D,this.animationParent=new THREE.Object3D,this.lookSpeed=.005,this.lookVertical=!0,this.lookHorizontal=!0,this.verticalAngleMap={srcRange:[0,2*Math.PI],dstRange:[0,2*Math.PI]},this.horizontalAngleMap={srcRange:[0,2*Math.PI],dstRange:[0,2*Math.PI]},this.target=new THREE.Object3D,this.mouseX=0,this.mouseY=0,this.lat=0,this.lon=0,this.phi=0,this.theta=0;var n=Math.PI*2,r=Math.PI/180;this.viewHalfX=0,this.viewHalfY=0,this.domElement!==document&&this.domElement.setAttribute("tabindex",-1),this.handleResize=function(){this.domElement===document?(this.viewHalfX=window.innerWidth/2,this.viewHalfY=window.innerHeight/2):(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2)},this.update=function(e){var t,n;this.lookHorizontal&&(this.lon+=this.mouseX*this.lookSpeed*e),this.lookVertical&&(this.lat-=this.mouseY*this.lookSpeed*e),this.lon=Math.max(0,Math.min(360,this.lon)),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=(90-this.lat)*r,this.theta=this.lon*r,this.phi=i(this.phi),t=this.verticalAngleMap.srcRange,n=this.verticalAngleMap.dstRange;var s=THREE.Math.mapLinear(this.phi,t[0],t[1],n[0],n[1]),u=n[1]-n[0],a=(s-n[0])/u;this.phi=o(a)*u+n[0],t=this.horizontalAngleMap.srcRange,n=this.horizontalAngleMap.dstRange;var f=THREE.Math.mapLinear(this.theta,t[0],t[1],n[0],n[1]),l=n[1]-n[0],c=(f-n[0])/l;this.theta=o(c)*l+n[0];var h=this.target.position,p=this.object.position;h.x=100*Math.sin(this.phi)*Math.cos(this.theta),h.y=100*Math.cos(this.phi),h.z=100*Math.sin(this.phi)*Math.sin(this.theta),this.object.lookAt(this.target.position)},this.onMouseMove=function(e){this.domElement===document?(this.mouseX=e.pageX-this.viewHalfX,this.mouseY=e.pageY-this.viewHalfY):(this.mouseX=e.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=e.pageY-this.domElement.offsetTop-this.viewHalfY)},this.init=function(){this.spline=new THREE.Spline,this.spline.initFromArray(this.waypoints),this.useConstantSpeed&&this.spline.reparametrizeByArcLength(this.resamplingCoef);if(this.createDebugDummy){var e=new THREE.MeshLambertMaterial({color:30719}),t=new THREE.MeshLambertMaterial({color:65280}),n=new THREE.CubeGeometry(10,10,20),r=new THREE.CubeGeometry(2,2,10);this.animationParent=new THREE.Mesh(n,e);var i=new THREE.Mesh(r,t);i.position.set(0,10,0),this.animation=a(this.animationParent,this.spline,this.id,this.duration),this.animationParent.add(this.object),this.animationParent.add(this.target),this.animationParent.add(i)}else this.animation=a(this.animationParent,this.spline,this.id,this.duration),this.animationParent.add(this.target),this.animationParent.add(this.object);this.createDebugPath&&l(this.debugPath,this.spline),this.domElement.addEventListener("mousemove",u(this,this.onMouseMove),!1)},this.handleResize()},THREE.PathControlsIdCounter=0,THREE.FlyControls=function(e,t){function n(e,t){return function(){t.apply(e,arguments)}}this.object=e,this.domElement=t!==undefined?t:document,t&&this.domElement.setAttribute("tabindex",-1),this.movementSpeed=1,this.rollSpeed=.005,this.dragToLook=!1,this.autoForward=!1,this.object.useQuaternion=!0,this.tmpQuaternion=new THREE.Quaternion,this.mouseStatus=0,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.moveVector=new THREE.Vector3(0,0,0),this.rotationVector=new THREE.Vector3(0,0,0),this.handleEvent=function(e){typeof this[e.type]=="function"&&this[e.type](e)},this.keydown=function(e){if(e.altKey)return;switch(e.keyCode){case 16:this.movementSpeedMultiplier=.1;break;case 87:this.moveState.forward=1;break;case 83:this.moveState.back=1;break;case 65:this.moveState.left=1;break;case 68:this.moveState.right=1;break;case 82:this.moveState.up=1;break;case 70:this.moveState.down=1;break;case 38:this.moveState.pitchUp=1;break;case 40:this.moveState.pitchDown=1;break;case 37:this.moveState.yawLeft=1;break;case 39:this.moveState.yawRight=1;break;case 81:this.moveState.rollLeft=1;break;case 69:this.moveState.rollRight=1}this.updateMovementVector(),this.updateRotationVector()},this.keyup=function(e){switch(e.keyCode){case 16:this.movementSpeedMultiplier=1;break;case 87:this.moveState.forward=0;break;case 83:this.moveState.back=0;break;case 65:this.moveState.left=0;break;case 68:this.moveState.right=0;break;case 82:this.moveState.up=0;break;case 70:this.moveState.down=0;break;case 38:this.moveState.pitchUp=0;break;case 40:this.moveState.pitchDown=0;break;case 37:this.moveState.yawLeft=0;break;case 39:this.moveState.yawRight=0;break;case 81:this.moveState.rollLeft=0;break;case 69:this.moveState.rollRight=0}this.updateMovementVector(),this.updateRotationVector()},this.mousedown=function(e){this.domElement!==document&&this.domElement.focus(),e.preventDefault(),e.stopPropagation();if(this.dragToLook)this.mouseStatus++;else switch(e.button){case 0:this.object.moveForward=!0;break;case 2:this.object.moveBackward=!0}},this.mousemove=function(e){if(!this.dragToLook||this.mouseStatus>0){var t=this.getContainerDimensions(),n=t.size[0]/2,r=t.size[1]/2;this.moveState.yawLeft=-(e.pageX-t.offset[0]-n)/n,this.moveState.pitchDown=(e.pageY-t.offset[1]-r)/r,this.updateRotationVector()}},this.mouseup=function(e){e.preventDefault(),e.stopPropagation();if(this.dragToLook)this.mouseStatus--,this.moveState.yawLeft=this.moveState.pitchDown=0;else switch(e.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1}this.updateRotationVector()},this.update=function(e){var t=e*this.movementSpeed,n=e*this.rollSpeed;this.object.translateX(this.moveVector.x*t),this.object.translateY(this.moveVector.y*t),this.object.translateZ(this.moveVector.z*t),this.tmpQuaternion.set(this.rotationVector.x*n,this.rotationVector.y*n,this.rotationVector.z*n,1).normalize(),this.object.quaternion.multiplySelf(this.tmpQuaternion),this.object.matrix.setPosition(this.object.position),this.object.matrix.setRotationFromQuaternion(this.object.quaternion),this.object.matrixWorldNeedsUpdate=!0},this.updateMovementVector=function(){var e=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-e+this.moveState.back},this.updateRotationVector=function(){this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft},this.getContainerDimensions=function(){return this.domElement!=document?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}},this.domElement.addEventListener("mousemove",n(this,this.mousemove),!1),this.domElement.addEventListener("mousedown",n(this,this.mousedown),!1),this.domElement.addEventListener("mouseup",n(this,this.mouseup),!1),this.domElement.addEventListener("keydown",n(this,this.keydown),!1),this.domElement.addEventListener("keyup",n(this,this.keyup),!1),this.updateMovementVector(),this.updateRotationVector()},THREE.RollControls=function(e,t){function v(e){switch(e.keyCode){case 38:case 87:a=1;break;case 37:case 65:f=-1;break;case 40:case 83:a=-1;break;case 39:case 68:f=1;break;case 81:o=!0,u=1;break;case 69:o=!0,u=-1;break;case 82:l=1;break;case 70:l=-1}}function m(e){switch(e.keyCode){case 38:case 87:a=0;break;case 37:case 65:f=0;break;case 40:case 83:a=0;break;case 39:case 68:f=0;break;case 81:o=!1;break;case 69:o=!1;break;case 82:l=0;break;case 70:l=0}}function g(e){c=(e.clientX-p)/window.innerWidth,h=(e.clientY-d)/window.innerHeight}function y(e){e.preventDefault(),e.stopPropagation();switch(e.button){case 0:a=1;break;case 2:a=-1}}function b(e){e.preventDefault(),e.stopPropagation();switch(e.button){case 0:a=0;break;case 2:a=0}}this.object=e,this.domElement=t!==undefined?t:document,this.mouseLook=!0,this.autoForward=!1,this.lookSpeed=1,this.movementSpeed=1,this.rollSpeed=1,this.constrainVertical=[-0.9,.9],this.object.matrixAutoUpdate=!1,this.forward=new THREE.Vector3(0,0,1),this.roll=0;var n=new THREE.Vector3,r=new THREE.Vector3,i=new THREE.Vector3,s=new THREE.Matrix4,o=!1,u=1,a=0,f=0,l=0,c=0,h=0,p=0,d=0;this.handleResize=function(){p=window.innerWidth/2,d=window.innerHeight/2},this.update=function(e){if(this.mouseLook){var t=e*this.lookSpeed;this.rotateHorizontally(t*c),this.rotateVertically(t*h)}var p=e*this.movementSpeed,d=a>0||this.autoForward&&!(a<0)?1:a;this.object.translateZ(-p*d),this.object.translateX(p*f),this.object.translateY(p*l),o&&(this.roll+=this.rollSpeed*e*u),this.forward.y>this.constrainVertical[1]?(this.forward.y=this.constrainVertical[1],this.forward.normalize()):this.forward.y<this.constrainVertical[0]&&(this.forward.y=this.constrainVertical[0],this.forward.normalize()),i.copy(this.forward),r.set(0,1,0),n.cross(r,i).normalize(),r.cross(i,n).normalize(),this.object.matrix.elements[0]=n.x,this.object.matrix.elements[4]=r.x,this.object.matrix.elements[8]=i.x,this.object.matrix.elements[1]=n.y,this.object.matrix.elements[5]=r.y,this.object.matrix.elements[9]=i.y,this.object.matrix.elements[2]=n.z,this.object.matrix.elements[6]=r.z,this.object.matrix.elements[10]=i.z,s.identity(),s.elements[0]=Math.cos(this.roll),s.elements[4]=-Math.sin(this.roll),s.elements[1]=Math.sin(this.roll),s.elements[5]=Math.cos(this.roll),this.object.matrix.multiplySelf(s),this.object.matrixWorldNeedsUpdate=!0,this.object.matrix.elements[12]=this.object.position.x,this.object.matrix.elements[13]=this.object.position.y,this.object.matrix.elements[14]=this.object.position.z},this.translateX=function(e){this.object.position.x+=this.object.matrix.elements[0]*e,this.object.position.y+=this.object.matrix.elements[1]*e,this.object.position.z+=this.object.matrix.elements[2]*e},this.translateY=function(e){this.object.position.x+=this.object.matrix.elements[4]*e,this.object.position.y+=this.object.matrix.elements[5]*e,this.object.position.z+=this.object.matrix.elements[6]*e},this.translateZ=function(e){this.object.position.x-=this.object.matrix.elements[8]*e,this.object.position.y-=this.object.matrix.elements[9]*e,this.object.position.z-=this.object.matrix.elements[10]*e},this.rotateHorizontally=function(e){n.set(this.object.matrix.elements[0],this.object.matrix.elements[1],this.object.matrix.elements[2]),n.multiplyScalar(e),this.forward.subSelf(n),this.forward.normalize()},this.rotateVertically=function(e){r.set(this.object.matrix.elements[4],this.object.matrix.elements[5],this.object.matrix.elements[6]),r.multiplyScalar(e),this.forward.addSelf(r),this.forward.normalize()},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousemove",g,!1),this.domElement.addEventListener("mousedown",y,!1),this.domElement.addEventListener("mouseup",b,!1),this.domElement.addEventListener("keydown",v,!1),this.domElement.addEventListener("keyup",m,!1),this.handleResize()},THREE.TrackballControls=function(e,t){function v(e){if(!n.enabled)return;if(o!==r.NONE)return;e.keyCode===n.keys[r.ROTATE]&&!n.noRotate?o=r.ROTATE:e.keyCode===n.keys[r.ZOOM]&&!n.noZoom?o=r.ZOOM:e.keyCode===n.keys[r.PAN]&&!n.noPan&&(o=r.PAN),o!==r.NONE&&(s=!0)}function m(e){if(!n.enabled)return;o!==r.NONE&&(o=r.NONE)}function g(e){if(!n.enabled)return;e.preventDefault(),e.stopPropagation(),o===r.NONE&&(o=e.button,o===r.ROTATE&&!n.noRotate?a=f=n.getMouseProjectionOnBall(e.clientX,e.clientY):o===r.ZOOM&&!n.noZoom?l=c=n.getMouseOnScreen(e.clientX,e.clientY):this.noPan||(h=p=n.getMouseOnScreen(e.clientX,e.clientY)))}function y(e){if(!n.enabled)return;s&&(a=f=n.getMouseProjectionOnBall(e.clientX,e.clientY),l=c=n.getMouseOnScreen(e.clientX,e.clientY),h=p=n.getMouseOnScreen(e.clientX,e.clientY),s=!1);if(o===r.NONE)return;o===r.ROTATE&&!n.noRotate?f=n.getMouseProjectionOnBall(e.clientX,e.clientY):o===r.ZOOM&&!n.noZoom?c=n.getMouseOnScreen(e.clientX,e.clientY):o===r.PAN&&!n.noPan&&(p=n.getMouseOnScreen(e.clientX,e.clientY))}function b(e){if(!n.enabled)return;e.preventDefault(),e.stopPropagation(),o=r.NONE}THREE.EventTarget.call(this);var n=this,r={NONE:-1,ROTATE:0,ZOOM:1,PAN:2};this.object=e,this.domElement=t!==undefined?t:document,this.enabled=!0,this.screen={width:0,height:0,offsetLeft:0,offsetTop:0},this.radius=(this.screen.width+this.screen.height)/4,this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=Infinity,this.keys=[65,83,68],this.target=new THREE.Vector3;var i=new THREE.Vector3,s=!1,o=r.NONE,u=new THREE.Vector3,a=new THREE.Vector3,f=new THREE.Vector3,l=new THREE.Vector2,c=new THREE.Vector2,h=new THREE.Vector2,p=new THREE.Vector2,d={type:"change"};this.handleResize=function(){this.screen.width=window.innerWidth,this.screen.height=window.innerHeight,this.screen.offsetLeft=0,this.screen.offsetTop=0,this.radius=(this.screen.width+this.screen.height)/4},this.handleEvent=function(e){typeof this[e.type]=="function"&&this[e.type](e)},this.getMouseOnScreen=function(e,t){return new THREE.Vector2((e-n.screen.offsetLeft)/n.radius*.5,(t-n.screen.offsetTop)/n.radius*.5)},this.getMouseProjectionOnBall=function(e,t){var r=new THREE.Vector3((e-n.screen.width*.5-n.screen.offsetLeft)/n.radius,(n.screen.height*.5+n.screen.offsetTop-t)/n.radius,0),i=r.length();i>1?r.normalize():r.z=Math.sqrt(1-i*i),u.copy(n.object.position).subSelf(n.target);var s=n.object.up.clone().setLength(r.y);return s.addSelf(n.object.up.clone().crossSelf(u).setLength(r.x)),s.addSelf(u.setLength(r.z)),s},this.rotateCamera=function(){var e=Math.acos(a.dot(f)/a.length()/f.length());if(e){var t=(new THREE.Vector3).cross(a,f).normalize(),r=new THREE.Quaternion;e*=n.rotateSpeed,r.setFromAxisAngle(t,-e),r.multiplyVector3(u),r.multiplyVector3(n.object.up),r.multiplyVector3(f),n.staticMoving?a=f:(r.setFromAxisAngle(t,e*(n.dynamicDampingFactor-1)),r.multiplyVector3(a))}},this.zoomCamera=function(){var e=1+(c.y-l.y)*n.zoomSpeed;e!==1&&e>0&&(u.multiplyScalar(e),n.staticMoving?l=c:l.y+=(c.y-l.y)*this.dynamicDampingFactor)},this.panCamera=function(){var e=p.clone().subSelf(h);if(e.lengthSq()){e.multiplyScalar(u.length()*n.panSpeed);var t=u.clone().crossSelf(n.object.up).setLength(e.x);t.addSelf(n.object.up.clone().setLength(e.y)),n.object.position.addSelf(t),n.target.addSelf(t),n.staticMoving?h=p:h.addSelf(e.sub(p,h).multiplyScalar(n.dynamicDampingFactor))}},this.checkDistances=function(){if(!n.noZoom||!n.noPan)n.object.position.lengthSq()>n.maxDistance*n.maxDistance&&n.object.position.setLength(n.maxDistance),u.lengthSq()<n.minDistance*n.minDistance&&n.object.position.add(n.target,u.setLength(n.minDistance))},this.update=function(){u.copy(n.object.position).subSelf(n.target),n.noRotate||n.rotateCamera(),n.noZoom||n.zoomCamera(),n.noPan||n.panCamera(),n.object.position.add(n.target,u),n.checkDistances(),n.object.lookAt(n.target),i.distanceToSquared(n.object.position)>0&&(n.dispatchEvent(d),i.copy(n.object.position))},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousemove",y,!1),this.domElement.addEventListener("mousedown",g,!1),this.domElement.addEventListener("mouseup",b,!1),window.addEventListener("keydown",v,!1),window.addEventListener("keyup",m,!1),this.handleResize()},THREE.OrbitControls=function(e,t){function y(){return 2*Math.PI/60/60*n.autoRotateSpeed}function b(){return Math.pow(.95,n.userZoomSpeed)}function w(e){if(!n.userRotate)return;e.preventDefault(),e.button===0||e.button===2?(m=v.ROTATE,s.set(e.clientX,e.clientY)):e.button===1&&(m=v.ZOOM,a.set(e.clientX,e.clientY)),document.addEventListener("mousemove",E,!1),document.addEventListener("mouseup",S,!1)}function E(e){e.preventDefault(),m===v.ROTATE?(o.set(e.clientX,e.clientY),u.sub(o,s),n.rotateLeft(2*Math.PI*u.x/i*n.userRotateSpeed),n.rotateUp(2*Math.PI*u.y/i*n.userRotateSpeed),s.copy(o)):m===v.ZOOM&&(f.set(e.clientX,e.clientY),l.sub(f,a),l.y>0?n.zoomIn():n.zoomOut(),a.copy(f))}function S(e){if(!n.userRotate)return;document.removeEventListener("mousemove",E,!1),document.removeEventListener("mouseup",S,!1),m=v.NONE}function x(e){if(!n.userZoom)return;e.wheelDelta>0?n.zoomOut():n.zoomIn()}THREE.EventTarget.call(this),this.object=e,this.domElement=t!==undefined?t:document,this.center=new THREE.Vector3,this.userZoom=!0,this.userZoomSpeed=1,this.userRotate=!0,this.userRotateSpeed=1,this.autoRotate=!1,this.autoRotateSpeed=2;var n=this,r=1e-6,i=1800,s=new THREE.Vector2,o=new THREE.Vector2,u=new THREE.Vector2,a=new THREE.Vector2,f=new THREE.Vector2,l=new THREE.Vector2,c=0,h=0,p=1,d=new THREE.Vector3,v={NONE:-1,ROTATE:0,ZOOM:1},m=v.NONE,g={type:"change"};this.rotateLeft=function(e){e===undefined&&(e=y()),h-=e},this.rotateRight=function(e){e===undefined&&(e=y()),h+=e},this.rotateUp=function(e){e===undefined&&(e=y()),c-=e},this.rotateDown=function(e){e===undefined&&(e=y()),c+=e},this.zoomIn=function(e){e===undefined&&(e=b()),p/=e},this.zoomOut=function(e){e===undefined&&(e=b()),p*=e},this.update=function(){var e=this.object.position,t=e.clone().subSelf(this.center),n=Math.atan2(t.x,t.z),i=Math.atan2(Math.sqrt(t.x*t.x+t.z*t.z),t.y);this.autoRotate&&this.rotateLeft(y()),n+=h,i+=c,i=Math.max(r,Math.min(Math.PI-r,i));var s=t.length();t.x=s*Math.sin(i)*Math.sin(n),t.y=s*Math.cos(i),t.z=s*Math.sin(i)*Math.cos(n),t.multiplyScalar(p),e.copy(this.center).addSelf(t),this.object.lookAt(this.center),h=0,c=0,p=1,d.distanceTo(this.object.position)>0&&(this.dispatchEvent(g),d.copy(this.object.position))},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",w,!1),this.domElement.addEventListener("mousewheel",x,!1)},THREE.CircleGeometry=function(e,t,n,r){THREE.Geometry.call(this),e=e||50,n=n!==undefined?n:0,r=r!==undefined?r:Math.PI*2,t=t!==undefined?Math.max(3,t):8;var i,s=[],o=new THREE.Vector3,u=new THREE.UV(.5,.5);this.vertices.push(o),s.push(u);for(i=0;i<=t;i++){var a=new THREE.Vector3;a.x=e*Math.cos(n+i/t*r),a.y=e*Math.sin(n+i/t*r),this.vertices.push(a),s.push(new THREE.UV((a.x/e+1)/2,-(a.y/e+1)/2+1))}var f=new THREE.Vector3(0,0,-1);for(i=1;i<=t;i++){var l=i,c=i+1,h=0;this.faces.push(new THREE.Face3(l,c,h,[f,f,f])),this.faceVertexUvs[0].push([s[i],s[i+1],u])}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere={radius:e}},THREE.CircleGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.CubeGeometry=function(e,t,n,r,i,s,o,u){function w(e,t,n,o,u,f,l,c){var h,p,d,v=r||1,m=i||1,g=u/2,y=f/2,b=a.vertices.length;if(e==="x"&&t==="y"||e==="y"&&t==="x")h="z";else if(e==="x"&&t==="z"||e==="z"&&t==="x")h="y",m=s||1;else if(e==="z"&&t==="y"||e==="y"&&t==="z")h="x",v=s||1;var w=v+1,E=m+1,S=u/v,x=f/m,T=new THREE.Vector3;T[h]=l>0?1:-1;for(d=0;d<E;d++)for(p=0;p<w;p++){var N=new THREE.Vector3;N[e]=(p*S-g)*n,N[t]=(d*x-y)*o,N[h]=l,a.vertices.push(N)}for(d=0;d<m;d++)for(p=0;p<v;p++){var C=p+w*d,k=p+w*(d+1),L=p+1+w*(d+1),A=p+1+w*d,O=new THREE.Face4(C+b,k+b,L+b,A+b);O.normal.copy(T),O.vertexNormals.push(T.clone(),T.clone(),T.clone(),T.clone()),O.materialIndex=c,a.faces.push(O),a.faceVertexUvs[0].push([new THREE.UV(p/v,1-d/m),new THREE.UV(p/v,1-(d+1)/m),new THREE.UV((p+1)/v,1-(d+1)/m),new THREE.UV((p+1)/v,1-d/m)])}}THREE.Geometry.call(this);var a=this,f=e/2,l=t/2,c=n/2,h,p,d,v,m,g;if(o!==undefined){if(o instanceof Array)this.materials=o;else{this.materials=[];for(var y=0;y<6;y++)this.materials.push(o)}h=0,v=1,p=2,m=3,d=4,g=5}else this.materials=[];this.sides={px:!0,nx:!0,py:!0,ny:!0,pz:!0,nz:!0};if(u!=undefined)for(var b in u)this.sides[b]!==undefined&&(this.sides[b]=u[b]);this.sides.px&&w("z","y",-1,-1,n,t,f,h),this.sides.nx&&w("z","y",1,-1,n,t,-f,v),this.sides.py&&w("x","z",1,1,e,n,l,p),this.sides.ny&&w("x","z",1,-1,e,n,-l,m),this.sides.pz&&w("x","y",1,-1,e,t,c,d),this.sides.nz&&w("x","y",-1,-1,e,t,-c,g),this.computeCentroids(),this.mergeVertices()},THREE.CubeGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.CylinderGeometry=function(e,t,n,r,i,s){THREE.Geometry.call(this),e=e!==undefined?e:20,t=t!==undefined?t:20,n=n!==undefined?n:100;var o=n/2,u=r||8,a=i||1,f,l,c=[],h=[];for(l=0;l<=a;l++){var p=[],d=[],v=l/a,m=v*(t-e)+e;for(f=0;f<=u;f++){var g=f/u,y=new THREE.Vector3;y.x=m*Math.sin(g*Math.PI*2),y.y=-v*n+o,y.z=m*Math.cos(g*Math.PI*2),this.vertices.push(y),p.push(this.vertices.length-1),d.push(new THREE.UV(g,1-v))}c.push(p),h.push(d)}var b=(t-e)/n,w,E;for(f=0;f<u;f++){e!==0?(w=this.vertices[c[0][f]].clone(),E=this.vertices[c[0][f+1]].clone()):(w=this.vertices[c[1][f]].clone(),E=this.vertices[c[1][f+1]].clone()),w.setY(Math.sqrt(w.x*w.x+w.z*w.z)*b).normalize(),E.setY(Math.sqrt(E.x*E.x+E.z*E.z)*b).normalize();for(l=0;l<a;l++){var S=c[l][f],x=c[l+1][f],T=c[l+1][f+1],N=c[l][f+1],C=w.clone(),k=w.clone(),L=E.clone(),A=E.clone(),O=h[l][f].clone(),M=h[l+1][f].clone(),_=h[l+1][f+1].clone(),D=h[l][f+1].clone();this.faces.push(new THREE.Face4(S,x,T,N,[C,k,L,A])),this.faceVertexUvs[0].push([O,M,_,D])}}if(!s&&e>0){this.vertices.push(new THREE.Vector3(0,o,0));for(f=0;f<u;f++){var S=c[0][f],x=c[0][f+1],T=this.vertices.length-1,C=new THREE.Vector3(0,1,0),k=new THREE.Vector3(0,1,0),L=new THREE.Vector3(0,1,0),O=h[0][f].clone(),M=h[0][f+1].clone(),_=new THREE.UV(M.u,0);this.faces.push(new THREE.Face3(S,x,T,[C,k,L])),this.faceVertexUvs[0].push([O,M,_])}}if(!s&&t>0){this.vertices.push(new THREE.Vector3(0,-o,0));for(f=0;f<u;f++){var S=c[l][f+1],x=c[l][f],T=this.vertices.length-1,C=new THREE.Vector3(0,-1,0),k=new THREE.Vector3(0,-1,0),L=new THREE.Vector3(0,-1,0),O=h[l][f+1].clone(),M=h[l][f].clone(),_=new THREE.UV(M.u,1);this.faces.push(new THREE.Face3(S,x,T,[C,k,L])),this.faceVertexUvs[0].push([O,M,_])}}this.computeCentroids(),this.computeFaceNormals()},THREE.CylinderGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.ExtrudeGeometry=function(e,t){if(typeof e=="undefined"){e=[];return}THREE.Geometry.call(this),e=e instanceof Array?e:[e],this.shapebb=e[e.length-1].getBoundingBox(),this.addShapeList(e,t),this.computeCentroids(),this.computeFaceNormals()},THREE.ExtrudeGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.ExtrudeGeometry.prototype.addShapeList=function(e,t){var n=e.length;for(var r=0;r<n;r++){var i=e[r];this.addShape(i,t)}},THREE.ExtrudeGeometry.prototype.addShape=function(e,t){function D(e,t,n){return t||console.log("die"),t.clone().multiplyScalar(n).addSelf(e)}function X(e,t,n){return $(e,t,n)}function V(e,t,n){var r=Math.atan2(t.y-e.y,t.x-e.x),i=Math.atan2(n.y-e.y,n.x-e.x);r>i&&(i+=Math.PI*2);var s=(r+i)/2,o=-Math.cos(s),u=-Math.sin(s),a=new THREE.Vector2(o,u);return a}function $(e,t,n){var r=THREE.ExtrudeGeometry.__v1,i=THREE.ExtrudeGeometry.__v2,s=THREE.ExtrudeGeometry.__v3,o=THREE.ExtrudeGeometry.__v4,u=THREE.ExtrudeGeometry.__v5,a=THREE.ExtrudeGeometry.__v6,f,l,c,h,p,d;return r.set(e.x-t.x,e.y-t.y),i.set(e.x-n.x,e.y-n.y),f=r.normalize(),l=i.normalize(),s.set(-f.y,f.x),o.set(l.y,-l.x),u.copy(e).addSelf(s),a.copy(e).addSelf(o),u.equals(a)?o.clone():(u.copy(t).addSelf(s),a.copy(n).addSelf(o),c=f.dot(o),h=a.subSelf(u).dot(o),c===0&&(console.log("Either infinite or no solutions!"),h===0?console.log("Its finite solutions."):console.log("Too bad, no solutions.")),p=h/c,p<0?V(e,t,n):(d=f.multiplyScalar(p).addSelf(u),d.subSelf(e).clone()))}function ot(){if(o){var e=0,t=I*e;for(K=0;K<R;K++)q=M[K],lt(q[2]+t,q[1]+t,q[0]+t,!0);e=a+s*2,t=I*e;for(K=0;K<R;K++)q=M[K],lt(q[0]+t,q[1]+t,q[2]+t,!1)}else{for(K=0;K<R;K++)q=M[K],lt(q[2],q[1],q[0],!0);for(K=0;K<R;K++)q=M[K],lt(q[0]+I*a,q[1]+I*a,q[2]+I*a,!1)}}function ut(){var e=0;at(_,e),e+=_.length;for(S=0,x=A.length;S<x;S++)E=A[S],at(E,e),e+=E.length}function at(e,t){var n,r;K=e.length;while(--K>=0){n=K,r=K-1,r<0&&(r=e.length-1);var i=0,o=a+s*2;for(i=0;i<o;i++){var u=I*i,f=I*(i+1),l=t+n+u,c=t+r+u,h=t+r+f,p=t+n+f;ct(l,c,h,p,e,i,o,n,r)}}}function ft(e,t,n){T.vertices.push(new THREE.Vector3(e,t,n))}function lt(n,r,i,s){n+=C,r+=C,i+=C,T.faces.push(new THREE.Face3(n,r,i,null,null,p));var o=s?v.generateBottomUV(T,e,t,n,r,i):v.generateTopUV(T,e,t,n,r,i);T.faceVertexUvs[0].push(o)}function ct(n,r,i,s,o,u,a,f,l){n+=C,r+=C,i+=C,s+=C,T.faces.push(new THREE.Face4(n,r,i,s,null,null,d));var c=v.generateSideWallUV(T,e,o,t,n,r,i,s,u,a,f,l);T.faceVertexUvs[0].push(c)}var n=t.amount!==undefined?t.amount:100,r=t.bevelThickness!==undefined?t.bevelThickness:6,i=t.bevelSize!==undefined?t.bevelSize:r-2,s=t.bevelSegments!==undefined?t.bevelSegments:3,o=t.bevelEnabled!==undefined?t.bevelEnabled:!0,u=t.curveSegments!==undefined?t.curveSegments:12,a=t.steps!==undefined?t.steps:1,f=t.bendPath,l=t.extrudePath,c,h=!1,p=t.material,d=t.extrudeMaterial,v=t.UVGenerator!==undefined?t.UVGenerator:THREE.ExtrudeGeometry.WorldUVGenerator,m=this.shapebb,g,y,b,w;l&&(c=l.getSpacedPoints(a),h=!0,o=!1,g=t.frames!==undefined?t.frames:new THREE.TubeGeometry.FrenetFrames(l,a,!1),y=new THREE.Vector3,b=new THREE.Vector3,w=new THREE.Vector3),o||(s=0,r=0,i=0);var E,S,x,T=this,N=[],C=this.vertices.length;f&&e.addWrapPath(f);var k=e.extractPoints(),L=k.shape,A=k.holes,O=!THREE.Shape.Utils.isClockWise(L);if(O){L=L.reverse();for(S=0,x=A.length;S<x;S++)E=A[S],THREE.Shape.Utils.isClockWise(E)&&(A[S]=E.reverse());O=!1}var M=THREE.Shape.Utils.triangulateShape(L,A),_=L;for(S=0,x=A.length;S<x;S++)E=A[S],L=L.concat(E);var P,H,B,j,F,I=L.length,q,R=M.length,U,z=_.length,W=180/Math.PI,J=[];for(var K=0,Q=_.length,G=Q-1,Y=K+1;K<Q;K++,G++,Y++){G===Q&&(G=0),Y===Q&&(Y=0);var Z=_[K],et=_[G],tt=_[Y];J[K]=X(_[K],_[G],_[Y])}var nt=[],rt,it=J.concat();for(S=0,x=A.length;S<x;S++){E=A[S],rt=[];for(K=0,Q=E.length,G=Q-1,Y=K+1;K<Q;K++,G++,Y++)G===Q&&(G=0),Y===Q&&(Y=0),rt[K]=X(E[K],E[G],E[Y]);nt.push(rt),it=it.concat(rt)}for(P=0;P<s;P++){B=P/s,j=r*(1-B),H=i*Math.sin(B*Math.PI/2);for(K=0,Q=_.length;K<Q;K++)F=D(_[K],J[K],H),ft(F.x,F.y,-j);for(S=0,x=A.length;S<x;S++){E=A[S],rt=nt[S];for(K=0,Q=E.length;K<Q;K++)F=D(E[K],rt[K],H),ft(F.x,F.y,-j)}}H=i;for(K=0;K<I;K++)F=o?D(L[K],it[K],H):L[K],h?(b.copy(g.normals[0]).multiplyScalar(F.x),y.copy(g.binormals[0]).multiplyScalar(F.y),w.copy(c[0]).addSelf(b).addSelf(y),ft(w.x,w.y,w.z)):ft(F.x,F.y,0);var st;for(st=1;st<=a;st++)for(K=0;K<I;K++)F=o?D(L[K],it[K],H):L[K],h?(b.copy(g.normals[st]).multiplyScalar(F.x),y.copy(g.binormals[st]).multiplyScalar(F.y),w.copy(c[st]).addSelf(b).addSelf(y),ft(w.x,w.y,w.z)):ft(F.x,F.y,n/a*st);for(P=s-1;P>=0;P--){B=P/s,j=r*(1-B),H=i*Math.sin(B*Math.PI/2);for(K=0,Q=_.length;K<Q;K++)F=D(_[K],J[K],H),ft(F.x,F.y,n+j);for(S=0,x=A.length;S<x;S++){E=A[S],rt=nt[S];for(K=0,Q=E.length;K<Q;K++)F=D(E[K],rt[K],H),h?ft(F.x,F.y+c[a-1].y,c[a-1].x+j):ft(F.x,F.y,n+j)}}ot(),ut()},THREE.ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(e,t,n,r,i,s){var o=e.vertices[r].x,u=e.vertices[r].y,a=e.vertices[i].x,f=e.vertices[i].y,l=e.vertices[s].x,c=e.vertices[s].y;return[new THREE.UV(o,u),new THREE.UV(a,f),new THREE.UV(l,c)]},generateBottomUV:function(e,t,n,r,i,s){return this.generateTopUV(e,t,n,r,i,s)},generateSideWallUV:function(e,t,n,r,i,s,o,u,a,f,l,c){var h=e.vertices[i].x,p=e.vertices[i].y,d=e.vertices[i].z,v=e.vertices[s].x,m=e.vertices[s].y,g=e.vertices[s].z,y=e.vertices[o].x,b=e.vertices[o].y,w=e.vertices[o].z,E=e.vertices[u].x,S=e.vertices[u].y,x=e.vertices[u].z;return Math.abs(p-m)<.01?[new THREE.UV(h,1-d),new THREE.UV(v,1-g),new THREE.UV(y,1-w),new THREE.UV(E,1-x)]:[new THREE.UV(p,1-d),new THREE.UV(m,1-g),new THREE.UV(b,1-w),new THREE.UV(S,1-x)]}},THREE.ExtrudeGeometry.__v1=new THREE.Vector2,THREE.ExtrudeGeometry.__v2=new THREE.Vector2,THREE.ExtrudeGeometry.__v3=new THREE.Vector2,THREE.ExtrudeGeometry.__v4=new THREE.Vector2,THREE.ExtrudeGeometry.__v5=new THREE.Vector2,THREE.ExtrudeGeometry.__v6=new THREE.Vector2,THREE.LatheGeometry=function(e,t,n){THREE.Geometry.call(this);var r=t||12,i=n||2*Math.PI,s=[],o=(new THREE.Matrix4).makeRotationZ(i/r);for(var u=0;u<e.length;u++)s[u]=e[u].clone(),this.vertices.push(s[u]);var a,f=r+1;for(a=0;a<f;a++)for(var u=0;u<s.length;u++)s[u]=o.multiplyVector3(s[u].clone()),this.vertices.push(s[u]);for(a=0;a<r;a++)for(var l=0,c=e.length;l<c-1;l++){var h=a*c+l,p=(a+1)%f*c+l,d=(a+1)%f*c+(l+1)%c,v=a*c+(l+1)%c;this.faces.push(new THREE.Face4(h,p,d,v)),this.faceVertexUvs[0].push([new THREE.UV(1-a/r,l/c),new THREE.UV(1-(a+1)/r,l/c),new THREE.UV(1-(a+1)/r,(l+1)/c),new THREE.UV(1-a/r,(l+1)/c)])}this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},THREE.LatheGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.PlaneGeometry=function(e,t,n,r){THREE.Geometry.call(this);var i,s,o=e/2,u=t/2,a=n||1,f=r||1,l=a+1,c=f+1,h=e/a,p=t/f,d=new THREE.Vector3(0,0,1);for(s=0;s<c;s++)for(i=0;i<l;i++){var v=i*h-o,m=s*p-u;this.vertices.push(new THREE.Vector3(v,-m,0))}for(s=0;s<f;s++)for(i=0;i<a;i++){var g=i+l*s,y=i+l*(s+1),b=i+1+l*(s+1),w=i+1+l*s,E=new THREE.Face4(g,y,b,w);E.normal.copy(d),E.vertexNormals.push(d.clone(),d.clone(),d.clone(),d.clone()),this.faces.push(E),this.faceVertexUvs[0].push([new THREE.UV(i/a,1-s/f),new THREE.UV(i/a,1-(s+1)/f),new THREE.UV((i+1)/a,1-(s+1)/f),new THREE.UV((i+1)/a,1-s/f)])}this.computeCentroids()},THREE.PlaneGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.SphereGeometry=function(e,t,n,r,i,s,o){THREE.Geometry.call(this),e=e||50,r=r!==undefined?r:0,i=i!==undefined?i:Math.PI*2,s=s!==undefined?s:0,o=o!==undefined?o:Math.PI;var u=Math.max(3,Math.floor(t)||8),a=Math.max(2,Math.floor(n)||6),f,l,c=[],h=[];for(l=0;l<=a;l++){var p=[],d=[];for(f=0;f<=u;f++){var v=f/u,m=l/a,g=new THREE.Vector3;g.x=-e*Math.cos(r+v*i)*Math.sin(s+m*o),g.y=e*Math.cos(s+m*o),g.z=e*Math.sin(r+v*i)*Math.sin(s+m*o),this.vertices.push(g),p.push(this.vertices.length-1),d.push(new THREE.UV(v,1-m))}c.push(p),h.push(d)}for(l=0;l<a;l++)for(f=0;f<u;f++){var y=c[l][f+1],b=c[l][f],w=c[l+1][f],E=c[l+1][f+1],S=this.vertices[y].clone().normalize(),x=this.vertices[b].clone().normalize(),T=this.vertices[w].clone().normalize(),N=this.vertices[E].clone().normalize(),C=h[l][f+1].clone(),k=h[l][f].clone(),L=h[l+1][f].clone(),A=h[l+1][f+1].clone();Math.abs(this.vertices[y].y)==e?(this.faces.push(new THREE.Face3(y,w,E,[S,T,N])),this.faceVertexUvs[0].push([C,L,A])):Math.abs(this.vertices[w].y)==e?(this.faces.push(new THREE.Face3(y,b,w,[S,x,T])),this.faceVertexUvs[0].push([C,k,L])):(this.faces.push(new THREE.Face4(y,b,w,E,[S,x,T,N])),this.faceVertexUvs[0].push([C,k,L,A]))}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere={radius:e}},THREE.SphereGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TextGeometry=function(e,t){var n=THREE.FontUtils.generateShapes(e,t);t.amount=t.height!==undefined?t.height:50,t.bevelThickness===undefined&&(t.bevelThickness=10),t.bevelSize===undefined&&(t.bevelSize=8),t.bevelEnabled===undefined&&(t.bevelEnabled=!1);if(t.bend){var r=n[n.length-1].getBoundingBox(),i=r.maxX;t.bendPath=new THREE.QuadraticBezierCurve(new THREE.Vector2(0,0),new THREE.Vector2(i/2,120),new THREE.Vector2(i,0))}THREE.ExtrudeGeometry.call(this,n,t)},THREE.TextGeometry.prototype=Object.create(THREE.ExtrudeGeometry.prototype),THREE.TorusGeometry=function(e,t,n,r,i){THREE.Geometry.call(this);var s=this;this.radius=e||100,this.tube=t||40,this.segmentsR=n||8,this.segmentsT=r||6,this.arc=i||Math.PI*2;var o=new THREE.Vector3,u=[],a=[];for(var f=0;f<=this.segmentsR;f++)for(var l=0;l<=this.segmentsT;l++){var c=l/this.segmentsT*this.arc,h=f/this.segmentsR*Math.PI*2;o.x=this.radius*Math.cos(c),o.y=this.radius*Math.sin(c);var p=new THREE.Vector3;p.x=(this.radius+this.tube*Math.cos(h))*Math.cos(c),p.y=(this.radius+this.tube*Math.cos(h))*Math.sin(c),p.z=this.tube*Math.sin(h),this.vertices.push(p),u.push(new THREE.UV(l/this.segmentsT,f/this.segmentsR)),a.push(p.clone().subSelf(o).normalize())}for(var f=1;f<=this.segmentsR;f++)for(var l=1;l<=this.segmentsT;l++){var d=(this.segmentsT+1)*f+l-1,v=(this.segmentsT+1)*(f-1)+l-1,m=(this.segmentsT+1)*(f-1)+l,g=(this.segmentsT+1)*f+l,y=new THREE.Face4(d,v,m,g,[a[d],a[v],a[m],a[g]]);y.normal.addSelf(a[d]),y.normal.addSelf(a[v]),y.normal.addSelf(a[m]),y.normal.addSelf(a[g]),y.normal.normalize(),this.faces.push(y),this.faceVertexUvs[0].push([u[d].clone(),u[v].clone(),u[m].clone(),u[g].clone()])}this.computeCentroids()},THREE.TorusGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TorusKnotGeometry=function(e,t,n,r,i,s,o){function A(e,t,n){return u.vertices.push(new THREE.Vector3(e,t,n))-1}function O(e,t,n,r,i,s){var o=Math.cos(e),u=Math.cos(t),a=Math.sin(e),f=n/r*e,l=Math.cos(f),c=i*(2+l)*.5*o,h=i*(2+l)*a*.5,p=s*i*Math.sin(f)*.5;return new THREE.Vector3(c,h,p)}THREE.Geometry.call(this);var u=this;this.radius=e||200,this.tube=t||40,this.segmentsR=n||64,this.segmentsT=r||8,this.p=i||2,this.q=s||3,this.heightScale=o||1,this.grid=new Array(this.segmentsR);var a=new THREE.Vector3,f=new THREE.Vector3,l=new THREE.Vector3;for(var c=0;c<this.segmentsR;++c){this.grid[c]=new Array(this.segmentsT);for(var h=0;h<this.segmentsT;++h){var p=c/this.segmentsR*2*this.p*Math.PI,d=h/this.segmentsT*2*Math.PI,v=O(p,d,this.q,this.p,this.radius,this.heightScale),m=O(p+.01,d,this.q,this.p,this.radius,this.heightScale),g,y;a.sub(m,v),f.add(m,v),l.cross(a,f),f.cross(l,a),l.normalize(),f.normalize(),g=-this.tube*Math.cos(d),y=this.tube*Math.sin(d),v.x+=g*f.x+y*l.x,v.y+=g*f.y+y*l.y,v.z+=g*f.z+y*l.z,this.grid[c][h]=A(v.x,v.y,v.z)}}for(var c=0;c<this.segmentsR;++c)for(var h=0;h<this.segmentsT;++h){var b=(c+1)%this.segmentsR,w=(h+1)%this.segmentsT,E=this.grid[c][h],S=this.grid[b][h],x=this.grid[b][w],T=this.grid[c][w],N=new THREE.UV(c/this.segmentsR,h/this.segmentsT),C=new THREE.UV((c+1)/this.segmentsR,h/this.segmentsT),k=new THREE.UV((c+1)/this.segmentsR,(h+1)/this.segmentsT),L=new THREE.UV(c/this.segmentsR,(h+1)/this.segmentsT);this.faces.push(new THREE.Face4(E,S,x,T)),this.faceVertexUvs[0].push([N,C,k,L])}this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},THREE.TorusKnotGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TubeGeometry=function(e,t,n,r,i,s){function I(e,t,n){return o.vertices.push(new THREE.Vector3(e,t,n))-1}THREE.Geometry.call(this),this.path=e,this.segments=t||64,this.radius=n||1,this.segmentsRadius=r||8,this.closed=i||!1,s&&(this.debug=new THREE.Object3D),this.grid=[];var o=this,u,a,f,l=this.segments+1,c,h,p,d,v,m,g,y,b,w,E,S=new THREE.Vector3,x,T,N,C,k,L,A,O,M,_,D,P,H=new THREE.TubeGeometry.FrenetFrames(e,t,i),B=H.tangents,j=H.normals,F=H.binormals;this.tangents=B,this.normals=j,this.binormals=F;for(x=0;x<l;x++){this.grid[x]=[],g=x/(l-1),E=e.getPointAt(g),u=B[x],a=j[x],f=F[x],this.debug&&(this.debug.add(new THREE.ArrowHelper(u,E,n,255)),this.debug.add(new THREE.ArrowHelper(a,E,n,16711680)),this.debug.add(new THREE.ArrowHelper(f,E,n,65280)));for(T=0;T<this.segmentsRadius;T++)y=T/this.segmentsRadius*2*Math.PI,b=-this.radius*Math.cos(y),w=this.radius*Math.sin(y),S.copy(E),S.x+=b*a.x+w*f.x,S.y+=b*a.y+w*f.y,S.z+=b*a.z+w*f.z,this.grid[x][T]=I(S.x,S.y,S.z)}for(x=0;x<this.segments;x++)for(T=0;T<this.segmentsRadius;T++)N=i?(x+1)%this.segments:x+1,C=(T+1)%this.segmentsRadius,k=this.grid[x][T],L=this.grid[N][T],A=this.grid[N][C],O=this.grid[x][C],M=new THREE.UV(x/this.segments,T/this.segmentsRadius),_=new THREE.UV((x+1)/this.segments,T/this.segmentsRadius),D=new THREE.UV((x+1)/this.segments,(T+1)/this.segmentsRadius),P=new THREE.UV(x/this.segments,(T+1)/this.segmentsRadius),this.faces.push(new THREE.Face4(k,L,A,O)),this.faceVertexUvs[0].push([M,_,D,P]);this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},THREE.TubeGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TubeGeometry.FrenetFrames=function(e,t,n){function E(e){u[0]=new THREE.Vector3,a[0]=new THREE.Vector3,e===undefined&&(e=new THREE.Vector3(0,0,1)),u[0].cross(e,o[0]).normalize(),a[0].cross(o[0],u[0]).normalize()}function S(){var t=e.getTangentAt(p);u[0]=(new THREE.Vector3).sub(t,o[0]).normalize(),a[0]=(new THREE.Vector3).cross(o[0],u[0]),u[0].cross(a[0],o[0]).normalize(),a[0].cross(o[0],u[0]).normalize()}function x(){u[0]=new THREE.Vector3,a[0]=new THREE.Vector3,d=Number.MAX_VALUE,v=Math.abs(o[0].x),m=Math.abs(o[0].y),g=Math.abs(o[0].z),v<=d&&(d=v,i.set(1,0,0)),m<=d&&(d=m,i.set(0,1,0)),g<=d&&i.set(0,0,1),f.cross(o[0],i).normalize(),u[0].cross(o[0],f),a[0].cross(o[0],u[0])}var r=new THREE.Vector3,i=new THREE.Vector3,s=new THREE.Vector3,o=[],u=[],a=[],f=new THREE.Vector3,l=new THREE.Matrix4,c=t+1,h,p=1e-4,d,v,m,g,y,b,w;this.tangents=o,this.normals=u,this.binormals=a;for(y=0;y<c;y++)b=y/(c-1),o[y]=e.getTangentAt(b),o[y].normalize();x();for(y=1;y<c;y++)u[y]=u[y-1].clone(),a[y]=a[y-1].clone(),f.cross(o[y-1],o[y]),f.length()>p&&(f.normalize(),h=Math.acos(o[y-1].dot(o[y])),l.makeRotationAxis(f,h).multiplyVector3(u[y])),a[y].cross(o[y],u[y]);if(n){h=Math.acos(u[0].dot(u[c-1])),h/=c-1,o[0].dot(f.cross(u[0],u[c-1]))>0&&(h=-h);for(y=1;y<c;y++)l.makeRotationAxis(o[y],h*y).multiplyVector3(u[y]),a[y].cross(o[y],u[y])}},THREE.PolyhedronGeometry=function(e,t,n,r){function f(e){var t=e.normalize().clone();t.index=i.vertices.push(t)-1;var n=h(e)/2/Math.PI+.5,r=p(e)/Math.PI+.5;return t.uv=new THREE.UV(n,1-r),t}function l(e,t,n,r){if(r<1){var s=new THREE.Face3(e.index,t.index,n.index,[e.clone(),t.clone(),n.clone()]);s.centroid.addSelf(e).addSelf(t).addSelf(n).divideScalar(3),s.normal=s.centroid.clone().normalize(),i.faces.push(s);var o=h(s.centroid);i.faceVertexUvs[0].push([d(e.uv,e,o),d(t.uv,t,o),d(n.uv,n,o)])}else r-=1,l(e,c(e,t),c(e,n),r),l(c(e,t),t,c(t,n),r),l(c(e,n),c(t,n),n,r),l(c(e,t),c(t,n),c(e,n),r)}function c(e,t){u[e.index]||(u[e.index]=[]),u[t.index]||(u[t.index]=[]);var n=u[e.index][t.index];return n===undefined&&(u[e.index][t.index]=u[t.index][e.index]=n=f((new THREE.Vector3).add(e,t).divideScalar(2))),n}function h(e){return Math.atan2(e.z,-e.x)}function p(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}function d(e,t,n){return n<0&&e.u===1&&(e=new THREE.UV(e.u-1,e.v)),t.x===0&&t.z===0&&(e=new THREE.UV(n/2/Math.PI+.5,e.v)),e}THREE.Geometry.call(this),n=n||1,r=r||0;var i=this;for(var s=0,o=e.length;s<o;s++)f(new THREE.Vector3(e[s][0],e[s][1],e[s][2]));var u=[],a=this.vertices;for(var s=0,o=t.length;s<o;s++)l(a[t[s][0]],a[t[s][1]],a[t[s][2]],r);this.mergeVertices();for(var s=0,o=this.vertices.length;s<o;s++)this.vertices[s].multiplyScalar(n);this.computeCentroids(),this.boundingSphere={radius:n}},THREE.PolyhedronGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.IcosahedronGeometry=function(e,t){var n=(1+Math.sqrt(5))/2,r=[[-1,n,0],[1,n,0],[-1,-n,0],[1,-n,0],[0,-1,n],[0,1,n],[0,-1,-n],[0,1,-n],[n,0,-1],[n,0,1],[-n,0,-1],[-n,0,1]],i=[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]];THREE.PolyhedronGeometry.call(this,r,i,e,t)},THREE.IcosahedronGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.OctahedronGeometry=function(e,t){var n=[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],r=[[0,2,4],[0,4,3],[0,3,5],[0,5,2],[1,2,5],[1,5,3],[1,3,4],[1,4,2]];THREE.PolyhedronGeometry.call(this,n,r,e,t)},THREE.OctahedronGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TetrahedronGeometry=function(e,t){var n=[[1,1,1],[-1,-1,1],[-1,1,-1],[1,-1,-1]],r=[[2,1,0],[0,3,2],[1,3,0],[2,3,1]];THREE.PolyhedronGeometry.call(this,n,r,e,t)},THREE.TetrahedronGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.ParametricGeometry=function(e,t,n,r){THREE.Geometry.call(this);var i=this.vertices,s=this.faces,o=this.faceVertexUvs[0];r=r===undefined?!1:r;var u,a,f,l,c,h,p=n+1,d=t+1;for(u=0;u<=n;u++){h=u/n;for(f=0;f<=t;f++)c=f/t,l=e(c,h),i.push(l)}var v,m,g,y,b,w,E,S;for(u=0;u<n;u++)for(f=0;f<t;f++)v=u*d+f,m=u*d+f+1,g=(u+1)*d+f,y=(u+1)*d+f+1,b=new THREE.UV(f/t,u/n),w=new THREE.UV((f+1)/t,u/n),E=new THREE.UV(f/t,(u+1)/n),S=new THREE.UV((f+1)/t,(u+1)/n),r?(s.push(new THREE.Face3(v,m,g)),s.push(new THREE.Face3(m,y,g)),o.push([b,w,E]),o.push([w,S,E])):(s.push(new THREE.Face4(v,m,y,g)),o.push([b,w,S,E]));this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},THREE.ParametricGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.ConvexGeometry=function(e){function r(n){var r=e[n].clone(),s=r.length();r.x+=s*u(),r.y+=s*u(),r.z+=s*u();var a=[];for(var f=0;f<t.length;){var l=t[f];if(i(l,r)){for(var c=0;c<3;c++){var h=[l[c],l[(c+1)%3]],p=!0;for(var d=0;d<a.length;d++)if(o(a[d],h)){a[d]=a[a.length-1],a.pop(),p=!1;break}p&&a.push(h)}t[f]=t[t.length-1],t.pop()}else f++}for(var d=0;d<a.length;d++)t.push([a[d][0],a[d][1],n])}function i(t,n){var r=e[t[0]],i=e[t[1]],o=e[t[2]],u=s(r,i,o),a=u.dot(r);return u.dot(n)>=a}function s(e,t,n){var r=new THREE.Vector3,i=new THREE.Vector3;return r.sub(n,t),i.sub(e,t),r.crossSelf(i),r.isZero()||r.normalize(),r}function o(e,t){return e[0]===t[1]&&e[1]===t[0]}function u(){return(Math.random()-.5)*2*1e-6}function a(e){var t=e.length();return new THREE.UV(e.x/t,e.y/t)}THREE.Geometry.call(this);var t=[[0,1,2],[0,2,1]];for(var n=3;n<e.length;n++)r(n);var f=0,l=new Array(e.length);for(var n=0;n<t.length;n++){var c=t[n];for(var h=0;h<3;h++)l[c[h]]===undefined&&(l[c[h]]=f++,this.vertices.push(e[c[h]])),c[h]=l[c[h]]}for(var n=0;n<t.length;n++)this.faces.push(new THREE.Face3(t[n][0],t[n][1],t[n][2]));for(var n=0;n<this.faces.length;n++){var c=this.faces[n];this.faceVertexUvs[0].push([a(this.vertices[c.a]),a(this.vertices[c.b]),a(this.vertices[c.c])])}this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},THREE.ConvexGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.AxisHelper=function(){THREE.Object3D.call(this);var e=new THREE.Geometry;e.vertices.push(new THREE.Vector3),e.vertices.push(new THREE.Vector3(0,100,0));var t=new THREE.CylinderGeometry(0,5,25,5,1),n,r;n=new THREE.Line(e,new THREE.LineBasicMaterial({color:16711680})),n.rotation.z=-Math.PI/2,this.add(n),r=new THREE.Mesh(t,new THREE.MeshBasicMaterial({color:16711680})),r.position.x=100,r.rotation.z=-Math.PI/2,this.add(r),n=new THREE.Line(e,new THREE.LineBasicMaterial({color:65280})),this.add(n),r=new THREE.Mesh(t,new THREE.MeshBasicMaterial({color:65280})),r.position.y=100,this.add(r),n=new THREE.Line(e,new THREE.LineBasicMaterial({color:255})),n.rotation.x=Math.PI/2,this.add(n),r=new THREE.Mesh(t,new THREE.MeshBasicMaterial({color:255})),r.position.z=100,r.rotation.x=Math.PI/2,this.add(r)},THREE.AxisHelper.prototype=Object.create(THREE.Object3D.prototype),THREE.ArrowHelper=function(e,t,n,r){THREE.Object3D.call(this),r===undefined&&(r=16776960),n===undefined&&(n=20);var i=new THREE.Geometry;i.vertices.push(new THREE.Vector3(0,0,0)),i.vertices.push(new THREE.Vector3(0,1,0)),this.line=new THREE.Line(i,new THREE.LineBasicMaterial({color:r})),this.add(this.line);var s=new THREE.CylinderGeometry(0,.05,.25,5,1);this.cone=new THREE.Mesh(s,new THREE.MeshBasicMaterial({color:r})),this.cone.position.set(0,1,0),this.add(this.cone),t instanceof THREE.Vector3&&(this.position=t),this.setDirection(e),this.setLength(n)},THREE.ArrowHelper.prototype=Object.create(THREE.Object3D.prototype),THREE.ArrowHelper.prototype.setDirection=function(e){var t=(new THREE.Vector3(0,1,0)).crossSelf(e),n=Math.acos((new THREE.Vector3(0,1,0)).dot(e.clone().normalize()));this.matrix=(new THREE.Matrix4).makeRotationAxis(t.normalize(),n),this.rotation.setEulerFromRotationMatrix(this.matrix,this.eulerOrder)},THREE.ArrowHelper.prototype.setLength=function(e){this.scale.set(e,e,e)},THREE.ArrowHelper.prototype.setColor=function(e){this.line.material.color.setHex(e),this.cone.material.color.setHex(e)},THREE.CameraHelper=function(e){function u(e,t,n){a(e,n),a(t,n)}function a(e,n){t.lineGeometry.vertices.push(new THREE.Vector3),t.lineGeometry.colors.push(new THREE.Color(n)),t.pointMap[e]===undefined&&(t.pointMap[e]=[]),t.pointMap[e].push(t.lineGeometry.vertices.length-1)}THREE.Object3D.call(this);var t=this;this.lineGeometry=new THREE.Geometry,this.lineMaterial=new THREE.LineBasicMaterial({color:16777215,vertexColors:THREE.FaceColors}),this.pointMap={};var n=16755200,r=16711680,i=43775,s=16777215,o=3355443;u("n1","n2",n),u("n2","n4",n),u("n4","n3",n),u("n3","n1",n),u("f1","f2",n),u("f2","f4",n),u("f4","f3",n),u("f3","f1",n),u("n1","f1",n),u("n2","f2",n),u("n3","f3",n),u("n4","f4",n),u("p","n1",r),u("p","n2",r),u("p","n3",r),u("p","n4",r),u("u1","u2",i),u("u2","u3",i),u("u3","u1",i),u("c","t",s),u("p","c",o),u("cn1","cn2",o),u("cn3","cn4",o),u("cf1","cf2",o),u("cf3","cf4",o),this.camera=e,this.update(e),this.lines=new THREE.Line(this.lineGeometry,this.lineMaterial,THREE.LinePieces),this.add(this.lines)},THREE.CameraHelper.prototype=Object.create(THREE.Object3D.prototype),THREE.CameraHelper.prototype.update=function(){function i(e,t,n,i){THREE.CameraHelper.__v.set(t,n,i),THREE.CameraHelper.__projector.unprojectVector(THREE.CameraHelper.__v,THREE.CameraHelper.__c);var s=r.pointMap[e];if(s!==undefined)for(var o=0,u=s.length;o<u;o++){var a=s[o];r.lineGeometry.vertices[a].copy(THREE.CameraHelper.__v)}}var e=this.camera,t=1,n=1,r=this;THREE.CameraHelper.__c.projectionMatrix.copy(e.projectionMatrix),i("c",0,0,-1),i("t",0,0,1),i("n1",-t,-n,-1),i("n2",t,-n,-1),i("n3",-t,n,-1),i("n4",t,n,-1),i("f1",-t,-n,1),i("f2",t,-n,1),i("f3",-t,n,1),i("f4",t,n,1),i("u1",t*.7,n*1.1,-1),i("u2",-t*.7,n*1.1,-1),i("u3",0,n*2,-1),i("cf1",-t,0,1),i("cf2",t,0,1),i("cf3",0,-n,1),i("cf4",0,n,1),i("cn1",-t,0,-1),i("cn2",t,0,-1),i("cn3",0,-n,-1),i("cn4",0,n,-1),this.lineGeometry.verticesNeedUpdate=!0},THREE.CameraHelper.__projector=new THREE.Projector,THREE.CameraHelper.__v=new THREE.Vector3,THREE.CameraHelper.__c=new THREE.Camera,THREE.SubdivisionModifier=function(e){this.subdivisions=e===undefined?1:e,this.useOldVertexColors=!1,this.supportUVs=!0,this.debug=!1},THREE.SubdivisionModifier.prototype.modify=function(e){var t=this.subdivisions;while(t-->0)this.smooth(e)},THREE.SubdivisionModifier.prototype.smooth=function(e){function i(e,n,r){t.push(new THREE.Vector3(e,n,r))}function o(){s.debug&&console.log.apply(console,arguments)}function u(){console&&console.log.apply(console,arguments)}function a(e,t,i,u,a,f,l){var c=new THREE.Face4(e,t,i,u,null,a.color,a.materialIndex);if(s.useOldVertexColors){c.vertexColors=[];var h,p,d;for(var v=0;v<4;v++){d=f[v],h=new THREE.Color,h.setRGB(0,0,0);for(var m=0,g=0;m<d.length;m++)p=a.vertexColors[d[m]-1],h.r+=p.r,h.g+=p.g,h.b+=p.b;h.r/=d.length,h.g/=d.length,h.b/=d.length,c.vertexColors[v]=h}}n.push(c);if(s.supportUVs){var y=[E(e,""),E(t,l),E(i,l),E(u,l)];y[0]?y[1]?y[2]?y[3]?r.push(y):o("d :( ",u+":"+l):o("c :( ",i+":"+l):o("b :( ",t+":"+l):o("a :( ",e+":"+l)}}function f(e,t){return Math.min(e,t)+"_"+Math.max(e,t)}function l(e){function d(e,t){p[e]===undefined&&(p[e]=[]),p[e].push(t)}var t,n,r,i,s,o,u,a,l,c,h,p={};for(t=0,n=e.faces.length;t<n;t++)u=e.faces[t],u instanceof THREE.Face3?(h=f(u.a,u.b),d(h,t),h=f(u.b,u.c),d(h,t),h=f(u.c,u.a),d(h,t)):u instanceof THREE.Face4&&(h=f(u.a,u.b),d(h,t),h=f(u.b,u.c),d(h,t),h=f(u.c,u.d),d(h,t),h=f(u.d,u.a),d(h,t));return p}function E(e,t){var n,r,i=e+":"+t,s=b[i];return s?s:(e>=w&&e<w+h.length?o("face pt"):o("edge pt"),u("warning, UV not found for",i),null)}function S(e,t,n){var r=e+":"+t;r in b?u("dup vertexNo",e,"oldFaceNo",t,"value",n,"key",r,b[r]):b[r]=n}function X(e,t){z[e]===undefined&&(z[e]=[]),z[e].push(t)}function V(e,t,n){W[e]===undefined&&(W[e]={}),W[e][t]=n}var t=[],n=[],r=[],s=this,c=e.vertices,h=e.faces,p=c.concat(),d=[],v={},m={},g=[],y=[],b={},w=c.length,x,T,N,C,k,L=e.faceVertexUvs[0],A="abcd",O;o("originalFaces, uvs, originalVerticesLength",h.length,L.length,w);if(s.supportUVs)for(x=0,T=L.length;x<T;x++)for(N=0,C=L[x].length;N<C;N++)O=h[x][A.charAt(N)],S(O,x,L[x][N]);L.length==0&&(s.supportUVs=!1);var M=0;for(var _ in b)M++;M||(s.supportUVs=!1,o("no uvs")),o("-- Original Faces + Vertices UVs completed",b,"vs",L.length);var D;for(x=0,T=h.length;x<T;x++){k=h[x],d.push(k.centroid),p.push(k.centroid);if(!s.supportUVs)continue;D=new THREE.UV,k instanceof THREE.Face3?(D.u=E(k.a,x).u+E(k.b,x).u+E(k.c,x).u,D.v=E(k.a,x).v+E(k.b,x).v+E(k.c,x).v,D.u/=3,D.v/=3):k instanceof THREE.Face4&&(D.u=E(k.a,x).u+E(k.b,x).u+E(k.c,x).u+E(k.d,x).u,D.v=E(k.a,x).v+E(k.b,x).v+E(k.c,x).v+E(k.d,x).v,D.u/=4,D.v/=4),S(w+x,"",D)}o("-- added UVs for new Faces",b);var P=l(e),H,B,j,F,I=0,q,R,U,z={},W={};for(x in P){H=P[x],q=x.split("_"),R=q[0],U=q[1],X(R,[R,U]),X(U,[R,U]);for(N=0,C=H.length;N<C;N++)k=H[N],V(R,k,x),V(U,k,x);H.length<2&&(m[x]=!0,g[R]=!0,g[U]=!0)}o("vertexEdgeMap",z,"vertexFaceMap",W);for(x in P){H=P[x],B=H[0],j=H[1],q=x.split("_"),R=q[0],U=q[1],F=new THREE.Vector3,m[x]?(F.addSelf(c[R]),F.addSelf(c[U]),F.multiplyScalar(.5),g[p.length]=!0):(F.addSelf(d[B]),F.addSelf(d[j]),F.addSelf(c[R]),F.addSelf(c[U]),F.multiplyScalar(.25)),v[x]=w+h.length+I,p.push(F),I++;if(!s.supportUVs)continue;D=new THREE.UV,D.u=E(R,B).u+E(U,B).u,D.v=E(R,B).v+E(U,B).v,D.u/=2,D.v/=2,S(v[x],B,D),m[x]||(D=new THREE.UV,D.u=E(R,j).u+E(U,j).u,D.v=E(R,j).v+E(U,j).v,D.u/=2,D.v/=2,S(v[x],j,D))}o("-- Step 2 done");var $,J,K,Q,G,Y,Z,et=["123","12","2","23"],tt=["123","23","3","31"],nt=["123","31","1","12"],rt=["1234","12","2","23"],it=["1234","23","3","34"],st=["1234","34","4","41"],ot=["1234","41","1","12"];for(x=0,T=d.length;x<T;x++)$=d[x],k=h[x],J=w+x,k instanceof THREE.Face3?(K=f(k.a,k.b),Q=f(k.b,k.c),Z=f(k.c,k.a),a(J,v[K],k.b,v[Q],k,et,x),a(J,v[Q],k.c,v[Z],k,tt,x),a(J,v[Z],k.a,v[K],k,nt,x)):k instanceof THREE.Face4?(K=f(k.a,k.b),Q=f(k.b,k.c),G=f(k.c,k.d),Y=f(k.d,k.a),a(J,v[K],k.b,v[Q],k,rt,x),a(J,v[Q],k.c,v[G],k,it,x),a(J,v[G],k.d,v[Y],k,st,x),a(J,v[Y],k.a,v[K],k,ot,x)):o("face should be a face!",k);t=p;var ut=new THREE.Vector3,at=new THREE.Vector3,ft;for(x=0,T=c.length;x<T;x++){if(z[x]===undefined)continue;ut.set(0,0,0),at.set(0,0,0);var lt=new THREE.Vector3(0,0,0),ct=0;for(N in W[x])ut.addSelf(d[N]),ct++;var ht=0;ft=z[x].length;for(N=0;N<ft;N++)m[f(z[x][N][0],z[x][N][1])]&&ht++;if(ht==2)continue;ut.divideScalar(ct);for(N=0;N<ft;N++){H=z[x][N];var pt=c[H[0]].clone().addSelf(c[H[1]]).divideScalar(2);at.addSelf(pt)}at.divideScalar(ft),lt.addSelf(c[x]),lt.multiplyScalar(ft-3),lt.addSelf(ut),lt.addSelf(at.multiplyScalar(2)),lt.divideScalar(ft),t[x]=lt}var dt=e;dt.vertices=t,dt.faces=n,dt.faceVertexUvs[0]=r,delete dt.__tmpVertices,dt.computeCentroids(),dt.computeFaceNormals(),dt.computeVertexNormals()},THREE.ImmediateRenderObject=function(){THREE.Object3D.call(this),this.render=function(e){}},THREE.ImmediateRenderObject.prototype=Object.create(THREE.Object3D.prototype),THREE.LensFlare=function(e,t,n,r,i){THREE.Object3D.call(this),this.lensFlares=[],this.positionScreen=new THREE.Vector3,this.customUpdateCallback=undefined,e!==undefined&&this.add(e,t,n,r,i)},THREE.LensFlare.prototype=Object.create(THREE.Object3D.prototype),THREE.LensFlare.prototype.add=function(e,t,n,r,i,s){t===undefined&&(t=-1),n===undefined&&(n=0),s===undefined&&(s=1),i===undefined&&(i=new THREE.Color(16777215)),r===undefined&&(r=THREE.NormalBlending),n=Math.min(n,Math.max(0,n)),this.lensFlares.push({texture:e,size:t,distance:n,x:0,y:0,z:0,scale:1,rotation:1,opacity:s,color:i,blending:r})},THREE.LensFlare.prototype.updateLensFlares=function(){var e,t=this.lensFlares.length,n,r=-this.positionScreen.x*2,i=-this.positionScreen.y*2;for(e=0;e<t;e++)n=this.lensFlares[e],n.x=this.positionScreen.x+r*n.distance,n.y=this.positionScreen.y+i*n.distance,n.wantedRotation=n.x*Math.PI*.25,n.rotation+=(n.wantedRotation-n.rotation)*.25},THREE.MorphBlendMesh=function(e,t){THREE.Mesh.call(this,e,t),this.animationsMap={},this.animationsList=[];var n=this.geometry.morphTargets.length,r="__default",i=0,s=n-1,o=n/1;this.createAnimation(r,i,s,o),this.setAnimationWeight(r,1)},THREE.MorphBlendMesh.prototype=Object.create(THREE.Mesh.prototype),THREE.MorphBlendMesh.prototype.createAnimation=function(e,t,n,r){var i={startFrame:t,endFrame:n,length:n-t+1,fps:r,duration:(n-t)/r,lastFrame:0,currentFrame:0,active:!1,time:0,direction:1,weight:1,directionBackwards:!1,mirroredLoop:!1};this.animationsMap[e]=i,this.animationsList.push(i)},THREE.MorphBlendMesh.prototype.autoCreateAnimations=function(e){var t=/([a-z]+)(\d+)/,n,r={},i=this.geometry;for(var s=0,o=i.morphTargets.length;s<o;s++){var u=i.morphTargets[s],a=u.name.match(t);if(a&&a.length>1){var f=a[1],l=a[2];r[f]||(r[f]={start:Infinity,end:-Infinity});var c=r[f];s<c.start&&(c.start=s),s>c.end&&(c.end=s),n||(n=f)}}for(var f in r){var c=r[f];this.createAnimation(f,c.start,c.end,e)}this.firstAnimation=n},THREE.MorphBlendMesh.prototype.setAnimationDirectionForward=function(e){var t=this.animationsMap[e];t&&(t.direction=1,t.directionBackwards=!1)},THREE.MorphBlendMesh.prototype.setAnimationDirectionBackward=function(e){var t=this.animationsMap[e];t&&(t.direction=-1,t.directionBackwards=!0)},THREE.MorphBlendMesh.prototype.setAnimationFPS=function(e,t){var n=this.animationsMap[e];n&&(n.fps=t,n.duration=(n.end-n.start)/n.fps)},THREE.MorphBlendMesh.prototype.setAnimationDuration=function(e,t){var n=this.animationsMap[e];n&&(n.duration=t,n.fps=(n.end-n.start)/n.duration)},THREE.MorphBlendMesh.prototype.setAnimationWeight=function(e,t){var n=this.animationsMap[e];n&&(n.weight=t)},THREE.MorphBlendMesh.prototype.setAnimationTime=function(e,t){var n=this.animationsMap[e];n&&(n.time=t)},THREE.MorphBlendMesh.prototype.getAnimationTime=function(e){var t=0,n=this.animationsMap[e];return n&&(t=n.time),t},THREE.MorphBlendMesh.prototype.getAnimationDuration=function(e){var t=-1,n=this.animationsMap[e];return n&&(t=n.duration),t},THREE.MorphBlendMesh.prototype.playAnimation=function(e){var t=this.animationsMap[e];t?(t.time=0,t.active=!0):console.warn("animation["+e+"] undefined")},THREE.MorphBlendMesh.prototype.stopAnimation=function(e){var t=this.animationsMap[e];t&&(t.active=!1)},THREE.MorphBlendMesh.prototype.update=function(e){for(var t=0,n=this.animationsList.length;t<n;t++){var r=this.animationsList[t];if(!r.active)continue;var i=r.duration/r.length;r.time+=r.direction*e;if(r.mirroredLoop){if(r.time>r.duration||r.time<0)r.direction*=-1,r.time>r.duration&&(r.time=r.duration,r.directionBackwards=!0),r.time<0&&(r.time=0,r.directionBackwards=!1)}else r.time=r.time%r.duration,r.time<0&&(r.time+=r.duration);var s=r.startFrame+THREE.Math.clamp(Math.floor(r.time/i),0,r.length-1),o=r.weight;s!==r.currentFrame&&(this.morphTargetInfluences[r.lastFrame]=0,this.morphTargetInfluences[r.currentFrame]=1*o,this.morphTargetInfluences[s]=0,r.lastFrame=r.currentFrame,r.currentFrame=s);var u=r.time%i/i;r.directionBackwards&&(u=1-u),this.morphTargetInfluences[r.currentFrame]=u*o,this.morphTargetInfluences[r.lastFrame]=(1-u)*o}},THREE.LensFlarePlugin=function(){function r(t){var n=e.createProgram(),r=e.createShader(e.FRAGMENT_SHADER),i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(r,t.fragmentShader),e.shaderSource(i,t.vertexShader),e.compileShader(r),e.compileShader(i),e.attachShader(n,r),e.attachShader(n,i),e.linkProgram(n),n}var e,t,n={};this.init=function(i){e=i.context,t=i,n.vertices=new Float32Array(16),n.faces=new Uint16Array(6);var s=0;n.vertices[s++]=-1,n.vertices[s++]=-1,n.vertices[s++]=0,n.vertices[s++]=0,n.vertices[s++]=1,n.vertices[s++]=-1,n.vertices[s++]=1,n.vertices[s++]=0,n.vertices[s++]=1,n.vertices[s++]=1,n.vertices[s++]=1,n.vertices[s++]=1,n.vertices[s++]=-1,n.vertices[s++]=1,n.vertices[s++]=0,n.vertices[s++]=1,s=0,n.faces[s++]=0,n.faces[s++]=1,n.faces[s++]=2,n.faces[s++]=0,n.faces[s++]=2,n.faces[s++]=3,n.vertexBuffer=e.createBuffer(),n.elementBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,n.vertices,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.elementBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,n.faces,e.STATIC_DRAW),n.tempTexture=e.createTexture(),n.occlusionTexture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,n.tempTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGB,16,16,0,e.RGB,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.bindTexture(e.TEXTURE_2D,n.occlusionTexture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,16,16,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS)<=0?(n.hasVertexTexture=!1,n.program=r(THREE.ShaderFlares.lensFlare)):(n.hasVertexTexture=!0,n.program=r(THREE.ShaderFlares.lensFlareVertexTexture)),n.attributes={},n.uniforms={},n.attributes.vertex=e.getAttribLocation(n.program,"position"),n.attributes.uv=e.getAttribLocation(n.program,"uv"),n.uniforms.renderType=e.getUniformLocation(n.program,"renderType"),n.uniforms.map=e.getUniformLocation(n.program,"map"),n.uniforms.occlusionMap=e.getUniformLocation(n.program,"occlusionMap"),n.uniforms.opacity=e.getUniformLocation(n.program,"opacity"),n.uniforms.color=e.getUniformLocation(n.program,"color"),n.uniforms.scale=e.getUniformLocation(n.program,"scale"),n.uniforms.rotation=e.getUniformLocation(n.program,"rotation"),n.uniforms.screenPosition=e.getUniformLocation(n.program,"screenPosition"),n.attributesEnabled=!1},this.render=function(r,i,s,o){var u=r.__webglFlares,a=u.length;if(!a)return;var f=new THREE.Vector3,l=o/s,c=s*.5,h=o*.5,p=16/o,d=new THREE.Vector2(p*l,p),v=new THREE.Vector3(1,1,0),m=new THREE.Vector2(1,1),g=n.uniforms,y=n.attributes;e.useProgram(n.program),n.attributesEnabled||(e.enableVertexAttribArray(n.attributes.vertex),e.enableVertexAttribArray(n.attributes.uv),n.attributesEnabled=!0),e.uniform1i(g.occlusionMap,0),e.uniform1i(g.map,1),e.bindBuffer(e.ARRAY_BUFFER,n.vertexBuffer),e.vertexAttribPointer(y.vertex,2,e.FLOAT,!1,16,0),e.vertexAttribPointer(y.uv,2,e.FLOAT,!1,16,8),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.elementBuffer),e.disable(e.CULL_FACE),e.depthMask(!1);var b,w,E,S,x;for(b=0;b<a;b++){p=16/o,d.set(p*l,p),S=u[b],f.set(S.matrixWorld.elements[12],S.matrixWorld.elements[13],S.matrixWorld.elements[14]),i.matrixWorldInverse.multiplyVector3(f),i.projectionMatrix.multiplyVector3(f),v.copy(f),m.x=v.x*c+c,m.y=v.y*h+h;if(n.hasVertexTexture||m.x>0&&m.x<s&&m.y>0&&m.y<o){e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,n.tempTexture),e.copyTexImage2D(e.TEXTURE_2D,0,e.RGB,m.x-8,m.y-8,16,16,0),e.uniform1i(g.renderType,0),e.uniform2f(g.scale,d.x,d.y),e.uniform3f(g.screenPosition,v.x,v.y,v.z),e.disable(e.BLEND),e.enable(e.DEPTH_TEST),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,n.occlusionTexture),e.copyTexImage2D(e.TEXTURE_2D,0,e.RGBA,m.x-8,m.y-8,16,16,0),e.uniform1i(g.renderType,1),e.disable(e.DEPTH_TEST),e.activeTexture(e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,n.tempTexture),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0),S.positionScreen.copy(v),S.customUpdateCallback?S.customUpdateCallback(S):S.updateLensFlares(),e.uniform1i(g.renderType,2),e.enable(e.BLEND);for(w=0,E=S.lensFlares.length;w<E;w++)x=S.lensFlares[w],x.opacity>.001&&x.scale>.001&&(v.x=x.x,v.y=x.y,v.z=x.z,p=x.size*x.scale/o,d.x=p*l,d.y=p,e.uniform3f(g.screenPosition,v.x,v.y,v.z),e.uniform2f(g.scale,d.x,d.y),e.uniform1f(g.rotation,x.rotation),e.uniform1f(g.opacity,x.opacity),e.uniform3f(g.color,x.color.r,x.color.g,x.color.b),t.setBlending(x.blending,x.blendEquation,x.blendSrc,x.blendDst),t.setTexture(x.texture,1),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0))}}e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.depthMask(!0)}},THREE.ShadowMapPlugin=function(){function f(e,t){var n=new THREE.DirectionalLight;n.isVirtual=!0,n.onlyShadow=!0,n.castShadow=!0,n.shadowCameraNear=e.shadowCameraNear,n.shadowCameraFar=e.shadowCameraFar,n.shadowCameraLeft=e.shadowCameraLeft,n.shadowCameraRight=e.shadowCameraRight,n.shadowCameraBottom=e.shadowCameraBottom,n.shadowCameraTop=e.shadowCameraTop,n.shadowCameraVisible=e.shadowCameraVisible,n.shadowDarkness=e.shadowDarkness,n.shadowBias=e.shadowCascadeBias[t],n.shadowMapWidth=e.shadowCascadeWidth[t],n.shadowMapHeight=e.shadowCascadeHeight[t],n.pointsWorld=[],n.pointsFrustum=[];var r=n.pointsWorld,i=n.pointsFrustum;for(var s=0;s<8;s++)r[s]=new THREE.Vector3,i[s]=new THREE.Vector3;var o=e.shadowCascadeNearZ[t],u=e.shadowCascadeFarZ[t];return i[0].set(-1,-1,o),i[1].set(1,-1,o),i[2].set(-1,1,o),i[3].set(1,1,o),i[4].set(-1,-1,u),i[5].set(1,-1,u),i[6].set(-1,1,u),i[7].set(1,1,u),n}function l(e,t){var n=e.shadowCascadeArray[t];n.position.copy(e.position),n.target.position.copy(e.target.position),n.lookAt(n.target),n.shadowCameraVisible=e.shadowCameraVisible,n.shadowDarkness=e.shadowDarkness,n.shadowBias=e.shadowCascadeBias[t];var r=e.shadowCascadeNearZ[t],i=e.shadowCascadeFarZ[t],s=n.pointsFrustum;s[0].z=r,s[1].z=r,s[2].z=r,s[3].z=r,s[4].z=i,s[5].z=i,s[6].z=i,s[7].z=i}function c(e,t){var n=t.shadowCamera,r=t.pointsFrustum,i=t.pointsWorld;u.set(Infinity,Infinity,Infinity),a.set(-Infinity,-Infinity,-Infinity);for(var s=0;s<8;s++){var o=i[s];o.copy(r[s]),THREE.ShadowMapPlugin.__projector.unprojectVector(o,e),n.matrixWorldInverse.multiplyVector3(o),o.x<u.x&&(u.x=o.x),o.x>a.x&&(a.x=o.x),o.y<u.y&&(u.y=o.y),o.y>a.y&&(a.y=o.y),o.z<u.z&&(u.z=o.z),o.z>a.z&&(a.z=o.z)}n.left=u.x,n.right=a.x,n.top=a.y,n.bottom=u.y,n.updateProjectionMatrix()}var e,t,n,r,i,s=new THREE.Frustum,o=new THREE.Matrix4,u=new THREE.Vector3,a=new THREE.Vector3;this.init=function(s){e=s.context,t=s;var o=THREE.ShaderLib.depthRGBA,u=THREE.UniformsUtils.clone(o.uniforms);n=new THREE.ShaderMaterial({fragmentShader:o.fragmentShader,vertexShader:o.vertexShader,uniforms:u}),r=new THREE.ShaderMaterial({fragmentShader:o.fragmentShader,vertexShader:o.vertexShader,uniforms:u,morphTargets:!0}),i=new THREE.ShaderMaterial({fragmentShader:o.fragmentShader,vertexShader:o.vertexShader,uniforms:u,skinning:!0}),n._shadowPass=!0,r._shadowPass=!0,i._shadowPass=!0},this.render=function(e,n){if(!t.shadowMapEnabled||!t.shadowMapAutoUpdate)return;this.update(e,n)},this.update=function(u,a){var h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k=[],L=0,A=null;e.clearColor(1,1,1,1),e.disable(e.BLEND),e.enable(e.CULL_FACE),t.shadowMapCullFrontFaces?e.cullFace(e.FRONT):e.cullFace(e.BACK),t.setDepthTest(!0);for(h=0,p=u.__lights.length;h<p;h++){N=u.__lights[h];if(!N.castShadow)continue;if(N instanceof THREE.DirectionalLight&&N.shadowCascade)for(m=0;m<N.shadowCascadeCount;m++){var O;if(!N.shadowCascadeArray[m]){O=f(N,m),O.originalCamera=a;var M=new THREE.Gyroscope;M.position=N.shadowCascadeOffset,M.add(O),M.add(O.target),a.add(M),N.shadowCascadeArray[m]=O,console.log("Created virtualLight",O)}else O=N.shadowCascadeArray[m];l(N,m),k[L]=O,L++}else k[L]=N,L++}for(h=0,p=k.length;h<p;h++){N=k[h];if(!N.shadowMap){var _={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat};N.shadowMap=new THREE.WebGLRenderTarget(N.shadowMapWidth,N.shadowMapHeight,_),N.shadowMapSize=new THREE.Vector2(N.shadowMapWidth,N.shadowMapHeight),N.shadowMatrix=new THREE.Matrix4}if(!N.shadowCamera){if(N instanceof THREE.SpotLight)N.shadowCamera=new THREE.PerspectiveCamera(N.shadowCameraFov,N.shadowMapWidth/N.shadowMapHeight,N.shadowCameraNear,N.shadowCameraFar);else{if(!(N instanceof THREE.DirectionalLight)){console.error("Unsupported light type for shadow");continue}N.shadowCamera=new THREE.OrthographicCamera(N.shadowCameraLeft,N.shadowCameraRight,N.shadowCameraTop,N.shadowCameraBottom,N.shadowCameraNear,N.shadowCameraFar)}u.add(N.shadowCamera),t.autoUpdateScene&&u.updateMatrixWorld()}N.shadowCameraVisible&&!N.cameraHelper&&(N.cameraHelper=new THREE.CameraHelper(N.shadowCamera),N.shadowCamera.add(N.cameraHelper)),N.isVirtual&&O.originalCamera==a&&c(a,N),g=N.shadowMap,y=N.shadowMatrix,b=N.shadowCamera,b.position.copy(N.matrixWorld.getPosition()),b.lookAt(N.target.matrixWorld.getPosition()),b.updateMatrixWorld(),b.matrixWorldInverse.getInverse(b.matrixWorld),N.cameraHelper&&(N.cameraHelper.lines.visible=N.shadowCameraVisible),N.shadowCameraVisible&&N.cameraHelper.update(),y.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),y.multiplySelf(b.projectionMatrix),y.multiplySelf(b.matrixWorldInverse),b._viewMatrixArray||(b._viewMatrixArray=new Float32Array(16)),b._projectionMatrixArray||(b._projectionMatrixArray=new Float32Array(16)),b.matrixWorldInverse.flattenToArray(b._viewMatrixArray),b.projectionMatrix.flattenToArray(b._projectionMatrixArray),o.multiply(b.projectionMatrix,b.matrixWorldInverse),s.setFromMatrix(o),t.setRenderTarget(g),t.clear(),C=u.__webglObjects;for(d=0,v=C.length;d<v;d++)x=C[d],T=x.object,x.render=!1,T.visible&&T.castShadow&&(!(T instanceof THREE.Mesh)||!T.frustumCulled||s.contains(T))&&(T._modelViewMatrix.multiply(b.matrixWorldInverse,T.matrixWorld),x.render=!0);for(d=0,v=C.length;d<v;d++)x=C[d],x.render&&(T=x.object,E=x.buffer,T.customDepthMaterial?S=T.customDepthMaterial:T.geometry.morphTargets.length?S=r:T instanceof THREE.SkinnedMesh?S=i:S=n,E instanceof THREE.BufferGeometry?t.renderBufferDirect(b,u.__lights,A,S,E,T):t.renderBuffer(b,u.__lights,A,S,E,T));C=u.__webglObjectsImmediate;for(d=0,v=C.length;d<v;d++)x=C[d],T=x.object,T.visible&&T.castShadow&&(T._modelViewMatrix.multiply(b.matrixWorldInverse,T.matrixWorld),t.renderImmediateObject(b,u.__lights,A,n,T))}var D=t.getClearColor(),P=t.getClearAlpha();e.clearColor(D.r,D.g,D.b,P),e.enable(e.BLEND),t.shadowMapCullFrontFaces&&e.cullFace(e.BACK)}},THREE.ShadowMapPlugin.__projector=new THREE.Projector,THREE.SpritePlugin=function(){function r(t){var n=e.createProgram(),r=e.createShader(e.FRAGMENT_SHADER),i=e.createShader(e.VERTEX_SHADER);return e.shaderSource(r,t.fragmentShader),e.shaderSource(i,t.vertexShader),e.compileShader(r),e.compileShader(i),e.attachShader(n,r),e.attachShader(n,i),e.linkProgram(n),n}function i(e,t){return t.z-e.z}var e,t,n={};this.init=function(i){e=i.context,t=i,n.vertices=new Float32Array(16),n.faces=new Uint16Array(6);var s=0;n.vertices[s++]=-1,n.vertices[s++]=-1,n.vertices[s++]=0,n.vertices[s++]=0,n.vertices[s++]=1,n.vertices[s++]=-1,n.vertices[s++]=1,n.vertices[s++]=0,n.vertices[s++]=1,n.vertices[s++]=1,n.vertices[s++]=1,n.vertices[s++]=1,n.vertices[s++]=-1,n.vertices[s++]=1,n.vertices[s++]=0,n.vertices[s++]=1,s=0,n.faces[s++]=0,n.faces[s++]=1,n.faces[s++]=2,n.faces[s++]=0,n.faces[s++]=2,n.faces[s++]=3,n.vertexBuffer=e.createBuffer(),n.elementBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,n.vertices,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.elementBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,n.faces,e.STATIC_DRAW),n.program=r(THREE.ShaderSprite.sprite),n.attributes={},n.uniforms={},n.attributes.position=e.getAttribLocation(n.program,"position"),n.attributes.uv=e.getAttribLocation(n.program,"uv"),n.uniforms.uvOffset=e.getUniformLocation(n.program,"uvOffset"),n.uniforms.uvScale=e.getUniformLocation(n.program,"uvScale"),n.uniforms.rotation=e.getUniformLocation(n.program,"rotation"),n.uniforms.scale=e.getUniformLocation(n.program,"scale"),n.uniforms.alignment=e.getUniformLocation(n.program,"alignment"),n.uniforms.color=e.getUniformLocation(n.program,"color"),n.uniforms.map=e.getUniformLocation(n.program,"map"),n.uniforms.opacity=e.getUniformLocation(n.program,"opacity"),n.uniforms.useScreenCoordinates=e.getUniformLocation(n.program,"useScreenCoordinates"),n.uniforms.affectedByDistance=e.getUniformLocation(n.program,"affectedByDistance"),n.uniforms.screenPosition=e.getUniformLocation(n.program,"screenPosition"),n.uniforms.modelViewMatrix=e.getUniformLocation(n.program,"modelViewMatrix"),n.uniforms.projectionMatrix=e.getUniformLocation(n.program,"projectionMatrix"),n.attributesEnabled=!1},this.render=function(r,s,o,u){var a=r.__webglSprites,f=a.length;if(!f)return;var l=n.attributes,c=n.uniforms,h=u/o,p=o*.5,d=u*.5,v=!0;e.useProgram(n.program),n.attributesEnabled||(e.enableVertexAttribArray(l.position),e.enableVertexAttribArray(l.uv),n.attributesEnabled=!0),e.disable(e.CULL_FACE),e.enable(e.BLEND),e.depthMask(!0),e.bindBuffer(e.ARRAY_BUFFER,n.vertexBuffer),e.vertexAttribPointer(l.position,2,e.FLOAT,!1,16,0),e.vertexAttribPointer(l.uv,2,e.FLOAT,!1,16,8),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.elementBuffer),e.uniformMatrix4fv(c.projectionMatrix,!1,s._projectionMatrixArray),e.activeTexture(e.TEXTURE0),e.uniform1i(c.map,0);var m,g,y,b,w=[];for(m=0;m<f;m++){g=a[m];if(!g.visible||g.opacity===0)continue;g.useScreenCoordinates?g.z=-g.position.z:(g._modelViewMatrix.multiply(s.matrixWorldInverse,g.matrixWorld),g.z=-g._modelViewMatrix.elements[14])}a.sort(i);for(m=0;m<f;m++){g=a[m];if(!g.visible||g.opacity===0)continue;g.map&&g.map.image&&g.map.image.width&&(g.useScreenCoordinates?(e.uniform1i(c.useScreenCoordinates,1),e.uniform3f(c.screenPosition,(g.position.x-p)/p,(d-g.position.y)/d,Math.max(0,Math.min(1,g.position.z)))):(e.uniform1i(c.useScreenCoordinates,0),e.uniform1i(c.affectedByDistance,g.affectedByDistance?1:0),e.uniformMatrix4fv(c.modelViewMatrix,!1,g._modelViewMatrix.elements)),b=g.map.image.width/(g.scaleByViewport?u:1),w[0]=b*h*g.scale.x,w[1]=b*g.scale.y,e.uniform2f(c.uvScale,g.uvScale.x,g.uvScale.y),e.uniform2f(c.uvOffset,g.uvOffset.x,g.uvOffset.y),e.uniform2f(c.alignment,g.alignment.x,g.alignment.y),e.uniform1f(c.opacity,g.opacity),e.uniform3f(c.color,g.color.r,g.color.g,g.color.b),e.uniform1f(c.rotation,g.rotation),e.uniform2fv(c.scale,w),g.mergeWith3D&&!v?(e.enable(e.DEPTH_TEST),v=!0):!g.mergeWith3D&&v&&(e.disable(e.DEPTH_TEST),v=!1),t.setBlending(g.blending,g.blendEquation,g.blendSrc,g.blendDst),t.setTexture(g.map,0),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0))}e.enable(e.CULL_FACE),e.enable(e.DEPTH_TEST),e.depthMask(!0)}},THREE.DepthPassPlugin=function(){this.enabled=!1,this.renderTarget=null;var e,t,n,r,i=new THREE.Frustum,s=new THREE.Matrix4;this.init=function(i){e=i.context,t=i;var s=THREE.ShaderLib.depthRGBA,o=THREE.UniformsUtils.clone(s.uniforms);n=new THREE.ShaderMaterial({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:o}),r=new THREE.ShaderMaterial({fragmentShader:s.fragmentShader,vertexShader:s.vertexShader,uniforms:o,morphTargets:!0}),n._shadowPass=!0,r._shadowPass=!0},this.render=function(e,t){if(!this.enabled)return;this.update(e,t)},this.update=function(o,u){var a,f,l,c,h,p,d,v,m,g,y,b,w=null;e.clearColor(1,1,1,1),e.disable(e.BLEND),t.setDepthTest(!0),t.autoUpdateScene&&o.updateMatrixWorld(),u._viewMatrixArray||(u._viewMatrixArray=new Float32Array(16)),u._projectionMatrixArray||(u._projectionMatrixArray=new Float32Array(16)),u.matrixWorldInverse.getInverse(u.matrixWorld),u.matrixWorldInverse.flattenToArray(u._viewMatrixArray),u.projectionMatrix.flattenToArray(u._projectionMatrixArray),s.multiply(u.projectionMatrix,u.matrixWorldInverse),i.setFromMatrix(s),t.setRenderTarget(this.renderTarget),t.clear(),b=o.__webglObjects;for(l=0,c=b.length;l<c;l++)m=b[l],g=m.object,m.render=!1,g.visible&&(!(g instanceof THREE.Mesh)||!g.frustumCulled||i.contains(g))&&(g._modelViewMatrix.multiply(u.matrixWorldInverse,g.matrixWorld),m.render=!0);for(l=0,c=b.length;l<c;l++)m=b[l],m.render&&(g=m.object,d=m.buffer,g.material&&t.setMaterialFaces(g.material),g.customDepthMaterial?v=g.customDepthMaterial:g.geometry.morphTargets.length?v=r:v=n,d instanceof THREE.BufferGeometry?t.renderBufferDirect(u,o.__lights,w,v,d,g):t.renderBuffer(u,o.__lights,w,v,d,g));b=o.__webglObjectsImmediate;for(l=0,c=b.length;l<c;l++)m=b[l],g=m.object,g.visible&&g.castShadow&&(g._modelViewMatrix.multiply(u.matrixWorldInverse,g.matrixWorld),t.renderImmediateObject(u,o.__lights,w,n,g));var E=t.getClearColor(),S=t.getClearAlpha();e.clearColor(E.r,E.g,E.b,S),e.enable(e.BLEND)}},THREE.ShaderFlares={lensFlareVertexTexture:{vertexShader:["uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform int renderType;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","vUV = uv;","vec2 pos = position;","if( renderType == 2 ) {","vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.1 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.5 ) ) +","texture2D( occlusionMap, vec2( 0.9, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.1, 0.9 ) ) +","texture2D( occlusionMap, vec2( 0.1, 0.5 ) ) +","texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","vVisibility = (       visibility.r / 9.0 ) *","( 1.0 - visibility.g / 9.0 ) *","(       visibility.b / 9.0 ) *","( 1.0 - visibility.a / 9.0 );","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision mediump float;","uniform sampler2D map;","uniform float opacity;","uniform int renderType;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","if( renderType == 0 ) {","gl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","} else if( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * vVisibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")},lensFlare:{vertexShader:["uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform int renderType;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uv;","vec2 pos = position;","if( renderType == 2 ) {","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["precision mediump float;","uniform sampler2D map;","uniform sampler2D occlusionMap;","uniform float opacity;","uniform int renderType;","uniform vec3 color;","varying vec2 vUV;","void main() {","if( renderType == 0 ) {","gl_FragColor = vec4( texture2D( map, vUV ).rgb, 0.0 );","} else if( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","float visibility = texture2D( occlusionMap, vec2( 0.5, 0.1 ) ).a +","texture2D( occlusionMap, vec2( 0.9, 0.5 ) ).a +","texture2D( occlusionMap, vec2( 0.5, 0.9 ) ).a +","texture2D( occlusionMap, vec2( 0.1, 0.5 ) ).a;","visibility = ( 1.0 - visibility / 4.0 );","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * visibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")}},THREE.ShaderSprite={sprite:{vertexShader:["uniform int useScreenCoordinates;","uniform int affectedByDistance;","uniform vec3 screenPosition;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 alignment;","uniform vec2 uvOffset;","uniform vec2 uvScale;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uvOffset + uv * uvScale;","vec2 alignedPosition = position + alignment;","vec2 rotatedPosition;","rotatedPosition.x = ( cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y ) * scale.x;","rotatedPosition.y = ( sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y ) * scale.y;","vec4 finalPosition;","if( useScreenCoordinates != 0 ) {","finalPosition = vec4( screenPosition.xy + rotatedPosition, screenPosition.z, 1.0 );","} else {","finalPosition = projectionMatrix * modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","finalPosition.xy += rotatedPosition * ( affectedByDistance == 1 ? 1.0 : finalPosition.z );","}","gl_Position = finalPosition;","}"].join("\n"),fragmentShader:["precision mediump float;","uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","varying vec2 vUV;","void main() {","vec4 texture = texture2D( map, vUV );","gl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","}"].join("\n")}},define("Three",function(e){return function(){return e.THREE}}(this)),function(){var e;e=function(e,t){var n,r,i,s,o,u,a,f;i=typeof exports!="undefined"&&exports!==null?exports:window;if(e.length>0){a=e.split(".");for(o=0,u=a.length;o<u;o++)r=a[o],i=i[r]||(i[r]={})}f=[];for(n in t)s=t[n],f.push(i[n]=s);return f},e("",{namespace:e})}.call(this),define("libs/namespace",function(){}),function(){define("cs!core/utils/AutoReload",["socket.io"],function(){var e;return namespace("Next",{AutoReload:e=function(){function e(){var e;this.getURLParameter("dev")==="true"&&(console.log("AutoReload init"),e=io.connect("http://localhost"),e.on("reload",function(){return console.log("reload!"),window.location.reload(!0)}))}return e.prototype.getURLParameter=function(e){return decodeURI((RegExp(e+"="+"(.+?)(&|$)").exec(location.search)||[0,null])[1])},e}()})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("cs!core/utils/CameraManager",["Underscore","libs/namespace","Three"],function(t){var n;return namespace("Next.utils",{CameraManager:n=function(){function t(t){var n;this.scene=t,this.update=e(this.update,this),this.items=[],this.camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,2e4),this.cameraContainer=new THREE.Object3D,this.cameraContainer.add(this.camera),this.scene.add(this.cameraContainer),this.currentCamera=this.camera,this.camera.position.set(0,2,200),this.camera.lookAt(new THREE.Vector3(0,1480,-3800)),this.cameraSide1=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,2e4),this.cameraSide1.position.set(500,2,200),this.cameraSide1.lookAt(new THREE.Vector3(0,50,200)),this.scene.add(this.cameraSide1),this.items.push(this.cameraSide1),this.cameraSide2=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,2e4),this.cameraSide2.position.set(100,2,200),this.cameraSide2.lookAt(new THREE.Vector3(0,30,185)),this.scene.add(this.cameraSide2),this.items.push(this.cameraSide2),this.cameraIntro2=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,2e4),this.cameraIntro2.position.set(89,5,-250),this.cameraIntro2.lookAt(new THREE.Vector3(0,10,-280)),this.scene.add(this.cameraIntro2),this.items.push(this.cameraIntro2),this.cameraIntro3=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,2e4),this.cameraIntro3.position.set(70,2,-280),this.cameraIntro3.lookAt(new THREE.Vector3(0,15,-270)),this.scene.add(this.cameraIntro3),this.items.push(this.cameraIntro3),this.cameraCity1=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,2e4),this.cameraCity1.position.set(110,220,-2810),this.cameraCity1.lookAt(new THREE.Vector3(0,0,-2980)),this.scene.add(this.cameraCity1),this.items.push(this.cameraCity1),n=140,this.cameraCity2=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,1,2e4),this.cameraCity2.position.set(160,320,-2500+n),this.cameraCity2.lookAt(new THREE.Vector3(0,0,-2100+n)),this.scene.add(this.cameraCity2),this.items.push(this.cameraCity2),this.cameraCityTop1=new THREE.PerspectiveCamera(80,window.innerWidth/window.innerHeight,1,2e4),this.cameraCityTop1.position.set(0,250,-2180),this.cameraCityTop1.lookAt(new THREE.Vector3(0,0,-2200)),this.scene.add(this.cameraCityTop1),this.items.push(this.cameraCityTop1),this.currentCamera=this.cameraSide1}return t.prototype.update=function(e,t,n){var r,i,s,o,u,a;return this.target=t,r=0,this.cameraSide1.position.x=500-e*14,this.cameraSide1.position.z=200-e*18+20,this.cameraSide2.position.z=200-e*18+10,i=0,e>25&&(this.currentCamera=this.cameraIntro2),e>28&&(this.currentCamera=this.cameraIntro3,this.cameraIntro3.position.z=200-e*12-150),e>32&&(this.cameraSide1.position.x=150,this.cameraSide1.position.y=8,this.cameraSide1.lookAt(this.target.position),this.currentCamera=this.cameraSide1),e>38&&e<44&&(s=-450-(e-36)*8,this.cameraSide1.position.z=s,this.cameraSide1.position.x=135,this.cameraSide1.lookAt(new THREE.Vector3(0,10,s)),this.currentCamera=this.cameraSide1),e>41&&(this.currentCamera=this.cameraIntro3,this.cameraIntro3.position.z=200-e*16-70),e>43&&e<46&&(this.cameraIntro2.position.z=this.target.position.z,this.currentCamera=this.cameraIntro2),e>45&&(this.currentCamera=this.cameraSide1,this.cameraSide1.position.y=1,this.cameraSide1.position.x=65,this.cameraSide1.lookAt(new THREE.Vector3(this.target.position.x,this.target.position.y+30,this.target.position.z+10))),e>49&&(this.currentCamera=this.cameraIntro3,this.cameraIntro3.position.z=200-e*15-130),e>53&&(this.currentCamera=this.cameraIntro2,this.cameraIntro2.position.z=-730,this.cameraIntro2.position.y=1),e>57&&(this.currentCamera=this.cameraSide2,this.cameraSide2.position.z=200-e*12-290,this.cameraIntro3.position.x=130),e>64&&(this.currentCamera=this.camera),e>96&&(this.currentCamera=this.cameraCityTop1),e>112&&e<120&&(a=-1210,this.currentCamera=this.cameraCity1,this.cameraCity1.lookAt(this.target.position)),e>120&&e<=133&&(this.currentCamera=this.cameraCity2,this.cameraCity2.position.y+=(120-this.cameraCity2.position.y)*.002,this.cameraCityTop1.position.z=-2180),e>133&&(this.currentCamera=this.camera,r=-700),this.currentCamera===this.camera&&e<169?$("#container canvas").addClass("interactive"):$("#container canvas").removeClass("interactive"),this.camera.position.z=200-e*18+r,this.cameraIntro2.lookAt(this.target.position),this.cameraCityTop1.position.z=-600-e*7,this.cameraCity2.lookAt(new THREE.Vector3(0,0,-2100)),this.camera.position.y=4+Math.sin(e*.5)*.6,o=n.x*-0.8,u=n.y*-0.4+.4,this.camera.rotation.y+=(o-this.camera.rotation.y)*.2,this.camera.rotation.x+=(u-this.camera.rotation.x)*.2},t}()})})}.call(this),THREE.EffectComposer=function(e,t){this.renderer=e,this.renderTarget1=t;if(this.renderTarget1===undefined){var n=window.innerWidth||1,r=window.innerHeight||1;this.renderTargetParameters={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat,stencilBuffer:!1},this.renderTarget1=new THREE.WebGLRenderTarget(n,r,this.renderTargetParameters)}this.renderTarget2=this.renderTarget1.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],this.copyPass=new THREE.ShaderPass(THREE.ShaderExtras.screen)},THREE.EffectComposer.prototype={swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e)},render:function(e){this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2;var t=!1,n,r,i=this.passes.length;for(r=0;r<i;r++){n=this.passes[r];if(!n.enabled)continue;n.render(this.renderer,this.writeBuffer,this.readBuffer,e,t);if(n.needsSwap){if(t){var s=this.renderer.context;s.stencilFunc(s.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),s.stencilFunc(s.EQUAL,1,4294967295)}this.swapBuffers()}n instanceof THREE.MaskPass?t=!0:n instanceof THREE.ClearMaskPass&&(t=!1)}},reset:function(e){this.renderTarget1=e,this.renderTarget1===undefined&&(this.renderTarget1=new THREE.WebGLRenderTarget(window.innerWidth,window.innerHeight,this.renderTargetParameters)),this.renderTarget2=this.renderTarget1.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,THREE.EffectComposer.quad.scale.set(window.innerWidth,window.innerHeight,1),THREE.EffectComposer.camera.left=window.innerWidth/-2,THREE.EffectComposer.camera.right=window.innerWidth/2,THREE.EffectComposer.camera.top=window.innerHeight/2,THREE.EffectComposer.camera.bottom=window.innerHeight/-2,THREE.EffectComposer.camera.updateProjectionMatrix()}},THREE.EffectComposer.initWidth=window.innerWidth||1,THREE.EffectComposer.initHeight=window.innerHeight||1,THREE.EffectComposer.camera=new THREE.OrthographicCamera(THREE.EffectComposer.initWidth/-2,THREE.EffectComposer.initWidth/2,THREE.EffectComposer.initHeight/2,THREE.EffectComposer.initHeight/-2,-1e4,1e4),THREE.EffectComposer.geometry=new THREE.PlaneGeometry(1,1),THREE.EffectComposer.quad=new THREE.Mesh(THREE.EffectComposer.geometry,null),THREE.EffectComposer.quad.position.z=-100,THREE.EffectComposer.quad.scale.set(THREE.EffectComposer.initWidth,THREE.EffectComposer.initHeight,1),THREE.EffectComposer.scene=new THREE.Scene,THREE.EffectComposer.scene.add(THREE.EffectComposer.quad),THREE.EffectComposer.scene.add(THREE.EffectComposer.camera),define("EffectComposer",function(){}),THREE.RenderPass=function(e,t,n,r,i){this.scene=e,this.camera=t,this.overrideMaterial=n,this.clearColor=r,this.clearAlpha=i!==undefined?i:1,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this.enabled=!0,this.clear=!0,this.needsSwap=!1},THREE.RenderPass.prototype={render:function(e,t,n,r){this.scene.overrideMaterial=this.overrideMaterial,this.clearColor&&(this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),e.render(this.scene,this.camera,n,this.clear),this.clearColor&&e.setClearColor(this.oldClearColor,this.oldClearAlpha),this.scene.overrideMaterial=null}},define("RenderPass",function(){}),THREE.BloomPass=function(e,t,n,r){e=e!==undefined?e:1,t=t!==undefined?t:25,n=n!==undefined?n:4,r=r!==undefined?r:256;var i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat};this.renderTargetX=new THREE.WebGLRenderTarget(r,r,i),this.renderTargetY=new THREE.WebGLRenderTarget(r,r,i);var s=THREE.ShaderExtras.screen;this.screenUniforms=THREE.UniformsUtils.clone(s.uniforms),this.screenUniforms.opacity.value=e,this.materialScreen=new THREE.ShaderMaterial({uniforms:this.screenUniforms,vertexShader:s.vertexShader,fragmentShader:s.fragmentShader,blending:THREE.AdditiveBlending,transparent:!0});var o=THREE.ShaderExtras.convolution;this.convolutionUniforms=THREE.UniformsUtils.clone(o.uniforms),this.convolutionUniforms.uImageIncrement.value=THREE.BloomPass.blurx,this.convolutionUniforms.cKernel.value=THREE.ShaderExtras.buildKernel(n),this.materialConvolution=new THREE.ShaderMaterial({uniforms:this.convolutionUniforms,vertexShader:"#define KERNEL_SIZE "+t+".0\n"+o.vertexShader,fragmentShader:"#define KERNEL_SIZE "+t+"\n"+o.fragmentShader}),this.enabled=!0,this.needsSwap=!1,this.clear=!1},THREE.BloomPass.prototype={render:function(e,t,n,r,i){i&&e.context.disable(e.context.STENCIL_TEST),THREE.EffectComposer.quad.material=this.materialConvolution,this.convolutionUniforms.tDiffuse.texture=n,this.convolutionUniforms.uImageIncrement.value=THREE.BloomPass.blurX,e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,this.renderTargetX,!0),this.convolutionUniforms.tDiffuse.texture=this.renderTargetX,this.convolutionUniforms.uImageIncrement.value=THREE.BloomPass.blurY,e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,this.renderTargetY,!0),THREE.EffectComposer.quad.material=this.materialScreen,this.screenUniforms.tDiffuse.texture=this.renderTargetY,i&&e.context.enable(e.context.STENCIL_TEST),e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,n,this.clear)}},THREE.BloomPass.blurX=new THREE.Vector2(.001953125,0),THREE.BloomPass.blurY=new THREE.Vector2(0,.001953125),define("BloomPass",function(){}),THREE.FilmPass=function(e,t,n,r){var i=THREE.ShaderExtras.film;this.uniforms=THREE.UniformsUtils.clone(i.uniforms),this.material=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:i.vertexShader,fragmentShader:i.fragmentShader}),r!==undefined&&(this.uniforms.grayscale.value=r),e!==undefined&&(this.uniforms.nIntensity.value=e),t!==undefined&&(this.uniforms.sIntensity.value=t),n!==undefined&&(this.uniforms.sCount.value=n),this.enabled=!0,this.renderToScreen=!1,this.needsSwap=!0},THREE.FilmPass.prototype={render:function(e,t,n,r){this.uniforms.tDiffuse.texture=n,this.uniforms.time.value+=r,THREE.EffectComposer.quad.material=this.material,this.renderToScreen?e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera):e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,t,!1)}},define("FilmPass",function(){}),THREE.TexturePass=function(e,t){var n=THREE.ShaderExtras.screen;this.uniforms=THREE.UniformsUtils.clone(n.uniforms),this.uniforms.opacity.value=t!==undefined?t:1,this.uniforms.tDiffuse.texture=e,this.material=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader}),this.enabled=!0,this.needsSwap=!1},THREE.TexturePass.prototype={render:function(e,t,n,r){THREE.EffectComposer.quad.material=this.material,e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,n)}},define("TexturePass",function(){}),THREE.ShaderPass=function(e,t){this.textureID=t!==undefined?t:"tDiffuse",this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader}),this.renderToScreen=!1,this.enabled=!0,this.needsSwap=!0,this.clear=!1},THREE.ShaderPass.prototype={render:function(e,t,n,r){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].texture=n),THREE.EffectComposer.quad.material=this.material,this.renderToScreen?e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera):e.render(THREE.EffectComposer.scene,THREE.EffectComposer.camera,t,this.clear)}},define("ShaderPass",function(){}),THREE.MaskPass=function(e,t){this.scene=e,this.camera=t,this.enabled=!0,this.clear=!0,this.needsSwap=!1,this.inverse=!1},THREE.MaskPass.prototype={render:function(e,t,n,r){var i=e.context;i.colorMask(!1,!1,!1,!1),i.depthMask(!1);var s,o;this.inverse?(s=0,o=1):(s=1,o=0),i.enable(i.STENCIL_TEST),i.stencilOp(i.REPLACE,i.REPLACE,i.REPLACE),i.stencilFunc(i.ALWAYS,s,4294967295),i.clearStencil(o),e.render(this.scene,this.camera,n,this.clear),e.render(this.scene,this.camera,t,this.clear),i.colorMask(!0,!0,!0,!0),i.depthMask(!0),i.stencilFunc(i.EQUAL,1,4294967295),i.stencilOp(i.KEEP,i.KEEP,i.KEEP)}},THREE.ClearMaskPass=function(){this.enabled=!0},THREE.ClearMaskPass.prototype={render:function(e,t,n,r){var i=e.context;i.disable(i.STENCIL_TEST)}},define("MaskPass",function(){}),THREE.ShaderExtras={screen:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},convolution:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},uImageIncrement:{type:"v2",value:new THREE.Vector2(.001953125,0)},cKernel:{type:"fv1",value:[]}},vertexShader:["uniform vec2 uImageIncrement;","varying vec2 vUv;","void main() {","vUv = uv - ( ( KERNEL_SIZE - 1.0 ) / 2.0 ) * uImageIncrement;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float cKernel[ KERNEL_SIZE ];","uniform sampler2D tDiffuse;","uniform vec2 uImageIncrement;","varying vec2 vUv;","void main() {","vec2 imageCoord = vUv;","vec4 sum = vec4( 0.0, 0.0, 0.0, 0.0 );","for( int i = 0; i < KERNEL_SIZE; i ++ ) {","sum += texture2D( tDiffuse, imageCoord ) * cKernel[ i ];","imageCoord += uImageIncrement;","}","gl_FragColor = sum;","}"].join("\n")},film:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},time:{type:"f",value:0},nIntensity:{type:"f",value:.5},sIntensity:{type:"f",value:.05},sCount:{type:"f",value:4096},grayscale:{type:"i",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float time;","uniform bool grayscale;","uniform float nIntensity;","uniform float sIntensity;","uniform float sCount;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 cTextureScreen = texture2D( tDiffuse, vUv );","float x = vUv.x * vUv.y * time *  1000.0;","x = mod( x, 13.0 ) * mod( x, 123.0 );","float dx = mod( x, 0.01 );","vec3 cResult = cTextureScreen.rgb + cTextureScreen.rgb * clamp( 0.1 + dx * 100.0, 0.0, 1.0 );","vec2 sc = vec2( sin( vUv.y * sCount ), cos( vUv.y * sCount ) );","cResult += cTextureScreen.rgb * vec3( sc.x, sc.y, sc.x ) * sIntensity;","cResult = cTextureScreen.rgb + clamp( nIntensity, 0.0,1.0 ) * ( cResult - cTextureScreen.rgb );","if( grayscale ) {","cResult = vec3( cResult.r * 0.3 + cResult.g * 0.59 + cResult.b * 0.11 );","}","gl_FragColor =  vec4( cResult, cTextureScreen.a );","}"].join("\n")},bokeh:{uniforms:{tColor:{type:"t",value:0,texture:null},tDepth:{type:"t",value:1,texture:null},focus:{type:"f",value:1},aspect:{type:"f",value:1},aperture:{type:"f",value:.025},maxblur:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["varying vec2 vUv;","uniform sampler2D tColor;","uniform sampler2D tDepth;","uniform float maxblur;","uniform float aperture;","uniform float focus;","uniform float aspect;","void main() {","vec2 aspectcorrect = vec2( 1.0, aspect );","vec4 depth1 = texture2D( tDepth, vUv );","float factor = depth1.x - focus;","vec2 dofblur = vec2 ( clamp( factor * aperture, -maxblur, maxblur ) );","vec2 dofblur9 = dofblur * 0.9;","vec2 dofblur7 = dofblur * 0.7;","vec2 dofblur4 = dofblur * 0.4;","vec4 col = vec4( 0.0 );","col += texture2D( tColor, vUv.xy );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15,  0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37,  0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.40,  0.0  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37, -0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15, -0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15,  0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37,  0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37, -0.15 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15, -0.37 ) * aspectcorrect ) * dofblur );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15,  0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37,  0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37, -0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15, -0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.15,  0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.37,  0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.37, -0.15 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.15, -0.37 ) * aspectcorrect ) * dofblur9 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.40,  0.0  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur7 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29,  0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.4,   0.0  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.29, -0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,  -0.4  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29,  0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.4,   0.0  ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2( -0.29, -0.29 ) * aspectcorrect ) * dofblur4 );","col += texture2D( tColor, vUv.xy + ( vec2(  0.0,   0.4  ) * aspectcorrect ) * dofblur4 );","gl_FragColor = col / 41.0;","gl_FragColor.a = 1.0;","}"].join("\n")},dofmipmap:{uniforms:{tColor:{type:"t",value:0,texture:null},tDepth:{type:"t",value:1,texture:null},focus:{type:"f",value:1},maxblur:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float focus;","uniform float maxblur;","uniform sampler2D tColor;","uniform sampler2D tDepth;","varying vec2 vUv;","void main() {","vec4 depth = texture2D( tDepth, vUv );","float factor = depth.x - focus;","vec4 col = texture2D( tColor, vUv, 2.0 * maxblur * abs( focus - depth.x ) );","gl_FragColor = col;","gl_FragColor.a = 1.0;","}"].join("\n")},sepia:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},amount:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float amount;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 color = texture2D( tDiffuse, vUv );","vec3 c = color.rgb;","color.r = dot( c, vec3( 1.0 - 0.607 * amount, 0.769 * amount, 0.189 * amount ) );","color.g = dot( c, vec3( 0.349 * amount, 1.0 - 0.314 * amount, 0.168 * amount ) );","color.b = dot( c, vec3( 0.272 * amount, 0.534 * amount, 1.0 - 0.869 * amount ) );","gl_FragColor = vec4( min( vec3( 1.0 ), color.rgb ), color.a );","}"].join("\n")},dotscreen:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},tSize:{type:"v2",value:new THREE.Vector2(256,256)},center:{type:"v2",value:new THREE.Vector2(.5,.5)},angle:{type:"f",value:1.57},scale:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec2 center;","uniform float angle;","uniform float scale;","uniform vec2 tSize;","uniform sampler2D tDiffuse;","varying vec2 vUv;","float pattern() {","float s = sin( angle ), c = cos( angle );","vec2 tex = vUv * tSize - center;","vec2 point = vec2( c * tex.x - s * tex.y, s * tex.x + c * tex.y ) * scale;","return ( sin( point.x ) * sin( point.y ) ) * 4.0;","}","void main() {","vec4 color = texture2D( tDiffuse, vUv );","float average = ( color.r + color.g + color.b ) / 3.0;","gl_FragColor = vec4( vec3( average * 10.0 - 5.0 + pattern() ), color.a );","}"].join("\n")},vignette:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},offset:{type:"f",value:1},darkness:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float offset;","uniform float darkness;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","vec2 uv = ( vUv - vec2( 0.5 ) ) * vec2( offset );","gl_FragColor = vec4( mix( texel.rgb, vec3( 1.0 - darkness ), dot( uv, uv ) ), texel.a );","}"].join("\n")},bleachbypass:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 base = texture2D( tDiffuse, vUv );","vec3 lumCoeff = vec3( 0.25, 0.65, 0.1 );","float lum = dot( lumCoeff, base.rgb );","vec3 blend = vec3( lum );","float L = min( 1.0, max( 0.0, 10.0 * ( lum - 0.45 ) ) );","vec3 result1 = 2.0 * base.rgb * blend;","vec3 result2 = 1.0 - 2.0 * ( 1.0 - blend ) * ( 1.0 - base.rgb );","vec3 newColor = mix( result1, result2, L );","float A2 = opacity * base.a;","vec3 mixRGB = A2 * newColor.rgb;","mixRGB += ( ( 1.0 - A2 ) * base.rgb );","gl_FragColor = vec4( mixRGB, base.a );","}"].join("\n")},focus:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},screenWidth:{type:"f",value:1024},screenHeight:{type:"f",value:1024},sampleDistance:{type:"f",value:.94},waveFactor:{type:"f",value:.00125}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float screenWidth;","uniform float screenHeight;","uniform float sampleDistance;","uniform float waveFactor;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 color, org, tmp, add;","float sample_dist, f;","vec2 vin;","vec2 uv = vUv;","add = color = org = texture2D( tDiffuse, uv );","vin = ( uv - vec2( 0.5 ) ) * vec2( 1.4 );","sample_dist = dot( vin, vin ) * 2.0;","f = ( waveFactor * 100.0 + sample_dist ) * sampleDistance * 4.0;","vec2 sampleSize = vec2(  1.0 / screenWidth, 1.0 / screenHeight ) * vec2( f );","add += tmp = texture2D( tDiffuse, uv + vec2( 0.111964, 0.993712 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( 0.846724, 0.532032 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( 0.943883, -0.330279 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( 0.330279, -0.943883 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( -0.532032, -0.846724 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( -0.993712, -0.111964 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","add += tmp = texture2D( tDiffuse, uv + vec2( -0.707107, 0.707107 ) * sampleSize );","if( tmp.b < color.b ) color = tmp;","color = color * vec4( 2.0 ) - ( add / vec4( 8.0 ) );","color = color + ( add / vec4( 8.0 ) - color ) * ( vec4( 1.0 ) - vec4( sample_dist * 0.5 ) );","gl_FragColor = vec4( color.rgb * color.rgb * vec3( 0.95 ) + color.rgb, 1.0 );","}"].join("\n")},triangleBlur:{uniforms:{texture:{type:"t",value:0,texture:null},delta:{type:"v2",value:new THREE.Vector2(1,1)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["#define ITERATIONS 10.0","uniform sampler2D texture;","uniform vec2 delta;","varying vec2 vUv;","float random( vec3 scale, float seed ) {","return fract( sin( dot( gl_FragCoord.xyz + seed, scale ) ) * 43758.5453 + seed );","}","void main() {","vec4 color = vec4( 0.0 );","float total = 0.0;","float offset = random( vec3( 12.9898, 78.233, 151.7182 ), 0.0 );","for ( float t = -ITERATIONS; t <= ITERATIONS; t ++ ) {","float percent = ( t + offset - 0.5 ) / ITERATIONS;","float weight = 1.0 - abs( percent );","color += texture2D( texture, vUv + delta * percent ) * weight;","total += weight;","}","gl_FragColor = color / total;","}"].join("\n")},basic:{uniforms:{},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["void main() {","gl_FragColor = vec4( 1.0, 0.0, 0.0, 0.5 );","}"].join("\n")},horizontalBlur:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},h:{type:"f",value:1/512}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float h;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, 		  	vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},verticalBlur:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},v:{type:"f",value:1/512}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float v;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y			  ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},horizontalTiltShift:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},h:{type:"f",value:1/512},r:{type:"f",value:.35}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float h;","uniform float r;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","float hh = h * abs( r - vUv.y );","sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * hh, vUv.y ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * hh, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * hh, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * hh, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, 		  	 vUv.y ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * hh, vUv.y ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * hh, vUv.y ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * hh, vUv.y ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * hh, vUv.y ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},verticalTiltShift:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},v:{type:"f",value:1/512},r:{type:"f",value:.35}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform float v;","uniform float r;","varying vec2 vUv;","void main() {","vec4 sum = vec4( 0.0 );","float vv = v * abs( r - vUv.y );","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * vv ) ) * 0.051;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * vv ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * vv ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * vv ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y			   ) ) * 0.1633;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * vv ) ) * 0.1531;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * vv ) ) * 0.12245;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * vv ) ) * 0.0918;","sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * vv ) ) * 0.051;","gl_FragColor = sum;","}"].join("\n")},blend:{uniforms:{tDiffuse1:{type:"t",value:0,texture:null},tDiffuse2:{type:"t",value:1,texture:null},mixRatio:{type:"f",value:.5},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform float mixRatio;","uniform sampler2D tDiffuse1;","uniform sampler2D tDiffuse2;","varying vec2 vUv;","void main() {","vec4 texel1 = texture2D( tDiffuse1, vUv );","vec4 texel2 = texture2D( tDiffuse2, vUv );","gl_FragColor = opacity * mix( texel1, texel2, mixRatio );","}"].join("\n")},fxaa:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},resolution:{type:"v2",value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","varying vec2 vUv;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","void main() {","vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ).xyz;","vec4 rgbaM  = texture2D( tDiffuse,  gl_FragCoord.xy  * resolution );","vec3 rgbM  = rgbaM.xyz;","float opacity  = rgbaM.w;","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float lumaNW = dot( rgbNW, luma );","float lumaNE = dot( rgbNE, luma );","float lumaSW = dot( rgbSW, luma );","float lumaSE = dot( rgbSE, luma );","float lumaM  = dot( rgbM,  luma );","float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","dir * rcpDirMin)) * resolution;","vec3 rgbA = 0.5 * (","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * ( 1.0 / 3.0 - 0.5 ) ).xyz +","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * ( 2.0 / 3.0 - 0.5 ) ).xyz );","vec3 rgbB = rgbA * 0.5 + 0.25 * (","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * -0.5 ).xyz +","texture2D( tDiffuse, gl_FragCoord.xy  * resolution + dir * 0.5 ).xyz );","float lumaB = dot( rgbB, luma );","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = vec4( rgbA, opacity );","} else {","gl_FragColor = vec4( rgbB, opacity );","}","}"].join("\n")},luminosity:{uniforms:{tDiffuse:{type:"t",value:0,texture:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float v = dot( texel.xyz, luma );","gl_FragColor = vec4( v, v, v, texel.w );","}"].join("\n")},colorCorrection:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},powRGB:{type:"v3",value:new THREE.Vector3(2,2,2)},mulRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec3 powRGB;","uniform vec3 mulRGB;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D( tDiffuse, vUv );","gl_FragColor.rgb = mulRGB * pow( gl_FragColor.rgb, powRGB );","}"].join("\n")},normalmap:{uniforms:{heightMap:{type:"t",value:0,texture:null},resolution:{type:"v2",value:new THREE.Vector2(512,512)},scale:{type:"v2",value:new THREE.Vector2(1,1)},height:{type:"f",value:.05}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float height;","uniform vec2 resolution;","uniform sampler2D heightMap;","varying vec2 vUv;","void main() {","float val = texture2D( heightMap, vUv ).x;","float valU = texture2D( heightMap, vUv + vec2( 1.0 / resolution.x, 0.0 ) ).x;","float valV = texture2D( heightMap, vUv + vec2( 0.0, 1.0 / resolution.y ) ).x;","gl_FragColor = vec4( ( 0.5 * normalize( vec3( val - valU, val - valV, height  ) ) + 0.5 ), 1.0 );","}"].join("\n")},ssao:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},tDepth:{type:"t",value:1,texture:null},size:{type:"v2",value:new THREE.Vector2(512,512)},cameraNear:{type:"f",value:1},cameraFar:{type:"f",value:100},fogNear:{type:"f",value:5},fogFar:{type:"f",value:100},fogEnabled:{type:"i",value:0},onlyAO:{type:"i",value:0},aoClamp:{type:"f",value:.3},lumInfluence:{type:"f",value:.9}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float cameraNear;","uniform float cameraFar;","uniform float fogNear;","uniform float fogFar;","uniform bool fogEnabled;","uniform bool onlyAO;","uniform vec2 size;","uniform float aoClamp;","uniform float lumInfluence;","uniform sampler2D tDiffuse;","uniform sampler2D tDepth;","varying vec2 vUv;","#define DL 2.399963229728653","#define EULER 2.718281828459045","float width = size.x;","float height = size.y;","float cameraFarPlusNear = cameraFar + cameraNear;","float cameraFarMinusNear = cameraFar - cameraNear;","float cameraCoef = 2.0 * cameraNear;","const int samples = 8;","const float radius = 5.0;","const bool useNoise = false;","const float noiseAmount = 0.0003;","const float diffArea = 0.4;","const float gDisplace = 0.4;","const vec3 onlyAOColor = vec3( 1.0, 0.7, 0.5 );","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","vec2 rand( const vec2 coord ) {","vec2 noise;","if ( useNoise ) {","float nx = dot ( coord, vec2( 12.9898, 78.233 ) );","float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );","noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );","} else {","float ff = fract( 1.0 - coord.s * ( width / 2.0 ) );","float gg = fract( coord.t * ( height / 2.0 ) );","noise = vec2( 0.25, 0.75 ) * vec2( ff ) + vec2( 0.75, 0.25 ) * gg;","}","return ( noise * 2.0  - 1.0 ) * noiseAmount;","}","float doFog() {","float zdepth = unpackDepth( texture2D( tDepth, vUv ) );","float depth = -cameraFar * cameraNear / ( zdepth * cameraFarMinusNear - cameraFar );","return smoothstep( fogNear, fogFar, depth );","}","float readDepth( const in vec2 coord ) {","return cameraCoef / ( cameraFarPlusNear - unpackDepth( texture2D( tDepth, coord ) ) * cameraFarMinusNear );","}","float compareDepths( const in float depth1, const in float depth2, inout int far ) {","float garea = 2.0;","float diff = ( depth1 - depth2 ) * 100.0;","if ( diff < gDisplace ) {","garea = diffArea;","} else {","far = 1;","}","float dd = diff - gDisplace;","float gauss = pow( EULER, -2.0 * dd * dd / ( garea * garea ) );","return gauss;","}","float calcAO( float depth, float dw, float dh ) {","float dd = radius - depth * radius;","vec2 vv = vec2( dw, dh );","vec2 coord1 = vUv + dd * vv;","vec2 coord2 = vUv - dd * vv;","float temp1 = 0.0;","float temp2 = 0.0;","int far = 0;","temp1 = compareDepths( depth, readDepth( coord1 ), far );","if ( far > 0 ) {","temp2 = compareDepths( readDepth( coord2 ), depth, far );","temp1 += ( 1.0 - temp1 ) * temp2;","}","return temp1;","}","void main() {","vec2 noise = rand( vUv );","float depth = readDepth( vUv );","float tt = clamp( depth, aoClamp, 1.0 );","float w = ( 1.0 / width )  / tt + ( noise.x * ( 1.0 - noise.x ) );","float h = ( 1.0 / height ) / tt + ( noise.y * ( 1.0 - noise.y ) );","float pw;","float ph;","float ao;","float dz = 1.0 / float( samples );","float z = 1.0 - dz / 2.0;","float l = 0.0;","for ( int i = 0; i <= samples; i ++ ) {","float r = sqrt( 1.0 - z );","pw = cos( l ) * r;","ph = sin( l ) * r;","ao += calcAO( depth, pw * w, ph * h );","z = z - dz;","l = l + DL;","}","ao /= float( samples );","ao = 1.0 - ao;","if ( fogEnabled ) {","ao = mix( ao, 1.0, doFog() );","}","vec3 color = texture2D( tDiffuse, vUv ).rgb;","vec3 lumcoeff = vec3( 0.299, 0.587, 0.114 );","float lum = dot( color.rgb, lumcoeff );","vec3 luminance = vec3( lum );","vec3 final = vec3( color * mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","if ( onlyAO ) {","final = onlyAOColor * vec3( mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","}","gl_FragColor = vec4( final, 1.0 );","}"].join("\n")},colorify:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},color:{type:"c",value:new THREE.Color(16777215)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float v = dot( texel.xyz, luma );","gl_FragColor = vec4( v * color, texel.w );","}"].join("\n")},unpackDepthRGBA:{uniforms:{tDiffuse:{type:"t",value:0,texture:null},opacity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","float unpackDepth( const in vec4 rgba_depth ) {","const vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );","float depth = dot( rgba_depth, bit_shift );","return depth;","}","void main() {","float depth = 1.0 - unpackDepth( texture2D( tDiffuse, vUv ) );","gl_FragColor = opacity * vec4( vec3( depth ), 1.0 );","}"].join("\n")},buildKernel:function(e){function t(e,t){return Math.exp(-(e*e)/(2*t*t))}var n,r,i,s,o=25,u=2*Math.ceil(e*3)+1;u>o&&(u=o),s=(u-1)*.5,r=new Array(u),i=0;for(n=0;n<u;++n)r[n]=t(n-s,e),i+=r[n];for(n=0;n<u;++n)r[n]/=i;return r}},define("ShaderExtras",function(){}),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("cs!core/utils/ThreeApp",["Underscore","libs/namespace","cs!core/utils/AutoReload","cs!core/utils/CameraManager","Three","EffectComposer","RenderPass","BloomPass","FilmPass","TexturePass","ShaderPass","MaskPass","ShaderExtras"],function(t){var n;return namespace("Next",{ThreeApp:n=function(){function t(){this.onResize=e(this.onResize,this),this.render=e(this.render,this),this.animate=e(this.animate,this),this.updateWorld=e(this.updateWorld,this),this.createWorld=e(this.createWorld,this),this.createCamera=e(this.createCamera,this),this.createLights=e(this.createLights,this),this.createRenderer=e(this.createRenderer,this),this.preInit=e(this.preInit,this),this.finished=!1,this.preInit(),this.onResize(),this.animate()}return t.prototype.preInit=function(){var e=this;return new Next.AutoReload,this.clock=new THREE.Clock,this.scene=new THREE.Scene,this.createCamera(),this.createLights(),this.createWorld(),this.createRenderer(),$(window).bind("resize",function(t){return e.onResize()})},t.prototype.createRenderer=function(){var e,t,n;$("body").append("<div id='container'></div>"),this.container=$("#container")[0],this.renderer=new THREE.WebGLRenderer({clearColor:Next.settings.backgroundColor,clearAlpha:1,antialias:!1}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.autoClear=!1,this.container.appendChild(this.renderer.domElement);if(Next.settings.postprocessing===!0)return this.renderModel=new THREE.RenderPass(this.scene,this.cameras.currentCamera),this.effectBloom=new THREE.BloomPass(1.3),this.effectFilm=new THREE.FilmPass(.51,.135,648,!1),this.effectVignette=new THREE.ShaderPass(THREE.ShaderExtras.vignette),this.effectVignette.uniforms.darkness.value=1.6,e={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1},this.renderTarget=new THREE.WebGLRenderTarget(window.innerWidth,window.innerHeight,e),this.composer=new THREE.EffectComposer(this.renderer,this.renderTarget),this.composer.addPass(this.renderModel),this.composer.addPass(this.effectBloom),this.composer.addPass(this.effectFilm),t=THREE.ImageUtils.loadTexture("textures/lens_dirt.jpg"),n=THREE.ImageUtils.loadTexture("textures/glitch3.jpg"),this.mainShader=new THREE.ShaderPass(Next.shaders.GlitchShader),this.mainShader.material.uniforms.tLensDirt.texture=t,this.mainShader.material.uniforms.tGlitch.texture=n,this.mainShader.needsSwap=!1,this.composer.addPass(this.mainShader),this.composer.addPass(this.effectVignette),this.effectVignette.renderToScreen=!0},t.prototype.createLights=function(){return this.directionalLight=new THREE.DirectionalLight(16777215,1.15),this.directionalLight.position.set(500,1e3,0),this.scene.add(this.directionalLight)},t.prototype.createCamera=function(){return this.cameras=new Next.utils.CameraManager(this.scene)},t.prototype.createWorld=function(){return!1},t.prototype.updateWorld=function(){return!1},t.prototype.animate=function(){var e,t;e=this.clock.getDelta(),t=this.clock.getElapsedTime()*10,this.updateWorld(t,e),this.render(t,e);if(this.finished===!1)return requestAnimationFrame(this.animate)},t.prototype.render=function(e,t){return this.renderer.clear(),this.composer?this.composer.render(t):this.renderer.render(this.scene,this.cameras.currentCamera)},t.prototype.onResize=function(){var e,t,n,r,i;t=window.innerWidth/window.innerHeight,i=this.cameras.items;for(n=0,r=i.length;n<r;n++)e=i[n],e.aspect=t,e.updateProjectionMatrix();this.renderer.setSize(window.innerWidth,window.innerHeight);if(this.composer)return this.composer.reset()},t}()})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("cs!core/objects/BuildingBlock",["Underscore","libs/namespace","Three"],function(t){var n;return namespace("Next.objects",{BuildingBlock:n=function(){function t(t,n,r,i,s,o){var u,a,f,l,c,h,p,d,v,m,g,y;this.materials=t,this.material=n,this.cubeRoof=r,this.plane=i,this.random=s,this.createReflections=o,this.setObjectUV=e(this.setObjectUV,this),this.setFacesIndices=e(this.setFacesIndices,this),this.cubeWidth=parseInt(100+this.random.getRandom()*100),this.cubeDepth=parseInt(100+this.random.getRandom()*100),this.cubeHeight=parseInt(50+this.random.getRandom()*200),this.combined=new THREE.Geometry,u=new THREE.CubeGeometry(this.cubeWidth,this.cubeHeight,this.cubeDepth,1,1,1,this.materials),this.setObjectUV(u),this.setFacesIndices(u),this.object=new THREE.Mesh(u,this.material),this.object.position.y=this.cubeHeight/2,THREE.GeometryUtils.merge(this.combined,this.object),l=this.cubeHeight/2,m=this.cubeWidth,f=this.cubeDepth,p=new THREE.Mesh(this.cubeRoof,this.material),p.scale.set(this.cubeWidth*1.01,2+this.random.getRandom()*10,this.cubeDepth*1.01),p.position.y=this.cubeHeight,THREE.GeometryUtils.merge(this.combined,p);if(this.random.getRandom()>.7)for(h=g=0,y=parseInt(this.random.getRandom()*2);0<=y?g<=y:g>=y;h=0<=y?++g:--g)a=parseInt(50+this.random.getRandom()*200),m*=this.random.getRandom()*.5+.5,f*=this.random.getRandom()*.5+.5,u=new THREE.CubeGeometry(m,a,f,1,1,1,this.materials),this.setObjectUV(u),this.setFacesIndices(u),d=new THREE.Mesh(u,this.material),d.position.y=a/2+l,THREE.GeometryUtils.merge(this.combined,d),l+=a,p=new THREE.Mesh(this.cubeRoof,this.material),p.scale.set(m*1.01,2+this.random.getRandom()*10,f*1.01),p.position.y=l,THREE.GeometryUtils.merge(this.combined,p);this.createReflections===!0&&(this.ref=new THREE.Mesh(this.plane,this.materials[2]),v=this.random.getRandom()*.5,c=1.3,this.ref.scale.set(this.cubeWidth*c+v,1,this.cubeDepth*c+v),this.ref.position.y=this.random.getRandom()+.1,THREE.GeometryUtils.merge(this.combined,ref)),this.mesh=new THREE.Mesh(this.combined,this.material)}return t.prototype.setFacesIndices=function(e){return e.faces[0].materialIndex=0,e.faces[1].materialIndex=0,e.faces[2].materialIndex=1,e.faces[3].materialIndex=1,e.faces[4].materialIndex=0,e.faces[5].materialIndex=0},t.prototype.setObjectUV=function(e){var t,n,r,i,s,o;i=.4,n=Math.random(),r=Math.random(),o=[];for(t=s=0;s<=5;t=++s)e.faceVertexUvs[0][t][0].u=n,e.faceVertexUvs[0][t][0].v=r,e.faceVertexUvs[0][t][1].u=n,e.faceVertexUvs[0][t][1].v=i+r,e.faceVertexUvs[0][t][2].u=i+n,e.faceVertexUvs[0][t][2].v=i+r,e.faceVertexUvs[0][t][3].u=i+n,o.push(e.faceVertexUvs[0][t][3].v=r);return o},t}()})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("cs!core/utils/Rc4Random",["libs/namespace"],function(){var t;return namespace("Next.utils",{Rc4Random:t=function(){function t(t){this.getRandom=e(this.getRandom,this),this.getRandomByte=e(this.getRandomByte,this);var n,r,i,s,o,u,a;this.keySchedule=[],this.keySchedule_i=0,this.keySchedule_j=0;for(n=s=0,u=255;0<=u?s<=u:s>=u;n=0<=u?++s:--s)this.keySchedule[n]=n;r=0;for(n=o=0,a=255;0<=a?o<=a:o>=a;n=0<=a?++o:--o)r=(r+this.keySchedule[n]+t.charCodeAt(n%t.length))%256,i=this.keySchedule[n],this.keySchedule[n]=this.keySchedule[r],this.keySchedule[r]=i}return t.prototype.getRandomByte=function(){var e;return this.keySchedule_i=(this.keySchedule_i+1)%256,this.keySchedule_j=(this.keySchedule_j+this.keySchedule[this.keySchedule_i])%256,e=this.keySchedule[this.keySchedule_i],this.keySchedule[this.keySchedule_i]=this.keySchedule[this.keySchedule_j],this.keySchedule[this.keySchedule_j]=e,this.keySchedule[(this.keySchedule[this.keySchedule_i]+this.keySchedule[this.keySchedule_j])%256]},t.prototype.getRandom=function(){var e,t,n,r,i;n=0,t=1;for(e=r=0,i=7;0<=i?r<=i:r>=i;e=0<=i?++r:--r)n+=this.getRandomByte()*t,t*=256;return n/0x10000000000000000},t}()})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};define("cs!core/objects/Buildings",["Underscore","libs/namespace","cs!core/objects/BuildingBlock","cs!core/utils/Rc4Random","Three"],function(t){var r;return namespace("Next.objects",{Buildings:r=function(t){function r(){this.createTexture=e(this.createTexture,this),this.drawWindow=e(this.drawWindow,this),this.createRoofTexture=e(this.createRoofTexture,this),this.rndGray=e(this.rndGray,this),this.rndColor=e(this.rndColor,this),this.createShaders=e(this.createShaders,this),this.createBuildingLine=e(this.createBuildingLine,this),this.update=e(this.update,this),this.updateWindow=e(this.updateWindow,this);var t,n,i,s,o,u,a,f;r.__super__.constructor.apply(this,arguments),this.numWindows=60,this.spacing=1,this.windowsOn=[],this.createReflections=!1,this.random=new Next.utils.Rc4Random("Lorem ipusm dolor sit amet."),this.randomBuildings=new Next.utils.Rc4Random("rBPvyBA1MUhvJVT4kNH6sLsAz6dRfwL6"),this.randomTexture=new Next.utils.Rc4Random("6s13LsAz6drBPvsdfayBAJVT4kNHRfwL1MUhv6"),this.createShaders(),this.buildingsGeom=new THREE.Geometry,this.createReflections===!0&&(this.reflectionsGeom=new THREE.Geometry),this.cubeRoof=new THREE.CubeGeometry(1,1,1,1,1,1,this.materials),f=this.cubeRoof.faces;for(n=s=0,a=f.length;s<a;n=++s)t=f[n],t.materialIndex=1;this.createReflections===!0&&(this.plane=new THREE.PlaneGeometry(1,1,1,1),this.plane.materials=this.materials,this.plane.faces[0].materialIndex=2),this.buildingCount=0;for(i=o=0;o<=10;i=++o)this.createBuildingLine(i*220+135,i);for(i=u=0;u<=10;i=++u)this.createBuildingLine(i*-220-290,i);this.buildings=new THREE.Mesh(this.buildingsGeom,this.material),this.add(this.buildings),this.buildingsGeom.dynamic=!1,this.createReflections===!0&&(this.reflections=new THREE.Mesh(this.reflectionsGeom,this.reflectionMaterial),this.add(this.reflections))}return n(r,t),r.prototype.updateWindow=function(e,t,n){var r,i,s,o,u;if(this.windowsOn[e][t]===-1)return;return this.windowsOn[e][t]*=.98,this.windowsOn[e][t]<=.05&&(this.windowsOn[e][t]=0),n&&this.windowsOn[e][t]===0&&Math.random()<.4&&(this.windowsOn[e][t]=1),r=1-this.windowsOn[e][t],o=this.spacing+e*(this.windowSize+this.spacing)-1,u=t*(this.windowSize+this.spacing)-1,s=this.windowSize+2-this.spacing,i=this.windowSize+2-this.spacing,this.contextCopy.fillStyle="rgba(0, 0, 0, "+r+")",this.contextCopy.fillRect(o,u,s,i)},r.prototype.update=function(e){var t,n,r,i,s;if(window.highQuality===!1)return;this.contextCopy.drawImage(this.canvas,0,0),this.texture.needsUpdate=!0,s=[];for(t=r=0,i=this.numWindows-1;0<=i?r<=i:r>=i;t=0<=i?++r:--r)s.push(function(){var r,i,s;s=[];for(n=r=0,i=this.numWindows-1;0<=i?r<=i:r>=i;n=0<=i?++r:--r)s.push(this.updateWindow(t,n,e));return s}.call(this));return s},r.prototype.createBuildingLine=function(e,t){var n,r,i,s,o;r=-2e3,e>0&&(r=-1640),o=[];for(i=s=0;s<=40;i=++s)t<3||i<3||i>37?(n=new Next.objects.BuildingBlock(this.materials,this.material,this.cubeRoof,this.plane,this.randomBuildings,this.createReflections),n.mesh.position.x=parseInt(0-n.cubeWidth/2-e+this.random.getRandom()*30),e===0&&this.random.getRandom()<.4&&(n.mesh.position.x*=this.random.getRandom()*50),r+=n.cubeDepth/2,n.mesh.position.z=r,r+=parseInt(n.cubeDepth/2+10+this.random.getRandom()*20),THREE.GeometryUtils.merge(this.buildingsGeom,n.mesh),this.createReflections===!0&&(n.ref.position.x=n.mesh.position.x,n.ref.position.z=n.mesh.position.z,THREE.GeometryUtils.merge(this.reflectionsGeom,n.ref)),o.push(this.buildingCount++)):o.push(void 0);return o},r.prototype.createShaders=function(){return this.wallcolor="#050505",this.createTexture(),this.createRoofTexture(),this.createReflections===!0&&(this.reflectionMaterial=new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture("textures/building_road_reflection4.png"),fog:!0,transparent:!0,blending:THREE.AdditiveBlending,depthWrite:!1,color:0,opacity:.7})),this.materialCube=new THREE.MeshPhongMaterial({map:this.texture,emissive:7829367,fog:!0,wireframe:!1}),this.materialCubeRoof=new THREE.MeshPhongMaterial({map:this.roofTexture,fog:!0,wireframe:!1}),this.materialWire=new THREE.MeshBasicMaterial({color:15658734,fog:!0,doubleSided:!0,wireframe:!0}),this.materials=[],this.materials.push(this.materialCube),this.materials.push(this.materialCubeRoof),this.materials.push(this.reflectionMaterial),this.material=new THREE.MeshFaceMaterial},r.prototype.rndColor=function(e,t,n,r,i,s){var o,u,a;return e==null&&(e=0),t==null&&(t=0),n==null&&(n=0),r==null&&(r=1),i==null&&(i=1),s==null&&(s=1),a=("0"+Math.floor(Math.random()*(256-e)*r+e).toString(16)).substr(-2),u=("0"+Math.floor(Math.random()*(256-t)*i+t).toString(16)).substr(-2),o=("0"+Math.floor(Math.random()*(256-n)*s+n).toString(16)).substr(-2),"#"+a+u+o},r.prototype.rndGray=function(e,t){var n;return e==null&&(e=0),t==null&&(t=1),n=("0"+Math.floor(Math.random()*(256-e)*t+e).toString(16)).substr(-2),"#"+n+n+n},r.prototype.createRoofTexture=function(){var e,t;return this.textureSize=32,e=document.createElement("canvas"),t=e.getContext("2d"),e.width=this.textureSize,e.height=this.textureSize,t.fillStyle=this.wallcolor,t.fillRect(0,0,this.textureSize,this.textureSize),this.roofTexture=new THREE.Texture(e),this.roofTexture.needsUpdate=!0},r.prototype.drawWindow=function(e,t,n,r,i){var s,o,u,a,f,l,c,h,p;f=this.randomTexture.getRandom()>.7,f?e.fillStyle=this.rndColor(240,230,160,1,.9,.6):e.fillStyle=this.rndGray(5,.4),e.fillRect(t,n,r,i),e.fillStyle=this.rndGray(5,.2),p=[];for(l=c=0,h=parseInt(Math.random()*5);0<=h?c<=h:c>=h;l=0<=h?++c:--c)o=r-parseInt(Math.random()*r),s=parseInt(i/2-Math.random()*(i/2)),u=parseInt(Math.random()*(r-o))+t,a=parseInt(i-s)+n,p.push(e.fillRect(u,a,o,s));return p},r.prototype.createTexture=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p;this.textureSize=512,e=document.createElement("canvas"),n=e.getContext("2d"),e.width=this.textureSize,e.height=this.textureSize,t=document.createElement("canvas"),this.contextCopy=t.getContext("2d"),t.width=this.textureSize,t.height=this.textureSize,u=this.textureSize-2*this.spacing,this.windowSize=u/this.numWindows-this.spacing,n.fillStyle=this.wallcolor,n.fillRect(0,0,this.textureSize,this.textureSize);for(a=l=0,h=this.numWindows-1;0<=h?l<=h:l>=h;a=0<=h?++l:--l){this.windowsOn[a]=[];for(f=c=0,p=this.numWindows-1;0<=p?c<=p:c>=p;f=0<=p?++c:--c)this.windowsOn[a][f]=-1,this.randomTexture.getRandom()<.5&&(this.windowsOn[a][f]=1,Math.random()<.05&&(this.windowsOn[a][f]=-1),s=this.spacing+a*(this.windowSize+this.spacing),o=f*(this.windowSize+this.spacing),i=this.windowSize-this.spacing,r=this.windowSize-this.spacing,this.drawWindow(n,s,o,i,r))}return this.canvasCopy=t,this.canvas=e,this.contextCopy.drawImage(this.canvas,0,0),this.texture=new THREE.Texture(this.canvasCopy),this.texture.wrapS=THREE.RepeatWrapping,this.texture.wrapT=THREE.RepeatWrapping,this.texture.needsUpdate=!0},r}(THREE.Object3D)})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};define("cs!core/objects/Tree",["Underscore","libs/namespace","cs!core/objects/BuildingBlock","Three"],function(t){var r;return namespace("Next.objects",{Tree:r=function(t){function r(t,n){this.plane=t,this.material2=n,this.buildLeaves=e(this.buildLeaves,this),this.buildTrunk=e(this.buildTrunk,this),r.__super__.constructor.apply(this,arguments),this.trunkHeight=(27+Math.random()*10)/1.5,this.trunkWidth=(3+Math.random()*2)/1.5,this.leavesRadius=(30+Math.random()*10)/1.5,this.buildTrunk(),this.buildLeaves()}return n(r,t),r.prototype.buildTrunk=function(){var e,t;return e=new THREE.Mesh(this.plane,this.material2),e.scale.set(this.trunkWidth,this.trunkHeight,1),e.position.y=this.trunkHeight/2,THREE.GeometryUtils.merge(this,e),t=new THREE.Mesh(this.plane,this.material2),t.scale.set(this.trunkWidth,this.trunkHeight,1),t.rotation.y=Math.PI*.5,t.position.y=this.trunkHeight/2,THREE.GeometryUtils.merge(this,t)},r.prototype.buildLeaves=function(){var e,t,n,r,i,s,o;r=50,n=1,e=this.leavesRadius/2,o=[];for(i=s=0;0<=r?s<=r:s>=r;i=0<=r?++s:--s)t=new THREE.Mesh(this.plane,this.material2),t.scale.set(n+Math.random()*7,n+Math.random()*7,1),t.rotation.set(Math.random()*10,Math.random()*10,Math.random()*10),t.position.set(-e+Math.random()*this.leavesRadius,this.trunkHeight-5+Math.random()*this.leavesRadius,-e+Math.random()*this.leavesRadius),o.push(THREE.GeometryUtils.merge(this,t));return o},r}(THREE.Geometry)})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};define("cs!core/objects/Cars",["Underscore","libs/namespace","Three"],function(t){var r;return namespace("Next.objects",{Cars:r=function(t){function r(t,n,i){var s,o,u,a;this.mat=t,this.plane=n,this.reverse=i!=null?i:!1,this.update=e(this.update,this),this.dispose=e(this.dispose,this),this.createMesh=e(this.createMesh,this),r.__super__.constructor.apply(this,arguments),this.maxLines=40,this.rndSpacing=20,this.availableMeshes=[];for(o=u=0,a=this.maxLines-1;0<=a?u<=a:u>=a;o=0<=a?++u:--u)s=new THREE.Mesh(this.plane,this.mat),s.doubleSided=!0,s.scale.set(1+Math.random()*2,1,100+Math.random()*150),s.position.y=-400,s.position.x=Math.random()*this.rndSpacing-this.rndSpacing*.5,s.rotation.z=Math.PI/2,this.reverse===!0&&(s.position.x*=-1,s.rotation.z*=-1),this.availableMeshes.push(s),this.add(s)}return n(r,t),r.prototype.createMesh=function(){var e;if(this.availableMeshes.length===0)return;e=this.availableMeshes.splice(0,1),e=e[0],e.position.y=4,e.position.z=300+Math.random()*100,this.reverse===!0&&(e.position.z-=1200);if(Math.random()<.4)return this.createMesh()},r.prototype.dispose=function(e){return e.position.y=-400,this.availableMeshes.push(e)},r.prototype.update=function(e){var t,n,r,i,s;r=e*2500,i=this.children,s=[];for(t in i)n=i[t],n.position.y>0?this.reverse===!0?(n.position.z+=r,n.position.z>300?s.push(this.dispose(n)):s.push(void 0)):(n.position.z-=r,n.position.z<-1e3?s.push(this.dispose(n)):s.push(void 0)):s.push(void 0);return s},r}(THREE.Object3D)})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};define("cs!core/objects/Planes",["Underscore","libs/namespace","Three"],function(t){var r;return namespace("Next.objects",{Planes:r=function(t){function r(t,n){this.mat=t,this.plane=n,this.createMesh=e(this.createMesh,this),this.update=e(this.update,this),r.__super__.constructor.apply(this,arguments),this.random=new Next.utils.Rc4Random("dLorem ipusm dolor sit amet."),this.maxLines=100,this.rndSpacing=2400,this.rndSpacingX=18e3,this.createMesh()}return n(r,t),r.prototype.update=function(e){var t,n,r,i;t=this.children.slice(0,this.children.length),i=[];for(n in t)r=t[n],r.scale.x>4?i.push(r.scale.x*=.96):(r.scale.x=1e-4,e&&r.scale.x<4&&Math.random()<.2?i.push(r.scale.x=20+this.random.getRandom()*189):i.push(void 0));return i},r.prototype.createMesh=function(){var e;if(this.children.length>=this.maxLines)return;return e=new THREE.Mesh(this.plane,this.mat),e.scale.set(.001,13e4,1),e.position.y=2e3,e.position.x=this.random.getRandom()*this.rndSpacingX-this.rndSpacingX*.5,e.rotation.z=e.position.x*-0.00015,this.reverse===!0&&(e.position.x*=-1,e.position.z-=1200,e.rotation.z*=-1),this.add(e),this.createMesh()},r}(THREE.Object3D)})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};define("cs!core/utils/Skeleton",["Underscore","libs/namespace","Three"],function(t){var r,i;return namespace("Next.utils",{Skeleton:r=function(t){function r(t,n,i,s,o,u,a){var f,l,c,h,p,d,v,m,g,y,b,w;this.materialSimple=t,this.materialWire=n,this.a=i,this.b=s,this.count=o!=null?o:3,this.radius=u!=null?u:1,this.direction=a!=null?a:new THREE.Vector3(1,0,0),this.update=e(this.update,this),this.addMiddlePart=e(this.addMiddlePart,this),r.__super__.constructor.apply(this,arguments),this.objects=[],this.mids=[],f=2,this.cube=new THREE.CubeGeometry(f,f,f),this.maxdiff=this.b.clone().subSelf(this.a).length(),this.object=new THREE.Mesh(this.cube,this.materialSimple),this.object.doubleSided=!0,this.object.position=this.a,this.add(this.object),this.mid=this.count-2,v=this.b.clone().subSelf(this.a).divideScalar(this.count-1),this.spacing=v,this.spacing_length=v.length(),h=new THREE.Object3D,h.position=this.a,this.objects.push(h),l=1/(this.count-1);for(c=m=b=this.mid;b<=1?m<=1:m>=1;c=b<=1?++m:--m)d=c*l,d>.5&&(d=(d-.5)*-1+.5),d*=2,p=this.addMiddlePart(this.a.clone().addSelf(v.clone().multiplyScalar(c))),h=new THREE.Object3D,h.position=p.position,this.objects.push(h);w=this.objects;for(g=0,y=w.length;g<y;g++)h=w[g],this.add(h);this.object2=new THREE.Mesh(this.cube,this.materialSimple),this.object2.position=this.b,this.object2.doubleSided=!0,this.add(this.object2)}return n(r,t),r.prototype.addMiddlePart=function(e){var t;return t=new THREE.Mesh(this.cube,this.materialSimple),t.position=e,this.add(t),this.mids.push(t),t},r.prototype.update=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v;o=this.objects.length;for(i=c=p=o-1;p<=1?c<=1:c>=1;i=p<=1?++c:--c)this.objects[i-1].lookAt(this.objects[i].position);this.objects[this.objects.length-1].lookAt(this.b),e=this.b.clone().subSelf(this.a),e.length()>this.maxdiff&&(r=this.b.clone().subSelf(this.a),f=1-e.length()/this.maxdiff,this.b.addSelf(r.multiplyScalar(f*.65))),l=this.b.clone().subSelf(this.a).divideScalar(this.count-1),n=l.clone().subSelf(this.spacing),t=this.direction.clone().multiplyScalar(n.length()),s=1/(this.count-1),v=[];for(u=h=d=this.mid;d<=1?h<=1:h>=1;u=d<=1?++h:--h)a=u*s,a>.5&&(a=(a-.5)*-1+.5),v.push(this.mids[u-1].position=this.a.clone().addSelf(l.clone().multiplyScalar(u)).addSelf(t.clone().multiplyScalar(a)));return v},r}(THREE.Object3D),Skeleton2:i=function(t){function r(t,n,i,s,o,u,a){var f,l,c,h,p,d,v,m,g,y,b,w;this.materialSimple=t,this.materialWire=n,this.a=i,this.b=s,this.count=o!=null?o:3,this.radius=u!=null?u:2,this.direction=a!=null?a:new THREE.Vector3(1,0,0),this.update=e(this.update,this),r.__super__.constructor.apply(this,arguments),l=this.spacing_length,w=this.objects;for(h=g=0,b=w.length;g<b;h=++g){v=w[h],p=5,c=l/(p+1);for(d=y=p;p<=1?y<=1:y>=1;d=p<=1?++y:--y)m=new THREE.Mesh(this.cube,this.materialSimple),m.doubleSided=!0,f=.2,m.scale=new THREE.Vector3(f,f,f),m.position.z=d*c,m.rotation.x=Math.PI*.5,v.add(m)}}return n(r,t),r.prototype.update=function(){var e,t,n,i,s;s=this.objects;for(e=n=0,i=s.length;n<i;e=++n)t=s[e],e>0&&(t.position=this.mids[e-1].position);return r.__super__.update.apply(this,arguments)},r}(r)})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};define("cs!core/objects/Biped",["Underscore","libs/namespace","cs!core/utils/Skeleton","Three"],function(t){var r;return namespace("Next.shapes",{Biped:r=function(t){function r(t,n,i){var s,o;this.app=t,this.material=n,this.materialWire=i,this.update=e(this.update,this),r.__super__.constructor.apply(this,arguments),this.legs_height=Math.random()*15+30,this.torso_height=Math.random()*7+22,this.arms_height=Math.random()*10+22,this.step_height=Math.random()*4+5,this.width=4+Math.random()*5,this.left_leg=new Next.utils.Skeleton2(this.material,this.materialWire,new THREE.Vector3(0,this.legs_height,-this.width),new THREE.Vector3(0,0,-this.width-.2),3,1),this.add(this.left_leg),this.right_leg=new Next.utils.Skeleton2(this.material,this.materialWire,new THREE.Vector3(0,this.legs_height,this.width),new THREE.Vector3(0,0,this.width+.2),3,1),this.add(this.right_leg),this.torso=new Next.utils.Skeleton2(this.material,this.materialWire,new THREE.Vector3(0,this.legs_height,0),new THREE.Vector3(0,this.legs_height+this.torso_height,0),5,3,new THREE.Vector3(-1,0,0)),this.add(this.torso),this.head=new THREE.Object3D,s=new THREE.CubeGeometry(5,6.5,5),o=new THREE.Mesh(s,this.material),o.doubleSided=!0,this.head.add(o),this.add(this.head),this.left_arm=new Next.utils.Skeleton2(this.material,this.materialWire,new THREE.Vector3(this.torso.b.x,this.torso.b.y,-this.width),new THREE.Vector3(0,this.torso.b.y-this.arms_height,-this.width-1.5),3,1,new THREE.Vector3(-1,0,0)),this.add(this.left_arm),this.right_arm=new Next.utils.Skeleton2(this.material,this.materialWire,new THREE.Vector3(this.torso.b.x,this.torso.b.y,this.width),new THREE.Vector3(0,this.torso.b.y-this.arms_height,this.width+1.5),3,1,new THREE.Vector3(-1,0,0)),this.add(this.right_arm),this.rotation.y=Math.PI*.5}return n(r,t),r.prototype.update=function(e){var t,n,r,i;return n=.0072,r=-13,t=-0.2,i=e*100,this.left_leg.a.y=this.legs_height*.8+Math.sin(i*n)*t,this.left_leg.b.y=Math.max(0,Math.sin(i*n)*this.step_height),this.left_leg.b.x=Math.cos(i*n)*r,this.left_leg.update(),this.right_leg.a.y=this.legs_height*.8+Math.sin(i*n+Math.PI)*t,this.right_leg.b.y=Math.max(0,Math.sin(i*n+Math.PI)*this.step_height),this.right_leg.b.x=Math.cos(i*n+Math.PI)*r,this.right_leg.update(),this.torso.a.y=(this.right_leg.a.y+this.left_leg.a.y)/2,this.torso.b.y=Math.cos(i*n+Math.PI)*.5+this.legs_height+this.torso_height-10,this.torso.b.x=Math.sin(i*n+Math.PI)*.5+5,this.torso.update(),this.left_arm.a.y=this.torso.b.y-2,this.left_arm.a.x=this.torso.b.x,this.left_arm.b.x=Math.sin(i*n+Math.PI)*1+4,this.left_arm.b.y=this.torso.b.y-this.arms_height+2+Math.sin(i*n+Math.PI)*.3,this.left_arm.update(),this.right_arm.a.y=this.torso.b.y-2,this.right_arm.a.x=this.torso.b.x,this.right_arm.b.x=Math.sin(i*n)*1+4,this.right_arm.b.y=this.torso.b.y-this.arms_height+2+Math.sin(i*n)*.3,this.right_arm.update(),this.head.position.y=this.torso.b.y+6,this.head.position.x=this.torso.b.x+3+Math.sin(i*n+Math.PI)*.5,this.head.rotation.z=Math.sin(i*n)*.05-.3},r}(THREE.Object3D)})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};define("cs!core/objects/Bird",["Underscore","libs/namespace","Three"],function(t){var r;return namespace("Next.objects",{Bird:r=function(t){function r(t){this.speed=t!=null?t:1.2,this.createGeometry=e(this.createGeometry,this),this.update=e(this.update,this),r.__super__.constructor.apply(this,arguments),this.time=0,this.createGeometry(),this.mat=new THREE.MeshBasicMaterial({color:16777215,emissive:8947848,side:THREE.DoubleSide}),this.side1=new THREE.Object3D,this.add(this.side1),this.side2=new THREE.Object3D,this.add(this.side2),this.object2=new THREE.Mesh(this.plane,this.mat),this.object2.position.x=35,this.object2.rotation.x=-Math.PI*.5,this.side1.add(this.object2),this.object=new THREE.Mesh(this.tri,this.mat),this.object.position.x=35,this.object.position.y=50,this.object.rotation.x=Math.PI*.5,this.object2.add(this.object),this.object3=new THREE.Mesh(this.plane,this.mat),this.object3.position.x=-35,this.object3.rotation.x=-Math.PI*.5,this.side2.add(this.object3),this.object4=new THREE.Mesh(this.tri,this.mat),this.object4.position.x=-35,this.object4.position.y=50,this.object4.rotation.x=Math.PI*.5,this.object3.add(this.object4)}return n(r,t),r.prototype.update=function(e){return this.time+=e*12,this.side1.position.y=(Math.sin(this.time*.3*this.speed)+Math.PI-.2)*10,this.side2.position.y=this.side1.position.y,this.side1.rotation.z=Math.sin(this.time*.3*this.speed)*.4+.1,this.object.rotation.z=Math.sin(this.time*.3*this.speed+Math.PI+.3)*.5-.3,this.side2.rotation.z=Math.sin(this.time*.3*this.speed)*-0.4-.1,this.object4.rotation.z=Math.sin(this.time*.3*this.speed+Math.PI+.3)*-0.5+.3+Math.PI},r.prototype.createGeometry=function(){return this.tri=new THREE.Geometry,this.tri.vertices.push(new THREE.Vector3(0,0,0)),this.tri.vertices.push(new THREE.Vector3(0,0,100)),this.tri.vertices.push(new THREE.Vector3(150,0,-42)),this.tri.dynamic=!1,this.tri.faces.push(new THREE.Face3(0,1,2)),this.tri.computeFaceNormals(),this.plane=new THREE.PlaneGeometry(70,100),this.plane.dynamic=!1},r}(THREE.Object3D)})})}.call(this),define("text",["module"],function(e){var t=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"],n=/^\s*<\?xml(\s)+version=[\'\"](\d)*.(\d)*[\'\"](\s)*\?>/im,r=/<body[^>]*>\s*([\s\S]+)\s*<\/body>/im,i=typeof location!="undefined"&&location.href,s=i&&location.protocol&&location.protocol.replace(/\:/,""),o=i&&location.hostname,u=i&&(location.port||undefined),a=[],f=e.config(),l,c;return l={version:"2.0.0",strip:function(e){if(e){e=e.replace(n,"");var t=e.match(r);t&&(e=t[1])}else e="";return e},jsEscape:function(e){return e.replace(/(['\\])/g,"\\$1").replace(/[\f]/g,"\\f").replace(/[\b]/g,"\\b").replace(/[\n]/g,"\\n").replace(/[\t]/g,"\\t").replace(/[\r]/g,"\\r")},createXhr:function(){var e,n,r;if(typeof XMLHttpRequest!="undefined")return new XMLHttpRequest;if(typeof ActiveXObject!="undefined")for(n=0;n<3;n++){r=t[n];try{e=new ActiveXObject(r)}catch(i){}if(e){t=[r];break}}return e},parseName:function(e){var t=!1,n=e.indexOf("."),r=e.substring(0,n),i=e.substring(n+1,e.length);return n=i.indexOf("!"),n!==-1&&(t=i.substring(n+1,i.length),t=t==="strip",i=i.substring(0,n)),{moduleName:r,ext:i,strip:t}},xdRegExp:/^((\w+)\:)?\/\/([^\/\\]+)/,useXhr:function(e,t,n,r){var i=l.xdRegExp.exec(e),s,o,u;return i?(s=i[2],o=i[3],o=o.split(":"),u=o[1],o=o[0],(!s||s===t)&&(!o||o===n)&&(!u&&!o||u===r)):!0},finishLoad:function(e,t,n,r){n=t?l.strip(n):n,f.isBuild&&(a[e]=n),r(n)},load:function(e,t,n,r){if(r.isBuild&&!r.inlineText){n();return}f.isBuild=r.isBuild;var a=l.parseName(e),c=a.moduleName+"."+a.ext,h=t.toUrl(c),p=f.useXhr||l.useXhr;!i||p(h,s,o,u)?l.get(h,function(t){l.finishLoad(e,a.strip,t,n)},function(e){n.error&&n.error(e)}):t([c],function(e){l.finishLoad(a.moduleName+"."+a.ext,a.strip,e,n)})},write:function(e,t,n,r){if(a.hasOwnProperty(t)){var i=l.jsEscape(a[t]);n.asModule(e+"!"+t,"define(function () { return '"+i+"';});\n")}},writeFile:function(e,t,n,r,i){var s=l.parseName(t),o=s.moduleName+"."+s.ext,u=n.toUrl(s.moduleName+"."+s.ext)+".js";l.load(o,n,function(t){var n=function(e){return r(u,e)};n.asModule=function(e,t){return r.asModule(e,u,t)},l.write(e,o,n,i)},i)}},typeof process!="undefined"&&process.versions&&!!process.versions.node?(c=require.nodeRequire("fs"),l.get=function(e,t){var n=c.readFileSync(e,"utf8");n.indexOf("")===0&&(n=n.substring(1)),t(n)}):l.createXhr()?l.get=function(e,t,n){var r=l.createXhr();r.open("GET",e,!0),f.onXhr&&f.onXhr(r,e),r.onreadystatechange=function(i){var s,o;r.readyState===4&&(s=r.status,s>399&&s<600?(o=new Error(e+" HTTP status: "+s),o.xhr=r,n(o)):t(r.responseText))},r.send(null)}:typeof Packages!="undefined"&&(l.get=function(e,t){var n="utf-8",r=new java.io.File(e),i=java.lang.System.getProperty("line.separator"),s=new java.io.BufferedReader(new java.io.InputStreamReader(new java.io.FileInputStream(r),n)),o,u,a="";try{o=new java.lang.StringBuffer,u=s.readLine(),u&&u.length()&&u.charAt(0)===65279&&(u=u.substring(1)),o.append(u);while((u=s.readLine())!==null)o.append(i),o.append(u);a=String(o.toString())}finally{s.close()}t(a)}),l}),define("text!core/../../shaders/basic.vert",[],function(){return"varying vec2 vUv;\n\nvoid main() {\n	vUv = vec2( uv.x, 1.0 - uv.y );\n	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}\n"}),define("text!core/../../shaders/glitch.frag",[],function(){return"#ifdef GL_ES\nprecision highp float;\n#endif\n\nuniform sampler2D tDiffuse;\nuniform sampler2D tLensDirt;\nuniform sampler2D tGlitch;\n\nvarying vec2 vUv;\n\nuniform float time;\nuniform vec3 resolution;\n\nuniform float glitch_intensity;\nuniform vec3 offset_color;\n\nvec4 mod289(vec4 x)\n{\n  return x - floor(x * (1.0 / 289.0)) * 289.0;\n}\n\nvec4 permute(vec4 x)\n{\n  return mod289(((x*34.0)+1.0)*x);\n}\n\nvec4 taylorInvSqrt(vec4 r)\n{\n  return 1.79284291400159 - 0.85373472095314 * r;\n}\n\nvec2 fade(vec2 t) {\n  return t*t*t*(t*(t*6.0-15.0)+10.0);\n}\n\n// Classic Perlin noise\nfloat cnoise(vec2 P)\n{\n  vec4 Pi = floor(P.xyxy) + vec4(0.0, 0.0, 1.0, 1.0);\n  vec4 Pf = fract(P.xyxy) - vec4(0.0, 0.0, 1.0, 1.0);\n  Pi = mod289(Pi); // To avoid truncation effects in permutation\n  vec4 ix = Pi.xzxz;\n  vec4 iy = Pi.yyww;\n  vec4 fx = Pf.xzxz;\n  vec4 fy = Pf.yyww;\n\n  vec4 i = permute(permute(ix) + iy);\n\n  vec4 gx = fract(i * (1.0 / 41.0)) * 2.0 - 1.0 ;\n  vec4 gy = abs(gx) - 0.5 ;\n  vec4 tx = floor(gx + 0.5);\n  gx = gx - tx;\n\n  vec2 g00 = vec2(gx.x,gy.x);\n  vec2 g10 = vec2(gx.y,gy.y);\n  vec2 g01 = vec2(gx.z,gy.z);\n  vec2 g11 = vec2(gx.w,gy.w);\n\n  vec4 norm = taylorInvSqrt(vec4(dot(g00, g00), dot(g01, g01), dot(g10, g10), dot(g11, g11)));\n  g00 *= norm.x;\n  g01 *= norm.y;\n  g10 *= norm.z;\n  g11 *= norm.w;\n\n  float n00 = dot(g00, vec2(fx.x, fy.x));\n  float n10 = dot(g10, vec2(fx.y, fy.y));\n  float n01 = dot(g01, vec2(fx.z, fy.z));\n  float n11 = dot(g11, vec2(fx.w, fy.w));\n\n  vec2 fade_xy = fade(Pf.xy);\n  vec2 n_x = mix(vec2(n00, n01), vec2(n10, n11), fade_xy.x);\n  float n_xy = mix(n_x.x, n_x.y, fade_xy.y);\n  return 2.3 * n_xy;\n}\n\n// Classic Perlin noise, periodic variant\nfloat pnoise(vec2 P, vec2 rep)\n{\n  vec4 Pi = floor(P.xyxy) + vec4(0.0, 0.0, 1.0, 1.0);\n  vec4 Pf = fract(P.xyxy) - vec4(0.0, 0.0, 1.0, 1.0);\n  Pi = mod(Pi, rep.xyxy); // To create noise with explicit period\n  Pi = mod289(Pi); // To avoid truncation effects in permutation\n  vec4 ix = Pi.xzxz;\n  vec4 iy = Pi.yyww;\n  vec4 fx = Pf.xzxz;\n  vec4 fy = Pf.yyww;\n\n  vec4 i = permute(permute(ix) + iy);\n\n  vec4 gx = fract(i * (1.0 / 41.0)) * 2.0 - 1.0 ;\n  vec4 gy = abs(gx) - 0.5 ;\n  vec4 tx = floor(gx + 0.5);\n  gx = gx - tx;\n\n  vec2 g00 = vec2(gx.x,gy.x);\n  vec2 g10 = vec2(gx.y,gy.y);\n  vec2 g01 = vec2(gx.z,gy.z);\n  vec2 g11 = vec2(gx.w,gy.w);\n\n  vec4 norm = taylorInvSqrt(vec4(dot(g00, g00), dot(g01, g01), dot(g10, g10), dot(g11, g11)));\n  g00 *= norm.x;\n  g01 *= norm.y;\n  g10 *= norm.z;\n  g11 *= norm.w;\n\n  float n00 = dot(g00, vec2(fx.x, fy.x));\n  float n10 = dot(g10, vec2(fx.y, fy.y));\n  float n01 = dot(g01, vec2(fx.z, fy.z));\n  float n11 = dot(g11, vec2(fx.w, fy.w));\n\n  vec2 fade_xy = fade(Pf.xy);\n  vec2 n_x = mix(vec2(n00, n01), vec2(n10, n11), fade_xy.x);\n  float n_xy = mix(n_x.x, n_x.y, fade_xy.y);\n  return 2.3 * n_xy;\n}\n\nvoid main(void)\n{\n  vec4 colorDirt = texture2D(tLensDirt, vUv);\n  vec4 glitchDisplace = texture2D(tGlitch, vec2(mod(mod(time, 142.0) * 0.1 + vUv.x * 0.05, 1.0), vUv.y));\n  vec4 glitchColor = texture2D(tGlitch, vec2(mod(mod(time, 242.0) * 0.03 + vUv.x * 0.1, 1.0), vUv.y));\n  vec4 glitchImage = texture2D(tGlitch, vec2(mod(mod(time, 42.0) * 0.5 + vUv.x * 0.1, 1.0), vUv.y));\n  //vec4 colorBlur = getBlur();\n  vec2 uvDisp = vec2(mod(vUv.x + glitchDisplace.r * 0.01, 1.0), mod(vUv.y + glitchColor.b * 0.01, 1.0));\n  //vec2 uvDiff = uvDisp - vUv;\n  float noiseOffset = cnoise(vec2(vUv.x * 10.0 + time, vUv.y * 10.0)) * glitch_intensity;\n  vec4 colorR = texture2D( tDiffuse, vec2(mod(uvDisp.x + offset_color.x * noiseOffset, 1.0), uvDisp.y) );\n  vec4 colorG = texture2D( tDiffuse, vec2(mod((vUv.x + uvDisp.x) / 2.0 + offset_color.y * noiseOffset, 1.0), uvDisp.y) );\n  vec4 colorB = texture2D( tDiffuse, vec2(mod(vUv.x + offset_color.z * noiseOffset, 1.0), uvDisp.y) );\n\n\n  float darkDirtMult = 0.05;\n  colorR = colorR - colorDirt * darkDirtMult;\n  colorG = colorG - colorDirt * darkDirtMult;\n  colorB = colorB - colorDirt * darkDirtMult;\n\n	gl_FragColor = vec4(colorR.r, colorG.g, colorB.b, 1.0);\n  //gl_FragColor = vec4(colorBlur.r, colorBlur.g, colorBlur.b, 1.0);\n  //gl_FragColor = vec4(noiseOffset, noiseOffset, noiseOffset, 1.0);\n  //gl_FragColor = vec4(colorDirt.r, colorDirt.g, colorDirt.b, 1.0);\n  //gl_FragColor = vec4(glitchDisplace.r, glitchDisplace.g, glitchDisplace.b, 1.0);\n}\n"}),function(){define("cs!core/shaders/Glitch",["text!../../../shaders/basic.vert","text!../../../shaders/glitch.frag","Three"],function(e,t){return namespace("Next.shaders",{GlitchShader:{uniforms:{time:{type:"f",value:0},glitch_intensity:{type:"f",value:.1},resolution:{type:"v3",value:new THREE.Vector3(0,0,0)},offset_color:{type:"v3",value:new THREE.Vector3(.005,0,0)},tDiffuse:{type:"t",value:0,texture:null},tLensDirt:{type:"t",value:1,texture:null},tGlitch:{type:"t",value:2,texture:null}},vertexShader:e,fragmentShader:t}})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("cs!core/utils/AudioManager",["Underscore","libs/namespace"],function(t){var n;return namespace("Next.utils",{AudioManager:n=function(){function n(n,r){var i,s,o,u=this;this.onLoadedCallback=r,this.rms=e(this.rms,this),this.play=e(this.play,this),this.pause=e(this.pause,this),this.createSound=e(this.createSound,this),this.load=e(this.load,this),this.update=e(this.update,this),this.fftSize=512,this.filters={},this.playing=!0,this.now=0,this.timeDelay=0,this.context=new webkitAudioContext,this.analyser=this.context.createAnalyser(),this.analyser.fftSize=this.fftSize,this.source=this.context.createBufferSource(),s={bass:{type:0,frequency:120,Q:1.2,gain:2},mid:{type:2,frequency:400,Q:1.2,gain:4},treble:{type:1,frequency:2e3,Q:1.2,gain:3}},t.each(s,function(e,t){var n;return n=u.context.createBiquadFilter(),n.key=t,n.type=e.type,n.frequency=e.frequency,n.Q.value=e.Q,n.analyser=u.context.createAnalyser(),n.analyser.fftSize=u.fftSize,n.delayNode=u.context.createDelayNode(),n.delayNode.delayTime.value=0,n.gainNode=u.context.createGainNode(),n.gainNode.gain.value=e.gain,u.filters[t]=n}),this.delay=this.context.createDelayNode(),this.delay.delayTime.value=this.fftSize*2/this.context.sampleRate,this.source.connect(this.analyser),this.analyser.connect(this.delay),o=!1,o?(i=this.context.createGainNode(),this.delay.connect(i),i.gain.value=0,i.connect(this.context.destination)):this.delay.connect(this.context.destination),t.each(this.filters,function(e){return u.source.connect(e.delayNode),e.delayNode.connect(e),e.connect(e.gainNode),e.gainNode.connect(e.analyser)}),this.samples=this.analyser.frequencyBinCount,this.data={freq:new Uint8Array(this.samples),time:new Uint8Array(this.samples),filter:{bass:new Uint8Array(256),mid:new Uint8Array(256),treble:new Uint8Array(256)}},this.load(n)}return n.prototype.update=function(){var e,n,r,i,s=this;this.analyser.smoothingTimeConstant=0,this.analyser.getByteFrequencyData(this.data.freq),this.analyser.getByteTimeDomainData(this.data.time),t.each(this.filters,function(e){return e.analyser.getByteTimeDomainData(s.data.filter[e.key])}),e=[0,0,0,0],r=[this.data.time,this.data.filter.bass,this.data.filter.mid,this.data.filter.treble];for(n=i=0;i<=3;n=++i)e[n]=this.rms(r[n]);return this.bass=e[1],this.mid=e[2],this.high=e[3],this.now=this.context.currentTime-this.timeDelay},n.prototype.load=function(e){var t,n=this;return t=new XMLHttpRequest,t.open("GET",e,!0),t.responseType="arraybuffer",t.onload=function(){return n.buffer=n.context.createBuffer(t.response,!1),n.source.buffer=n.buffer,n.source.loop=!1,n.play()},t.send()},n.prototype.createSound=function(){var e,n=this;return e=this.context.createBufferSource(),this.buffer&&(e.buffer=this.buffer),e.connect(this.analyser),t.each(this.filters,function(t){return e.connect(t.delayNode)}),e},n.prototype.pause=function(){return this.source&&(this.source.noteOff(0),this.source.disconnect(0),this.source=!1),this.playing=!1},n.prototype.play=function(){this.playing=!0,this.timeDelay=this.context.currentTime-this.now,this.source||(this.source=this.createSound()),this.source.buffer&&this.source.noteGrainOn(0,this.now,this.buffer.duration-this.now);if(this.onLoadedCallback)return this.onLoadedCallback()},n.prototype.rms=function(e){var t,n,r,i,s,o;i=e.length,t=0;for(n=s=0,o=i-1;0<=o?s<=o:s>=o;n=0<=o?++s:--s)r=(e[n]-128)/128,t+=r*r;return Math.sqrt(t/i)},n}()})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}};define("cs!core/utils/LensFlareContainer",["Underscore","libs/namespace","Three"],function(t){var n;return namespace("Next.utils",{LensFlareContainer:n=function(){function t(t,n){var r,i,s,o;this.scene=t,this.sunLight=n,this.updateLensFlare=e(this.updateLensFlare,this),i=THREE.ImageUtils.loadTexture("textures/flare0.png"),s=THREE.ImageUtils.loadTexture("textures/flare2.png"),o=THREE.ImageUtils.loadTexture("textures/flare3.png"),r=new THREE.Color(16777215),this.lensFlare=new THREE.LensFlare(i,512,0,THREE.AdditiveBlending,r),this.lensFlare.add(s,512,0,THREE.AdditiveBlending),this.lensFlare.add(s,1024,0,THREE.AdditiveBlending),this.lensFlare.add(s,512,0,THREE.AdditiveBlending),this.lensFlare.add(o,60,.6,THREE.AdditiveBlending),this.lensFlare.add(o,70,.7,THREE.AdditiveBlending),this.lensFlare.add(o,120,.9,THREE.AdditiveBlending),this.lensFlare.add(o,70,1,THREE.AdditiveBlending),this.lensFlare.position=this.sunLight.position,this.lensFlare.customUpdateCallback=this.updateLensFlare,this.scene.add(this.lensFlare)}return t.prototype.updateLensFlare=function(e){var t,n,r,i,s,o;this.lensFlare.position.y=this.sunLight.position.y,r=-e.positionScreen.x*2,i=-e.positionScreen.y*2;for(t=s=0,o=e.lensFlares.length-1;0<=o?s<=o:s>=o;t=0<=o?++s:--s)n=e.lensFlares[t],n.x=e.positionScreen.x+r*n.distance,n.y=e.positionScreen.y+i*n.distance,n.rotation=0,t===0?n.scale=this.sunLight.position.y*.004:n.scale=.7;return e.lensFlares[2].y+=.025,e.lensFlares[1].rotation=e.positionScreen.x*.4-15*Math.PI/180,e.lensFlares[3].rotation=e.positionScreen.x*.5+45*Math.PI/180},t}()})})}.call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t={}.hasOwnProperty,n=function(e,n){function i(){this.constructor=e}for(var r in n)t.call(n,r)&&(e[r]=n[r]);return i.prototype=n.prototype,e.prototype=new i,e.__super__=n.prototype,e};define("cs!core/App",["Underscore","Three","libs/namespace","cs!core/utils/ThreeApp","cs!core/objects/Buildings","cs!core/objects/Tree","cs!core/objects/Cars","cs!core/objects/Planes","cs!core/objects/Biped","cs!core/objects/Bird","cs!core/shaders/Glitch","cs!core/utils/AudioManager","cs!core/utils/Rc4Random","cs!core/utils/LensFlareContainer"],function(t){var r;return namespace("Next",{settings:{postprocessing:!0,backgroundColor:1119511},App:r=function(t){function r(){this.updateWorld=e(this.updateWorld,this),this.rgbToHex=e(this.rgbToHex,this),this.componentToHex=e(this.componentToHex,this),this.handleVisibilityChange=e(this.handleVisibilityChange,this),this.onSoundLoaded=e(this.onSoundLoaded,this),this.createWorld=e(this.createWorld,this);var t=this;this.mouse={x:0,y:0},this.playing=!1,this.is_paused=!1,this.cameras=[],this.outro=!1,r.__super__.constructor.apply(this,arguments),$("#container canvas").fadeOut(0),this.audio=new Next.utils.AudioManager("audio/walk_in_a_fog.mp3",this.onSoundLoaded),$("body").mousemove(function(e){var n,r,i,s;return s=document.width,i=document.height,n=e.pageX,r=e.pageY,t.mouse.x=n/s-.5,t.mouse.y=r/i-.5}),document.addEventListener("webkitvisibilitychange",this.handleVisibilityChange,!1)}return n(r,t),r.prototype.createWorld=function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;this.scene.fog=new THREE.FogExp2(1053203,.0035),this.sunLight=new THREE.DirectionalLight(16512466,0),this.sunLight.position.set(0,-200,-7220),this.scene.add(this.sunLight),v=new THREE.SphereGeometry(200,20,20),v.dynamic=!1,m=new THREE.MeshBasicMaterial({color:16512466,fog:!1}),this.sun=new THREE.Mesh(v,m),this.sun.dynamic=!1,this.sun.position.set(0,-200,-8e3),this.scene.add(this.sun),this.lensFlare=new Next.utils.LensFlareContainer(this.scene,this.sunLight),this.buildings=new Next.objects.Buildings,this.buildings.position.z=-6e3,this.scene.add(this.buildings),a=new THREE.MeshPhongMaterial({color:3355443,fog:!0,side:THREE.DoubleSide}),f=new THREE.MeshBasicMaterial({color:5592405,fog:!0,side:THREE.DoubleSide,wireframe:!0}),h=new THREE.PlaneGeometry(1,1,1,1),h.dynamic=!1,o=new THREE.MeshBasicMaterial({color:16724787,fog:!0,blending:THREE.AdditiveBlending,transparent:!0,side:THREE.DoubleSide}),u=new THREE.MeshBasicMaterial({color:16777215,fog:!0,blending:THREE.AdditiveBlending,transparent:!0,side:THREE.DoubleSide}),i=new THREE.MeshBasicMaterial({color:window.userColor,fog:!1,blending:THREE.AdditiveBlending,transparent:!0}),this.planes1=new Next.objects.Planes(i,h),this.planes1.position.z=-10400,this.scene.add(this.planes1),t=new THREE.CubeGeometry(1,1,1),t.dynamic=!1,this.cars1=new Next.objects.Cars(o,t),this.cars1.position.x=30,this.scene.add(this.cars1),this.cars2=new Next.objects.Cars(u,t,!0),this.cars2.position.x=-30,this.scene.add(this.cars2),this.cars3=new Next.objects.Cars(o,t),this.cars3.scale.x=.6,this.cars3.position.x=300,this.cars3.position.z=-2120,this.cars3.rotation.y=Math.PI*.5,this.scene.add(this.cars3),this.cars4=new Next.objects.Cars(u,t),this.cars4.scale.x=.6,this.cars4.position.x=-300,this.cars4.position.z=-2270,this.cars4.rotation.y=Math.PI*-0.5,this.scene.add(this.cars4),y=[];for(c=E=0;E<=10;c=++E)y.push(new Next.objects.Tree(h,a));b=.5,p=new Next.utils.Rc4Random("42z6drBPvsdfayBAJVT4kNHR"),this.trees=new THREE.Geometry;for(c=S=0;S<=40;c=++S)n=y[parseInt(p.getRandom()*10)],g=new THREE.Mesh(n,a),g.position.x=60,g.position.z=-9e3+c*220+p.getRandom()*30,g.doubleSided=!0,THREE.GeometryUtils.merge(this.trees,g),n=y[parseInt(p.getRandom()*10)],g=new THREE.Mesh(n,a),g.position.x=-60,g.position.z=-9e3+c*220+110+p.getRandom()*30,g.doubleSided=!0,THREE.GeometryUtils.merge(this.trees,g);return this.trees.dynamic=!1,this.treesMesh=new THREE.Mesh(this.trees,a),this.treesMesh.doubleSided=!0,this.treesMesh.position.z=700,this.scene.add(this.treesMesh),this.materialPlane=new THREE.MeshLambertMaterial({color:328965,fog:!0}),this.plane=new THREE.PlaneGeometry(3e4,3e4,5,5),this.plane.dynamic=!1,r=new THREE.Mesh(this.plane,this.materialPlane),r.rotation.x=-Math.PI*.5,this.scene.add(r),s=new THREE.MeshLambertMaterial({color:16777215,fog:!0}),l=new THREE.MeshBasicMaterial({color:16777215,fog:!0,wireframe:!0}),this.thing=new Next.shapes.Biped(this,s,l),w=.3,this.thing.scale.set(w,w,w),this.scene.add(this.thing),this.thing.position.y=0,this.thing.position.z=240,this.bird=new Next.objects.Bird,this.bird.position.z=-3e3,e=.02,this.bird.scale.set(e,e,e),this.bird.position.y=12,this.bird.position.x=300,this.scene.add(this.bird),this.textureRise=THREE.ImageUtils.loadTexture("textures/sunrise.png"),this.materialSky=new THREE.MeshBasicMaterial({map:this.textureRise,fog:!1,transparent:!0,opacity:0,side:THREE.DoubleSide}),d=new THREE.PlaneGeometry(1,1,1,1),d.dynamic=!1,this.sky=new THREE.Mesh(d,this.materialSky),this.sky.position.z=-10900,this.sky.position.y=5e3,this.sky.scale.set(1e4,1e4,1),this.scene.add(this.sky)},r.prototype.onSoundLoaded=function(){return this.playing=!0,$("#container canvas").delay(20).fadeIn(3e3)},r.prototype.handleVisibilityChange=function(){if(this.finished===!0)return;return document.webkitHidden?(this.audio.pause(),this.is_paused=!0):(this.audio.play(),this.is_paused=!1)},r.prototype.componentToHex=function(e){var t,n;return t=e.toString(16),(n=t.length===1)!=null?n:"0"+{hex:t}},r.prototype.rgbToHex=function(e,t,n){return"#"+this.componentToHex(e)+this.componentToHex(t)+this.componentToHex(n)},r.prototype.updateWorld=function(e,t){var n,r,i,s,o,u=this;this.time=e;if(this.is_paused===!0)return;if(this.playing===!1)return;if(!this.audio)return;s=this.audio.now,this.audio.update(),s>16&&(this.cars1.update(t),this.cars2.update(t),this.cars3.update(t),this.cars4.update(t),this.audio.bass>.32&&Math.random()>.89&&this.cars1.createMesh(),this.audio.high>.37&&Math.random()>.86&&this.cars2.createMesh(),this.audio.bass>.32&&Math.random()>.8&&this.cars3.createMesh(),this.audio.mid>.33&&Math.random()>.52&&this.cars4.createMesh()),s>80&&this.planes1.update(this.audio.high>.37&&Math.random()>.82),o=0,s>112&&s<120&&(o=-1210),s>144&&(o=1e3,this.mainShader.uniforms.offset_color.value.x=.02,this.mainShader.uniforms.glitch_intensity.value=.3),s>137&&(this.materialSky.opacity=(s-137)*.01),s>140&&(this.sun.position.y+=t*10,this.sunLight.position.y=this.sun.position.y+100,this.sunLight.intensity=(s-140)/10,r=new THREE.Color,i=.001,r.setRGB(.06667+(s-140)*i,.08235+(s-144)*i*.1,.090196+(s-144)*i*.3),this.renderer.setClearColor(r),this.scene.fog.color=r),s>133&&(this.bird.update(t),this.bird.position.x=3,this.bird.position.z=-3260+(s-133)*30),this.thing.update(e),this.thing.position.z=240-s*18+o,this.cameras.update(s,this.thing,this.mouse),this.renderModel.camera=this.cameras.currentCamera,s>162&&this.outro===!1&&(this.outro=!0,$("body").css("background-color","#fff"),_gaq.push(["_trackEvent","Animation","completed"]),$("#container canvas").fadeOut(7e3,function(){return u.finished=!0,$("body").append('<a href="/" id="replay">Replay</a>'),$("#replay").hide().fadeIn(300),$("footer .right").addClass("finished"),$("body").append($("footer .right"))})),n=50;if(this.cameras.currentCamera===this.cameras.cameraCity1||this.cameras.currentCamera===this.cameras.cameraCity2)n=-300;this.cars1.position.z=this.cameras.currentCamera.position.z-n,this.cars2.position.z=this.cameras.currentCamera.position.z-n,this.buildings.update(this.audio.bass>.32&&Math.random()>.82);if(this.mainShader)return this.mainShader.uniforms.time.value=e/10,this.mainShader.uniforms.resolution.value=new THREE.Vector3(window.innerWidth,window.innerHeight,0)},r}(Next.ThreeApp)})})}.call(this),require.config({paths:{CoffeeScript:"libs/coffee-script",cs:"libs/require/cs"}}),require(["cs!core/App"],function(){new Next.App}),define("boot",function(){})